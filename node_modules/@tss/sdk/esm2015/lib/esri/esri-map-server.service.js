/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { map, tap } from 'rxjs/operators';
// TSS.
import { Logger } from '../core/logging/logger.service';
import { NetworkFeature } from '../lrs/networks/network-feature';
import { EventFeatureCollection } from '../lrs/events/event-feature-collection';
import { NetworkFeatureCollection } from '../lrs/networks/network-feature-collection';
import { CriteriaOperator } from '../maps/where-clause-builder';
import { EsriConfig } from './esri-config';
import { getEsriMapServiceHttOptions, addParamsToHttpOptions } from './esri-map-service-request';
import { toFieldName } from '../maps/fields/layer-field';
import { DataSourceConfig } from '../data-source/data-source-config';
import { toFormData } from '../http/to-form-data.function';
import { MAP_LAYERS_SERVICE_ENDPOINT, LRS_LAYERS_SERVICE_ENDPOINT, MAP_LAYER_QUERY_SERVICE_ENDPOINT, LRS_SERVER_META_ENDPOINT, LRS_SERVER_APPLY_EDITS_ENDPOINT, LRS_GEOMETRY_TO_MEASURE, MAP_LAYER_SERVICE_ENDPOINT } from './esri.constants';
import { getGeometryToMeasureOptions } from './geometry-to-measure/get-geometry-to-measure-options.function';
import { getMapQueryOptions } from './query/get-map-query-options.function';
import { toHttpQueryParams } from './query/to-http-query-params.function';
import { tryStripGdbVersion } from './try-strip-gdb-version.function';
import { toLayerId } from '../maps/to-layer-id.function';
import { BaseEsriService } from './base-esri.service';
import { joinAndFomatWithLayer } from './join-and-format-with-layer.function';
import { join } from '../core/url/join.function';
import { format } from '../core/formatting/format.function';
import { FeatureClassLayer } from '../maps/feature-class-layer';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./esri-config";
import * as i3 from "../data-source/data-source-config";
import * as i4 from "../core/logging/logger.service";
export class EsriMapServerService extends BaseEsriService {
    /**
     * @param {?} http
     * @param {?} config
     * @param {?} dataConfig
     * @param {?} log
     */
    constructor(http, config, dataConfig, log) {
        super(http, config, dataConfig, log);
    }
    /**
     * Retrieves the map service metadata for all layers.
     * @param {?} serviceUrl
     * @return {?}
     */
    getMapLayers(serviceUrl) {
        /** @type {?} */
        const url = join(serviceUrl, MAP_LAYERS_SERVICE_ENDPOINT);
        return this.http
            .get(url, getEsriMapServiceHttOptions())
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, serviceUrl))));
    }
    /**
     * Retrieves the map service metadata for a given layer (by it's ID).
     * @param {?} serviceUrl
     * @param {?} layerId
     * @return {?}
     */
    getMapLayer(serviceUrl, layerId) {
        /** @type {?} */
        const url = joinAndFomatWithLayer(layerId, {}, serviceUrl, MAP_LAYER_SERVICE_ENDPOINT);
        return this.http
            .get(url, getEsriMapServiceHttOptions())
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, serviceUrl))), map((/**
         * @param {?} mapLayerMetadata
         * @return {?}
         */
        mapLayerMetadata => new FeatureClassLayer(mapLayerMetadata))));
    }
    /**
     * Retrieves the LRS Layers Metadata information from the map service
     * @param {?} serviceUrl
     * @return {?}
     */
    getLrsLayers(serviceUrl) {
        /** @type {?} */
        const url = join(serviceUrl, LRS_LAYERS_SERVICE_ENDPOINT);
        return this.http
            .get(url, getEsriMapServiceHttOptions())
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, serviceUrl))));
    }
    /**
     * Retrieves the LRS Server Metadata information from the map service
     * @param {?} serviceUrl
     * @return {?}
     */
    getLrsServer(serviceUrl) {
        /** @type {?} */
        const url = join(serviceUrl, LRS_SERVER_META_ENDPOINT);
        return this.http
            .get(url, getEsriMapServiceHttOptions())
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, serviceUrl))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?=} lrsId
     * @return {?}
     */
    getVersions(serviceUrl, lrsId) {
        return this.getLrsServer(serviceUrl)
            .pipe(map((/**
         * @param {?} metadata
         * @return {?}
         */
        (metadata) => {
            /** @type {?} */
            let lrs = metadata ? metadata.lrs[0] : null;
            if (!lrs) {
                throw new Error(`No LRS infos found`);
            }
            if (lrsId) {
                lrs = metadata.lrs.find((/**
                 * @param {?} lrsInfo
                 * @return {?}
                 */
                lrsInfo => lrsInfo.id === lrsId));
                if (!lrs) {
                    throw new Error(`No LRS info found with ID '${lrsId}'`);
                }
            }
            return lrs.versions;
        })));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} networkLayerId
     * @param {?} routeId
     * @param {?} x
     * @param {?} y
     * @param {?=} viewDate
     * @param {?=} inSpatialReferenceId
     * @param {?=} outputSpatialReferenceId
     * @return {?}
     */
    singleGeometryToMeasure(serviceUrl, networkLayerId, routeId, x, y, viewDate, inSpatialReferenceId = 4326, outputSpatialReferenceId = 4326) {
        /** @type {?} */
        const locations = [
            { routeId, geometry: { x, y } }
        ];
        return this.geometryToMeasure(serviceUrl, networkLayerId, {
            locations,
            temporalViewDate: viewDate,
            inSR: inSpatialReferenceId,
            outSR: outputSpatialReferenceId,
        })
            .pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        result => {
            /** @type {?} */
            const match = { m: null, x: null, y: null, z: null };
            if (result.locations.length && result.locations[0].results.length) {
                const [found] = result.locations[0].results;
                match.m = found.measure;
                match.x = found.geometry.x;
                match.y = found.geometry.y;
            }
            return match;
        })));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} networkLayerId
     * @param {?} options
     * @return {?}
     */
    geometryToMeasure(serviceUrl, networkLayerId, options) {
        /** @type {?} */
        const endpoint = format(LRS_GEOMETRY_TO_MEASURE, { layerId: networkLayerId });
        /** @type {?} */
        const url = join(serviceUrl, endpoint);
        /** @type {?} */
        const httpOption = getEsriMapServiceHttOptions();
        /** @type {?} */
        const serviceOptions = getGeometryToMeasureOptions(options);
        /** @type {?} */
        const useGetMethod = !this.shouldUsePostMethod(serviceOptions);
        if (useGetMethod) {
            addParamsToHttpOptions(httpOption, serviceOptions);
        }
        return (useGetMethod
            ? this.http.get(url, httpOption)
            : this.http.post(url, toFormData(serviceOptions), httpOption))
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        response => this.handleEsriResponseError(response, serviceUrl))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} edits
     * @param {?=} gdbVersion
     * @return {?}
     */
    applyEdits(serviceUrl, edits, gdbVersion) {
        /** @type {?} */
        const url = join(serviceUrl, LRS_SERVER_APPLY_EDITS_ENDPOINT);
        /** @type {?} */
        const options = getEsriMapServiceHttOptions();
        /** @type {?} */
        const useGetMethod = !this.shouldUsePostMethod(edits);
        if (useGetMethod) {
            options.params = options.params
                .set('edits', JSON.stringify(edits))
                .set('gdbVersion', gdbVersion);
        }
        return (useGetMethod
            ? this.http.get(url, options)
            : this.http.post(url, toFormData({ edits, gdbVersion }), options))
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        response => this.handleEsriResponseError(response, serviceUrl))));
    }
    /**
     * @template T
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} field
     * @param {?=} options
     * @return {?}
     */
    getUniqueValues(serviceUrl, layer, field, options) {
        /** @type {?} */
        const fieldName = toFieldName(field);
        /** @type {?} */
        const queryOptions = getMapQueryOptions({
            outFields: fieldName,
            returnDistinctValues: true,
            returnGeometry: false,
        }, options);
        return this.query(serviceUrl, toLayerId(layer), queryOptions)
            .pipe(map((/**
         * @param {?} collection
         * @return {?}
         */
        collection => {
            return collection.features.map((/**
             * @param {?} f
             * @return {?}
             */
            f => f.properties[fieldName]));
        })));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} whereClause
     * @param {?=} options
     * @return {?}
     */
    getQueryCount(serviceUrl, layer, whereClause, options) {
        /** @type {?} */
        const queryOptions = getMapQueryOptions({
            returnCountOnly: true,
            returnGeometry: false,
            where: whereClause,
        }, options);
        return this.query(serviceUrl, toLayerId(layer), queryOptions)
            .pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        (result) => {
            return (result || { count: 0 }).count;
        })));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} eventId
     * @param {?=} options
     * @return {?}
     */
    getEvent(serviceUrl, layer, eventId, options) {
        tryStripGdbVersion(layer, options);
        throw new Error('Not implemented yet');
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} routeId
     * @param {?} fromMeasure
     * @param {?} toMeasure
     * @param {?=} viewDate
     * @param {?=} options
     * @return {?}
     */
    queryEvents(serviceUrl, layer, routeId, fromMeasure, toMeasure, viewDate, options) {
        tryStripGdbVersion(layer, options);
        /** @type {?} */
        const where = this.getWhereBuilder()
            .withEventLayer(layer)
            .withRouteId(routeId)
            .withViewDate(viewDate)
            .betweenMeasures(fromMeasure, toMeasure)
            .toWhereClause();
        /** @type {?} */
        const queryOptions = getMapQueryOptions({ where, returnGeometry: false }, options);
        return this
            .query(serviceUrl, layer.id, queryOptions)
            .pipe(map((/**
         * @param {?} featureCollection
         * @return {?}
         */
        featureCollection => new EventFeatureCollection(featureCollection, layer))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} searchText
     * @param {?=} options
     * @return {?}
     */
    searchEventsByText(serviceUrl, layer, searchText, options) {
        return this.searchByText(serviceUrl, layer.id, searchText, options)
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        response => this.handleEsriResponseError(response, serviceUrl))), map((/**
         * @param {?} featureCollection
         * @return {?}
         */
        featureCollection => new EventFeatureCollection(featureCollection, layer))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} routeId
     * @param {?} layer
     * @param {?=} viewDate
     * @param {?=} options
     * @return {?}
     */
    getRoute(serviceUrl, routeId, layer, viewDate, options) {
        tryStripGdbVersion(layer, options);
        /** @type {?} */
        const where = this.getWhereBuilder()
            .withNetworkLayer(layer)
            .where(layer.compositeRouteIdFieldName, CriteriaOperator.Equals, routeId)
            .withViewDate(viewDate)
            .toWhereClause();
        /** @type {?} */
        const queryOptions = getMapQueryOptions({
            where
        }, options);
        return this
            .query(serviceUrl, layer.id, queryOptions)
            .pipe(map((/**
         * @param {?} x
         * @return {?}
         */
        x => {
            return x && x.features && x.features.length
                ? new NetworkFeature(x.features[0], layer)
                : null;
        })));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} whereClause
     * @param {?=} options
     * @return {?}
     */
    queryRoutes(serviceUrl, layer, whereClause, options) {
        /** @type {?} */
        const queryOptions = getMapQueryOptions({
            where: whereClause
        }, options);
        return this.query(serviceUrl, layer.id, queryOptions)
            .pipe(map((/**
         * @param {?} featureCollection
         * @return {?}
         */
        featureCollection => new NetworkFeatureCollection(featureCollection, layer, options.outSR))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layer
     * @param {?} searchText
     * @param {?=} options
     * @return {?}
     */
    searchRoutesByText(serviceUrl, layer, searchText, options) {
        return this.searchByText(serviceUrl, layer.id, searchText, options)
            .pipe(map((/**
         * @param {?} featureCollection
         * @return {?}
         */
        featureCollection => new NetworkFeatureCollection(featureCollection, layer))));
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layerId
     * @param {?} searchText
     * @param {?=} options
     * @return {?}
     */
    searchByText(serviceUrl, layerId, searchText, options) {
        /** @type {?} */
        const queryOptions = getMapQueryOptions({
            text: searchText
        }, options);
        // The where clause must be deleted because if a where clause is specified it will override the search text.
        delete queryOptions.where;
        return this.query(serviceUrl, layerId, queryOptions);
    }
    /**
     * @param {?} serviceUrl
     * @param {?} layerId
     * @param {?} options
     * @return {?}
     */
    query(serviceUrl, layerId, options) {
        /** @type {?} */
        const url = joinAndFomatWithLayer(layerId, options, serviceUrl, MAP_LAYER_QUERY_SERVICE_ENDPOINT);
        /** @type {?} */
        const httpOption = getEsriMapServiceHttOptions();
        /** @type {?} */
        const usePostMethod = this.shouldUsePostMethod(options.where);
        if (!usePostMethod) {
            httpOption.params = toHttpQueryParams(options, httpOption.params);
        }
        /** @type {?} */
        const source = usePostMethod
            ? this.http.post(url, options, httpOption)
            : this.http.get(url, httpOption);
        return source.pipe(map((/**
         * @param {?} response
         * @return {?}
         */
        (response) => {
            this.handleEsriResponseError(response, url);
            return (/** @type {?} */ (response));
        })));
    }
}
EsriMapServerService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
EsriMapServerService.ctorParameters = () => [
    { type: HttpClient },
    { type: EsriConfig },
    { type: DataSourceConfig },
    { type: Logger }
];
/** @nocollapse */ EsriMapServerService.ngInjectableDef = i0.defineInjectable({ factory: function EsriMapServerService_Factory() { return new EsriMapServerService(i0.inject(i1.HttpClient), i0.inject(i2.EsriConfig), i0.inject(i3.DataSourceConfig), i0.inject(i4.Logger)); }, token: EsriMapServerService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNyaS1tYXAtc2VydmVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9lc3JpL2VzcmktbWFwLXNlcnZlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFJbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRXhELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUtqRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNoRixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUd0RixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUdoRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSwyQkFBMkIsRUFBcUIsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUtwSCxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDckUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFLckUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzNELE9BQU8sRUFDTCwyQkFBMkIsRUFDM0IsMkJBQTJCLEVBQzNCLGdDQUFnQyxFQUNoQyx3QkFBd0IsRUFDeEIsK0JBQStCLEVBQy9CLHVCQUF1QixFQUN2QiwwQkFBMEIsRUFDM0IsTUFBTSxrQkFBa0IsQ0FBQztBQUUxQixPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFB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O2NBQ2pGLEdBQUcsR0FBRyxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxnQ0FBZ0MsQ0FBQzs7Y0FDM0YsVUFBVSxHQUFHLDJCQUEyQixFQUFFOztjQUMxQyxhQUFhLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFFN0QsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsQixVQUFVLENBQUMsTUFBTSxHQUFHLGlCQUFpQixDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkU7O2NBRUssTUFBTSxHQUFHLGFBQWE7WUFDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFvQixHQUFHLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQztZQUM3RCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQW9CLEdBQUcsRUFBRSxVQUFVLENBQUM7UUFFckQsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUNoQixHQUFHOzs7O1FBQUMsQ0FBQyxRQUF5RCxFQUFFLEVBQUU7WUFDaEUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUM1QyxPQUFPLG1CQUFBLFFBQVEsRUFBcUIsQ0FBQztRQUN2QyxDQUFDLEVBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQzs7O1lBclZGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQTNEUSxVQUFVO1lBcUJWLFVBQVU7WUFPVixnQkFBZ0I7WUFyQmhCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBbmd1bGFyLlxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuLy8gM3JkIFBhcnR5LlxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8vIFRTUy5cbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5cbmltcG9ydCB7IE5ldHdvcmtGZWF0dXJlIH0gZnJvbSAnLi4vbHJzL25ldHdvcmtzL25ldHdvcmstZmVhdHVyZSc7XG5pbXBvcnQgeyBOZXR3b3JrTGF5ZXIgfSBmcm9tICcuLi9scnMvbmV0d29ya3MvbmV0d29yay1sYXllcic7XG5pbXBvcnQgeyBFdmVudExheWVyIH0gZnJvbSAnLi4vbHJzL2V2ZW50cy9ldmVudC1sYXllcic7XG5pbXBvcnQgeyBMcnNNZXRhZGF0YSB9IGZyb20gJy4uL2xycy9scnMtbWV0YWRhdGEnO1xuaW1wb3J0IHsgRXZlbnRGZWF0dXJlIH0gZnJvbSAnLi4vbHJzL2V2ZW50cy9ldmVudC1mZWF0dXJlJztcbmltcG9ydCB7IEV2ZW50RmVhdHVyZUNvbGxlY3Rpb24gfSBmcm9tICcuLi9scnMvZXZlbnRzL2V2ZW50LWZlYXR1cmUtY29sbGVjdGlvbic7XG5pbXBvcnQgeyBOZXR3b3JrRmVhdHVyZUNvbGxlY3Rpb24gfSBmcm9tICcuLi9scnMvbmV0d29ya3MvbmV0d29yay1mZWF0dXJlLWNvbGxlY3Rpb24nO1xuXG5pbXBvcnQgeyBNYXBTZXJ2ZXJNZXRhZGF0YSB9IGZyb20gJy4uL21hcHMvbWFwLXNlcnZlci1tZXRhZGF0YSc7XG5pbXBvcnQgeyBDcml0ZXJpYU9wZXJhdG9yIH0gZnJvbSAnLi4vbWFwcy93aGVyZS1jbGF1c2UtYnVpbGRlcic7XG5cbmltcG9ydCB7IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zIH0gZnJvbSAnLi9xdWVyeS9lc2ktbWFwLXNlcnZpY2UtcXVlcnktb3B0aW9ucyc7XG5pbXBvcnQgeyBFc3JpQ29uZmlnIH0gZnJvbSAnLi9lc3JpLWNvbmZpZyc7XG5pbXBvcnQgeyBnZXRFc3JpTWFwU2VydmljZUh0dE9wdGlvbnMsIEFuZ3VsYXJIdHRwT3B0aW9uLCBhZGRQYXJhbXNUb0h0dHBPcHRpb25zIH0gZnJvbSAnLi9lc3JpLW1hcC1zZXJ2aWNlLXJlcXVlc3QnO1xuaW1wb3J0IHsgRXNyaU1hcFNlcnZpY2VFcnJvclJlc3BvbnNlIH0gZnJvbSAnLi9lc3JpLW1hcC1zZXJ2ZXItZXJyb3ItcmVzcG9uc2UnO1xuaW1wb3J0IHsgRmVhdHVyZUNvbGxlY3Rpb24gfSBmcm9tICdnZW9qc29uJztcblxuaW1wb3J0IHsgTWFwTGF5ZXIgfSBmcm9tICcuLi9tYXBzL21hcC1sYXllcic7XG5pbXBvcnQgeyBMYXllckZpZWxkLCB0b0ZpZWxkTmFtZSB9IGZyb20gJy4uL21hcHMvZmllbGRzL2xheWVyLWZpZWxkJztcbmltcG9ydCB7IERhdGFTb3VyY2VDb25maWcgfSBmcm9tICcuLi9kYXRhLXNvdXJjZS9kYXRhLXNvdXJjZS1jb25maWcnO1xuaW1wb3J0IHsgR2VvZGF0YmFzZVZlcnNpb24gfSBmcm9tICcuLi9tYXBzL2dlb2RhdGFiYXNlLXZlcnNpb24nO1xuaW1wb3J0IHsgTHJzSW5mbyB9IGZyb20gJy4uL2xycy9scnMtaW5mbyc7XG5pbXBvcnQgeyBFc3JpQXBwbHlFZGl0c1Jlc3BvbnNlIH0gZnJvbSAnLi9scnMtc2VydmVyL2VzcmktYXBwbHktZWRpdHMtcmVzcG9uc2UnO1xuaW1wb3J0IHsgRXNyaUV2ZW50RWRpdHMgfSBmcm9tICcuL2xycy1zZXJ2ZXIvZXNyaS1ldmVudC1lZGl0cyc7XG5pbXBvcnQgeyB0b0Zvcm1EYXRhIH0gZnJvbSAnLi4vaHR0cC90by1mb3JtLWRhdGEuZnVuY3Rpb24nO1xuaW1wb3J0IHtcbiAgTUFQX0xBWUVSU19TRVJWSUNFX0VORFBPSU5ULFxuICBMUlNfTEFZRVJTX1NFUlZJQ0VfRU5EUE9JTlQsXG4gIE1BUF9MQVlFUl9RVUVSWV9TRVJWSUNFX0VORFBPSU5ULFxuICBMUlNfU0VSVkVSX01FVEFfRU5EUE9JTlQsXG4gIExSU19TRVJWRVJfQVBQTFlfRURJVFNfRU5EUE9JTlQsXG4gIExSU19HRU9NRVRSWV9UT19NRUFTVVJFLFxuICBNQVBfTEFZRVJfU0VSVklDRV9FTkRQT0lOVFxufSBmcm9tICcuL2VzcmkuY29uc3RhbnRzJztcbmltcG9ydCB7IEVzcmlNYXBTZXJ2aWNlR2VvbWV0cnlUb01lYXN1cmVPcHRpb25zIH0gZnJvbSAnLi9nZW9tZXRyeS10by1tZWFzdXJlL2VzcmktZ2VvbWV0cnktdG8tbWVhc3VyZS1vcHRpb25zJztcbmltcG9ydCB7IGdldEdlb21ldHJ5VG9NZWFzdXJlT3B0aW9ucyB9IGZyb20gJy4vZ2VvbWV0cnktdG8tbWVhc3VyZS9nZXQtZ2VvbWV0cnktdG8tbWVhc3VyZS1vcHRpb25zLmZ1bmN0aW9uJztcbmltcG9ydCB7IEVzcmlHZW9tZXRyeVRvTWVhc3VyZVJlc3VsdCB9IGZyb20gJy4vZ2VvbWV0cnktdG8tbWVhc3VyZS9lc3JpLWdlb21ldHJ5LXRvLW1lYXN1cmUtcmVzdWx0JztcbmltcG9ydCB7IGdldE1hcFF1ZXJ5T3B0aW9ucyB9IGZyb20gJy4vcXVlcnkvZ2V0LW1hcC1xdWVyeS1vcHRpb25zLmZ1bmN0aW9uJztcbmltcG9ydCB7IHRvSHR0cFF1ZXJ5UGFyYW1zIH0gZnJvbSAnLi9xdWVyeS90by1odHRwLXF1ZXJ5LXBhcmFtcy5mdW5jdGlvbic7XG5pbXBvcnQgeyB0cnlTdHJpcEdkYlZlcnNpb24gfSBmcm9tICcuL3RyeS1zdHJpcC1nZGItdmVyc2lvbi5mdW5jdGlvbic7XG5pbXBvcnQgeyB0b0xheWVySWQgfSBmcm9tICcuLi9tYXBzL3RvLWxheWVyLWlkLmZ1bmN0aW9uJztcbmltcG9ydCB7IEJhc2VFc3JpU2VydmljZSB9IGZyb20gJy4vYmFzZS1lc3JpLnNlcnZpY2UnO1xuaW1wb3J0IHsgam9pbkFuZEZvbWF0V2l0aExheWVyIH0gZnJvbSAnLi9qb2luLWFuZC1mb3JtYXQtd2l0aC1sYXllci5mdW5jdGlvbic7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAnLi4vY29yZS91cmwvam9pbi5mdW5jdGlvbic7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9jb3JlL2Zvcm1hdHRpbmcvZm9ybWF0LmZ1bmN0aW9uJztcbmltcG9ydCB7IEZlYXR1cmVDbGFzc0xheWVyIH0gZnJvbSAnLi4vbWFwcy9mZWF0dXJlLWNsYXNzLWxheWVyJztcblxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBFc3JpTWFwU2VydmVyU2VydmljZSBleHRlbmRzIEJhc2VFc3JpU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKGh0dHA6IEh0dHBDbGllbnQsIGNvbmZpZzogRXNyaUNvbmZpZywgZGF0YUNvbmZpZzogRGF0YVNvdXJjZUNvbmZpZywgbG9nOiBMb2dnZXIpIHtcbiAgICBzdXBlcihodHRwLCBjb25maWcsIGRhdGFDb25maWcsIGxvZyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBtYXAgc2VydmljZSBtZXRhZGF0YSBmb3IgYWxsIGxheWVycy5cbiAgICovXG4gIGdldE1hcExheWVycyhzZXJ2aWNlVXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE1hcFNlcnZlck1ldGFkYXRhPiB7XG4gICAgY29uc3QgdXJsID0gam9pbihzZXJ2aWNlVXJsLCBNQVBfTEFZRVJTX1NFUlZJQ0VfRU5EUE9JTlQpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8TWFwU2VydmVyTWV0YWRhdGE+KHVybCwgZ2V0RXNyaU1hcFNlcnZpY2VIdHRPcHRpb25zKCkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKChyZXNwb25zZTogYW55KSA9PiB0aGlzLmhhbmRsZUVzcmlSZXNwb25zZUVycm9yKHJlc3BvbnNlLCBzZXJ2aWNlVXJsKSlcbiAgICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBtYXAgc2VydmljZSBtZXRhZGF0YSBmb3IgYSBnaXZlbiBsYXllciAoYnkgaXQncyBJRCkuXG4gICAqL1xuICBnZXRNYXBMYXllcihzZXJ2aWNlVXJsOiBzdHJpbmcsIGxheWVySWQ6IG51bWJlcik6IE9ic2VydmFibGU8RmVhdHVyZUNsYXNzTGF5ZXI+IHtcbiAgICBjb25zdCB1cmwgPSBqb2luQW5kRm9tYXRXaXRoTGF5ZXIobGF5ZXJJZCwge30sIHNlcnZpY2VVcmwsIE1BUF9MQVlFUl9TRVJWSUNFX0VORFBPSU5UKTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0PEZlYXR1cmVDbGFzc0xheWVyPih1cmwsIGdldEVzcmlNYXBTZXJ2aWNlSHR0T3B0aW9ucygpKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgocmVzcG9uc2U6IGFueSkgPT4gdGhpcy5oYW5kbGVFc3JpUmVzcG9uc2VFcnJvcihyZXNwb25zZSwgc2VydmljZVVybCkpLFxuICAgICAgICBtYXAobWFwTGF5ZXJNZXRhZGF0YSA9PiBuZXcgRmVhdHVyZUNsYXNzTGF5ZXIobWFwTGF5ZXJNZXRhZGF0YSkpXG4gICAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyB0aGUgTFJTIExheWVycyBNZXRhZGF0YSBpbmZvcm1hdGlvbiBmcm9tIHRoZSBtYXAgc2VydmljZVxuICAgKi9cbiAgZ2V0THJzTGF5ZXJzKHNlcnZpY2VVcmw6IHN0cmluZyk6IE9ic2VydmFibGU8THJzTWV0YWRhdGE+IHtcbiAgICBjb25zdCB1cmwgPSBqb2luKHNlcnZpY2VVcmwsIExSU19MQVlFUlNfU0VSVklDRV9FTkRQT0lOVCk7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmdldDxMcnNNZXRhZGF0YT4odXJsLCBnZXRFc3JpTWFwU2VydmljZUh0dE9wdGlvbnMoKSlcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKHJlc3BvbnNlOiBhbnkpID0+IHRoaXMuaGFuZGxlRXNyaVJlc3BvbnNlRXJyb3IocmVzcG9uc2UsIHNlcnZpY2VVcmwpKVxuICAgICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGhlIExSUyBTZXJ2ZXIgTWV0YWRhdGEgaW5mb3JtYXRpb24gZnJvbSB0aGUgbWFwIHNlcnZpY2VcbiAgICovXG4gIGdldExyc1NlcnZlcihzZXJ2aWNlVXJsOiBzdHJpbmcpOiBPYnNlcnZhYmxlPExyc01ldGFkYXRhPiB7XG4gICAgY29uc3QgdXJsID0gam9pbihzZXJ2aWNlVXJsLCBMUlNfU0VSVkVSX01FVEFfRU5EUE9JTlQpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8THJzTWV0YWRhdGE+KHVybCwgZ2V0RXNyaU1hcFNlcnZpY2VIdHRPcHRpb25zKCkpXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKChyZXNwb25zZTogYW55KSA9PiB0aGlzLmhhbmRsZUVzcmlSZXNwb25zZUVycm9yKHJlc3BvbnNlLCBzZXJ2aWNlVXJsKSlcbiAgICAgICk7XG4gIH1cblxuICBnZXRWZXJzaW9ucyhzZXJ2aWNlVXJsOiBzdHJpbmcsIGxyc0lkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxHZW9kYXRiYXNlVmVyc2lvbltdPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0THJzU2VydmVyKHNlcnZpY2VVcmwpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChtZXRhZGF0YTogTHJzTWV0YWRhdGEpID0+IHtcbiAgICAgICAgICBsZXQgbHJzOiBMcnNJbmZvID0gbWV0YWRhdGEgPyBtZXRhZGF0YS5scnNbMF0gOiBudWxsO1xuICAgICAgICAgIGlmICghbHJzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIExSUyBpbmZvcyBmb3VuZGApO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChscnNJZCkge1xuICAgICAgICAgICAgbHJzID0gbWV0YWRhdGEubHJzLmZpbmQobHJzSW5mbyA9PiBscnNJbmZvLmlkID09PSBscnNJZCk7XG4gICAgICAgICAgICBpZiAoIWxycykge1xuICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIExSUyBpbmZvIGZvdW5kIHdpdGggSUQgJyR7bHJzSWR9J2ApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBscnMudmVyc2lvbnM7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgc2luZ2xlR2VvbWV0cnlUb01lYXN1cmUoXG4gICAgc2VydmljZVVybDogc3RyaW5nLFxuICAgIG5ldHdvcmtMYXllcklkOiBudW1iZXIsXG4gICAgcm91dGVJZDogc3RyaW5nLFxuICAgIHg6IG51bWJlcixcbiAgICB5OiBudW1iZXIsXG4gICAgdmlld0RhdGU/OiBEYXRlLFxuICAgIGluU3BhdGlhbFJlZmVyZW5jZUlkID0gNDMyNixcbiAgICBvdXRwdXRTcGF0aWFsUmVmZXJlbmNlSWQgPSA0MzI2XG4gICk6IE9ic2VydmFibGU8eyBtOiBudW1iZXIsIHg6IG51bWJlciwgeTogbnVtYmVyLCB6PzogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBsb2NhdGlvbnMgPSBbXG4gICAgICB7IHJvdXRlSWQsIGdlb21ldHJ5OiB7IHgsIHkgfSB9XG4gICAgXTtcblxuICAgIHJldHVybiB0aGlzLmdlb21ldHJ5VG9NZWFzdXJlKHNlcnZpY2VVcmwsIG5ldHdvcmtMYXllcklkLCB7XG4gICAgICBsb2NhdGlvbnMsXG4gICAgICB0ZW1wb3JhbFZpZXdEYXRlOiB2aWV3RGF0ZSxcbiAgICAgIGluU1I6IGluU3BhdGlhbFJlZmVyZW5jZUlkLFxuICAgICAgb3V0U1I6IG91dHB1dFNwYXRpYWxSZWZlcmVuY2VJZCxcbiAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChyZXN1bHQgPT4ge1xuICAgICAgICAgIGNvbnN0IG1hdGNoID0geyBtOiBudWxsLCB4OiBudWxsLCB5OiBudWxsLCB6OiBudWxsIH07XG4gICAgICAgICAgaWYgKHJlc3VsdC5sb2NhdGlvbnMubGVuZ3RoICYmIHJlc3VsdC5sb2NhdGlvbnNbMF0ucmVzdWx0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgIGNvbnN0IFtmb3VuZF0gPSByZXN1bHQubG9jYXRpb25zWzBdLnJlc3VsdHM7XG4gICAgICAgICAgICBtYXRjaC5tID0gZm91bmQubWVhc3VyZTtcbiAgICAgICAgICAgIG1hdGNoLnggPSBmb3VuZC5nZW9tZXRyeS54O1xuICAgICAgICAgICAgbWF0Y2gueSA9IGZvdW5kLmdlb21ldHJ5Lnk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIG1hdGNoO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIGdlb21ldHJ5VG9NZWFzdXJlKFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBuZXR3b3JrTGF5ZXJJZDogbnVtYmVyLFxuICAgIG9wdGlvbnM6IEVzcmlNYXBTZXJ2aWNlR2VvbWV0cnlUb01lYXN1cmVPcHRpb25zXG4gICk6IE9ic2VydmFibGU8RXNyaUdlb21ldHJ5VG9NZWFzdXJlUmVzdWx0PiB7XG4gICAgY29uc3QgZW5kcG9pbnQgPSBmb3JtYXQoTFJTX0dFT01FVFJZX1RPX01FQVNVUkUsIHsgbGF5ZXJJZDogbmV0d29ya0xheWVySWQgfSk7XG4gICAgY29uc3QgdXJsID0gam9pbihzZXJ2aWNlVXJsLCBlbmRwb2ludCk7XG4gICAgY29uc3QgaHR0cE9wdGlvbjogQW5ndWxhckh0dHBPcHRpb24gPSBnZXRFc3JpTWFwU2VydmljZUh0dE9wdGlvbnMoKTtcbiAgICBjb25zdCBzZXJ2aWNlT3B0aW9ucyA9IGdldEdlb21ldHJ5VG9NZWFzdXJlT3B0aW9ucyhvcHRpb25zKTtcbiAgICBjb25zdCB1c2VHZXRNZXRob2QgPSAhdGhpcy5zaG91bGRVc2VQb3N0TWV0aG9kKHNlcnZpY2VPcHRpb25zKTtcblxuICAgIGlmICh1c2VHZXRNZXRob2QpIHtcbiAgICAgIGFkZFBhcmFtc1RvSHR0cE9wdGlvbnMoaHR0cE9wdGlvbiwgc2VydmljZU9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiAoXG4gICAgICB1c2VHZXRNZXRob2RcbiAgICAgICAgPyB0aGlzLmh0dHAuZ2V0PEVzcmlHZW9tZXRyeVRvTWVhc3VyZVJlc3VsdD4odXJsLCBodHRwT3B0aW9uKVxuICAgICAgICA6IHRoaXMuaHR0cC5wb3N0PEVzcmlHZW9tZXRyeVRvTWVhc3VyZVJlc3VsdD4odXJsLCB0b0Zvcm1EYXRhKHNlcnZpY2VPcHRpb25zKSwgaHR0cE9wdGlvbilcbiAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgdGFwKHJlc3BvbnNlID0+IHRoaXMuaGFuZGxlRXNyaVJlc3BvbnNlRXJyb3IocmVzcG9uc2UsIHNlcnZpY2VVcmwpKSxcbiAgICAgICk7XG4gIH1cblxuICBhcHBseUVkaXRzKHNlcnZpY2VVcmw6IHN0cmluZywgZWRpdHM6IEVzcmlFdmVudEVkaXRzW10sIGdkYlZlcnNpb24/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVzcmlBcHBseUVkaXRzUmVzcG9uc2U+IHtcbiAgICBjb25zdCB1cmwgPSBqb2luKHNlcnZpY2VVcmwsIExSU19TRVJWRVJfQVBQTFlfRURJVFNfRU5EUE9JTlQpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSBnZXRFc3JpTWFwU2VydmljZUh0dE9wdGlvbnMoKTtcbiAgICBjb25zdCB1c2VHZXRNZXRob2QgPSAhdGhpcy5zaG91bGRVc2VQb3N0TWV0aG9kKGVkaXRzKTtcblxuICAgIGlmICh1c2VHZXRNZXRob2QpIHtcbiAgICAgIG9wdGlvbnMucGFyYW1zID0gb3B0aW9ucy5wYXJhbXNcbiAgICAgICAgLnNldCgnZWRpdHMnLCBKU09OLnN0cmluZ2lmeShlZGl0cykpXG4gICAgICAgIC5zZXQoJ2dkYlZlcnNpb24nLCBnZGJWZXJzaW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gKFxuICAgICAgdXNlR2V0TWV0aG9kXG4gICAgICAgID8gdGhpcy5odHRwLmdldDxFc3JpQXBwbHlFZGl0c1Jlc3BvbnNlPih1cmwsIG9wdGlvbnMpXG4gICAgICAgIDogdGhpcy5odHRwLnBvc3Q8RXNyaUFwcGx5RWRpdHNSZXNwb25zZT4odXJsLCB0b0Zvcm1EYXRhKHsgZWRpdHMsIGdkYlZlcnNpb24gfSksIG9wdGlvbnMpXG4gICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcChyZXNwb25zZSA9PiB0aGlzLmhhbmRsZUVzcmlSZXNwb25zZUVycm9yKHJlc3BvbnNlLCBzZXJ2aWNlVXJsKSksXG4gICAgICApO1xuICB9XG5cbiAgZ2V0VW5pcXVlVmFsdWVzPFQ+KFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBsYXllcjogTWFwTGF5ZXIgfCBudW1iZXIsXG4gICAgZmllbGQ6IHN0cmluZyB8IExheWVyRmllbGQsXG4gICAgb3B0aW9ucz86IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zXG4gICk6IE9ic2VydmFibGU8VFtdPiB7XG4gICAgY29uc3QgZmllbGROYW1lID0gdG9GaWVsZE5hbWUoZmllbGQpO1xuICAgIGNvbnN0IHF1ZXJ5T3B0aW9uczogRXNyaU1hcFNlcnZpY2VRdWVyeU9wdGlvbnMgPSBnZXRNYXBRdWVyeU9wdGlvbnMoe1xuICAgICAgb3V0RmllbGRzOiBmaWVsZE5hbWUsXG4gICAgICByZXR1cm5EaXN0aW5jdFZhbHVlczogdHJ1ZSxcbiAgICAgIHJldHVybkdlb21ldHJ5OiBmYWxzZSxcbiAgICB9LCBvcHRpb25zKTtcblxuICAgIHJldHVybiB0aGlzLnF1ZXJ5KHNlcnZpY2VVcmwsIHRvTGF5ZXJJZChsYXllciksIHF1ZXJ5T3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoY29sbGVjdGlvbiA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZmVhdHVyZXMubWFwKGYgPT4gZi5wcm9wZXJ0aWVzW2ZpZWxkTmFtZV0pO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIGdldFF1ZXJ5Q291bnQoXG4gICAgc2VydmljZVVybDogc3RyaW5nLFxuICAgIGxheWVyOiBNYXBMYXllciB8IG51bWJlcixcbiAgICB3aGVyZUNsYXVzZTogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPG51bWJlcj4ge1xuICAgIGNvbnN0IHF1ZXJ5T3B0aW9uczogRXNyaU1hcFNlcnZpY2VRdWVyeU9wdGlvbnMgPSBnZXRNYXBRdWVyeU9wdGlvbnMoe1xuICAgICAgcmV0dXJuQ291bnRPbmx5OiB0cnVlLFxuICAgICAgcmV0dXJuR2VvbWV0cnk6IGZhbHNlLFxuICAgICAgd2hlcmU6IHdoZXJlQ2xhdXNlLFxuICAgIH0sIG9wdGlvbnMpO1xuXG4gICAgcmV0dXJuIHRoaXMucXVlcnkoc2VydmljZVVybCwgdG9MYXllcklkKGxheWVyKSwgcXVlcnlPcHRpb25zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgocmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICByZXR1cm4gKHJlc3VsdCB8fCB7IGNvdW50OiAwIH0pLmNvdW50O1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIGdldEV2ZW50KFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBsYXllcjogRXZlbnRMYXllcixcbiAgICBldmVudElkOiBzdHJpbmcgfCBudW1iZXIsXG4gICAgb3B0aW9ucz86IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zXG4gICk6IE9ic2VydmFibGU8RXZlbnRGZWF0dXJlPiB7XG4gICAgdHJ5U3RyaXBHZGJWZXJzaW9uKGxheWVyLCBvcHRpb25zKTtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCB5ZXQnKTtcbiAgfVxuXG4gIHF1ZXJ5RXZlbnRzKFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBsYXllcjogRXZlbnRMYXllcixcbiAgICByb3V0ZUlkOiBzdHJpbmcgfCBudW1iZXIsXG4gICAgZnJvbU1lYXN1cmU6IG51bWJlcixcbiAgICB0b01lYXN1cmU6IG51bWJlcixcbiAgICB2aWV3RGF0ZT86IERhdGUsXG4gICAgb3B0aW9ucz86IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zXG4gICk6IE9ic2VydmFibGU8RXZlbnRGZWF0dXJlQ29sbGVjdGlvbj4ge1xuICAgIHRyeVN0cmlwR2RiVmVyc2lvbihsYXllciwgb3B0aW9ucyk7XG4gICAgY29uc3Qgd2hlcmUgPSB0aGlzLmdldFdoZXJlQnVpbGRlcigpXG4gICAgICAud2l0aEV2ZW50TGF5ZXIobGF5ZXIpXG4gICAgICAud2l0aFJvdXRlSWQocm91dGVJZClcbiAgICAgIC53aXRoVmlld0RhdGUodmlld0RhdGUpXG4gICAgICAuYmV0d2Vlbk1lYXN1cmVzKGZyb21NZWFzdXJlLCB0b01lYXN1cmUpXG4gICAgICAudG9XaGVyZUNsYXVzZSgpO1xuXG4gICAgY29uc3QgcXVlcnlPcHRpb25zOiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9ucyA9IGdldE1hcFF1ZXJ5T3B0aW9ucyh7IHdoZXJlLCByZXR1cm5HZW9tZXRyeTogZmFsc2UgfSwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gdGhpc1xuICAgICAgLnF1ZXJ5KHNlcnZpY2VVcmwsIGxheWVyLmlkLCBxdWVyeU9wdGlvbnMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZlYXR1cmVDb2xsZWN0aW9uID0+IG5ldyBFdmVudEZlYXR1cmVDb2xsZWN0aW9uKGZlYXR1cmVDb2xsZWN0aW9uLCBsYXllcikpXG4gICAgICApO1xuICB9XG5cbiAgc2VhcmNoRXZlbnRzQnlUZXh0KFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBsYXllcjogRXZlbnRMYXllcixcbiAgICBzZWFyY2hUZXh0OiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zXG4gICk6IE9ic2VydmFibGU8RXZlbnRGZWF0dXJlQ29sbGVjdGlvbj4ge1xuICAgIHJldHVybiB0aGlzLnNlYXJjaEJ5VGV4dChzZXJ2aWNlVXJsLCBsYXllci5pZCwgc2VhcmNoVGV4dCwgb3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAocmVzcG9uc2UgPT4gdGhpcy5oYW5kbGVFc3JpUmVzcG9uc2VFcnJvcihyZXNwb25zZSwgc2VydmljZVVybCkpLFxuICAgICAgICBtYXAoZmVhdHVyZUNvbGxlY3Rpb24gPT4gbmV3IEV2ZW50RmVhdHVyZUNvbGxlY3Rpb24oZmVhdHVyZUNvbGxlY3Rpb24sIGxheWVyKSlcbiAgICAgICk7XG4gIH1cblxuICBnZXRSb3V0ZShcbiAgICBzZXJ2aWNlVXJsOiBzdHJpbmcsXG4gICAgcm91dGVJZDogc3RyaW5nIHwgbnVtYmVyLFxuICAgIGxheWVyOiBOZXR3b3JrTGF5ZXIsXG4gICAgdmlld0RhdGU/OiBEYXRlLFxuICAgIG9wdGlvbnM/OiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPE5ldHdvcmtGZWF0dXJlPiB7XG4gICAgdHJ5U3RyaXBHZGJWZXJzaW9uKGxheWVyLCBvcHRpb25zKTtcbiAgICBjb25zdCB3aGVyZSA9IHRoaXMuZ2V0V2hlcmVCdWlsZGVyKClcbiAgICAgIC53aXRoTmV0d29ya0xheWVyKGxheWVyKVxuICAgICAgLndoZXJlKGxheWVyLmNvbXBvc2l0ZVJvdXRlSWRGaWVsZE5hbWUsIENyaXRlcmlhT3BlcmF0b3IuRXF1YWxzLCByb3V0ZUlkKVxuICAgICAgLndpdGhWaWV3RGF0ZSh2aWV3RGF0ZSlcbiAgICAgIC50b1doZXJlQ2xhdXNlKCk7XG5cbiAgICBjb25zdCBxdWVyeU9wdGlvbnM6IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zID0gZ2V0TWFwUXVlcnlPcHRpb25zKHtcbiAgICAgIHdoZXJlXG4gICAgfSwgb3B0aW9ucyk7XG5cbiAgICByZXR1cm4gdGhpc1xuICAgICAgLnF1ZXJ5KHNlcnZpY2VVcmwsIGxheWVyLmlkLCBxdWVyeU9wdGlvbnMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHggPT4ge1xuICAgICAgICAgIHJldHVybiB4ICYmIHguZmVhdHVyZXMgJiYgeC5mZWF0dXJlcy5sZW5ndGhcbiAgICAgICAgICAgID8gbmV3IE5ldHdvcmtGZWF0dXJlKHguZmVhdHVyZXNbMF0sIGxheWVyKVxuICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgfVxuXG4gIHF1ZXJ5Um91dGVzKFxuICAgIHNlcnZpY2VVcmw6IHN0cmluZyxcbiAgICBsYXllcjogTmV0d29ya0xheWVyLFxuICAgIHdoZXJlQ2xhdXNlOiBzdHJpbmcsXG4gICAgb3B0aW9ucz86IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zXG4gICk6IE9ic2VydmFibGU8TmV0d29ya0ZlYXR1cmVDb2xsZWN0aW9uPiB7XG4gICAgY29uc3QgcXVlcnlPcHRpb25zOiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9ucyA9IGdldE1hcFF1ZXJ5T3B0aW9ucyh7XG4gICAgICB3aGVyZTogd2hlcmVDbGF1c2VcbiAgICB9LCBvcHRpb25zKTtcblxuICAgIHJldHVybiB0aGlzLnF1ZXJ5KHNlcnZpY2VVcmwsIGxheWVyLmlkLCBxdWVyeU9wdGlvbnMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKGZlYXR1cmVDb2xsZWN0aW9uID0+IG5ldyBOZXR3b3JrRmVhdHVyZUNvbGxlY3Rpb24oZmVhdHVyZUNvbGxlY3Rpb24sIGxheWVyLCBvcHRpb25zLm91dFNSKSlcbiAgICAgICk7XG4gIH1cblxuICBzZWFyY2hSb3V0ZXNCeVRleHQoXG4gICAgc2VydmljZVVybDogc3RyaW5nLFxuICAgIGxheWVyOiBOZXR3b3JrTGF5ZXIsXG4gICAgc2VhcmNoVGV4dDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPE5ldHdvcmtGZWF0dXJlQ29sbGVjdGlvbj4ge1xuICAgIHJldHVybiB0aGlzLnNlYXJjaEJ5VGV4dChzZXJ2aWNlVXJsLCBsYXllci5pZCwgc2VhcmNoVGV4dCwgb3B0aW9ucylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoZmVhdHVyZUNvbGxlY3Rpb24gPT4gbmV3IE5ldHdvcmtGZWF0dXJlQ29sbGVjdGlvbihmZWF0dXJlQ29sbGVjdGlvbiwgbGF5ZXIpKVxuICAgICAgKTtcbiAgfVxuXG4gIHNlYXJjaEJ5VGV4dChcbiAgICBzZXJ2aWNlVXJsOiBzdHJpbmcsXG4gICAgbGF5ZXJJZDogbnVtYmVyIHwgTWFwTGF5ZXIsXG4gICAgc2VhcmNoVGV4dDogc3RyaW5nLFxuICAgIG9wdGlvbnM/OiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9uc1xuICApOiBPYnNlcnZhYmxlPEZlYXR1cmVDb2xsZWN0aW9uPiB7XG4gICAgY29uc3QgcXVlcnlPcHRpb25zOiBFc3JpTWFwU2VydmljZVF1ZXJ5T3B0aW9ucyA9IGdldE1hcFF1ZXJ5T3B0aW9ucyh7XG4gICAgICB0ZXh0OiBzZWFyY2hUZXh0XG4gICAgfSwgb3B0aW9ucyk7XG5cbiAgICAvLyBUaGUgd2hlcmUgY2xhdXNlIG11c3QgYmUgZGVsZXRlZCBiZWNhdXNlIGlmIGEgd2hlcmUgY2xhdXNlIGlzIHNwZWNpZmllZCBpdCB3aWxsIG92ZXJyaWRlIHRoZSBzZWFyY2ggdGV4dC5cbiAgICBkZWxldGUgcXVlcnlPcHRpb25zLndoZXJlO1xuXG4gICAgcmV0dXJuIHRoaXMucXVlcnkoc2VydmljZVVybCwgbGF5ZXJJZCwgcXVlcnlPcHRpb25zKTtcbiAgfVxuXG4gIHF1ZXJ5KHNlcnZpY2VVcmw6IHN0cmluZywgbGF5ZXJJZDogbnVtYmVyIHwgTWFwTGF5ZXIsIG9wdGlvbnM6IEVzcmlNYXBTZXJ2aWNlUXVlcnlPcHRpb25zKTogT2JzZXJ2YWJsZTxGZWF0dXJlQ29sbGVjdGlvbj4ge1xuICAgIGNvbnN0IHVybCA9IGpvaW5BbmRGb21hdFdpdGhMYXllcihsYXllcklkLCBvcHRpb25zLCBzZXJ2aWNlVXJsLCBNQVBfTEFZRVJfUVVFUllfU0VSVklDRV9FTkRQT0lOVCk7XG4gICAgY29uc3QgaHR0cE9wdGlvbiA9IGdldEVzcmlNYXBTZXJ2aWNlSHR0T3B0aW9ucygpO1xuICAgIGNvbnN0IHVzZVBvc3RNZXRob2QgPSB0aGlzLnNob3VsZFVzZVBvc3RNZXRob2Qob3B0aW9ucy53aGVyZSk7XG5cbiAgICBpZiAoIXVzZVBvc3RNZXRob2QpIHtcbiAgICAgIGh0dHBPcHRpb24ucGFyYW1zID0gdG9IdHRwUXVlcnlQYXJhbXMob3B0aW9ucywgaHR0cE9wdGlvbi5wYXJhbXMpO1xuICAgIH1cblxuICAgIGNvbnN0IHNvdXJjZSA9IHVzZVBvc3RNZXRob2RcbiAgICAgID8gdGhpcy5odHRwLnBvc3Q8RmVhdHVyZUNvbGxlY3Rpb24+KHVybCwgb3B0aW9ucywgaHR0cE9wdGlvbilcbiAgICAgIDogdGhpcy5odHRwLmdldDxGZWF0dXJlQ29sbGVjdGlvbj4odXJsLCBodHRwT3B0aW9uKTtcblxuICAgIHJldHVybiBzb3VyY2UucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2U6IEZlYXR1cmVDb2xsZWN0aW9uIHwgRXNyaU1hcFNlcnZpY2VFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHRoaXMuaGFuZGxlRXNyaVJlc3BvbnNlRXJyb3IocmVzcG9uc2UsIHVybCk7XG4gICAgICAgIHJldHVybiByZXNwb25zZSBhcyBGZWF0dXJlQ29sbGVjdGlvbjtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuIl19