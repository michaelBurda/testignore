/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { tap, map } from 'rxjs/operators';
// TSS.
import { getPortalUrl } from './get-portal-url.function';
import { getEsriMapServiceHttOptions, addParamsToHttpOptions } from '../esri-map-service-request';
import { EsriConfig } from '../esri-config';
import { DataSourceConfig } from '../../data-source/data-source-config';
import { BaseEsriService } from '../base-esri.service';
import { Logger } from '../../core/logging/logger.service';
import { toFormData } from '../../http/to-form-data.function';
import { toEsriPortalAccessToken } from './to-esri-portal-access-token.function';
import { toEsriServerToken } from '../to-esri-server-token.function';
import { PORTAL_GENERATE_TOKEN_ENDPOINT, PORTAL_OAUTH_TOKEN_ENDPOINT } from '../esri.constants';
import { removePortalAccessTokenFromHash } from './remove-portal-access-token-from-hash.function';
import { join } from '../../core/url/join.function';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../esri-config";
import * as i3 from "../../data-source/data-source-config";
import * as i4 from "../../core/logging/logger.service";
export class EsriPortalService extends BaseEsriService {
    /**
     * @param {?} http
     * @param {?} config
     * @param {?} dataConfig
     * @param {?} log
     */
    constructor(http, config, dataConfig, log) {
        super(http, config, dataConfig, log);
    }
    /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} code
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    getTokenByCode(portalUrl, clientId, code, bodyData, params) {
        /** @type {?} */
        const data = Object.assign({
            client_id: clientId,
            code,
            redirect_uri: removePortalAccessTokenFromHash(window.location.href),
            grant_type: 'authorization_code'
        }, bodyData);
        /** @type {?} */
        const formData = toFormData(data);
        return this.doPost(portalUrl, PORTAL_OAUTH_TOKEN_ENDPOINT, formData, params)
            .pipe(map((/**
         * @param {?} rawToken
         * @return {?}
         */
        rawToken => toEsriPortalAccessToken(rawToken, portalUrl))));
    }
    /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} refreshToken
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    refreshToken(portalUrl, clientId, refreshToken, bodyData, params) {
        /** @type {?} */
        const data = Object.assign({
            client_id: clientId,
            refresh_token: refreshToken,
            grant_type: 'refresh_token'
        }, bodyData);
        /** @type {?} */
        const formData = toFormData(data);
        return this.doPost(portalUrl, PORTAL_OAUTH_TOKEN_ENDPOINT, formData, params)
            .pipe(map((/**
         * @param {?} rawToken
         * @return {?}
         */
        rawToken => toEsriPortalAccessToken(rawToken, portalUrl))));
    }
    /**
     * @param {?} portalUrl
     * @param {?} portalAccessToken
     * @param {?} serverUrl
     * @param {?=} params
     * @return {?}
     */
    getServerToken(portalUrl, portalAccessToken, serverUrl, params) {
        /** @type {?} */
        const additionalParams = {
            request: 'getToken',
            serverUrl,
            token: portalAccessToken,
            referer: window.location.host
        };
        return this.doGet(portalUrl, PORTAL_GENERATE_TOKEN_ENDPOINT, additionalParams, params)
            .pipe(map((/**
         * @param {?} token
         * @return {?}
         */
        token => toEsriServerToken(token))));
    }
    /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} queryParams
     * @param {?=} params
     * @return {?}
     */
    doGet(portalUrl, endpoint, queryParams, params) {
        /** @type {?} */
        const basePortalUrl = getPortalUrl(portalUrl);
        /** @type {?} */
        const url = join(basePortalUrl, endpoint);
        /** @type {?} */
        const httpOption = getEsriMapServiceHttOptions(params);
        addParamsToHttpOptions(httpOption, queryParams);
        return this.http
            .get(url, httpOption)
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, url))));
    }
    /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} formData
     * @param {?=} params
     * @return {?}
     */
    doPost(portalUrl, endpoint, formData, params) {
        /** @type {?} */
        const basePortalUrl = getPortalUrl(portalUrl);
        /** @type {?} */
        const url = join(basePortalUrl, endpoint);
        /** @type {?} */
        const httpOption = getEsriMapServiceHttOptions(params);
        return this.http
            .post(url, formData, httpOption)
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        (response) => this.handleEsriResponseError(response, url))));
    }
}
EsriPortalService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
EsriPortalService.ctorParameters = () => [
    { type: HttpClient },
    { type: EsriConfig },
    { type: DataSourceConfig },
    { type: Logger }
];
/** @nocollapse */ EsriPortalService.ngInjectableDef = i0.defineInjectable({ factory: function EsriPortalService_Factory() { return new EsriPortalService(i0.inject(i1.HttpClient), i0.inject(i2.EsriConfig), i0.inject(i3.DataSourceConfig), i0.inject(i4.Logger)); }, token: EsriPortalService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNyaS1wb3J0YWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0c3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL2VzcmkvcG9ydGFsL2VzcmktcG9ydGFsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQWMsTUFBTSxzQkFBc0IsQ0FBQztBQUk5RCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOztBQUcxQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDekQsT0FBTyxFQUFFLDJCQUEyQixFQUFxQixzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXJILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM1QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUN4RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRTNELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUM5RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUNqRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNyRSxPQUFPLEVBQ0wsOEJBQThCLEVBQzlCLDJCQUEyQixFQUM1QixNQUFNLG1CQUFtQixDQUFDO0FBQzNCLE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBQ2xHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQzs7Ozs7O0FBTXBELE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlOzs7Ozs7O0lBQ3BELFlB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QUUsTUFBbUI7O2NBQ3hGLGFBQWEsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDOztjQUN2QyxHQUFHLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUM7O2NBQ25DLFVBQVUsR0FBc0IsMkJBQTJCLENBQUMsTUFBTSxDQUFDO1FBRXpFLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixJQUFJLENBQUksR0FBRyxFQUFFLFFBQVEsRUFBRSxVQUFVLENBQUM7YUFDbEMsSUFBSSxDQUNILEdBQUc7Ozs7UUFBQyxDQUFDLFFBQVcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBQyxDQUNsRSxDQUFDO0lBQ04sQ0FBQzs7O1lBaEZGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQTVCUSxVQUFVO1lBVVYsVUFBVTtZQUNWLGdCQUFnQjtZQUVoQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQW5ndWxhci5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbi8vIDNyZCBQYXJ0eS5cbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vLyBUU1MuXG5pbXBvcnQgeyBnZXRQb3J0YWxVcmwgfSBmcm9tICcuL2dldC1wb3J0YWwtdXJsLmZ1bmN0aW9uJztcbmltcG9ydCB7IGdldEVzcmlNYXBTZXJ2aWNlSHR0T3B0aW9ucywgQW5ndWxhckh0dHBPcHRpb24sIGFkZFBhcmFtc1RvSHR0cE9wdGlvbnMgfSBmcm9tICcuLi9lc3JpLW1hcC1zZXJ2aWNlLXJlcXVlc3QnO1xuaW1wb3J0IHsgRXNyaVNlcnZlclRva2VuIH0gZnJvbSAnLi4vZXNyaS1zZXJ2ZXItdG9rZW4nO1xuaW1wb3J0IHsgRXNyaUNvbmZpZyB9IGZyb20gJy4uL2VzcmktY29uZmlnJztcbmltcG9ydCB7IERhdGFTb3VyY2VDb25maWcgfSBmcm9tICcuLi8uLi9kYXRhLXNvdXJjZS9kYXRhLXNvdXJjZS1jb25maWcnO1xuaW1wb3J0IHsgQmFzZUVzcmlTZXJ2aWNlIH0gZnJvbSAnLi4vYmFzZS1lc3JpLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vLi4vY29yZS9sb2dnaW5nL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IEVzcmlQb3J0YWxBY2Nlc3NUb2tlbiB9IGZyb20gJy4vZXNyaS1wb3J0YWwtYWNjZXNzLXRva2VuJztcbmltcG9ydCB7IHRvRm9ybURhdGEgfSBmcm9tICcuLi8uLi9odHRwL3RvLWZvcm0tZGF0YS5mdW5jdGlvbic7XG5pbXBvcnQgeyB0b0VzcmlQb3J0YWxBY2Nlc3NUb2tlbiB9IGZyb20gJy4vdG8tZXNyaS1wb3J0YWwtYWNjZXNzLXRva2VuLmZ1bmN0aW9uJztcbmltcG9ydCB7IHRvRXNyaVNlcnZlclRva2VuIH0gZnJvbSAnLi4vdG8tZXNyaS1zZXJ2ZXItdG9rZW4uZnVuY3Rpb24nO1xuaW1wb3J0IHtcbiAgUE9SVEFMX0dFTkVSQVRFX1RPS0VOX0VORFBPSU5ULFxuICBQT1JUQUxfT0FVVEhfVE9LRU5fRU5EUE9JTlRcbn0gZnJvbSAnLi4vZXNyaS5jb25zdGFudHMnO1xuaW1wb3J0IHsgcmVtb3ZlUG9ydGFsQWNjZXNzVG9rZW5Gcm9tSGFzaCB9IGZyb20gJy4vcmVtb3ZlLXBvcnRhbC1hY2Nlc3MtdG9rZW4tZnJvbS1oYXNoLmZ1bmN0aW9uJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICcuLi8uLi9jb3JlL3VybC9qb2luLmZ1bmN0aW9uJztcblxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBFc3JpUG9ydGFsU2VydmljZSBleHRlbmRzIEJhc2VFc3JpU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKGh0dHA6IEh0dHBDbGllbnQsIGNvbmZpZzogRXNyaUNvbmZpZywgZGF0YUNvbmZpZzogRGF0YVNvdXJjZUNvbmZpZywgbG9nOiBMb2dnZXIpIHtcbiAgICBzdXBlcihodHRwLCBjb25maWcsIGRhdGFDb25maWcsIGxvZyk7XG4gIH1cblxuICBnZXRUb2tlbkJ5Q29kZShwb3J0YWxVcmw6IHN0cmluZywgY2xpZW50SWQ6IHN0cmluZywgY29kZTogc3RyaW5nLCBib2R5RGF0YT86IHt9LCBwYXJhbXM/OiBIdHRwUGFyYW1zKTogT2JzZXJ2YWJsZTxFc3JpUG9ydGFsQWNjZXNzVG9rZW4+IHtcbiAgICBjb25zdCBkYXRhID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBjbGllbnRfaWQ6IGNsaWVudElkLFxuICAgICAgY29kZSxcbiAgICAgIHJlZGlyZWN0X3VyaTogcmVtb3ZlUG9ydGFsQWNjZXNzVG9rZW5Gcm9tSGFzaCh3aW5kb3cubG9jYXRpb24uaHJlZiksXG4gICAgICBncmFudF90eXBlOiAnYXV0aG9yaXphdGlvbl9jb2RlJ1xuICAgIH0sIGJvZHlEYXRhKTtcbiAgICBjb25zdCBmb3JtRGF0YSA9IHRvRm9ybURhdGEoZGF0YSk7XG5cbiAgICByZXR1cm4gdGhpcy5kb1Bvc3QocG9ydGFsVXJsLCBQT1JUQUxfT0FVVEhfVE9LRU5fRU5EUE9JTlQsIGZvcm1EYXRhLCBwYXJhbXMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHJhd1Rva2VuID0+IHRvRXNyaVBvcnRhbEFjY2Vzc1Rva2VuKHJhd1Rva2VuLCBwb3J0YWxVcmwpKVxuICAgICAgKTtcbiAgfVxuXG4gIHJlZnJlc2hUb2tlbihcbiAgICBwb3J0YWxVcmw6IHN0cmluZyxcbiAgICBjbGllbnRJZDogc3RyaW5nLFxuICAgIHJlZnJlc2hUb2tlbjogc3RyaW5nLFxuICAgIGJvZHlEYXRhPzoge30sXG4gICAgcGFyYW1zPzogSHR0cFBhcmFtc1xuICApOiBPYnNlcnZhYmxlPEVzcmlQb3J0YWxBY2Nlc3NUb2tlbj4ge1xuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgIGNsaWVudF9pZDogY2xpZW50SWQsXG4gICAgICByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW4sXG4gICAgICBncmFudF90eXBlOiAncmVmcmVzaF90b2tlbidcbiAgICB9LCBib2R5RGF0YSk7XG4gICAgY29uc3QgZm9ybURhdGEgPSB0b0Zvcm1EYXRhKGRhdGEpO1xuXG4gICAgcmV0dXJuIHRoaXMuZG9Qb3N0KHBvcnRhbFVybCwgUE9SVEFMX09BVVRIX1RPS0VOX0VORFBPSU5ULCBmb3JtRGF0YSwgcGFyYW1zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChyYXdUb2tlbiA9PiB0b0VzcmlQb3J0YWxBY2Nlc3NUb2tlbihyYXdUb2tlbiwgcG9ydGFsVXJsKSlcbiAgICAgICk7XG4gIH1cblxuICBnZXRTZXJ2ZXJUb2tlbihwb3J0YWxVcmw6IHN0cmluZywgcG9ydGFsQWNjZXNzVG9rZW46IHN0cmluZywgc2VydmVyVXJsOiBzdHJpbmcsIHBhcmFtcz86IEh0dHBQYXJhbXMpOiBPYnNlcnZhYmxlPEVzcmlTZXJ2ZXJUb2tlbj4ge1xuICAgIGNvbnN0IGFkZGl0aW9uYWxQYXJhbXMgPSB7XG4gICAgICByZXF1ZXN0OiAnZ2V0VG9rZW4nLFxuICAgICAgc2VydmVyVXJsLFxuICAgICAgdG9rZW46IHBvcnRhbEFjY2Vzc1Rva2VuLFxuICAgICAgcmVmZXJlcjogd2luZG93LmxvY2F0aW9uLmhvc3RcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMuZG9HZXQocG9ydGFsVXJsLCBQT1JUQUxfR0VORVJBVEVfVE9LRU5fRU5EUE9JTlQsIGFkZGl0aW9uYWxQYXJhbXMsIHBhcmFtcylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAodG9rZW4gPT4gdG9Fc3JpU2VydmVyVG9rZW4odG9rZW4pKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBkb0dldDxUPihwb3J0YWxVcmw6IHN0cmluZywgZW5kcG9pbnQ6IHN0cmluZywgcXVlcnlQYXJhbXM6IHt9LCBwYXJhbXM/OiBIdHRwUGFyYW1zKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3QgYmFzZVBvcnRhbFVybCA9IGdldFBvcnRhbFVybChwb3J0YWxVcmwpO1xuICAgIGNvbnN0IHVybCA9IGpvaW4oYmFzZVBvcnRhbFVybCwgZW5kcG9pbnQpO1xuICAgIGNvbnN0IGh0dHBPcHRpb246IEFuZ3VsYXJIdHRwT3B0aW9uID0gZ2V0RXNyaU1hcFNlcnZpY2VIdHRPcHRpb25zKHBhcmFtcyk7XG5cbiAgICBhZGRQYXJhbXNUb0h0dHBPcHRpb25zKGh0dHBPcHRpb24sIHF1ZXJ5UGFyYW1zKTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0PFQ+KHVybCwgaHR0cE9wdGlvbilcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKHJlc3BvbnNlOiBUKSA9PiB0aGlzLmhhbmRsZUVzcmlSZXNwb25zZUVycm9yKHJlc3BvbnNlLCB1cmwpKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBkb1Bvc3Q8VD4ocG9ydGFsVXJsOiBzdHJpbmcsIGVuZHBvaW50OiBzdHJpbmcsIGZvcm1EYXRhOiBGb3JtRGF0YSwgcGFyYW1zPzogSHR0cFBhcmFtcyk6IE9ic2VydmFibGU8VD4ge1xuICAgIGNvbnN0IGJhc2VQb3J0YWxVcmwgPSBnZXRQb3J0YWxVcmwocG9ydGFsVXJsKTtcbiAgICBjb25zdCB1cmwgPSBqb2luKGJhc2VQb3J0YWxVcmwsIGVuZHBvaW50KTtcbiAgICBjb25zdCBodHRwT3B0aW9uOiBBbmd1bGFySHR0cE9wdGlvbiA9IGdldEVzcmlNYXBTZXJ2aWNlSHR0T3B0aW9ucyhwYXJhbXMpO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8VD4odXJsLCBmb3JtRGF0YSwgaHR0cE9wdGlvbilcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKHJlc3BvbnNlOiBUKSA9PiB0aGlzLmhhbmRsZUVzcmlSZXNwb25zZUVycm9yKHJlc3BvbnNlLCB1cmwpKVxuICAgICAgKTtcbiAgfVxufVxuIl19