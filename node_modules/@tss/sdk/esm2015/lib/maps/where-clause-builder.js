/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { isFieldValueNumeric } from './fields/layer-field';
/** @type {?} */
export const FIELD_QUOTE = '"';
/** @enum {string} */
const CriteriaOperator = {
    Equals: '=',
    DoesNotEqual: '<>',
    // In = 'IN',
    // OneOf, NotOneOf, Between, NotBetween, Contains...
    GreaterThan: '>',
    LessThan: '<',
    GreaterOrEqualTo: '>=',
    LessThanOrEqualTo: '<=',
};
export { CriteriaOperator };
/** @enum {string} */
const TargetOperator = {
    Is: 'IS',
    Not: 'NOT',
    In: 'IN',
    Like: 'LIKE',
    Between: 'BETWEEN',
};
export { TargetOperator };
/** @enum {string} */
const ValueOperator = {
    Wildcard: '%',
    Null: 'NULL',
};
export { ValueOperator };
/** @enum {string} */
const GroupingOperator = {
    OpenParenthesis: '(',
    ClosedParenthesis: ')',
    Parenthesis: '()',
};
export { GroupingOperator };
/** @enum {string} */
const CombiningOperator = {
    And: 'AND',
    Or: 'OR',
};
export { CombiningOperator };
/**
 * @record
 */
export function WhereClauseBuilderOptions() { }
if (false) {
    /** @type {?|undefined} */
    WhereClauseBuilderOptions.prototype.quoteFields;
}
/** @type {?} */
export const DefaultWhereClauseBuilderOptions = {
    quoteFields: true
};
export class WhereClauseBuilder {
    /**
     * @param {?=} options
     */
    constructor(options) {
        this.statements = [];
        this.options = Object.assign({}, DefaultWhereClauseBuilderOptions, options);
    }
    /**
     * @return {?}
     */
    get criteriaCount() {
        return this.statements.length;
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} statement
     * @return {THIS}
     */
    add(statement) {
        (/** @type {?} */ (this)).statements.push(statement);
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereEqual(field, value) {
        return value === null
            ? (/** @type {?} */ (this)).whereIsNull(field.name)
            : (/** @type {?} */ (this)).where(field.name, CriteriaOperator.Equals, value, isFieldValueNumeric(field, value));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereLike(field, value) {
        return (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)} ${TargetOperator.Like} '%${value}%'`);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereStartsWith(field, value) {
        return (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)} ${TargetOperator.Like} '${value}%'`);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereEndsWith(field, value) {
        return (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)} ${TargetOperator.Like} '%${value}'`);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereNotEqual(field, value) {
        return value === null
            ? (/** @type {?} */ (this)).whereIsNotNull(field.name)
            : (/** @type {?} */ (this)).where(field.name, CriteriaOperator.DoesNotEqual, value, isFieldValueNumeric(field, value));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @return {THIS}
     */
    whereIsNull(field) {
        return (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)} ${TargetOperator.Is} ${ValueOperator.Null}`);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @return {THIS}
     */
    whereIsNotNull(field) {
        return (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)} ${TargetOperator.Is} ${TargetOperator.Not} ${ValueOperator.Null}`);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} operator
     * @param {?} value
     * @param {?=} isNumeric
     * @return {THIS}
     */
    where(field, operator, value, isNumeric = false) {
        value = isNumeric ? value : `'${value}'`;
        (/** @type {?} */ (this)).add(`${(/** @type {?} */ (this)).formatField(field)}${operator}${value}`);
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} field
     * @param {?} value
     * @return {THIS}
     */
    whereNumeric(field, value) {
        (/** @type {?} */ (this)).where(field, value, true);
        return (/** @type {?} */ (this));
    }
    /**
     * @return {?}
     */
    toWhereClause() {
        return this.statements.join(` ${CombiningOperator.And} `);
    }
    /**
     * @return {?}
     */
    toString() {
        return this.toWhereClause();
    }
    /**
     * @return {?}
     */
    clear() {
        this.statements.length = 0;
    }
    /**
     * @protected
     * @param {?} field
     * @return {?}
     */
    formatField(field) {
        field = field || '';
        /** @type {?} */
        const addQuotes = this.options.quoteFields;
        if (addQuotes) {
            if (!field.startsWith(FIELD_QUOTE)) {
                field = `${FIELD_QUOTE}${field}`;
            }
            if (!field.endsWith(FIELD_QUOTE)) {
                field = `${field}${FIELD_QUOTE}`;
            }
        }
        else {
            /** @type {?} */
            const quoteRegex = new RegExp(FIELD_QUOTE, 'i');
            return field.replace(quoteRegex, '');
        }
        return field;
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    WhereClauseBuilder.prototype.statements;
    /**
     * @type {?}
     * @private
     */
    WhereClauseBuilder.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2hlcmUtY2xhdXNlLWJ1aWxkZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9tYXBzL3doZXJlLWNsYXVzZS1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsbUJBQW1CLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFHdkUsTUFBTSxPQUFPLFdBQVcsR0FBRyxHQUFHOzs7SUFFNUIsUUFBUyxHQUFHO0lBQ1osY0FBZSxJQUFJO0lBQ25CLGFBQWE7SUFDYixvREFBb0Q7SUFDcEQsYUFBYyxHQUFHO0lBQ2pCLFVBQVcsR0FBRztJQUNkLGtCQUFtQixJQUFJO0lBQ3ZCLG1CQUFvQixJQUFJOzs7OztJQUl4QixJQUFLLElBQUk7SUFDVCxLQUFNLEtBQUs7SUFDWCxJQUFLLElBQUk7SUFDVCxNQUFPLE1BQU07SUFDYixTQUFVLFNBQVM7Ozs7O0lBSW5CLFVBQVcsR0FBRztJQUNkLE1BQU8sTUFBTTs7Ozs7SUFJYixpQkFBa0IsR0FBRztJQUNyQixtQkFBb0IsR0FBRztJQUN2QixhQUFjLElBQUk7Ozs7O0lBSWxCLEtBQU0sS0FBSztJQUNYLElBQUssSUFBSTs7Ozs7O0FBR1gsK0NBRUM7OztJQURDLGdEQUFzQjs7O0FBR3hCLE1BQU0sT0FBTyxnQ0FBZ0MsR0FBRztJQUM5QyxXQUFXLEVBQUUsSUFBSTtDQUNsQjtBQUVELE1BQU0sT0FBTyxrQkFBa0I7Ozs7SUFJN0IsWUFBWSxPQUFtQztRQUg5QixlQUFVLEdBQWEsRUFBRSxDQUFDO1FBSXpDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsZ0NBQWdDLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDOUUsQ0FBQzs7OztJQUVELElBQUksYUFBYTtRQUNmLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7SUFDaEMsQ0FBQzs7Ozs7OztJQUVELEdBQUcsQ0FBQyxTQUFpQjtR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VUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0NBQ0Y7Ozs7OztJQTFGQyx3Q0FBMkM7Ozs7O0lBQzNDLHFDQUFvRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExheWVyRmllbGQsIGlzRmllbGRWYWx1ZU51bWVyaWMgfSBmcm9tICcuL2ZpZWxkcy9sYXllci1maWVsZCc7XG5cblxuZXhwb3J0IGNvbnN0IEZJRUxEX1FVT1RFID0gJ1wiJztcbmV4cG9ydCBlbnVtIENyaXRlcmlhT3BlcmF0b3Ige1xuICBFcXVhbHMgPSAnPScsXG4gIERvZXNOb3RFcXVhbCA9ICc8PicsXG4gIC8vIEluID0gJ0lOJyxcbiAgLy8gT25lT2YsIE5vdE9uZU9mLCBCZXR3ZWVuLCBOb3RCZXR3ZWVuLCBDb250YWlucy4uLlxuICBHcmVhdGVyVGhhbiA9ICc+JyxcbiAgTGVzc1RoYW4gPSAnPCcsXG4gIEdyZWF0ZXJPckVxdWFsVG8gPSAnPj0nLFxuICBMZXNzVGhhbk9yRXF1YWxUbyA9ICc8PScsXG59XG5cbmV4cG9ydCBlbnVtIFRhcmdldE9wZXJhdG9yIHtcbiAgSXMgPSAnSVMnLFxuICBOb3QgPSAnTk9UJyxcbiAgSW4gPSAnSU4nLFxuICBMaWtlID0gJ0xJS0UnLFxuICBCZXR3ZWVuID0gJ0JFVFdFRU4nLFxufVxuXG5leHBvcnQgZW51bSBWYWx1ZU9wZXJhdG9yIHtcbiAgV2lsZGNhcmQgPSAnJScsXG4gIE51bGwgPSAnTlVMTCcsXG59XG5cbmV4cG9ydCBlbnVtIEdyb3VwaW5nT3BlcmF0b3Ige1xuICBPcGVuUGFyZW50aGVzaXMgPSAnKCcsXG4gIENsb3NlZFBhcmVudGhlc2lzID0gJyknLFxuICBQYXJlbnRoZXNpcyA9ICcoKScsXG59XG5cbmV4cG9ydCBlbnVtIENvbWJpbmluZ09wZXJhdG9yIHtcbiAgQW5kID0gJ0FORCcsXG4gIE9yID0gJ09SJyxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXaGVyZUNsYXVzZUJ1aWxkZXJPcHRpb25zIHtcbiAgcXVvdGVGaWVsZHM/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY29uc3QgRGVmYXVsdFdoZXJlQ2xhdXNlQnVpbGRlck9wdGlvbnMgPSB7XG4gIHF1b3RlRmllbGRzOiB0cnVlXG59O1xuXG5leHBvcnQgY2xhc3MgV2hlcmVDbGF1c2VCdWlsZGVyIHtcbiAgcHJpdmF0ZSByZWFkb25seSBzdGF0ZW1lbnRzOiBzdHJpbmdbXSA9IFtdO1xuICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IFdoZXJlQ2xhdXNlQnVpbGRlck9wdGlvbnM7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9ucz86IFdoZXJlQ2xhdXNlQnVpbGRlck9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBEZWZhdWx0V2hlcmVDbGF1c2VCdWlsZGVyT3B0aW9ucywgb3B0aW9ucyk7XG4gIH1cblxuICBnZXQgY3JpdGVyaWFDb3VudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnN0YXRlbWVudHMubGVuZ3RoO1xuICB9XG5cbiAgYWRkKHN0YXRlbWVudDogc3RyaW5nKTogdGhpcyB7XG4gICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHdoZXJlRXF1YWwoZmllbGQ6IExheWVyRmllbGQsIHZhbHVlOiBhbnkpOiB0aGlzIHtcbiAgICByZXR1cm4gdmFsdWUgPT09IG51bGxcbiAgICAgID8gdGhpcy53aGVyZUlzTnVsbChmaWVsZC5uYW1lKVxuICAgICAgOiB0aGlzLndoZXJlKGZpZWxkLm5hbWUsIENyaXRlcmlhT3BlcmF0b3IuRXF1YWxzLCB2YWx1ZSwgaXNGaWVsZFZhbHVlTnVtZXJpYyhmaWVsZCwgdmFsdWUpKTtcbiAgfVxuXG4gIHdoZXJlTGlrZShmaWVsZDogc3RyaW5nLCB2YWx1ZTogYW55KTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXMuYWRkKGAke3RoaXMuZm9ybWF0RmllbGQoZmllbGQpfSAke1RhcmdldE9wZXJhdG9yLkxpa2V9ICclJHt2YWx1ZX0lJ2ApO1xuICB9XG5cbiAgd2hlcmVTdGFydHNXaXRoKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcbiAgICByZXR1cm4gdGhpcy5hZGQoYCR7dGhpcy5mb3JtYXRGaWVsZChmaWVsZCl9ICR7VGFyZ2V0T3BlcmF0b3IuTGlrZX0gJyR7dmFsdWV9JSdgKTtcbiAgfVxuXG4gIHdoZXJlRW5kc1dpdGgoZmllbGQ6IHN0cmluZywgdmFsdWU6IGFueSk6IHRoaXMge1xuICAgIHJldHVybiB0aGlzLmFkZChgJHt0aGlzLmZvcm1hdEZpZWxkKGZpZWxkKX0gJHtUYXJnZXRPcGVyYXRvci5MaWtlfSAnJSR7dmFsdWV9J2ApO1xuICB9XG5cbiAgd2hlcmVOb3RFcXVhbChmaWVsZDogTGF5ZXJGaWVsZCwgdmFsdWU6IGFueSk6IHRoaXMge1xuICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbFxuICAgICAgPyB0aGlzLndoZXJlSXNOb3ROdWxsKGZpZWxkLm5hbWUpXG4gICAgICA6IHRoaXMud2hlcmUoZmllbGQubmFtZSwgQ3JpdGVyaWFPcGVyYXRvci5Eb2VzTm90RXF1YWwsIHZhbHVlLCBpc0ZpZWxkVmFsdWVOdW1lcmljKGZpZWxkLCB2YWx1ZSkpO1xuICB9XG5cbiAgd2hlcmVJc051bGwoZmllbGQ6IHN0cmluZyk6IHRoaXMge1xuICAgIHJldHVybiB0aGlzLmFkZChgJHt0aGlzLmZvcm1hdEZpZWxkKGZpZWxkKX0gJHtUYXJnZXRPcGVyYXRvci5Jc30gJHtWYWx1ZU9wZXJhdG9yLk51bGx9YCk7XG4gIH1cblxuICB3aGVyZUlzTm90TnVsbChmaWVsZDogc3RyaW5nKTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXMuYWRkKGAke3RoaXMuZm9ybWF0RmllbGQoZmllbGQpfSAke1RhcmdldE9wZXJhdG9yLklzfSAke1RhcmdldE9wZXJhdG9yLk5vdH0gJHtWYWx1ZU9wZXJhdG9yLk51bGx9YCk7XG4gIH1cblxuICB3aGVyZShmaWVsZDogc3RyaW5nLCBvcGVyYXRvcjogQ3JpdGVyaWFPcGVyYXRvciB8IFRhcmdldE9wZXJhdG9yLCB2YWx1ZTogYW55LCBpc051bWVyaWMgPSBmYWxzZSk6IHRoaXMge1xuICAgIHZhbHVlID0gaXNOdW1lcmljID8gdmFsdWUgOiBgJyR7dmFsdWV9J2A7XG4gICAgdGhpcy5hZGQoYCR7dGhpcy5mb3JtYXRGaWVsZChmaWVsZCl9JHtvcGVyYXRvcn0ke3ZhbHVlfWApO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2hlcmVOdW1lcmljKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB0aGlzIHtcbiAgICB0aGlzLndoZXJlKGZpZWxkLCB2YWx1ZSwgdHJ1ZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b1doZXJlQ2xhdXNlKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGVtZW50cy5qb2luKGAgJHtDb21iaW5pbmdPcGVyYXRvci5BbmR9IGApO1xuICB9XG5cbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy50b1doZXJlQ2xhdXNlKCk7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnN0YXRlbWVudHMubGVuZ3RoID0gMDtcbiAgfVxuXG4gIHByb3RlY3RlZCBmb3JtYXRGaWVsZChmaWVsZDogc3RyaW5nKSB7XG4gICAgZmllbGQgPSBmaWVsZCB8fCAnJztcbiAgICBjb25zdCBhZGRRdW90ZXMgPSB0aGlzLm9wdGlvbnMucXVvdGVGaWVsZHM7XG5cbiAgICBpZiAoYWRkUXVvdGVzKSB7XG4gICAgICBpZiAoIWZpZWxkLnN0YXJ0c1dpdGgoRklFTERfUVVPVEUpKSB7XG4gICAgICAgIGZpZWxkID0gYCR7RklFTERfUVVPVEV9JHtmaWVsZH1gO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWZpZWxkLmVuZHNXaXRoKEZJRUxEX1FVT1RFKSkge1xuICAgICAgICBmaWVsZCA9IGAke2ZpZWxkfSR7RklFTERfUVVPVEV9YDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcXVvdGVSZWdleCA9IG5ldyBSZWdFeHAoRklFTERfUVVPVEUsICdpJyk7XG4gICAgICByZXR1cm4gZmllbGQucmVwbGFjZShxdW90ZVJlZ2V4LCAnJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpZWxkO1xuICB9XG59XG4iXX0=