/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Router } from '@angular/router';
import { Injector, Injectable } from '@angular/core';
import { CoreConfig } from '../core/core.config';
import { Logger } from '../core/logging/logger.service';
import { PersistentStorage } from '../core/storage/persistent-storage.service';
import { getQueryParams } from '../core/url/get-query-params.function';
import { getFirstHashRoutePath } from '../core/url/get-first-hash-route-path.function';
import { getFullUrl } from '../core/url/get-full-url.function';
import { isDate } from '../core/type-check/is-date.function';
import { toPrimitiveType } from '../core/type-conversion/to-primitive-type.function';
import { lowerCaseFirst } from '../core/formatting/lower-case-first.function';
import { isValue } from '../core/type-check/is-value.function';
import { setValue } from '../core/object/set-value.function';
import { AuthService } from '../security/auth.service';
import { SecurityConfig } from '../security/security-config';
import { RoleManagerService } from '../security/role-manager.service';
import { AppProfileService } from './app-profile.service';
import { AppConfig } from './app.config';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../security/auth.service";
import * as i3 from "./app-profile.service";
import * as i4 from "../core/logging/logger.service";
import * as i5 from "./app.config";
import * as i6 from "../core/storage/persistent-storage.service";
import * as i7 from "../security/security-config";
import * as i8 from "../security/role-manager.service";
/**
 * @record
 */
function ModuleConfigInstanceMap() { }
if (false) {
    /** @type {?} */
    ModuleConfigInstanceMap.prototype.instance;
    /** @type {?} */
    ModuleConfigInstanceMap.prototype.config;
}
/**
 * Application initialization service that is responsible for bootstrapping
 * the application.
 */
export class AppInitializerService {
    /**
     * @param {?} router
     * @param {?} auth
     * @param {?} appProfiles
     * @param {?} log
     * @param {?} config
     * @param {?} storage
     * @param {?} securityConfig
     * @param {?} roleMgr
     * @param {?} injector
     */
    constructor(router, auth, appProfiles, log, config, storage, securityConfig, roleMgr, injector) {
        this.router = router;
        this.auth = auth;
        this.appProfiles = appProfiles;
        this.log = log;
        this.config = config;
        this.storage = storage;
        this.securityConfig = securityConfig;
        this.roleMgr = roleMgr;
        this.injector = injector;
        this.ready = false;
        this.loading = false;
        this.moduleConfigInstances = new Map();
        this.queryParameters = getQueryParams();
        this.onReady = new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.resolveFn = resolve;
            this.rejectFn = reject;
        }));
    }
    /**
     * Initializes/bootstraps a standard TSS application.
     * @return {?}
     */
    initialize() {
        /** @type {?} */
        const appId = this.config.appId;
        const [firstRoutePath] = this.router.url.split('/');
        /** @type {?} */
        const profileId = this.queryParameters.profileId
            || firstRoutePath
            || getFirstHashRoutePath(getFullUrl())
            || this.config.defaultProfileId;
        // We override module configurations here because the user may be trying to debug the session. The
        // override has to happen again at the end of the process to override any settings that may have
        // been set through the app initialization process.
        this.overrideModuleConfigurationsFromQueryParams();
        this.log.debug(`Initializing application with profile ID: ${profileId}`);
        // We need to try and read any stored security token before we make
        // a request to get profile info, so that the request is authenticated.
        this.auth.loadStoredToken();
        this.populateModuleConfigInstances();
        if (!this.config.queryProfile || !this.config.hasServiceUrl) {
            this.config.profile = {
                name: '',
                appId,
                id: profileId,
            };
            this.log.debug(this.config.hasServiceUrl
                ? `Profile query skipped due to configuration option`
                : `No service URL configured, can't retrieve profile details - skipping profile retrieval`);
            this.overrideModuleConfigurationsFromQueryParams();
            this.ready = true;
            this.resolveFn(this.config.profile);
        }
        else {
            this.loading = true;
            // We need to try and read any stored security token before we make
            // a request to get profile info, so that the request is authenticated.
            this.queryProfile(profileId)
                .then((/**
             * @param {?} profile
             * @return {?}
             */
            (profile) => this.resolveFn(profile)))
                .catch((/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                if (this.config.continueOnAppBootstrapError) {
                    this.resolveFn(this.config.profile);
                }
                else {
                    this.rejectFn(err);
                }
            }));
        }
    }
    /**
     * @private
     * @param {?} profileId
     * @return {?}
     */
    queryProfile(profileId) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.appProfiles.get(profileId)
                .subscribe((/**
             * @param {?} profile
             * @return {?}
             */
            (profile) => {
                if (!profile) {
                    return reject(`No profile found with ID '${profileId}'`);
                }
                this.config.profileId = profile.id;
                this.config.profile = profile;
                this.checkTokenInvalidationDate();
                this.applyModuleConfigurations();
                this.overrideModuleConfigurationsFromQueryParams();
                this.retrieveUserAccount()
                    .then((/**
                 * @return {?}
                 */
                () => {
                    this.configureRoleManager();
                    this.ready = true;
                    this.loading = false;
                    resolve(profile);
                }))
                    .catch((/**
                 * @param {?} err
                 * @return {?}
                 */
                (err) => {
                    this.loading = false;
                    reject(err);
                }));
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                this.loading = false;
                this.log.error(`Failed to retrieve application profile with app ID '${this.config.appId}' and ID '${profileId}'`);
                reject(err);
            }));
        }));
    }
    /**
     * Gets the date of the cached "invalidation" date.
     * The invalidation date is used to let the server force users to re-authenticate.
     * @private
     * @return {?}
     */
    getCachedTokenInvalidationDate() {
        return new Date(this.storage.get(this.securityConfig.tokenInvalidationDateLookup));
    }
    /**
     * Caches the "invalidation" date.
     * The invalidation date is used to let the server force users to re-authenticate.
     * @private
     * @param {?=} setDate
     * @return {?}
     */
    setCachedTokenExpireDate(setDate) {
        this.log.debug(`Setting cached token invalidation date: ${setDate}`);
        if (setDate) {
            this.log.debug(`Setting token invalidation date to: ${setDate}`);
            this.storage.set(this.securityConfig.tokenInvalidationDateLookup, setDate);
        }
        else {
            this.storage.remove(this.securityConfig.tokenInvalidationDateLookup);
        }
    }
    /**
     * Compares the cached token validation data with the invalidation date from the server.
     * If the invalidation date from the server is new than the cached date, then the user
     * must be forcibly signed out.
     * @private
     * @return {?}
     */
    checkTokenInvalidationDate() {
        /** @type {?} */
        let tokenExpireDate;
        /** @type {?} */
        const siteInfo = this.config.profile && this.config.profile.app && this.config.profile.app.siteInfo
            ? this.config.profile.app.siteInfo
            : null;
        if (siteInfo && siteInfo[AppInitializerService.tokenExpireDateKey]) {
            /** @type {?} */
            const lastTokenInvalidateDate = this.getCachedTokenInvalidationDate();
            tokenExpireDate = new Date(siteInfo[AppInitializerService.tokenExpireDateKey]);
            // Note, we are setting milliseconds to 0 because we don't care about that level of accuracy.
            // Also, the "setMilliseconds" method returns the "timestamp" so we can just compare those two results.
            /** @type {?} */
            const lastTokenValidationDatesMatch = isDate(lastTokenInvalidateDate) && isDate(tokenExpireDate)
                ? lastTokenInvalidateDate.setMilliseconds(0) === tokenExpireDate.setMilliseconds(0)
                : lastTokenInvalidateDate === tokenExpireDate;
            if (this.auth.account && this.auth.account.lastSignIn < tokenExpireDate && !lastTokenValidationDatesMatch) {
                this.log.info('Signing out user due to token invalidation date from security configuration');
                this.auth.onSignedOut();
            }
            else if (this.auth.account) {
                this.log.debug('User has been authenticated after the token invalidation date');
            }
            if (tokenExpireDate) {
                this.setCachedTokenExpireDate(tokenExpireDate);
            }
        }
    }
    /**
     * Retrieves the user account if the user is already signed in, logs the user out if
     * the token is expired, or refreshes the user account information - depending on
     * the configured authentication provider.
     * @private
     * @return {?}
     */
    retrieveUserAccount() {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            try {
                /** @type {?} */
                let queryingInfo = false;
                /** @type {?} */
                const app = this.config.profile && this.config.profile.app
                    ? this.config.profile.app : null;
                // If the local auth status says that no one is logged in, but the service is recognizing that someone is
                // logged in, then this means that authentication is happening through windows via Active Directory or some
                // other means. We need to get the user info so we can set the app "state" as "logged in".
                if (app && app.security && !this.auth.isAuthenticated && app.security.isAuthenticated) {
                    this.log.debug('Retrieving additional user info do to authentication state');
                    queryingInfo = true;
                    this.auth.getUserInfo().subscribe((/**
                     * @param {?} info
                     * @return {?}
                     */
                    info => {
                        /** @type {?} */
                        const expiresDate = new Date();
                        expiresDate.setDate(expiresDate.getDate() + app.security.accessTokenExpireDays);
                        this.auth.onSignedIn(Object.assign({ '.expires': expiresDate }, info));
                        resolve(info);
                    }), (/**
                     * @param {?} err
                     * @return {?}
                     */
                    err => {
                        reject(err);
                    }));
                }
                else if (this.auth.isAuthenticated && app.security && !app.security.isAuthenticated) {
                    this.log.debug(`Signing out user do to out of sync authentication state`);
                    // Sign out/clear the auth cache because the server says they don't know who this is, but
                    // the client side code thinks it knows who it is.
                    this.auth.onSignedOut();
                }
                if (!queryingInfo) {
                    this.log.debug(`No request made for additional user account info`);
                    resolve(this.auth.account);
                }
            }
            catch (e) {
                this.log.error('Failed to do pre-verification of user on app load. {0}', e);
                reject(e);
            }
        }));
    }
    /**
     * Set module configuration properties based on overrides from an object.
     * This object can come from multiple places - such as the server or query params.
     * See: the "applyModuleConfigurations" and "overrideModuleConfigurations" methods.
     * @private
     * @param {?} sourceMapping
     * @return {?}
     */
    applyModuleConfigurationsFromObject(sourceMapping) {
        sourceMapping = sourceMapping || {};
        this.moduleConfigInstances
            .forEach((/**
         * @param {?} config
         * @return {?}
         */
        config => {
            /** @type {?} */
            const moduleConfigName = config.config.className;
            /** @type {?} */
            const configInstance = config.instance;
            Object.keys(sourceMapping)
                .forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                /** @type {?} */
                const value = toPrimitiveType(sourceMapping[key]);
                /** @type {?} */
                const modulePrefix = lowerCaseFirst(moduleConfigName + '.');
                /** @type {?} */
                const rootKey = key.replace(modulePrefix, '');
                if (isValue(value) && key.toLowerCase().startsWith(modulePrefix.toLowerCase())) {
                    // A config object has properties in our siteInfo object.
                    this.log.debug(`Setting ${moduleConfigName} property '${rootKey}' to ${value}`);
                    setValue(configInstance, rootKey, value);
                }
            }));
        }));
    }
    /**
     * Set module configuration properties based on overrides from the server.
     * This functionality lets us dynamically override client side configuration
     * through the use of "App Settings" from the server.
     * @private
     * @return {?}
     */
    applyModuleConfigurations() {
        /** @type {?} */
        const profile = this.config.profile;
        if (!profile || !profile.app || !profile.app.siteInfo) {
            return;
        }
        this.applyModuleConfigurationsFromObject(profile.app.siteInfo);
    }
    /**
     * Set module configuration properties based on overrides from the URL query parameters.
     * This functionality lets us dynamically override client side and server side configurations
     * by passing explicit settings through query parameters. A good use case for this is to pass
     * "coreConfig.logLevel=1" as a query parameter in production to debug an issue in a production
     * environment.
     * @private
     * @return {?}
     */
    overrideModuleConfigurationsFromQueryParams() {
        if (this.config.allowQueryParamInjections) {
            this.applyModuleConfigurationsFromObject(this.queryParameters);
        }
    }
    /**
     * Instantiates instances of each configured module configuration object. Properties of
     * these module config instances will later be set based on server-side overides.
     * @private
     * @return {?}
     */
    populateModuleConfigInstances() {
        CoreConfig.moduleConfigs
            .forEach((/**
         * @param {?} moduleAutoConfig
         * @return {?}
         */
        moduleAutoConfig => {
            try {
                // Reason: https://github.com/angular/angular/issues/22063
                // tslint:disable-next-line
                /** @type {?} */
                const configInstance = this.injector.get(moduleAutoConfig.injectorToken);
                this.moduleConfigInstances.set(moduleAutoConfig.injectorToken, {
                    instance: configInstance,
                    config: moduleAutoConfig
                });
                this.log.debug(`Created module configuration instance for: ${moduleAutoConfig.className}`);
                if ('serviceUrl' in configInstance || 'hasServiceUrl' in configInstance) {
                    configInstance.serviceUrl = this.config.serviceUrl;
                }
            }
            catch (err) {
                this.log.error(`Failed to get module config: ${moduleAutoConfig.className}`, err);
            }
        }));
    }
    /**
     * Updates security options based on information retrieved form the application profile.
     * For example, security may be enabled or disabled, guest roles will be set, etc.
     * @private
     * @return {?}
     */
    configureRoleManager() {
        /** @type {?} */
        const security = this.config.profile && this.config.profile.app && this.config.profile.app.security
            ? this.config.profile.app.security : null;
        if (!security) {
            return;
        }
        // We want to explicitly
        if (security.hasOwnProperty('enabled')) {
            this.securityConfig.rolesEnabled = !!security.enabled;
        }
        if (!this.roleMgr.enabled) {
            this.log.warn('Security is disabled');
        }
        security.guestPrivileges = security.guestPrivileges || [];
        this.roleMgr.addRoles(security.guestPrivileges);
        this.log.info(`Configured default roles (guest roles) - total of ${security.guestPrivileges.length}`);
        this.log.info(`User has a total of ${this.roleMgr.roleCount} roles assigned to them`);
    }
}
AppInitializerService.tokenExpireDateKey = 'token-expire-date';
AppInitializerService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AppInitializerService.ctorParameters = () => [
    { type: Router },
    { type: AuthService },
    { type: AppProfileService },
    { type: Logger },
    { type: AppConfig },
    { type: PersistentStorage },
    { type: SecurityConfig },
    { type: RoleManagerService },
    { type: Injector }
];
/** @nocollapse */ AppInitializerService.ngInjectableDef = i0.defineInjectable({ factory: function AppInitializerService_Factory() { return new AppInitializerService(i0.inject(i1.Router), i0.inject(i2.AuthService), i0.inject(i3.AppProfileService), i0.inject(i4.Logger), i0.inject(i5.AppConfig), i0.inject(i6.PersistentStorage), i0.inject(i7.SecurityConfig), i0.inject(i8.RoleManagerService), i0.inject(i0.INJECTOR)); }, token: AppInitializerService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.tokenExpireDateKey;
    /** @type {?} */
    AppInitializerService.prototype.ready;
    /** @type {?} */
    AppInitializerService.prototype.loading;
    /** @type {?} */
    AppInitializerService.prototype.onReady;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.moduleConfigInstances;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.queryParameters;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.resolveFn;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.rejectFn;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.auth;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.appProfiles;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.log;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.securityConfig;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.roleMgr;
    /**
     * @type {?}
     * @private
     */
    AppInitializerService.prototype.injector;
}
/**
 * Application initialization factory that provides a hook into
 * the Angular bootstrapping process.
 * @param {?} injector
 * @return {?}
 */
export function AppInitializerFactory(injector) {
    return (/**
     * @return {?}
     */
    () => {
        /** @type {?} */
        const initializer = injector.get(AppInitializerService);
        initializer.initialize();
        return initializer.onReady;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWluaXRpYWxpemVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9hcHAvYXBwLWluaXRpYWxpemVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJckQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN4RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUMvRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdkUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDdkYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0RBQW9ELENBQUM7QUFDckYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFN0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUd0RSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FB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O0lBQ3pCLDRDQUFzQzs7Ozs7SUFDdEMsb0NBQW1COzs7OztJQUNuQix1Q0FBeUI7Ozs7O0lBQ3pCLHdDQUFrQzs7Ozs7SUFDbEMsK0NBQXNDOzs7OztJQUN0Qyx3Q0FBbUM7Ozs7O0lBQ25DLHlDQUEwQjs7Ozs7Ozs7QUFxVDlCLE1BQU0sVUFBVSxxQkFBcUIsQ0FBQyxRQUFrQjtJQUN0RDs7O0lBQU8sR0FBd0IsRUFBRTs7Y0FDekIsV0FBVyxHQUEwQixRQUFRLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDO1FBQzlFLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUV6QixPQUFPLFdBQVcsQ0FBQyxPQUFPLENBQUM7SUFDN0IsQ0FBQyxFQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEFuZ3VsYXIuXG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgSW5qZWN0b3IsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuLy8gVFNTLlxuaW1wb3J0IHsgQXV0b0NvbmZpZ0RhdGEgfSBmcm9tICcuLi9jb3JlL2F1dG8tY29uZmlnLWRhdGEnO1xuaW1wb3J0IHsgQ29yZUNvbmZpZyB9IGZyb20gJy4uL2NvcmUvY29yZS5jb25maWcnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vY29yZS9sb2dnaW5nL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcnNpc3RlbnRTdG9yYWdlIH0gZnJvbSAnLi4vY29yZS9zdG9yYWdlL3BlcnNpc3RlbnQtc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IGdldFF1ZXJ5UGFyYW1zIH0gZnJvbSAnLi4vY29yZS91cmwvZ2V0LXF1ZXJ5LXBhcmFtcy5mdW5jdGlvbic7XG5pbXBvcnQgeyBnZXRGaXJzdEhhc2hSb3V0ZVBhdGggfSBmcm9tICcuLi9jb3JlL3VybC9nZXQtZmlyc3QtaGFzaC1yb3V0ZS1wYXRoLmZ1bmN0aW9uJztcbmltcG9ydCB7IGdldEZ1bGxVcmwgfSBmcm9tICcuLi9jb3JlL3VybC9nZXQtZnVsbC11cmwuZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNEYXRlIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLWRhdGUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgdG9QcmltaXRpdmVUeXBlIH0gZnJvbSAnLi4vY29yZS90eXBlLWNvbnZlcnNpb24vdG8tcHJpbWl0aXZlLXR5cGUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgbG93ZXJDYXNlRmlyc3QgfSBmcm9tICcuLi9jb3JlL2Zvcm1hdHRpbmcvbG93ZXItY2FzZS1maXJzdC5mdW5jdGlvbic7XG5pbXBvcnQgeyBpc1ZhbHVlIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLXZhbHVlLmZ1bmN0aW9uJztcbmltcG9ydCB7IHNldFZhbHVlIH0gZnJvbSAnLi4vY29yZS9vYmplY3Qvc2V0LXZhbHVlLmZ1bmN0aW9uJztcblxuaW1wb3J0IHsgQXV0aFNlcnZpY2UgfSBmcm9tICcuLi9zZWN1cml0eS9hdXRoLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2VjdXJpdHlDb25maWcgfSBmcm9tICcuLi9zZWN1cml0eS9zZWN1cml0eS1jb25maWcnO1xuaW1wb3J0IHsgUm9sZU1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VjdXJpdHkvcm9sZS1tYW5hZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgVXNlckFjY291bnQgfSBmcm9tICcuLi9zZWN1cml0eS91c2VyLWFjY291bnQnO1xuXG5pbXBvcnQgeyBBcHBQcm9maWxlU2VydmljZSB9IGZyb20gJy4vYXBwLXByb2ZpbGUuc2VydmljZSc7XG5pbXBvcnQgeyBBcHBDb25maWcgfSBmcm9tICcuL2FwcC5jb25maWcnO1xuaW1wb3J0IHsgQXBwUHJvZmlsZSB9IGZyb20gJy4vYXBwLXByb2ZpbGUnO1xuXG5cbmludGVyZmFjZSBNb2R1bGVDb25maWdJbnN0YW5jZU1hcCB7XG4gIGluc3RhbmNlOiBhbnk7XG4gIGNvbmZpZzogQXV0b0NvbmZpZ0RhdGE7XG59XG5cblxuLyoqXG4gKiBBcHBsaWNhdGlvbiBpbml0aWFsaXphdGlvbiBzZXJ2aWNlIHRoYXQgaXMgcmVzcG9uc2libGUgZm9yIGJvb3RzdHJhcHBpbmdcbiAqIHRoZSBhcHBsaWNhdGlvbi5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQXBwSW5pdGlhbGl6ZXJTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgdG9rZW5FeHBpcmVEYXRlS2V5ID0gJ3Rva2VuLWV4cGlyZS1kYXRlJztcblxuICByZWFkeSA9IGZhbHNlO1xuICBsb2FkaW5nID0gZmFsc2U7XG4gIG9uUmVhZHk6IFByb21pc2U8QXBwUHJvZmlsZT47XG5cbiAgcHJpdmF0ZSByZWFkb25seSBtb2R1bGVDb25maWdJbnN0YW5jZXMgPSBuZXcgTWFwPHN0cmluZywgTW9kdWxlQ29uZmlnSW5zdGFuY2VNYXA+KCk7XG4gIHByaXZhdGUgcmVhZG9ubHkgcXVlcnlQYXJhbWV0ZXJzOiBhbnk7XG4gIHByaXZhdGUgcmVzb2x2ZUZuOiAodmFsdWU/OiBBcHBQcm9maWxlIHwgUHJvbWlzZUxpa2U8QXBwUHJvZmlsZT4pID0+IHZvaWQ7XG4gIHByaXZhdGUgcmVqZWN0Rm46IChyZWFzb24/OiBhbnkpID0+IHZvaWQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIGF1dGg6IEF1dGhTZXJ2aWNlLFxuICAgIHByaXZhdGUgYXBwUHJvZmlsZXM6IEFwcFByb2ZpbGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9nOiBMb2dnZXIsXG4gICAgcHJpdmF0ZSBjb25maWc6IEFwcENvbmZpZyxcbiAgICBwcml2YXRlIHN0b3JhZ2U6IFBlcnNpc3RlbnRTdG9yYWdlLFxuICAgIHByaXZhdGUgc2VjdXJpdHlDb25maWc6IFNlY3VyaXR5Q29uZmlnLFxuICAgIHByaXZhdGUgcm9sZU1ncjogUm9sZU1hbmFnZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge1xuICAgIHRoaXMucXVlcnlQYXJhbWV0ZXJzID0gZ2V0UXVlcnlQYXJhbXMoKTtcbiAgICB0aGlzLm9uUmVhZHkgPSBuZXcgUHJvbWlzZTxBcHBQcm9maWxlPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnJlc29sdmVGbiA9IHJlc29sdmU7XG4gICAgICB0aGlzLnJlamVjdEZuID0gcmVqZWN0O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemVzL2Jvb3RzdHJhcHMgYSBzdGFuZGFyZCBUU1MgYXBwbGljYXRpb24uXG4gICAqL1xuICBpbml0aWFsaXplKCk6IHZvaWQge1xuICAgIGNvbnN0IGFwcElkOiBzdHJpbmcgPSB0aGlzLmNvbmZpZy5hcHBJZDtcbiAgICBjb25zdCBbZmlyc3RSb3V0ZVBhdGhdID0gdGhpcy5yb3V0ZXIudXJsLnNwbGl0KCcvJyk7XG4gICAgY29uc3QgcHJvZmlsZUlkOiBzdHJpbmcgPSB0aGlzLnF1ZXJ5UGFyYW1ldGVycy5wcm9maWxlSWRcbiAgICAgIHx8IGZpcnN0Um91dGVQYXRoXG4gICAgICB8fCBnZXRGaXJzdEhhc2hSb3V0ZVBhdGgoZ2V0RnVsbFVybCgpKVxuICAgICAgfHwgdGhpcy5jb25maWcuZGVmYXVsdFByb2ZpbGVJZDtcblxuICAgIC8vIFdlIG92ZXJyaWRlIG1vZHVsZSBjb25maWd1cmF0aW9ucyBoZXJlIGJlY2F1c2UgdGhlIHVzZXIgbWF5IGJlIHRyeWluZyB0byBkZWJ1ZyB0aGUgc2Vzc2lvbi4gVGhlXG4gICAgLy8gb3ZlcnJpZGUgaGFzIHRvIGhhcHBlbiBhZ2FpbiBhdCB0aGUgZW5kIG9mIHRoZSBwcm9jZXNzIHRvIG92ZXJyaWRlIGFueSBzZXR0aW5ncyB0aGF0IG1heSBoYXZlXG4gICAgLy8gYmVlbiBzZXQgdGhyb3VnaCB0aGUgYXBwIGluaXRpYWxpemF0aW9uIHByb2Nlc3MuXG4gICAgdGhpcy5vdmVycmlkZU1vZHVsZUNvbmZpZ3VyYXRpb25zRnJvbVF1ZXJ5UGFyYW1zKCk7XG5cbiAgICB0aGlzLmxvZy5kZWJ1ZyhgSW5pdGlhbGl6aW5nIGFwcGxpY2F0aW9uIHdpdGggcHJvZmlsZSBJRDogJHtwcm9maWxlSWR9YCk7XG5cbiAgICAvLyBXZSBuZWVkIHRvIHRyeSBhbmQgcmVhZCBhbnkgc3RvcmVkIHNlY3VyaXR5IHRva2VuIGJlZm9yZSB3ZSBtYWtlXG4gICAgLy8gYSByZXF1ZXN0IHRvIGdldCBwcm9maWxlIGluZm8sIHNvIHRoYXQgdGhlIHJlcXVlc3QgaXMgYXV0aGVudGljYXRlZC5cbiAgICB0aGlzLmF1dGgubG9hZFN0b3JlZFRva2VuKCk7XG4gICAgdGhpcy5wb3B1bGF0ZU1vZHVsZUNvbmZpZ0luc3RhbmNlcygpO1xuXG4gICAgaWYgKCF0aGlzLmNvbmZpZy5xdWVyeVByb2ZpbGUgfHwgIXRoaXMuY29uZmlnLmhhc1NlcnZpY2VVcmwpIHtcbiAgICAgIHRoaXMuY29uZmlnLnByb2ZpbGUgPSB7XG4gICAgICAgIG5hbWU6ICcnLFxuICAgICAgICBhcHBJZCxcbiAgICAgICAgaWQ6IHByb2ZpbGVJZCxcbiAgICAgIH07XG5cbiAgICAgIHRoaXMubG9nLmRlYnVnKHRoaXMuY29uZmlnLmhhc1NlcnZpY2VVcmxcbiAgICAgICAgPyBgUHJvZmlsZSBxdWVyeSBza2lwcGVkIGR1ZSB0byBjb25maWd1cmF0aW9uIG9wdGlvbmBcbiAgICAgICAgOiBgTm8gc2VydmljZSBVUkwgY29uZmlndXJlZCwgY2FuJ3QgcmV0cmlldmUgcHJvZmlsZSBkZXRhaWxzIC0gc2tpcHBpbmcgcHJvZmlsZSByZXRyaWV2YWxgKTtcblxuICAgICAgdGhpcy5vdmVycmlkZU1vZHVsZUNvbmZpZ3VyYXRpb25zRnJvbVF1ZXJ5UGFyYW1zKCk7XG4gICAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgICAgIHRoaXMucmVzb2x2ZUZuKHRoaXMuY29uZmlnLnByb2ZpbGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuXG4gICAgICAvLyBXZSBuZWVkIHRvIHRyeSBhbmQgcmVhZCBhbnkgc3RvcmVkIHNlY3VyaXR5IHRva2VuIGJlZm9yZSB3ZSBtYWtlXG4gICAgICAvLyBhIHJlcXVlc3QgdG8gZ2V0IHByb2ZpbGUgaW5mbywgc28gdGhhdCB0aGUgcmVxdWVzdCBpcyBhdXRoZW50aWNhdGVkLlxuICAgICAgdGhpcy5xdWVyeVByb2ZpbGUocHJvZmlsZUlkKVxuICAgICAgICAudGhlbigocHJvZmlsZTogQXBwUHJvZmlsZSkgPT4gdGhpcy5yZXNvbHZlRm4ocHJvZmlsZSkpXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuY29uZmlnLmNvbnRpbnVlT25BcHBCb290c3RyYXBFcnJvcikge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlRm4odGhpcy5jb25maWcucHJvZmlsZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmVqZWN0Rm4oZXJyKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcXVlcnlQcm9maWxlKHByb2ZpbGVJZDogc3RyaW5nKTogUHJvbWlzZTxBcHBQcm9maWxlPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuYXBwUHJvZmlsZXMuZ2V0KHByb2ZpbGVJZClcbiAgICAgICAgLnN1YnNjcmliZSgocHJvZmlsZSkgPT4ge1xuICAgICAgICAgIGlmICghcHJvZmlsZSkge1xuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChgTm8gcHJvZmlsZSBmb3VuZCB3aXRoIElEICcke3Byb2ZpbGVJZH0nYCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5jb25maWcucHJvZmlsZUlkID0gcHJvZmlsZS5pZDtcbiAgICAgICAgICB0aGlzLmNvbmZpZy5wcm9maWxlID0gcHJvZmlsZTtcblxuICAgICAgICAgIHRoaXMuY2hlY2tUb2tlbkludmFsaWRhdGlvbkRhdGUoKTtcbiAgICAgICAgICB0aGlzLmFwcGx5TW9kdWxlQ29uZmlndXJhdGlvbnMoKTtcbiAgICAgICAgICB0aGlzLm92ZXJyaWRlTW9kdWxlQ29uZmlndXJhdGlvbnNGcm9tUXVlcnlQYXJhbXMoKTtcbiAgICAgICAgICB0aGlzLnJldHJpZXZlVXNlckFjY291bnQoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmNvbmZpZ3VyZVJvbGVNYW5hZ2VyKCk7XG4gICAgICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgcmVzb2x2ZShwcm9maWxlKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgIHRoaXMubG9nLmVycm9yKGBGYWlsZWQgdG8gcmV0cmlldmUgYXBwbGljYXRpb24gcHJvZmlsZSB3aXRoIGFwcCBJRCAnJHt0aGlzLmNvbmZpZy5hcHBJZH0nIGFuZCBJRCAnJHtwcm9maWxlSWR9J2ApO1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkYXRlIG9mIHRoZSBjYWNoZWQgXCJpbnZhbGlkYXRpb25cIiBkYXRlLlxuICAgKiBUaGUgaW52YWxpZGF0aW9uIGRhdGUgaXMgdXNlZCB0byBsZXQgdGhlIHNlcnZlciBmb3JjZSB1c2VycyB0byByZS1hdXRoZW50aWNhdGUuXG4gICAqL1xuICBwcml2YXRlIGdldENhY2hlZFRva2VuSW52YWxpZGF0aW9uRGF0ZSgpOiBEYXRlIHtcbiAgICByZXR1cm4gbmV3IERhdGUodGhpcy5zdG9yYWdlLmdldCh0aGlzLnNlY3VyaXR5Q29uZmlnLnRva2VuSW52YWxpZGF0aW9uRGF0ZUxvb2t1cCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhY2hlcyB0aGUgXCJpbnZhbGlkYXRpb25cIiBkYXRlLlxuICAgKiBUaGUgaW52YWxpZGF0aW9uIGRhdGUgaXMgdXNlZCB0byBsZXQgdGhlIHNlcnZlciBmb3JjZSB1c2VycyB0byByZS1hdXRoZW50aWNhdGUuXG4gICAqL1xuICBwcml2YXRlIHNldENhY2hlZFRva2VuRXhwaXJlRGF0ZShzZXREYXRlPzogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5sb2cuZGVidWcoYFNldHRpbmcgY2FjaGVkIHRva2VuIGludmFsaWRhdGlvbiBkYXRlOiAke3NldERhdGV9YCk7XG5cbiAgICBpZiAoc2V0RGF0ZSkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYFNldHRpbmcgdG9rZW4gaW52YWxpZGF0aW9uIGRhdGUgdG86ICR7c2V0RGF0ZX1gKTtcbiAgICAgIHRoaXMuc3RvcmFnZS5zZXQodGhpcy5zZWN1cml0eUNvbmZpZy50b2tlbkludmFsaWRhdGlvbkRhdGVMb29rdXAsIHNldERhdGUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlKHRoaXMuc2VjdXJpdHlDb25maWcudG9rZW5JbnZhbGlkYXRpb25EYXRlTG9va3VwKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ29tcGFyZXMgdGhlIGNhY2hlZCB0b2tlbiB2YWxpZGF0aW9uIGRhdGEgd2l0aCB0aGUgaW52YWxpZGF0aW9uIGRhdGUgZnJvbSB0aGUgc2VydmVyLlxuICAgKiBJZiB0aGUgaW52YWxpZGF0aW9uIGRhdGUgZnJvbSB0aGUgc2VydmVyIGlzIG5ldyB0aGFuIHRoZSBjYWNoZWQgZGF0ZSwgdGhlbiB0aGUgdXNlclxuICAgKiBtdXN0IGJlIGZvcmNpYmx5IHNpZ25lZCBvdXQuXG4gICAqL1xuICBwcml2YXRlIGNoZWNrVG9rZW5JbnZhbGlkYXRpb25EYXRlKCk6IHZvaWQge1xuICAgIGxldCB0b2tlbkV4cGlyZURhdGU7XG4gICAgY29uc3Qgc2l0ZUluZm8gPSB0aGlzLmNvbmZpZy5wcm9maWxlICYmIHRoaXMuY29uZmlnLnByb2ZpbGUuYXBwICYmIHRoaXMuY29uZmlnLnByb2ZpbGUuYXBwLnNpdGVJbmZvXG4gICAgICA/IHRoaXMuY29uZmlnLnByb2ZpbGUuYXBwLnNpdGVJbmZvXG4gICAgICA6IG51bGw7XG5cbiAgICBpZiAoc2l0ZUluZm8gJiYgc2l0ZUluZm9bQXBwSW5pdGlhbGl6ZXJTZXJ2aWNlLnRva2VuRXhwaXJlRGF0ZUtleV0pIHtcbiAgICAgIGNvbnN0IGxhc3RUb2tlbkludmFsaWRhdGVEYXRlID0gdGhpcy5nZXRDYWNoZWRUb2tlbkludmFsaWRhdGlvbkRhdGUoKTtcbiAgICAgIHRva2VuRXhwaXJlRGF0ZSA9IG5ldyBEYXRlKHNpdGVJbmZvW0FwcEluaXRpYWxpemVyU2VydmljZS50b2tlbkV4cGlyZURhdGVLZXldKTtcblxuICAgICAgLy8gTm90ZSwgd2UgYXJlIHNldHRpbmcgbWlsbGlzZWNvbmRzIHRvIDAgYmVjYXVzZSB3ZSBkb24ndCBjYXJlIGFib3V0IHRoYXQgbGV2ZWwgb2YgYWNjdXJhY3kuXG4gICAgICAvLyBBbHNvLCB0aGUgXCJzZXRNaWxsaXNlY29uZHNcIiBtZXRob2QgcmV0dXJucyB0aGUgXCJ0aW1lc3RhbXBcIiBzbyB3ZSBjYW4ganVzdCBjb21wYXJlIHRob3NlIHR3byByZXN1bHRzLlxuICAgICAgY29uc3QgbGFzdFRva2VuVmFsaWRhdGlvbkRhdGVzTWF0Y2ggPSBpc0RhdGUobGFzdFRva2VuSW52YWxpZGF0ZURhdGUpICYmIGlzRGF0ZSh0b2tlbkV4cGlyZURhdGUpXG4gICAgICAgID8gbGFzdFRva2VuSW52YWxpZGF0ZURhdGUuc2V0TWlsbGlzZWNvbmRzKDApID09PSB0b2tlbkV4cGlyZURhdGUuc2V0TWlsbGlzZWNvbmRzKDApXG4gICAgICAgIDogbGFzdFRva2VuSW52YWxpZGF0ZURhdGUgPT09IHRva2VuRXhwaXJlRGF0ZTtcblxuICAgICAgaWYgKHRoaXMuYXV0aC5hY2NvdW50ICYmIHRoaXMuYXV0aC5hY2NvdW50Lmxhc3RTaWduSW4gPCB0b2tlbkV4cGlyZURhdGUgJiYgIWxhc3RUb2tlblZhbGlkYXRpb25EYXRlc01hdGNoKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oJ1NpZ25pbmcgb3V0IHVzZXIgZHVlIHRvIHRva2VuIGludmFsaWRhdGlvbiBkYXRlIGZyb20gc2VjdXJpdHkgY29uZmlndXJhdGlvbicpO1xuICAgICAgICB0aGlzLmF1dGgub25TaWduZWRPdXQoKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5hdXRoLmFjY291bnQpIHtcbiAgICAgICAgdGhpcy5sb2cuZGVidWcoJ1VzZXIgaGFzIGJlZW4gYXV0aGVudGljYXRlZCBhZnRlciB0aGUgdG9rZW4gaW52YWxpZGF0aW9uIGRhdGUnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRva2VuRXhwaXJlRGF0ZSkge1xuICAgICAgICB0aGlzLnNldENhY2hlZFRva2VuRXhwaXJlRGF0ZSh0b2tlbkV4cGlyZURhdGUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGhlIHVzZXIgYWNjb3VudCBpZiB0aGUgdXNlciBpcyBhbHJlYWR5IHNpZ25lZCBpbiwgbG9ncyB0aGUgdXNlciBvdXQgaWZcbiAgICogdGhlIHRva2VuIGlzIGV4cGlyZWQsIG9yIHJlZnJlc2hlcyB0aGUgdXNlciBhY2NvdW50IGluZm9ybWF0aW9uIC0gZGVwZW5kaW5nIG9uXG4gICAqIHRoZSBjb25maWd1cmVkIGF1dGhlbnRpY2F0aW9uIHByb3ZpZGVyLlxuICAgKi9cbiAgcHJpdmF0ZSByZXRyaWV2ZVVzZXJBY2NvdW50KCk6IFByb21pc2U8VXNlckFjY291bnQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgbGV0IHF1ZXJ5aW5nSW5mbyA9IGZhbHNlO1xuICAgICAgICBjb25zdCBhcHAgPSB0aGlzLmNvbmZpZy5wcm9maWxlICYmIHRoaXMuY29uZmlnLnByb2ZpbGUuYXBwXG4gICAgICAgICAgPyB0aGlzLmNvbmZpZy5wcm9maWxlLmFwcCA6IG51bGw7XG5cbiAgICAgICAgLy8gSWYgdGhlIGxvY2FsIGF1dGggc3RhdHVzIHNheXMgdGhhdCBubyBvbmUgaXMgbG9nZ2VkIGluLCBidXQgdGhlIHNlcnZpY2UgaXMgcmVjb2duaXppbmcgdGhhdCBzb21lb25lIGlzXG4gICAgICAgIC8vIGxvZ2dlZCBpbiwgdGhlbiB0aGlzIG1lYW5zIHRoYXQgYXV0aGVudGljYXRpb24gaXMgaGFwcGVuaW5nIHRocm91Z2ggd2luZG93cyB2aWEgQWN0aXZlIERpcmVjdG9yeSBvciBzb21lXG4gICAgICAgIC8vIG90aGVyIG1lYW5zLiBXZSBuZWVkIHRvIGdldCB0aGUgdXNlciBpbmZvIHNvIHdlIGNhbiBzZXQgdGhlIGFwcCBcInN0YXRlXCIgYXMgXCJsb2dnZWQgaW5cIi5cbiAgICAgICAgaWYgKGFwcCAmJiBhcHAuc2VjdXJpdHkgJiYgIXRoaXMuYXV0aC5pc0F1dGhlbnRpY2F0ZWQgJiYgYXBwLnNlY3VyaXR5LmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgICAgIHRoaXMubG9nLmRlYnVnKCdSZXRyaWV2aW5nIGFkZGl0aW9uYWwgdXNlciBpbmZvIGRvIHRvIGF1dGhlbnRpY2F0aW9uIHN0YXRlJyk7XG4gICAgICAgICAgcXVlcnlpbmdJbmZvID0gdHJ1ZTtcbiAgICAgICAgICB0aGlzLmF1dGguZ2V0VXNlckluZm8oKS5zdWJzY3JpYmUoaW5mbyA9PiB7XG4gICAgICAgICAgICBjb25zdCBleHBpcmVzRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICBleHBpcmVzRGF0ZS5zZXREYXRlKGV4cGlyZXNEYXRlLmdldERhdGUoKSArIGFwcC5zZWN1cml0eS5hY2Nlc3NUb2tlbkV4cGlyZURheXMpO1xuICAgICAgICAgICAgdGhpcy5hdXRoLm9uU2lnbmVkSW4oT2JqZWN0LmFzc2lnbih7ICcuZXhwaXJlcyc6IGV4cGlyZXNEYXRlIH0sIGluZm8pKTtcbiAgICAgICAgICAgIHJlc29sdmUoaW5mbyk7XG4gICAgICAgICAgfSwgZXJyID0+IHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXV0aC5pc0F1dGhlbnRpY2F0ZWQgJiYgYXBwLnNlY3VyaXR5ICYmICFhcHAuc2VjdXJpdHkuaXNBdXRoZW50aWNhdGVkKSB7XG4gICAgICAgICAgdGhpcy5sb2cuZGVidWcoYFNpZ25pbmcgb3V0IHVzZXIgZG8gdG8gb3V0IG9mIHN5bmMgYXV0aGVudGljYXRpb24gc3RhdGVgKTtcbiAgICAgICAgICAvLyBTaWduIG91dC9jbGVhciB0aGUgYXV0aCBjYWNoZSBiZWNhdXNlIHRoZSBzZXJ2ZXIgc2F5cyB0aGV5IGRvbid0IGtub3cgd2hvIHRoaXMgaXMsIGJ1dFxuICAgICAgICAgIC8vIHRoZSBjbGllbnQgc2lkZSBjb2RlIHRoaW5rcyBpdCBrbm93cyB3aG8gaXQgaXMuXG4gICAgICAgICAgdGhpcy5hdXRoLm9uU2lnbmVkT3V0KCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXF1ZXJ5aW5nSW5mbykge1xuICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBObyByZXF1ZXN0IG1hZGUgZm9yIGFkZGl0aW9uYWwgdXNlciBhY2NvdW50IGluZm9gKTtcbiAgICAgICAgICByZXNvbHZlKHRoaXMuYXV0aC5hY2NvdW50KTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICB0aGlzLmxvZy5lcnJvcignRmFpbGVkIHRvIGRvIHByZS12ZXJpZmljYXRpb24gb2YgdXNlciBvbiBhcHAgbG9hZC4gezB9JywgZSk7XG4gICAgICAgIHJlamVjdChlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgbW9kdWxlIGNvbmZpZ3VyYXRpb24gcHJvcGVydGllcyBiYXNlZCBvbiBvdmVycmlkZXMgZnJvbSBhbiBvYmplY3QuXG4gICAqIFRoaXMgb2JqZWN0IGNhbiBjb21lIGZyb20gbXVsdGlwbGUgcGxhY2VzIC0gc3VjaCBhcyB0aGUgc2VydmVyIG9yIHF1ZXJ5IHBhcmFtcy5cbiAgICogU2VlOiB0aGUgXCJhcHBseU1vZHVsZUNvbmZpZ3VyYXRpb25zXCIgYW5kIFwib3ZlcnJpZGVNb2R1bGVDb25maWd1cmF0aW9uc1wiIG1ldGhvZHMuXG4gICAqL1xuICBwcml2YXRlIGFwcGx5TW9kdWxlQ29uZmlndXJhdGlvbnNGcm9tT2JqZWN0KHNvdXJjZU1hcHBpbmc6IGFueSkge1xuICAgIHNvdXJjZU1hcHBpbmcgPSBzb3VyY2VNYXBwaW5nIHx8IHt9O1xuICAgIHRoaXMubW9kdWxlQ29uZmlnSW5zdGFuY2VzXG4gICAgICAuZm9yRWFjaChjb25maWcgPT4ge1xuICAgICAgICBjb25zdCBtb2R1bGVDb25maWdOYW1lID0gY29uZmlnLmNvbmZpZy5jbGFzc05hbWU7XG4gICAgICAgIGNvbnN0IGNvbmZpZ0luc3RhbmNlID0gY29uZmlnLmluc3RhbmNlO1xuXG4gICAgICAgIE9iamVjdC5rZXlzKHNvdXJjZU1hcHBpbmcpXG4gICAgICAgICAgLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0b1ByaW1pdGl2ZVR5cGUoc291cmNlTWFwcGluZ1trZXldKTtcbiAgICAgICAgICAgIGNvbnN0IG1vZHVsZVByZWZpeCA9IGxvd2VyQ2FzZUZpcnN0KG1vZHVsZUNvbmZpZ05hbWUgKyAnLicpO1xuICAgICAgICAgICAgY29uc3Qgcm9vdEtleSA9IGtleS5yZXBsYWNlKG1vZHVsZVByZWZpeCwgJycpOyAvLyBUdXJuIGFwcENvbmZpZy5mb28uYmFyIC0tPiBmb28uYmFyXG5cbiAgICAgICAgICAgIGlmIChpc1ZhbHVlKHZhbHVlKSAmJiBrZXkudG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKG1vZHVsZVByZWZpeC50b0xvd2VyQ2FzZSgpKSkge1xuICAgICAgICAgICAgICAvLyBBIGNvbmZpZyBvYmplY3QgaGFzIHByb3BlcnRpZXMgaW4gb3VyIHNpdGVJbmZvIG9iamVjdC5cbiAgICAgICAgICAgICAgdGhpcy5sb2cuZGVidWcoYFNldHRpbmcgJHttb2R1bGVDb25maWdOYW1lfSBwcm9wZXJ0eSAnJHtyb290S2V5fScgdG8gJHt2YWx1ZX1gKTtcbiAgICAgICAgICAgICAgc2V0VmFsdWUoY29uZmlnSW5zdGFuY2UsIHJvb3RLZXksIHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBtb2R1bGUgY29uZmlndXJhdGlvbiBwcm9wZXJ0aWVzIGJhc2VkIG9uIG92ZXJyaWRlcyBmcm9tIHRoZSBzZXJ2ZXIuXG4gICAqIFRoaXMgZnVuY3Rpb25hbGl0eSBsZXRzIHVzIGR5bmFtaWNhbGx5IG92ZXJyaWRlIGNsaWVudCBzaWRlIGNvbmZpZ3VyYXRpb25cbiAgICogdGhyb3VnaCB0aGUgdXNlIG9mIFwiQXBwIFNldHRpbmdzXCIgZnJvbSB0aGUgc2VydmVyLlxuICAgKi9cbiAgcHJpdmF0ZSBhcHBseU1vZHVsZUNvbmZpZ3VyYXRpb25zKCk6IHZvaWQge1xuICAgIGNvbnN0IHByb2ZpbGUgPSB0aGlzLmNvbmZpZy5wcm9maWxlO1xuICAgIGlmICghcHJvZmlsZSB8fCAhcHJvZmlsZS5hcHAgfHwgIXByb2ZpbGUuYXBwLnNpdGVJbmZvKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5hcHBseU1vZHVsZUNvbmZpZ3VyYXRpb25zRnJvbU9iamVjdChwcm9maWxlLmFwcC5zaXRlSW5mbyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IG1vZHVsZSBjb25maWd1cmF0aW9uIHByb3BlcnRpZXMgYmFzZWQgb24gb3ZlcnJpZGVzIGZyb20gdGhlIFVSTCBxdWVyeSBwYXJhbWV0ZXJzLlxuICAgKiBUaGlzIGZ1bmN0aW9uYWxpdHkgbGV0cyB1cyBkeW5hbWljYWxseSBvdmVycmlkZSBjbGllbnQgc2lkZSBhbmQgc2VydmVyIHNpZGUgY29uZmlndXJhdGlvbnNcbiAgICogYnkgcGFzc2luZyBleHBsaWNpdCBzZXR0aW5ncyB0aHJvdWdoIHF1ZXJ5IHBhcmFtZXRlcnMuIEEgZ29vZCB1c2UgY2FzZSBmb3IgdGhpcyBpcyB0byBwYXNzXG4gICAqIFwiY29yZUNvbmZpZy5sb2dMZXZlbD0xXCIgYXMgYSBxdWVyeSBwYXJhbWV0ZXIgaW4gcHJvZHVjdGlvbiB0byBkZWJ1ZyBhbiBpc3N1ZSBpbiBhIHByb2R1Y3Rpb25cbiAgICogZW52aXJvbm1lbnQuXG4gICAqL1xuICBwcml2YXRlIG92ZXJyaWRlTW9kdWxlQ29uZmlndXJhdGlvbnNGcm9tUXVlcnlQYXJhbXMoKSB7XG4gICAgaWYgKHRoaXMuY29uZmlnLmFsbG93UXVlcnlQYXJhbUluamVjdGlvbnMpIHtcbiAgICAgIHRoaXMuYXBwbHlNb2R1bGVDb25maWd1cmF0aW9uc0Zyb21PYmplY3QodGhpcy5xdWVyeVBhcmFtZXRlcnMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnN0YW50aWF0ZXMgaW5zdGFuY2VzIG9mIGVhY2ggY29uZmlndXJlZCBtb2R1bGUgY29uZmlndXJhdGlvbiBvYmplY3QuIFByb3BlcnRpZXMgb2ZcbiAgICogdGhlc2UgbW9kdWxlIGNvbmZpZyBpbnN0YW5jZXMgd2lsbCBsYXRlciBiZSBzZXQgYmFzZWQgb24gc2VydmVyLXNpZGUgb3ZlcmlkZXMuXG4gICAqL1xuICBwcml2YXRlIHBvcHVsYXRlTW9kdWxlQ29uZmlnSW5zdGFuY2VzKCk6IHZvaWQge1xuICAgIENvcmVDb25maWcubW9kdWxlQ29uZmlnc1xuICAgICAgLmZvckVhY2gobW9kdWxlQXV0b0NvbmZpZyA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgLy8gUmVhc29uOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8yMjA2M1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxuICAgICAgICAgIGNvbnN0IGNvbmZpZ0luc3RhbmNlID0gdGhpcy5pbmplY3Rvci5nZXQobW9kdWxlQXV0b0NvbmZpZy5pbmplY3RvclRva2VuKTtcbiAgICAgICAgICB0aGlzLm1vZHVsZUNvbmZpZ0luc3RhbmNlcy5zZXQobW9kdWxlQXV0b0NvbmZpZy5pbmplY3RvclRva2VuLCB7XG4gICAgICAgICAgICBpbnN0YW5jZTogY29uZmlnSW5zdGFuY2UsXG4gICAgICAgICAgICBjb25maWc6IG1vZHVsZUF1dG9Db25maWdcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLmxvZy5kZWJ1ZyhgQ3JlYXRlZCBtb2R1bGUgY29uZmlndXJhdGlvbiBpbnN0YW5jZSBmb3I6ICR7bW9kdWxlQXV0b0NvbmZpZy5jbGFzc05hbWV9YCk7XG5cbiAgICAgICAgICBpZiAoJ3NlcnZpY2VVcmwnIGluIGNvbmZpZ0luc3RhbmNlIHx8ICdoYXNTZXJ2aWNlVXJsJyBpbiBjb25maWdJbnN0YW5jZSkge1xuICAgICAgICAgICAgY29uZmlnSW5zdGFuY2Uuc2VydmljZVVybCA9IHRoaXMuY29uZmlnLnNlcnZpY2VVcmw7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICB0aGlzLmxvZy5lcnJvcihgRmFpbGVkIHRvIGdldCBtb2R1bGUgY29uZmlnOiAke21vZHVsZUF1dG9Db25maWcuY2xhc3NOYW1lfWAsIGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgc2VjdXJpdHkgb3B0aW9ucyBiYXNlZCBvbiBpbmZvcm1hdGlvbiByZXRyaWV2ZWQgZm9ybSB0aGUgYXBwbGljYXRpb24gcHJvZmlsZS5cbiAgICogRm9yIGV4YW1wbGUsIHNlY3VyaXR5IG1heSBiZSBlbmFibGVkIG9yIGRpc2FibGVkLCBndWVzdCByb2xlcyB3aWxsIGJlIHNldCwgZXRjLlxuICAgKi9cbiAgcHJpdmF0ZSBjb25maWd1cmVSb2xlTWFuYWdlcigpOiB2b2lkIHtcbiAgICBjb25zdCBzZWN1cml0eSA9IHRoaXMuY29uZmlnLnByb2ZpbGUgJiYgdGhpcy5jb25maWcucHJvZmlsZS5hcHAgJiYgdGhpcy5jb25maWcucHJvZmlsZS5hcHAuc2VjdXJpdHlcbiAgICAgID8gdGhpcy5jb25maWcucHJvZmlsZS5hcHAuc2VjdXJpdHkgOiBudWxsO1xuXG4gICAgaWYgKCFzZWN1cml0eSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFdlIHdhbnQgdG8gZXhwbGljaXRseVxuICAgIGlmIChzZWN1cml0eS5oYXNPd25Qcm9wZXJ0eSgnZW5hYmxlZCcpKSB7XG4gICAgICB0aGlzLnNlY3VyaXR5Q29uZmlnLnJvbGVzRW5hYmxlZCA9ICEhc2VjdXJpdHkuZW5hYmxlZDtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucm9sZU1nci5lbmFibGVkKSB7XG4gICAgICB0aGlzLmxvZy53YXJuKCdTZWN1cml0eSBpcyBkaXNhYmxlZCcpO1xuICAgIH1cblxuICAgIHNlY3VyaXR5Lmd1ZXN0UHJpdmlsZWdlcyA9IHNlY3VyaXR5Lmd1ZXN0UHJpdmlsZWdlcyB8fCBbXTtcbiAgICB0aGlzLnJvbGVNZ3IuYWRkUm9sZXMoc2VjdXJpdHkuZ3Vlc3RQcml2aWxlZ2VzKTtcbiAgICB0aGlzLmxvZy5pbmZvKGBDb25maWd1cmVkIGRlZmF1bHQgcm9sZXMgKGd1ZXN0IHJvbGVzKSAtIHRvdGFsIG9mICR7c2VjdXJpdHkuZ3Vlc3RQcml2aWxlZ2VzLmxlbmd0aH1gKTtcbiAgICB0aGlzLmxvZy5pbmZvKGBVc2VyIGhhcyBhIHRvdGFsIG9mICR7dGhpcy5yb2xlTWdyLnJvbGVDb3VudH0gcm9sZXMgYXNzaWduZWQgdG8gdGhlbWApO1xuICB9XG59XG5cbi8qKlxuICogQXBwbGljYXRpb24gaW5pdGlhbGl6YXRpb24gZmFjdG9yeSB0aGF0IHByb3ZpZGVzIGEgaG9vayBpbnRvXG4gKiB0aGUgQW5ndWxhciBib290c3RyYXBwaW5nIHByb2Nlc3MuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBBcHBJbml0aWFsaXplckZhY3RvcnkoaW5qZWN0b3I6IEluamVjdG9yKTogKCkgPT4gUHJvbWlzZTxhbnk+IHtcbiAgcmV0dXJuICgpOiBQcm9taXNlPEFwcFByb2ZpbGU+ID0+IHtcbiAgICBjb25zdCBpbml0aWFsaXplcjogQXBwSW5pdGlhbGl6ZXJTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KEFwcEluaXRpYWxpemVyU2VydmljZSk7XG4gICAgaW5pdGlhbGl6ZXIuaW5pdGlhbGl6ZSgpO1xuXG4gICAgcmV0dXJuIGluaXRpYWxpemVyLm9uUmVhZHk7XG4gIH07XG59XG4iXX0=