/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { forkJoin, of } from 'rxjs';
import { map, tap, mergeMap } from 'rxjs/operators';
import { LrsMetadata } from './lrs-metadata';
import { MapServerMetadata } from '../maps/map-server-metadata';
import { mergeLrsMetadataSources } from './lrs-metadata-merge';
import { isString } from '../core/type-check/is-string.function';
export class LrsMetadataRetriever {
    /**
     * @param {?} http
     * @param {?} mapServer
     * @param {?} dataSourceService
     * @param {?} dataSourceLrsMetadataService
     * @param {?} notify
     * @param {?} log
     */
    constructor(http, mapServer, dataSourceService, dataSourceLrsMetadataService, notify, log) {
        this.http = http;
        this.mapServer = mapServer;
        this.dataSourceService = dataSourceService;
        this.dataSourceLrsMetadataService = dataSourceLrsMetadataService;
        this.notify = notify;
        this.log = log;
    }
    /**
     * @param {?} dataSource
     * @return {?}
     */
    withDataSource(dataSource) {
        if (isString(dataSource)) {
            this.dataSourceId = (/** @type {?} */ (dataSource));
        }
        else {
            this.dataSource = (/** @type {?} */ (dataSource));
            this.dataSourceId = this.dataSource.id;
        }
        return this;
    }
    /**
     * @param {?} lrsMeta
     * @return {?}
     */
    withLrsMetadata(lrsMeta) {
        this.dataSourceLrsMetadata = lrsMeta;
        return this;
    }
    /**
     * @return {?}
     */
    retrieve() {
        if (!this.dataSourceId) {
            throw new Error('A data source ID must be supplied');
        }
        return of(null)
            .pipe(mergeMap(this.getDataSource.bind(this)), mergeMap(this.getDataSourceLrsMetadata.bind(this)), mergeMap(this.getMapServiceLayers.bind(this)), mergeMap(this.getMapServiceLrsMetadata.bind(this)), mergeMap(this.mergeAll.bind(this)));
    }
    /**
     * @private
     * @return {?}
     */
    getDataSource() {
        /** @type {?} */
        const observable = this.dataSource
            ? of(this.dataSource)
            : this.dataSourceService
                .get(this.dataSourceId)
                .pipe(tap((/**
             * @param {?} dataSource
             * @return {?}
             */
            (dataSource) => this.dataSource = dataSource)));
        return this.notify
            .with(observable)
            .error(`Failed to retrieve data source by ID: ${this.dataSourceId}: {error}`)
            .source;
    }
    /**
     * @private
     * @return {?}
     */
    getDataSourceLrsMetadata() {
        /** @type {?} */
        const observable = this.dataSourceLrsMetadata
            ? of(this.dataSourceLrsMetadata)
            : this.dataSourceLrsMetadataService
                .get(this.dataSourceId)
                .pipe(tap((/**
             * @param {?} meta
             * @return {?}
             */
            (meta) => {
                this.dataSourceLrsMetadata = new LrsMetadata(this.dataSource)
                    .assign(meta);
                // NOTE: If we don't recieve any data source LRS metadata back then we assume that
                // the map service has LRS capabiliities - otherwise we have no LRS server data available.
                if (!meta) {
                    this.dataSourceLrsMetadata.serviceHasLrsMeta = true;
                }
            })));
        return this.notify
            .with(observable)
            .error(`Failed to retrieve data source LRS metadata by data source ID: ${this.dataSourceId}: {error}`)
            .source;
    }
    /**
     * @private
     * @return {?}
     */
    getMapServiceLayers() {
        /** @type {?} */
        const observable = this.mapServerMetadata || !this.dataSource.serviceUrl
            ? of(this.mapServerMetadata)
            : this.mapServer
                .getMapLayers(this.dataSource.serviceUrl)
                .pipe(tap((/**
             * @param {?} meta
             * @return {?}
             */
            (meta) => this.mapServerMetadata = new MapServerMetadata().assign(meta))));
        return this.notify
            .with(observable)
            .error(`Failed to retrieve map service metadata from URL: ${this.dataSource.serviceUrl}: {error}`)
            .source;
    }
    /**
     * @private
     * @return {?}
     */
    getMapServiceLrsMetadata() {
        /** @type {?} */
        const observable = !this.dataSource.serviceUrl || !this.dataSourceLrsMetadata.serviceHasLrsMeta
            ? of(this.mapServerLrsMetadata)
            : forkJoin([
                this.mapServer.getLrsServer(this.dataSource.serviceUrl),
                this.mapServer.getLrsLayers(this.dataSource.serviceUrl)
            ])
                .pipe(map((/**
             * @param {?} meta
             * @return {?}
             */
            (meta) => {
                const [lrsServerMeta, lrsLayersMeta] = meta;
                /** @type {?} */
                const lrsMetadata = Object.assign({}, lrsServerMeta, lrsLayersMeta);
                /** @type {?} */
                const mapServerLrsMetadata = new LrsMetadata().assign(lrsMetadata);
                return mapServerLrsMetadata;
            })), tap((/**
             * @param {?} meta
             * @return {?}
             */
            (meta) => this.mapServerLrsMetadata = new LrsMetadata().assign(meta))));
        return this.notify
            .with(observable)
            .error(`Failed to retrieve map service LRS metadata from URL: ${this.dataSource.serviceUrl}: {error}`)
            .source;
    }
    /**
     * @private
     * @return {?}
     */
    mergeAll() {
        /** @type {?} */
        const fullLrsMeta = mergeLrsMetadataSources(this.dataSource, this.dataSourceLrsMetadata, this.mapServerLrsMetadata, this.mapServerMetadata);
        return of(fullLrsMeta);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LrsMetadataRetriever.prototype.dataSourceId;
    /**
     * @type {?}
     * @private
     */
    LrsMetadataRetriever.prototype.dataSource;
    /**
     * @type {?}
     * @private
     */
    LrsMetadataRetriever.prototype.dataSourceLrsMetadata;
    /**
     * @type {?}
     * @private
     */
    LrsMetadataRetriever.prototype.mapServerMetadata;
    /**
     * @type {?}
     * @private
     */
    LrsMetadataRetriever.prototype.mapServerLrsMetadata;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.http;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.mapServer;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.dataSourceService;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.dataSourceLrsMetadataService;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.notify;
    /**
     * @type {?}
     * @protected
     */
    LrsMetadataRetriever.prototype.log;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHJzLW1ldGFkYXRhLXJldHJpZXZlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0c3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL2xycy9scnMtbWV0YWRhdGEtcmV0cmlldmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSxPQUFPLEVBQWMsUUFBUSxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHN0MsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFLaEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBR2pFLE1BQU0sT0FBTyxvQkFBb0I7Ozs7Ozs7OztJQU8vQixZQUNZLElBQWdCLEVBQ2hCLFNBQStCLEVBQy9CLGlCQUFvQyxFQUNwQyw0QkFBMEQsRUFDMUQsTUFBcUIsRUFDckIsR0FBVztRQUxYLFNBQUksR0FBSixJQUFJLENBQVk7UUFDaEIsY0FBUyxHQUFULFNBQVMsQ0FBc0I7UUFDL0Isc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQ0FBNEIsR0FBNUIsNEJBQTRCLENBQThCO1FBQzFELFdBQU0sR0FBTixNQUFNLENBQWU7UUFDckIsUUFBRyxHQUFILEdBQUcsQ0FBUTtJQUN2QixDQUFDOzs7OztJQUVNLGNBQWMsQ0FBQyxVQUErQjtRQUNuRCxJQUFJLFFBQVEsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUN4QixJQUFJLENBQUMsWUFBWSxHQUFHLG1CQUFBLFVBQVUsRUFBVSxDQUFDO1NBQzFDO2FBQU07WUFDTCxJQUFJLENBQUMsVUFBVSxHQUFHLG1CQUFBLFVBQVUsRUFBYyxDQUFDO1lBQzND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LENBQUMsb0JBQW9CLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FDdkY7UUFFTCxPQUFPLElBQUksQ0FBQyxNQUFNO2FBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQzthQUNoQixLQUFLLENBQUMseURBQXlELElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxXQUFXLENBQUM7YUFDckcsTUFBTSxDQUFDO0lBQ1osQ0FBQzs7Ozs7SUFFTyxRQUFROztjQUNSLFdBQVcsR0FBRyx1QkFBdUIsQ0FDekMsSUFBSSxDQUFDLFVBQVUsRUFDZixJQUFJLENBQUMscUJBQXFCLEVBQzFCLElBQUksQ0FBQyxvQkFBb0IsRUFDekIsSUFBSSxDQUFDLGlCQUFpQixDQUN2QjtRQUVELE9BQU8sRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3pCLENBQUM7Q0FDRjs7Ozs7O0lBcklDLDRDQUE2Qjs7Ozs7SUFDN0IsMENBQStCOzs7OztJQUMvQixxREFBMkM7Ozs7O0lBQzNDLGlEQUE2Qzs7Ozs7SUFDN0Msb0RBQTBDOzs7OztJQUd4QyxvQ0FBMEI7Ozs7O0lBQzFCLHlDQUF5Qzs7Ozs7SUFDekMsaURBQThDOzs7OztJQUM5Qyw0REFBb0U7Ozs7O0lBQ3BFLHNDQUErQjs7Ozs7SUFDL0IsbUNBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZm9ya0pvaW4sIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCwgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IExyc01ldGFkYXRhIH0gZnJvbSAnLi9scnMtbWV0YWRhdGEnO1xuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJy4uL2RhdGEtc291cmNlL2RhdGEtc291cmNlJztcbmltcG9ydCB7IERhdGFTb3VyY2VTZXJ2aWNlIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2UvZGF0YS1zb3VyY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBNYXBTZXJ2ZXJNZXRhZGF0YSB9IGZyb20gJy4uL21hcHMvbWFwLXNlcnZlci1tZXRhZGF0YSc7XG5pbXBvcnQgeyBEYXRhU291cmNlTHJzTWV0YWRhdGFTZXJ2aWNlIH0gZnJvbSAnLi9kYXRhLXNvdXJjZS1scnMtbWV0YWRhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9jb3JlL2xvZ2dpbmcvbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2NvcmUvbm90aWZ5L25vdGlmeS5zZXJ2aWNlJztcbmltcG9ydCB7IEVzcmlNYXBTZXJ2ZXJTZXJ2aWNlIH0gZnJvbSAnLi4vZXNyaS9lc3JpLW1hcC1zZXJ2ZXIuc2VydmljZSc7XG5pbXBvcnQgeyBtZXJnZUxyc01ldGFkYXRhU291cmNlcyB9IGZyb20gJy4vbHJzLW1ldGFkYXRhLW1lcmdlJztcbmltcG9ydCB7IGlzU3RyaW5nIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLXN0cmluZy5mdW5jdGlvbic7XG5cblxuZXhwb3J0IGNsYXNzIExyc01ldGFkYXRhUmV0cmlldmVyIHtcbiAgcHJpdmF0ZSBkYXRhU291cmNlSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSBkYXRhU291cmNlOiBEYXRhU291cmNlO1xuICBwcml2YXRlIGRhdGFTb3VyY2VMcnNNZXRhZGF0YTogTHJzTWV0YWRhdGE7XG4gIHByaXZhdGUgbWFwU2VydmVyTWV0YWRhdGE6IE1hcFNlcnZlck1ldGFkYXRhO1xuICBwcml2YXRlIG1hcFNlcnZlckxyc01ldGFkYXRhOiBMcnNNZXRhZGF0YTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCxcbiAgICBwcm90ZWN0ZWQgbWFwU2VydmVyOiBFc3JpTWFwU2VydmVyU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgZGF0YVNvdXJjZVNlcnZpY2U6IERhdGFTb3VyY2VTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBkYXRhU291cmNlTHJzTWV0YWRhdGFTZXJ2aWNlOiBEYXRhU291cmNlTHJzTWV0YWRhdGFTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBub3RpZnk6IE5vdGlmeVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGxvZzogTG9nZ2VyKSB7XG4gIH1cblxuICBwdWJsaWMgd2l0aERhdGFTb3VyY2UoZGF0YVNvdXJjZTogc3RyaW5nIHwgRGF0YVNvdXJjZSk6IExyc01ldGFkYXRhUmV0cmlldmVyIHtcbiAgICBpZiAoaXNTdHJpbmcoZGF0YVNvdXJjZSkpIHtcbiAgICAgIHRoaXMuZGF0YVNvdXJjZUlkID0gZGF0YVNvdXJjZSBhcyBzdHJpbmc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2UgYXMgRGF0YVNvdXJjZTtcbiAgICAgIHRoaXMuZGF0YVNvdXJjZUlkID0gdGhpcy5kYXRhU291cmNlLmlkO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHVibGljIHdpdGhMcnNNZXRhZGF0YShscnNNZXRhOiBMcnNNZXRhZGF0YSk6IExyc01ldGFkYXRhUmV0cmlldmVyIHtcbiAgICB0aGlzLmRhdGFTb3VyY2VMcnNNZXRhZGF0YSA9IGxyc01ldGE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwdWJsaWMgcmV0cmlldmUoKTogT2JzZXJ2YWJsZTxMcnNNZXRhZGF0YT4ge1xuICAgIGlmICghdGhpcy5kYXRhU291cmNlSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQSBkYXRhIHNvdXJjZSBJRCBtdXN0IGJlIHN1cHBsaWVkJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG9mKG51bGwpXG4gICAgICAucGlwZShcbiAgICAgICAgbWVyZ2VNYXAodGhpcy5nZXREYXRhU291cmNlLmJpbmQodGhpcykpLFxuICAgICAgICBtZXJnZU1hcCh0aGlzLmdldERhdGFTb3VyY2VMcnNNZXRhZGF0YS5iaW5kKHRoaXMpKSxcbiAgICAgICAgbWVyZ2VNYXAodGhpcy5nZXRNYXBTZXJ2aWNlTGF5ZXJzLmJpbmQodGhpcykpLFxuICAgICAgICBtZXJnZU1hcCh0aGlzLmdldE1hcFNlcnZpY2VMcnNNZXRhZGF0YS5iaW5kKHRoaXMpKSxcbiAgICAgICAgbWVyZ2VNYXAodGhpcy5tZXJnZUFsbC5iaW5kKHRoaXMpKVxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGF0YVNvdXJjZSgpOiBPYnNlcnZhYmxlPERhdGFTb3VyY2U+IHtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gdGhpcy5kYXRhU291cmNlXG4gICAgICA/IG9mKHRoaXMuZGF0YVNvdXJjZSlcbiAgICAgIDogdGhpcy5kYXRhU291cmNlU2VydmljZVxuICAgICAgICAuZ2V0KHRoaXMuZGF0YVNvdXJjZUlkKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICB0YXAoKGRhdGFTb3VyY2U6IERhdGFTb3VyY2UpID0+IHRoaXMuZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2UpXG4gICAgICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5ub3RpZnlcbiAgICAgIC53aXRoKG9ic2VydmFibGUpXG4gICAgICAuZXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSBkYXRhIHNvdXJjZSBieSBJRDogJHt0aGlzLmRhdGFTb3VyY2VJZH06IHtlcnJvcn1gKVxuICAgICAgLnNvdXJjZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGF0YVNvdXJjZUxyc01ldGFkYXRhKCk6IE9ic2VydmFibGU8THJzTWV0YWRhdGE+IHtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gdGhpcy5kYXRhU291cmNlTHJzTWV0YWRhdGFcbiAgICAgID8gb2YodGhpcy5kYXRhU291cmNlTHJzTWV0YWRhdGEpXG4gICAgICA6IHRoaXMuZGF0YVNvdXJjZUxyc01ldGFkYXRhU2VydmljZVxuICAgICAgICAuZ2V0KHRoaXMuZGF0YVNvdXJjZUlkKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICB0YXAoKG1ldGE6IExyc01ldGFkYXRhKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRhdGFTb3VyY2VMcnNNZXRhZGF0YSA9IG5ldyBMcnNNZXRhZGF0YSh0aGlzLmRhdGFTb3VyY2UpXG4gICAgICAgICAgICAgIC5hc3NpZ24obWV0YSk7XG5cbiAgICAgICAgICAgIC8vIE5PVEU6IElmIHdlIGRvbid0IHJlY2lldmUgYW55IGRhdGEgc291cmNlIExSUyBtZXRhZGF0YSBiYWNrIHRoZW4gd2UgYXNzdW1lIHRoYXRcbiAgICAgICAgICAgIC8vIHRoZSBtYXAgc2VydmljZSBoYXMgTFJTIGNhcGFiaWxpaXRpZXMgLSBvdGhlcndpc2Ugd2UgaGF2ZSBubyBMUlMgc2VydmVyIGRhdGEgYXZhaWxhYmxlLlxuICAgICAgICAgICAgaWYgKCFtZXRhKSB7XG4gICAgICAgICAgICAgIHRoaXMuZGF0YVNvdXJjZUxyc01ldGFkYXRhLnNlcnZpY2VIYXNMcnNNZXRhID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMubm90aWZ5XG4gICAgICAud2l0aChvYnNlcnZhYmxlKVxuICAgICAgLmVycm9yKGBGYWlsZWQgdG8gcmV0cmlldmUgZGF0YSBzb3VyY2UgTFJTIG1ldGFkYXRhIGJ5IGRhdGEgc291cmNlIElEOiAke3RoaXMuZGF0YVNvdXJjZUlkfToge2Vycm9yfWApXG4gICAgICAuc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNYXBTZXJ2aWNlTGF5ZXJzKCk6IE9ic2VydmFibGU8TWFwU2VydmVyTWV0YWRhdGE+IHtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gdGhpcy5tYXBTZXJ2ZXJNZXRhZGF0YSB8fCAhdGhpcy5kYXRhU291cmNlLnNlcnZpY2VVcmxcbiAgICAgID8gb2YodGhpcy5tYXBTZXJ2ZXJNZXRhZGF0YSlcbiAgICAgIDogdGhpcy5tYXBTZXJ2ZXJcbiAgICAgICAgLmdldE1hcExheWVycyh0aGlzLmRhdGFTb3VyY2Uuc2VydmljZVVybClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgdGFwKChtZXRhOiBNYXBTZXJ2ZXJNZXRhZGF0YSkgPT4gdGhpcy5tYXBTZXJ2ZXJNZXRhZGF0YSA9IG5ldyBNYXBTZXJ2ZXJNZXRhZGF0YSgpLmFzc2lnbihtZXRhKSlcbiAgICAgICAgKTtcblxuICAgIHJldHVybiB0aGlzLm5vdGlmeVxuICAgICAgLndpdGgob2JzZXJ2YWJsZSlcbiAgICAgIC5lcnJvcihgRmFpbGVkIHRvIHJldHJpZXZlIG1hcCBzZXJ2aWNlIG1ldGFkYXRhIGZyb20gVVJMOiAke3RoaXMuZGF0YVNvdXJjZS5zZXJ2aWNlVXJsfToge2Vycm9yfWApXG4gICAgICAuc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNYXBTZXJ2aWNlTHJzTWV0YWRhdGEoKTogT2JzZXJ2YWJsZTxMcnNNZXRhZGF0YT4ge1xuICAgIGNvbnN0IG9ic2VydmFibGUgPSAhdGhpcy5kYXRhU291cmNlLnNlcnZpY2VVcmwgfHwgIXRoaXMuZGF0YVNvdXJjZUxyc01ldGFkYXRhLnNlcnZpY2VIYXNMcnNNZXRhXG4gICAgICA/IG9mKHRoaXMubWFwU2VydmVyTHJzTWV0YWRhdGEpXG4gICAgICA6IGZvcmtKb2luKFtcbiAgICAgICAgdGhpcy5tYXBTZXJ2ZXIuZ2V0THJzU2VydmVyKHRoaXMuZGF0YVNvdXJjZS5zZXJ2aWNlVXJsKSxcbiAgICAgICAgdGhpcy5tYXBTZXJ2ZXIuZ2V0THJzTGF5ZXJzKHRoaXMuZGF0YVNvdXJjZS5zZXJ2aWNlVXJsKVxuICAgICAgXSlcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWFwKChtZXRhOiBMcnNNZXRhZGF0YVtdKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBbbHJzU2VydmVyTWV0YSwgbHJzTGF5ZXJzTWV0YV0gPSBtZXRhO1xuICAgICAgICAgICAgY29uc3QgbHJzTWV0YWRhdGEgPSBPYmplY3QuYXNzaWduKHt9LCBscnNTZXJ2ZXJNZXRhLCBscnNMYXllcnNNZXRhKTtcbiAgICAgICAgICAgIGNvbnN0IG1hcFNlcnZlckxyc01ldGFkYXRhID0gbmV3IExyc01ldGFkYXRhKCkuYXNzaWduKGxyc01ldGFkYXRhKTtcbiAgICAgICAgICAgIHJldHVybiBtYXBTZXJ2ZXJMcnNNZXRhZGF0YTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICB0YXAoKG1ldGE6IExyc01ldGFkYXRhKSA9PiB0aGlzLm1hcFNlcnZlckxyc01ldGFkYXRhID0gbmV3IExyc01ldGFkYXRhKCkuYXNzaWduKG1ldGEpKVxuICAgICAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMubm90aWZ5XG4gICAgICAud2l0aChvYnNlcnZhYmxlKVxuICAgICAgLmVycm9yKGBGYWlsZWQgdG8gcmV0cmlldmUgbWFwIHNlcnZpY2UgTFJTIG1ldGFkYXRhIGZyb20gVVJMOiAke3RoaXMuZGF0YVNvdXJjZS5zZXJ2aWNlVXJsfToge2Vycm9yfWApXG4gICAgICAuc291cmNlO1xuICB9XG5cbiAgcHJpdmF0ZSBtZXJnZUFsbCgpOiBPYnNlcnZhYmxlPExyc01ldGFkYXRhPiB7XG4gICAgY29uc3QgZnVsbExyc01ldGEgPSBtZXJnZUxyc01ldGFkYXRhU291cmNlcyhcbiAgICAgIHRoaXMuZGF0YVNvdXJjZSxcbiAgICAgIHRoaXMuZGF0YVNvdXJjZUxyc01ldGFkYXRhLFxuICAgICAgdGhpcy5tYXBTZXJ2ZXJMcnNNZXRhZGF0YSxcbiAgICAgIHRoaXMubWFwU2VydmVyTWV0YWRhdGFcbiAgICApO1xuXG4gICAgcmV0dXJuIG9mKGZ1bGxMcnNNZXRhKTtcbiAgfVxufVxuIl19