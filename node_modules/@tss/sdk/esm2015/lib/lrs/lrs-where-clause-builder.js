/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { WhereClauseBuilder, CriteriaOperator } from '../maps/where-clause-builder';
import { toUtcDate } from '../core/date-time/conversion/to-utc-date.function';
import { setDateToBeginningOfDay } from '../core/date-time/set-date-to-beginning-of-date.function';
import { getDateFormatForProvider } from '../data-source/get-date-format-for-provider.function';
import { format } from '../core/formatting/format.function';
import { formatDateForQuery } from '../core/date-time/format/format-date-for-query.function';
/** @type {?} */
export const NO_TEMPORAL_LAYER_SUPPLIED_ERROR_MSG = 'No LRS temporal layers supplied';
/** @type {?} */
export const NO_REFERENCE_LAYER_SUPPLIED_ERROR_MSG = 'No LRS reference layer supplied';
/** @type {?} */
export const LRS_DATE_WHERE_CLAUSE_TEMPLATE = '(({fromDateFieldName} IS NULL OR {fromDateFieldName} <= {dateEndOfDay})'
    + ' AND ({toDateFieldName} IS NULL OR {toDateFieldName} > {date}))';
/** @type {?} */
export const LRS_POINT_EVENT_WHERE_CLAUSE_TEMPLATE = `({fromMeasureFieldName} between {fromMeasure} and {toMeasure})`;
/** @type {?} */
export const LRS_LINEAR_EVENT_WHERE_CLAUSE_TEMPLATE = `(({fromMeasureFieldName} between {fromMeasure} AND {toMeasure})`
    + ` OR ({toMeasureFieldName} between {fromMeasure} AND {toMeasure}) OR ({fromMeasureFieldName} < {fromMeasure}`
    + ` AND {toMeasureFieldName} > {toMeasure})) AND NOT (({fromMeasureFieldName} < {fromMeasure}`
    + ` AND {toMeasureFieldName} <= {fromMeasure}) OR ({toMeasureFieldName} > {toMeasure} AND {fromMeasureFieldName} >= {toMeasure}))`;
/**
 * @param {?} fromDateFieldName
 * @param {?} toDateFieldName
 * @param {?=} dbType
 * @param {?=} viewDate
 * @return {?}
 */
export function getLrsViewDateWhereStatement(fromDateFieldName, toDateFieldName, dbType, viewDate) {
    viewDate = toUtcDate(viewDate || new Date());
    setDateToBeginningOfDay(viewDate);
    // TODO: Look into whether we need to actually use end of day or not
    // Currently we are just setting it to same as 'date' - RG.
    /** @type {?} */
    const dateFormat = getDateFormatForProvider(dbType);
    return format(LRS_DATE_WHERE_CLAUSE_TEMPLATE, {
        fromDateFieldName,
        toDateFieldName,
        date: formatDateForQuery(viewDate, dateFormat),
        dateEndOfDay: formatDateForQuery(viewDate, dateFormat),
    });
}
export class LrsWhereClauseBuilder extends WhereClauseBuilder {
    /**
     * @param {?=} options
     */
    constructor(options) {
        super(options);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceData
     * @return {THIS}
     */
    withDataSource(sourceData) {
        return (/** @type {?} */ (this)).withDataProvider(sourceData.providerName);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceDbType
     * @return {THIS}
     */
    withDataProvider(sourceDbType) {
        (/** @type {?} */ (this)).sourceDbType = sourceDbType;
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} eventLayer
     * @return {THIS}
     */
    withEventLayer(eventLayer) {
        return (/** @type {?} */ (this)).withTemporalLayer(eventLayer)
            .withReferenceLayer(eventLayer);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} referenceLayer
     * @return {THIS}
     */
    withReferenceLayer(referenceLayer) {
        (/** @type {?} */ (this)).referenceLayer = referenceLayer;
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} networkLayer
     * @return {THIS}
     */
    withNetworkLayer(networkLayer) {
        return (/** @type {?} */ (this)).withTemporalLayer(networkLayer);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} temporalLayer
     * @return {THIS}
     */
    withTemporalLayer(temporalLayer) {
        (/** @type {?} */ (this)).temporalLayer = temporalLayer;
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} routeId
     * @param {?=} routeIdFieldName
     * @return {THIS}
     */
    withRouteId(routeId, routeIdFieldName) {
        return (/** @type {?} */ (this)).where(routeIdFieldName || (/** @type {?} */ (this)).referenceLayer.routeIdFieldName, CriteriaOperator.Equals, routeId);
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?=} viewDate
     * @param {?=} fromDateFieldName
     * @param {?=} toDateFieldName
     * @return {THIS}
     */
    withViewDate(viewDate, fromDateFieldName, toDateFieldName) {
        if ((/** @type {?} */ (this)).temporalLayer) {
            fromDateFieldName = fromDateFieldName || (/** @type {?} */ (this)).temporalLayer.fromDateFieldName;
            toDateFieldName = toDateFieldName || (/** @type {?} */ (this)).temporalLayer.toDateFieldName;
        }
        /** @type {?} */
        const hasDateFieldInfo = Boolean((/** @type {?} */ (this)).temporalLayer || fromDateFieldName && toDateFieldName);
        if (!hasDateFieldInfo) {
            throw new Error(NO_TEMPORAL_LAYER_SUPPLIED_ERROR_MSG);
        }
        if (fromDateFieldName && toDateFieldName) {
            /** @type {?} */
            const dateClause = getLrsViewDateWhereStatement((/** @type {?} */ (this)).formatField(fromDateFieldName), (/** @type {?} */ (this)).formatField(toDateFieldName), (/** @type {?} */ (this)).sourceDbType, viewDate);
            (/** @type {?} */ (this)).add(dateClause);
        }
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} fromMeasure
     * @param {?} toMeasure
     * @param {?=} fromMeasureFieldName
     * @param {?=} toMeasureFieldName
     * @return {THIS}
     */
    betweenMeasures(fromMeasure, toMeasure, fromMeasureFieldName, toMeasureFieldName) {
        if ((/** @type {?} */ (this)).referenceLayer) {
            fromMeasureFieldName = fromMeasureFieldName || (/** @type {?} */ (this)).referenceLayer.fromMeasureFieldName;
            toMeasureFieldName = toMeasureFieldName || (/** @type {?} */ (this)).referenceLayer.toMeasureFieldName;
        }
        /** @type {?} */
        const hasMeasureFieldInfo = Boolean((/** @type {?} */ (this)).referenceLayer || fromMeasureFieldName);
        if (!hasMeasureFieldInfo) {
            throw new Error(NO_REFERENCE_LAYER_SUPPLIED_ERROR_MSG);
        }
        /** @type {?} */
        const whereTemplate = toMeasureFieldName
            ? LRS_LINEAR_EVENT_WHERE_CLAUSE_TEMPLATE
            : LRS_POINT_EVENT_WHERE_CLAUSE_TEMPLATE;
        /** @type {?} */
        const measureClause = format(whereTemplate, {
            fromMeasureFieldName: (/** @type {?} */ (this)).formatField(fromMeasureFieldName),
            toMeasureFieldName: (/** @type {?} */ (this)).formatField(toMeasureFieldName),
            fromMeasure,
            toMeasure,
        });
        return (/** @type {?} */ (this)).add(measureClause);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.temporalLayer;
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.referenceLayer;
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.sourceDbType;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHJzLXdoZXJlLWNsYXVzZS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvbHJzL2xycy13aGVyZS1jbGF1c2UtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUE2QixNQUFNLDhCQUE4QixDQUFDO0FBSy9HLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUM5RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwwREFBMEQsQ0FBQztBQUVuRyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxzREFBc0QsQ0FBQztBQUNoRyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seURBQXlELENBQUM7O0FBRzdGLE1BQU0sT0FBTyxvQ0FBb0MsR0FBRyxpQ0FBaUM7O0FBQ3JGLE1BQU0sT0FBTyxxQ0FBcUMsR0FBRyxpQ0FBaUM7O0FBQ3RGLE1BQU0sT0FBTyw4QkFBOEIsR0FBRyx5RUFBeUU7TUFDbkgsaUVBQWlFOztBQUNyRSxNQUFNLE9BQU8scUNBQXFDLEdBQUcsZ0VBQWdFOztBQUNySCxNQUFNLE9BQU8sc0NBQXNDLEdBQUcsaUVBQWlFO01BQ25ILDZHQUE2RztNQUM3Ryw0RkFBNEY7TUFDNUYsZ0lBQWdJOzs7Ozs7OztBQUdwSSxNQUFNLFVBQVUsNEJBQTRCLENBQzFDLGlCQUF5QixFQUN6QixlQUF1QixFQUN2QixNQUErQixFQUMvQixRQUFlO0lBRWYsUUFBUSxHQUFHLFNBQVMsQ0FBQyxRQUFRLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7O1VBSTVCLFVBQVUsR0FBRyx3QkFBd0IsQ0FBQyxNQUFNLENBQUM7SUFFbkQsT0FBTyxNQUFNLENBQUMs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QUFBLENBQUM7SUFDZCxDQUFDOzs7Ozs7Ozs7O0lBRUQsZUFBZSxDQUFDLFdBQW1CLEVBQUUsU0FBaUIsRUFBRSxvQkFBNkIsRUFBRSxrQkFBMkI7UUFDaEgsSUFBSSxtQkFBQSxJQUFJLEVBQUEsQ0FBQyxjQUFjLEVBQUU7WUFDdkIsb0JBQW9CLEdBQUcsb0JBQW9CLElBQUksbUJBQUEsSUFBSSxFQUFBLENBQUMsY0FBYyxDQUFDLG9CQUFvQixDQUFDO1lBQ3hGLGtCQUFrQixHQUFHLGtCQUFrQixJQUFJLG1CQUFBLElBQUksRUFBQSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQztTQUNuRjs7Y0FFSyxtQkFBbUIsR0FBRyxPQUFPLENBQUMsbUJBQUEsSUFBSSxFQUFBLENBQUMsY0FBYyxJQUFJLG9CQUFvQixDQUFDO1FBQ2hGLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7U0FDeEQ7O2NBRUssYUFBYSxHQUFHLGtCQUFrQjtZQUN0QyxDQUFDLENBQUMsc0NBQXNDO1lBQ3hDLENBQUMsQ0FBQyxxQ0FBcUM7O2NBRW5DLGFBQWEsR0FBRyxNQUFNLENBQUMsYUFBYSxFQUFFO1lBQzFDLG9CQUFvQixFQUFFLG1CQUFBLElBQUksRUFBQSxDQUFDLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQztZQUM1RCxrQkFBa0IsRUFBRSxtQkFBQSxJQUFJLEVBQUEsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUM7WUFDeEQsV0FBVztZQUNYLFNBQVM7U0FDVixDQUFDO1FBRUYsT0FBTyxtQkFBQSxJQUFJLEVBQUEsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDakMsQ0FBQztDQUNGOzs7Ozs7SUExRkMsOENBQXFDOzs7OztJQUNyQywrQ0FBMEM7Ozs7O0lBQzFDLDZDQUE2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFdoZXJlQ2xhdXNlQnVpbGRlciwgQ3JpdGVyaWFPcGVyYXRvciwgV2hlcmVDbGF1c2VCdWlsZGVyT3B0aW9ucyB9IGZyb20gJy4uL21hcHMvd2hlcmUtY2xhdXNlLWJ1aWxkZXInO1xuaW1wb3J0IHsgTHJzUmVmZXJlbmNlTGF5ZXIsIFRlbXBvcmFsTGF5ZXIgfSBmcm9tICcuL2xycy1sYXllcic7XG5pbXBvcnQgeyBOZXR3b3JrTGF5ZXIgfSBmcm9tICcuL25ldHdvcmtzL25ldHdvcmstbGF5ZXInO1xuaW1wb3J0IHsgRXZlbnRMYXllciB9IGZyb20gJy4vZXZlbnRzL2V2ZW50LWxheWVyJztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICcuLi9kYXRhLXNvdXJjZS9kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyB0b1V0Y0RhdGUgfSBmcm9tICcuLi9jb3JlL2RhdGUtdGltZS9jb252ZXJzaW9uL3RvLXV0Yy1kYXRlLmZ1bmN0aW9uJztcbmltcG9ydCB7IHNldERhdGVUb0JlZ2lubmluZ09mRGF5IH0gZnJvbSAnLi4vY29yZS9kYXRlLXRpbWUvc2V0LWRhdGUtdG8tYmVnaW5uaW5nLW9mLWRhdGUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgRGF0YVNvdXJjZVByb3ZpZGVyVHlwZSB9IGZyb20gJy4uL2RhdGEtc291cmNlL2RhdGEtc291cmNlLXByb3ZpZGVyLXR5cGUnO1xuaW1wb3J0IHsgZ2V0RGF0ZUZvcm1hdEZvclByb3ZpZGVyIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2UvZ2V0LWRhdGUtZm9ybWF0LWZvci1wcm92aWRlci5mdW5jdGlvbic7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9jb3JlL2Zvcm1hdHRpbmcvZm9ybWF0LmZ1bmN0aW9uJztcbmltcG9ydCB7IGZvcm1hdERhdGVGb3JRdWVyeSB9IGZyb20gJy4uL2NvcmUvZGF0ZS10aW1lL2Zvcm1hdC9mb3JtYXQtZGF0ZS1mb3ItcXVlcnkuZnVuY3Rpb24nO1xuXG5cbmV4cG9ydCBjb25zdCBOT19URU1QT1JBTF9MQVlFUl9TVVBQTElFRF9FUlJPUl9NU0cgPSAnTm8gTFJTIHRlbXBvcmFsIGxheWVycyBzdXBwbGllZCc7XG5leHBvcnQgY29uc3QgTk9fUkVGRVJFTkNFX0xBWUVSX1NVUFBMSUVEX0VSUk9SX01TRyA9ICdObyBMUlMgcmVmZXJlbmNlIGxheWVyIHN1cHBsaWVkJztcbmV4cG9ydCBjb25zdCBMUlNfREFURV9XSEVSRV9DTEFVU0VfVEVNUExBVEUgPSAnKCh7ZnJvbURhdGVGaWVsZE5hbWV9IElTIE5VTEwgT1Ige2Zyb21EYXRlRmllbGROYW1lfSA8PSB7ZGF0ZUVuZE9mRGF5fSknXG4gICsgJyBBTkQgKHt0b0RhdGVGaWVsZE5hbWV9IElTIE5VTEwgT1Ige3RvRGF0ZUZpZWxkTmFtZX0gPiB7ZGF0ZX0pKSc7XG5leHBvcnQgY29uc3QgTFJTX1BPSU5UX0VWRU5UX1dIRVJFX0NMQVVTRV9URU1QTEFURSA9IGAoe2Zyb21NZWFzdXJlRmllbGROYW1lfSBiZXR3ZWVuIHtmcm9tTWVhc3VyZX0gYW5kIHt0b01lYXN1cmV9KWA7XG5leHBvcnQgY29uc3QgTFJTX0xJTkVBUl9FVkVOVF9XSEVSRV9DTEFVU0VfVEVNUExBVEUgPSBgKCh7ZnJvbU1lYXN1cmVGaWVsZE5hbWV9IGJldHdlZW4ge2Zyb21NZWFzdXJlfSBBTkQge3RvTWVhc3VyZX0pYFxuICArIGAgT1IgKHt0b01lYXN1cmVGaWVsZE5hbWV9IGJldHdlZW4ge2Zyb21NZWFzdXJlfSBBTkQge3RvTWVhc3VyZX0pIE9SICh7ZnJvbU1lYXN1cmVGaWVsZE5hbWV9IDwge2Zyb21NZWFzdXJlfWBcbiAgKyBgIEFORCB7dG9NZWFzdXJlRmllbGROYW1lfSA+IHt0b01lYXN1cmV9KSkgQU5EIE5PVCAoKHtmcm9tTWVhc3VyZUZpZWxkTmFtZX0gPCB7ZnJvbU1lYXN1cmV9YFxuICArIGAgQU5EIHt0b01lYXN1cmVGaWVsZE5hbWV9IDw9IHtmcm9tTWVhc3VyZX0pIE9SICh7dG9NZWFzdXJlRmllbGROYW1lfSA+IHt0b01lYXN1cmV9IEFORCB7ZnJvbU1lYXN1cmVGaWVsZE5hbWV9ID49IHt0b01lYXN1cmV9KSlgO1xuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRMcnNWaWV3RGF0ZVdoZXJlU3RhdGVtZW50KFxuICBmcm9tRGF0ZUZpZWxkTmFtZTogc3RyaW5nLFxuICB0b0RhdGVGaWVsZE5hbWU6IHN0cmluZyxcbiAgZGJUeXBlPzogRGF0YVNvdXJjZVByb3ZpZGVyVHlwZSxcbiAgdmlld0RhdGU/OiBEYXRlXG4pOiBzdHJpbmcge1xuICB2aWV3RGF0ZSA9IHRvVXRjRGF0ZSh2aWV3RGF0ZSB8fCBuZXcgRGF0ZSgpKTtcbiAgc2V0RGF0ZVRvQmVnaW5uaW5nT2ZEYXkodmlld0RhdGUpO1xuXG4gIC8vIFRPRE86IExvb2sgaW50byB3aGV0aGVyIHdlIG5lZWQgdG8gYWN0dWFsbHkgdXNlIGVuZCBvZiBkYXkgb3Igbm90XG4gIC8vIEN1cnJlbnRseSB3ZSBhcmUganVzdCBzZXR0aW5nIGl0IHRvIHNhbWUgYXMgJ2RhdGUnIC0gUkcuXG4gIGNvbnN0IGRhdGVGb3JtYXQgPSBnZXREYXRlRm9ybWF0Rm9yUHJvdmlkZXIoZGJUeXBlKTtcblxuICByZXR1cm4gZm9ybWF0KExSU19EQVRFX1dIRVJFX0NMQVVTRV9URU1QTEFURSwge1xuICAgIGZyb21EYXRlRmllbGROYW1lLFxuICAgIHRvRGF0ZUZpZWxkTmFtZSxcbiAgICBkYXRlOiBmb3JtYXREYXRlRm9yUXVlcnkodmlld0RhdGUsIGRhdGVGb3JtYXQpLFxuICAgIGRhdGVFbmRPZkRheTogZm9ybWF0RGF0ZUZvclF1ZXJ5KHZpZXdEYXRlLCBkYXRlRm9ybWF0KSxcbiAgfSk7XG59XG5cbmV4cG9ydCBjbGFzcyBMcnNXaGVyZUNsYXVzZUJ1aWxkZXIgZXh0ZW5kcyBXaGVyZUNsYXVzZUJ1aWxkZXIge1xuICAvLyBwcml2YXRlIG5ldHdvcmtMYXllcjogTmV0d29ya0xheWVyO1xuICAvLyBwcml2YXRlIGV2ZW50TGF5ZXI6IEV2ZW50TGF5ZXI7XG4gIHByaXZhdGUgdGVtcG9yYWxMYXllcjogVGVtcG9yYWxMYXllcjtcbiAgcHJpdmF0ZSByZWZlcmVuY2VMYXllcjogTHJzUmVmZXJlbmNlTGF5ZXI7XG4gIHByaXZhdGUgc291cmNlRGJUeXBlOiBEYXRhU291cmNlUHJvdmlkZXJUeXBlO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBXaGVyZUNsYXVzZUJ1aWxkZXJPcHRpb25zKSB7XG4gICAgc3VwZXIob3B0aW9ucyk7XG4gIH1cblxuICB3aXRoRGF0YVNvdXJjZShzb3VyY2VEYXRhOiBEYXRhU291cmNlKTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXMud2l0aERhdGFQcm92aWRlcihzb3VyY2VEYXRhLnByb3ZpZGVyTmFtZSk7XG4gIH1cblxuICB3aXRoRGF0YVByb3ZpZGVyKHNvdXJjZURiVHlwZTogRGF0YVNvdXJjZVByb3ZpZGVyVHlwZSk6IHRoaXMge1xuICAgIHRoaXMuc291cmNlRGJUeXBlID0gc291cmNlRGJUeXBlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2l0aEV2ZW50TGF5ZXIoZXZlbnRMYXllcjogRXZlbnRMYXllcik6IHRoaXMge1xuICAgIHJldHVybiB0aGlzXG4gICAgICAud2l0aFRlbXBvcmFsTGF5ZXIoZXZlbnRMYXllcilcbiAgICAgIC53aXRoUmVmZXJlbmNlTGF5ZXIoZXZlbnRMYXllcik7XG4gIH1cblxuICB3aXRoUmVmZXJlbmNlTGF5ZXIocmVmZXJlbmNlTGF5ZXI6IExyc1JlZmVyZW5jZUxheWVyKTogdGhpcyB7XG4gICAgdGhpcy5yZWZlcmVuY2VMYXllciA9IHJlZmVyZW5jZUxheWVyO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2l0aE5ldHdvcmtMYXllcihuZXR3b3JrTGF5ZXI6IE5ldHdvcmtMYXllcik6IHRoaXMge1xuICAgIHJldHVybiB0aGlzLndpdGhUZW1wb3JhbExheWVyKG5ldHdvcmtMYXllcik7XG4gIH1cblxuICB3aXRoVGVtcG9yYWxMYXllcih0ZW1wb3JhbExheWVyOiBUZW1wb3JhbExheWVyKTogdGhpcyB7XG4gICAgdGhpcy50ZW1wb3JhbExheWVyID0gdGVtcG9yYWxMYXllcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHdpdGhSb3V0ZUlkKHJvdXRlSWQ6IHN0cmluZyB8IG51bWJlciwgcm91dGVJZEZpZWxkTmFtZT86IHN0cmluZyk6IHRoaXMge1xuICAgIHJldHVybiB0aGlzLndoZXJlKHJvdXRlSWRGaWVsZE5hbWUgfHwgdGhpcy5yZWZlcmVuY2VMYXllci5yb3V0ZUlkRmllbGROYW1lLCBDcml0ZXJpYU9wZXJhdG9yLkVxdWFscywgcm91dGVJZCk7XG4gIH1cblxuICB3aXRoVmlld0RhdGUodmlld0RhdGU/OiBEYXRlLCBmcm9tRGF0ZUZpZWxkTmFtZT86IHN0cmluZywgdG9EYXRlRmllbGROYW1lPzogc3RyaW5nKTogdGhpcyB7XG4gICAgaWYgKHRoaXMudGVtcG9yYWxMYXllcikge1xuICAgICAgZnJvbURhdGVGaWVsZE5hbWUgPSBmcm9tRGF0ZUZpZWxkTmFtZSB8fCB0aGlzLnRlbXBvcmFsTGF5ZXIuZnJvbURhdGVGaWVsZE5hbWU7XG4gICAgICB0b0RhdGVGaWVsZE5hbWUgPSB0b0RhdGVGaWVsZE5hbWUgfHwgdGhpcy50ZW1wb3JhbExheWVyLnRvRGF0ZUZpZWxkTmFtZTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNEYXRlRmllbGRJbmZvID0gQm9vbGVhbih0aGlzLnRlbXBvcmFsTGF5ZXIgfHwgZnJvbURhdGVGaWVsZE5hbWUgJiYgdG9EYXRlRmllbGROYW1lKTtcbiAgICBpZiAoIWhhc0RhdGVGaWVsZEluZm8pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihOT19URU1QT1JBTF9MQVlFUl9TVVBQTElFRF9FUlJPUl9NU0cpO1xuICAgIH1cblxuICAgIGlmIChmcm9tRGF0ZUZpZWxkTmFtZSAmJiB0b0RhdGVGaWVsZE5hbWUpIHtcbiAgICAgIGNvbnN0IGRhdGVDbGF1c2UgPSBnZXRMcnNWaWV3RGF0ZVdoZXJlU3RhdGVtZW50KFxuICAgICAgICB0aGlzLmZvcm1hdEZpZWxkKGZyb21EYXRlRmllbGROYW1lKSxcbiAgICAgICAgdGhpcy5mb3JtYXRGaWVsZCh0b0RhdGVGaWVsZE5hbWUpLFxuICAgICAgICB0aGlzLnNvdXJjZURiVHlwZSxcbiAgICAgICAgdmlld0RhdGVcbiAgICAgICk7XG5cbiAgICAgIHRoaXMuYWRkKGRhdGVDbGF1c2UpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgYmV0d2Vlbk1lYXN1cmVzKGZyb21NZWFzdXJlOiBudW1iZXIsIHRvTWVhc3VyZTogbnVtYmVyLCBmcm9tTWVhc3VyZUZpZWxkTmFtZT86IHN0cmluZywgdG9NZWFzdXJlRmllbGROYW1lPzogc3RyaW5nKTogdGhpcyB7XG4gICAgaWYgKHRoaXMucmVmZXJlbmNlTGF5ZXIpIHtcbiAgICAgIGZyb21NZWFzdXJlRmllbGROYW1lID0gZnJvbU1lYXN1cmVGaWVsZE5hbWUgfHwgdGhpcy5yZWZlcmVuY2VMYXllci5mcm9tTWVhc3VyZUZpZWxkTmFtZTtcbiAgICAgIHRvTWVhc3VyZUZpZWxkTmFtZSA9IHRvTWVhc3VyZUZpZWxkTmFtZSB8fCB0aGlzLnJlZmVyZW5jZUxheWVyLnRvTWVhc3VyZUZpZWxkTmFtZTtcbiAgICB9XG5cbiAgICBjb25zdCBoYXNNZWFzdXJlRmllbGRJbmZvID0gQm9vbGVhbih0aGlzLnJlZmVyZW5jZUxheWVyIHx8IGZyb21NZWFzdXJlRmllbGROYW1lKTtcbiAgICBpZiAoIWhhc01lYXN1cmVGaWVsZEluZm8pIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihOT19SRUZFUkVOQ0VfTEFZRVJfU1VQUExJRURfRVJST1JfTVNHKTtcbiAgICB9XG5cbiAgICBjb25zdCB3aGVyZVRlbXBsYXRlID0gdG9NZWFzdXJlRmllbGROYW1lXG4gICAgICA/IExSU19MSU5FQVJfRVZFTlRfV0hFUkVfQ0xBVVNFX1RFTVBMQVRFXG4gICAgICA6IExSU19QT0lOVF9FVkVOVF9XSEVSRV9DTEFVU0VfVEVNUExBVEU7XG5cbiAgICBjb25zdCBtZWFzdXJlQ2xhdXNlID0gZm9ybWF0KHdoZXJlVGVtcGxhdGUsIHtcbiAgICAgIGZyb21NZWFzdXJlRmllbGROYW1lOiB0aGlzLmZvcm1hdEZpZWxkKGZyb21NZWFzdXJlRmllbGROYW1lKSxcbiAgICAgIHRvTWVhc3VyZUZpZWxkTmFtZTogdGhpcy5mb3JtYXRGaWVsZCh0b01lYXN1cmVGaWVsZE5hbWUpLFxuICAgICAgZnJvbU1lYXN1cmUsXG4gICAgICB0b01lYXN1cmUsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5hZGQobWVhc3VyZUNsYXVzZSk7XG4gIH1cbn1cbiJdfQ==