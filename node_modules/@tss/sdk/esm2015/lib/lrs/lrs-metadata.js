/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { IntersectionLayer } from './intersections/intersection-layer';
import { EventLayer } from './events/event-layer';
import { NetworkLayer } from './networks/network-layer';
import { RedlineLayer } from './redlines/redline-layer';
import { CenterlineLayer } from './centerlines/centerline-layer';
import { CalibrationPointLayer } from './calibration-points/calibration-point-layer';
import { MapServerMetadata } from '../maps/map-server-metadata';
import { getGeometryField, getIdField } from '../maps/fields/layer-field';
import { findLayer } from './layer-search';
import { mergeMapMetadata, mergeLrsMetadata, deepMergeMapMetadata } from './lrs-metadata-merge';
import { LRS_METADATA_VALIDATIONS } from './lrs-metadata-validations';
import { NonLrsLayer } from './non-lrs/non-lrs-layer';
import { isNotValue } from '../core/type-check/is-not-value.function';
import { clone } from '../core/clone/clone.function';
/**
 * @param {?} layerId
 * @param {...?} layerList
 * @return {?}
 */
function find(layerId, ...layerList) {
    return findLayer(layerId, ...layerList);
}
export class LrsMetadata extends MapServerMetadata {
    /**
     * @param {?=} dataSource
     */
    constructor(dataSource) {
        super();
        this.networkLayers = [];
        this.eventLayers = [];
        this.redlineLayers = [];
        this.centerlineLayers = [];
        this.calibrationPointLayers = [];
        this.intersectionLayers = [];
        this.nonLRSLayers = [];
        this.lrs = [];
        this.domains = [];
        if (dataSource) {
            this.dataSource = dataSource;
            this.dataSourceId = dataSource.id;
        }
    }
    /**
     * Gets a layer by ID - searching across all types (event layers, network layers, etc).
     * @param {?} layerId
     * @return {?}
     */
    getLayer(layerId) {
        return find(layerId, this.getAllLayers());
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    getLrsLayer(layerId) {
        return (/** @type {?} */ ((find(layerId, this.networkLayers, this.eventLayers, this.redlineLayers))));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    getLayerDetail(layerId) {
        // TODO: Come up with a better way to check these layer types.
        // NOTE: We are doing all of these boolean checks instead of just simply calling
        // isEventLayer = this.isEventLayer(layerId) because of performance reasons.
        /** @type {?} */
        const isLrsLayer = this.isLrsLayer(layerId);
        /** @type {?} */
        const isEventLayer = this.isEventLayer(layerId);
        /** @type {?} */
        const isNetworkLayer = !isEventLayer && this.isNetworkLayer(layerId);
        /** @type {?} */
        const isCalibrationPointLayer = !isEventLayer && !isNetworkLayer && this.isCalibrationPointLayer(layerId);
        /** @type {?} */
        const isCenterlineLayer = !isEventLayer && !isNetworkLayer && !isCalibrationPointLayer && this.isCenterlineLayer(layerId);
        /** @type {?} */
        const isIntersectionLayer = !isEventLayer && !isNetworkLayer && !isCalibrationPointLayer && !isCenterlineLayer
            && this.isIntersectionLayer(layerId);
        /** @type {?} */
        const isRedlineLayer = !isEventLayer && !isNetworkLayer && !isCalibrationPointLayer && !isCenterlineLayer && !isIntersectionLayer
            && this.isRedlineLayer(layerId);
        /** @type {?} */
        const isTable = !isEventLayer && !isNetworkLayer && !isCalibrationPointLayer && !isCenterlineLayer && !isIntersectionLayer
            && !isRedlineLayer && this.isTable(layerId);
        /** @type {?} */
        const isNonLRSLayer = !isEventLayer && !isNetworkLayer && !isCalibrationPointLayer && !isCenterlineLayer && !isIntersectionLayer
            && !isRedlineLayer && !isTable && this.isNonLRSLayer(layerId);
        /** @type {?} */
        const layer = this.getLayer(layerId);
        /** @type {?} */
        const shapeField = layer ? getGeometryField(layer.fields) : null;
        /** @type {?} */
        const idField = layer ? getIdField(layer.fields) : null;
        return {
            layer,
            layerId,
            isEventLayer,
            isNetworkLayer,
            isCalibrationPointLayer,
            isCenterlineLayer,
            isIntersectionLayer,
            isRedlineLayer,
            isTable,
            isNonLRSLayer,
            isLrsLayer,
            shapeField,
            idField,
        };
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isLrsLayer(layerId) {
        return Boolean(this.getLrsLayer(layerId));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isNetworkLayer(layerId) {
        return Boolean(find(layerId, this.networkLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isEventLayer(layerId) {
        return Boolean(find(layerId, this.eventLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isIntersectionLayer(layerId) {
        return Boolean(find(layerId, this.intersectionLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isRedlineLayer(layerId) {
        return Boolean(find(layerId, this.redlineLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isCenterlineLayer(layerId) {
        return Boolean(find(layerId, this.centerlineLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isCalibrationPointLayer(layerId) {
        return Boolean(find(layerId, this.calibrationPointLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isNonLRSLayer(layerId) {
        return Boolean(find(layerId, this.nonLRSLayers));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    isTable(layerId) {
        return Boolean(find(layerId, this.tables));
    }
    /**
     * Merges map server general information into this LRS metadata instance.
     * @param {?} mapMetadata
     * @return {?}
     */
    mergeMapMetadata(mapMetadata) {
        mergeMapMetadata(this, mapMetadata);
        return this;
    }
    /**
     * @param {?} mapMetadata
     * @return {?}
     */
    deepMergeMapMetadata(mapMetadata) {
        deepMergeMapMetadata(this, mapMetadata);
        return this;
    }
    /**
     * Merges other LRS metadata into this LRS metdata instance.
     * @param {?} lrsMetadata
     * @return {?}
     */
    mergeLrsMetadata(lrsMetadata) {
        mergeLrsMetadata(this, lrsMetadata);
        return this;
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    getNetworkLayer(layerId) {
        return (/** @type {?} */ (find(layerId, this.networkLayers)));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    getEventLayer(layerId) {
        return (/** @type {?} */ (find(layerId, this.eventLayers)));
    }
    /**
     * @param {?} layerId
     * @return {?}
     */
    getIntersectionLayer(layerId) {
        return (/** @type {?} */ (find(layerId, this.intersectionLayers)));
    }
    /**
     * @return {?}
     */
    getLrsLayers() {
        return ((/** @type {?} */ (this.eventLayers)))
            .concat(this.networkLayers)
            .concat(this.redlineLayers);
    }
    /**
     * @return {?}
     */
    getFeatureClassLayers() {
        return ((/** @type {?} */ (this.eventLayers)))
            .concat(this.networkLayers)
            .concat(this.redlineLayers)
            .concat(this.calibrationPointLayers)
            .concat(this.centerlineLayers)
            .concat(this.nonLRSLayers);
    }
    /**
     * @return {?}
     */
    getAllLayers() {
        return ((/** @type {?} */ (this.getFeatureClassLayers())))
            .concat(this.tables)
            .concat(this.layers);
    }
    /**
     * @param {?} layer
     * @return {?}
     */
    getNetworkIdForLayer(layer) {
        /** @type {?} */
        let networkId = null;
        if (this.isEventLayer(layer.id)) {
            /** @type {?} */
            const eventLayer = (/** @type {?} */ (layer));
            networkId = eventLayer.parentNetwork ? eventLayer.parentNetwork.id : null;
        }
        if (isNotValue(networkId)) {
            this.networkLayers.forEach((/**
             * @param {?} network
             * @return {?}
             */
            network => {
                if (network.eventLayers.find((/**
                 * @param {?} l
                 * @return {?}
                 */
                l => l.id === layer.id))) {
                    networkId = network.id;
                }
            }));
        }
        return networkId;
    }
    /**
     * @param {?} networkLayerId
     * @return {?}
     */
    getEventLayersByNetwork(networkLayerId) {
        /** @type {?} */
        const networkLayer = this.getNetworkLayer(networkLayerId);
        return this.eventLayers.filter((/**
         * @param {?} layer
         * @return {?}
         */
        layer => layer.parentNetwork
            && layer.parentNetwork.id === networkLayerId
            || networkLayer.eventLayers
                && networkLayer.eventLayers.find((/**
                 * @param {?} l
                 * @return {?}
                 */
                l => l.id === layer.id))));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    rebuildLayers() {
        (/** @type {?} */ (this)).eventLayers = (/** @type {?} */ (this)).eventLayers.map((/**
         * @param {?} eventLayer
         * @return {?}
         */
        eventLayer => new EventLayer(find(eventLayer.id, (/** @type {?} */ (this)).layers), eventLayer)));
        (/** @type {?} */ (this)).networkLayers = (/** @type {?} */ (this)).networkLayers.map((/**
         * @param {?} networkLayer
         * @return {?}
         */
        networkLayer => new NetworkLayer(find(networkLayer.id, (/** @type {?} */ (this)).layers), networkLayer)));
        (/** @type {?} */ (this)).redlineLayers = (/** @type {?} */ (this)).redlineLayers.map((/**
         * @param {?} redlineLayer
         * @return {?}
         */
        redlineLayer => new RedlineLayer(find(redlineLayer.id, (/** @type {?} */ (this)).layers), redlineLayer)));
        (/** @type {?} */ (this)).centerlineLayers = (/** @type {?} */ (this)).centerlineLayers.map((/**
         * @param {?} centerlineLayer
         * @return {?}
         */
        centerlineLayer => new CenterlineLayer(centerlineLayer)));
        (/** @type {?} */ (this)).calibrationPointLayers = (/** @type {?} */ (this)).calibrationPointLayers.map((/**
         * @param {?} calibrationPointLayer
         * @return {?}
         */
        calibrationPointLayer => new CalibrationPointLayer(calibrationPointLayer)));
        (/** @type {?} */ (this)).intersectionLayers = (/** @type {?} */ (this)).intersectionLayers.map((/**
         * @param {?} intersectionLayer
         * @return {?}
         */
        intersectionLayer => new IntersectionLayer(intersectionLayer)));
        (/** @type {?} */ (this)).nonLRSLayers = (/** @type {?} */ (this)).nonLRSLayers.map((/**
         * @param {?} nonLrsLayer
         * @return {?}
         */
        nonLrsLayer => new NonLrsLayer(find(nonLrsLayer.id, (/** @type {?} */ (this)).layers), nonLrsLayer)));
        return (/** @type {?} */ (this)).assignCodedValueDomainsToFields();
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    assignCodedValueDomainsToFields() {
        if ((/** @type {?} */ (this)).domains.length) {
            (/** @type {?} */ (this)).getFeatureClassLayers()
                .forEach((/**
             * @param {?} layer
             * @return {?}
             */
            layer => layer.applyFieldDomains((/** @type {?} */ (this)).domains)));
        }
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} source
     * @return {THIS}
     */
    assign(source) {
        Object.assign((/** @type {?} */ (this)), source);
        return (/** @type {?} */ (this));
    }
    /**
     * @return {?}
     */
    clone() {
        /** @type {?} */
        const copy = clone(this);
        return new LrsMetadata()
            .assign(copy)
            .rebuildLayers();
    }
    /**
     * @return {?}
     */
    validate() {
        return LRS_METADATA_VALIDATIONS
            .check(this);
    }
}
if (false) {
    /** @type {?} */
    LrsMetadata.prototype.dataSource;
    /** @type {?} */
    LrsMetadata.prototype.dataSourceId;
    /** @type {?} */
    LrsMetadata.prototype.name;
    /** @type {?} */
    LrsMetadata.prototype.serviceHasLrsMeta;
    /** @type {?} */
    LrsMetadata.prototype.networkLayers;
    /** @type {?} */
    LrsMetadata.prototype.eventLayers;
    /** @type {?} */
    LrsMetadata.prototype.redlineLayers;
    /** @type {?} */
    LrsMetadata.prototype.centerlineLayers;
    /** @type {?} */
    LrsMetadata.prototype.calibrationPointLayers;
    /** @type {?} */
    LrsMetadata.prototype.intersectionLayers;
    /** @type {?} */
    LrsMetadata.prototype.nonLRSLayers;
    /** @type {?} */
    LrsMetadata.prototype.lrs;
    /** @type {?} */
    LrsMetadata.prototype.domains;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHJzLW1ldGFkYXRhLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvbHJzL2xycy1tZXRhZGF0YS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBRUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFDdkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3JGLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2hFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxVQUFVLEVBQW9CLE1BQU0sNEJBQTRCLENBQUM7QUFLNUYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2hHLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUV0RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDdEUsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7Ozs7QUFJckQsU0FBUyxJQUFJLENBQUMsT0FBZSxFQUFFLEdBQUcsU0FBdUI7SUFDdkQsT0FBTyxTQUFTLENBQUMsT0FBTyxFQUFFLEdBQUcsU0FBUyxDQUFDLENBQUM7QUFDMUMsQ0FBQztBQUdELE1BQU0s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QUFDO0lBQ2hELENBQUM7Ozs7OztJQUVELCtCQUErQjtRQUM3QixJQUFJLG1CQUFBLElBQUksRUFBQSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFDdkIsbUJBQUEsSUFBSSxFQUFBLENBQUMscUJBQXFCLEVBQUU7aUJBQ3pCLE9BQU87Ozs7WUFBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxtQkFBQSxJQUFJLEVBQUEsQ0FBQyxPQUFPLENBQUMsRUFBQyxDQUFDO1NBQzVEO1FBRUQsT0FBTyxtQkFBQSxJQUFJLEVBQUEsQ0FBQztJQUNkLENBQUM7Ozs7Ozs7SUFFRCxNQUFNLENBQUMsTUFBVztRQUNoQixNQUFNLENBQUMsTUFBTSxDQUFDLG1CQUFBLElBQUksRUFBQSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVCLE9BQU8sbUJBQUEsSUFBSSxFQUFBLENBQUM7SUFDZCxDQUFDOzs7O0lBRUQsS0FBSzs7Y0FDRyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQztRQUN4QixPQUFPLElBQUksV0FBVyxFQUFFO2FBQ3JCLE1BQU0sQ0FBQyxJQUFJLENBQUM7YUFDWixhQUFhLEVBQUUsQ0FBQztJQUNyQixDQUFDOzs7O0lBRUQsUUFBUTtRQUNOLE9BQU8sd0JBQXdCO2FBQzVCLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNqQixDQUFDO0NBQ0Y7OztJQXpPQyxpQ0FBdUI7O0lBQ3ZCLG1DQUFxQjs7SUFDckIsMkJBQWE7O0lBQ2Isd0NBQTJCOztJQUMzQixvQ0FBbUM7O0lBQ25DLGtDQUErQjs7SUFDL0Isb0NBQW1DOztJQUNuQyx1Q0FBeUM7O0lBQ3pDLDZDQUFxRDs7SUFDckQseUNBQTZDOztJQUM3QyxtQ0FBdUM7O0lBQ3ZDLDBCQUFvQjs7SUFDcEIsOEJBQWlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJy4uL2RhdGEtc291cmNlL2RhdGEtc291cmNlJztcbmltcG9ydCB7IEZlYXR1cmVDbGFzc0xheWVyIH0gZnJvbSAnLi4vbWFwcy9mZWF0dXJlLWNsYXNzLWxheWVyJztcbmltcG9ydCB7IEludGVyc2VjdGlvbkxheWVyIH0gZnJvbSAnLi9pbnRlcnNlY3Rpb25zL2ludGVyc2VjdGlvbi1sYXllcic7XG5pbXBvcnQgeyBFdmVudExheWVyIH0gZnJvbSAnLi9ldmVudHMvZXZlbnQtbGF5ZXInO1xuaW1wb3J0IHsgTmV0d29ya0xheWVyIH0gZnJvbSAnLi9uZXR3b3Jrcy9uZXR3b3JrLWxheWVyJztcbmltcG9ydCB7IFJlZGxpbmVMYXllciB9IGZyb20gJy4vcmVkbGluZXMvcmVkbGluZS1sYXllcic7XG5pbXBvcnQgeyBDZW50ZXJsaW5lTGF5ZXIgfSBmcm9tICcuL2NlbnRlcmxpbmVzL2NlbnRlcmxpbmUtbGF5ZXInO1xuaW1wb3J0IHsgQ2FsaWJyYXRpb25Qb2ludExheWVyIH0gZnJvbSAnLi9jYWxpYnJhdGlvbi1wb2ludHMvY2FsaWJyYXRpb24tcG9pbnQtbGF5ZXInO1xuaW1wb3J0IHsgTWFwU2VydmVyTWV0YWRhdGEgfSBmcm9tICcuLi9tYXBzL21hcC1zZXJ2ZXItbWV0YWRhdGEnO1xuaW1wb3J0IHsgZ2V0R2VvbWV0cnlGaWVsZCwgZ2V0SWRGaWVsZCwgTGF5ZXJGaWVsZERvbWFpbiB9IGZyb20gJy4uL21hcHMvZmllbGRzL2xheWVyLWZpZWxkJztcbmltcG9ydCB7IE1hcExheWVyIH0gZnJvbSAnLi4vbWFwcy9tYXAtbGF5ZXInO1xuaW1wb3J0IHsgTHJzTGF5ZXIgfSBmcm9tICcuL2xycy1sYXllcic7XG5pbXBvcnQgeyBMcnNMYXllckRldGFpbCB9IGZyb20gJy4vbHJzLWxheWVyLWRldGFpbCc7XG5pbXBvcnQgeyBMcnNJbmZvIH0gZnJvbSAnLi9scnMtaW5mbyc7XG5pbXBvcnQgeyBmaW5kTGF5ZXIgfSBmcm9tICcuL2xheWVyLXNlYXJjaCc7XG5pbXBvcnQgeyBtZXJnZU1hcE1ldGFkYXRhLCBtZXJnZUxyc01ldGFkYXRhLCBkZWVwTWVyZ2VNYXBNZXRhZGF0YSB9IGZyb20gJy4vbHJzLW1ldGFkYXRhLW1lcmdlJztcbmltcG9ydCB7IExSU19NRVRBREFUQV9WQUxJREFUSU9OUyB9IGZyb20gJy4vbHJzLW1ldGFkYXRhLXZhbGlkYXRpb25zJztcbmltcG9ydCB7IE5vbkxyc0xheWVyIH0gZnJvbSAnLi9ub24tbHJzL25vbi1scnMtbGF5ZXInO1xuaW1wb3J0IHsgQ2xvbmVhYmxlIH0gZnJvbSAnLi4vY29yZS9jbG9uZS9jbG9uZWFibGUnO1xuaW1wb3J0IHsgaXNOb3RWYWx1ZSB9IGZyb20gJy4uL2NvcmUvdHlwZS1jaGVjay9pcy1ub3QtdmFsdWUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgY2xvbmUgfSBmcm9tICcuLi9jb3JlL2Nsb25lL2Nsb25lLmZ1bmN0aW9uJztcbmltcG9ydCB7IFZhbGlkYXRpb25SZXN1bHQgfSBmcm9tICcuLi9jb3JlL3ZhbGlkYXRpb24vdmFsaWRhdGlvbi1yZXN1bHRzJztcblxuXG5mdW5jdGlvbiBmaW5kKGxheWVySWQ6IG51bWJlciwgLi4ubGF5ZXJMaXN0OiBNYXBMYXllcltdW10pOiBNYXBMYXllciB7XG4gIHJldHVybiBmaW5kTGF5ZXIobGF5ZXJJZCwgLi4ubGF5ZXJMaXN0KTtcbn1cblxuXG5leHBvcnQgY2xhc3MgTHJzTWV0YWRhdGEgZXh0ZW5kcyBNYXBTZXJ2ZXJNZXRhZGF0YSBpbXBsZW1lbnRzIENsb25lYWJsZTxMcnNNZXRhZGF0YT4ge1xuICBkYXRhU291cmNlOiBEYXRhU291cmNlO1xuICBkYXRhU291cmNlSWQ6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICBzZXJ2aWNlSGFzTHJzTWV0YTogYm9vbGVhbjtcbiAgbmV0d29ya0xheWVyczogTmV0d29ya0xheWVyW10gPSBbXTtcbiAgZXZlbnRMYXllcnM6IEV2ZW50TGF5ZXJbXSA9IFtdO1xuICByZWRsaW5lTGF5ZXJzOiBSZWRsaW5lTGF5ZXJbXSA9IFtdO1xuICBjZW50ZXJsaW5lTGF5ZXJzOiBDZW50ZXJsaW5lTGF5ZXJbXSA9IFtdO1xuICBjYWxpYnJhdGlvblBvaW50TGF5ZXJzOiBDYWxpYnJhdGlvblBvaW50TGF5ZXJbXSA9IFtdO1xuICBpbnRlcnNlY3Rpb25MYXllcnM6IEludGVyc2VjdGlvbkxheWVyW10gPSBbXTtcbiAgbm9uTFJTTGF5ZXJzOiBGZWF0dXJlQ2xhc3NMYXllcltdID0gW107XG4gIGxyczogTHJzSW5mb1tdID0gW107XG4gIGRvbWFpbnM6IExheWVyRmllbGREb21haW5bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKGRhdGFTb3VyY2U/OiBEYXRhU291cmNlKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIGlmIChkYXRhU291cmNlKSB7XG4gICAgICB0aGlzLmRhdGFTb3VyY2UgPSBkYXRhU291cmNlO1xuICAgICAgdGhpcy5kYXRhU291cmNlSWQgPSBkYXRhU291cmNlLmlkO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGEgbGF5ZXIgYnkgSUQgLSBzZWFyY2hpbmcgYWNyb3NzIGFsbCB0eXBlcyAoZXZlbnQgbGF5ZXJzLCBuZXR3b3JrIGxheWVycywgZXRjKS5cbiAgICovXG4gIGdldExheWVyKGxheWVySWQ6IG51bWJlcik6IE1hcExheWVyIHtcbiAgICByZXR1cm4gZmluZChsYXllcklkLCB0aGlzLmdldEFsbExheWVycygpKTtcbiAgfVxuXG4gIGdldExyc0xheWVyKGxheWVySWQ6IG51bWJlcik6IExyc0xheWVyIHtcbiAgICByZXR1cm4gKFxuICAgICAgZmluZChsYXllcklkLCB0aGlzLm5ldHdvcmtMYXllcnMsIHRoaXMuZXZlbnRMYXllcnMsIHRoaXMucmVkbGluZUxheWVycylcbiAgICApIGFzIExyc0xheWVyO1xuICB9XG5cbiAgZ2V0TGF5ZXJEZXRhaWwobGF5ZXJJZDogbnVtYmVyKTogTHJzTGF5ZXJEZXRhaWwge1xuICAgIC8vIFRPRE86IENvbWUgdXAgd2l0aCBhIGJldHRlciB3YXkgdG8gY2hlY2sgdGhlc2UgbGF5ZXIgdHlwZXMuXG4gICAgLy8gTk9URTogV2UgYXJlIGRvaW5nIGFsbCBvZiB0aGVzZSBib29sZWFuIGNoZWNrcyBpbnN0ZWFkIG9mIGp1c3Qgc2ltcGx5IGNhbGxpbmdcbiAgICAvLyBpc0V2ZW50TGF5ZXIgPSB0aGlzLmlzRXZlbnRMYXllcihsYXllcklkKSBiZWNhdXNlIG9mIHBlcmZvcm1hbmNlIHJlYXNvbnMuXG4gICAgY29uc3QgaXNMcnNMYXllciA9IHRoaXMuaXNMcnNMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBpc0V2ZW50TGF5ZXIgPSB0aGlzLmlzRXZlbnRMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBpc05ldHdvcmtMYXllciA9ICFpc0V2ZW50TGF5ZXIgJiYgdGhpcy5pc05ldHdvcmtMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBpc0NhbGlicmF0aW9uUG9pbnRMYXllciA9ICFpc0V2ZW50TGF5ZXIgJiYgIWlzTmV0d29ya0xheWVyICYmIHRoaXMuaXNDYWxpYnJhdGlvblBvaW50TGF5ZXIobGF5ZXJJZCk7XG4gICAgY29uc3QgaXNDZW50ZXJsaW5lTGF5ZXIgPSAhaXNFdmVudExheWVyICYmICFpc05ldHdvcmtMYXllciAmJiAhaXNDYWxpYnJhdGlvblBvaW50TGF5ZXIgJiYgdGhpcy5pc0NlbnRlcmxpbmVMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBpc0ludGVyc2VjdGlvbkxheWVyID0gIWlzRXZlbnRMYXllciAmJiAhaXNOZXR3b3JrTGF5ZXIgJiYgIWlzQ2FsaWJyYXRpb25Qb2ludExheWVyICYmICFpc0NlbnRlcmxpbmVMYXllclxuICAgICAgJiYgdGhpcy5pc0ludGVyc2VjdGlvbkxheWVyKGxheWVySWQpO1xuICAgIGNvbnN0IGlzUmVkbGluZUxheWVyID0gIWlzRXZlbnRMYXllciAmJiAhaXNOZXR3b3JrTGF5ZXIgJiYgIWlzQ2FsaWJyYXRpb25Qb2ludExheWVyICYmICFpc0NlbnRlcmxpbmVMYXllciAmJiAhaXNJbnRlcnNlY3Rpb25MYXllclxuICAgICAgJiYgdGhpcy5pc1JlZGxpbmVMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBpc1RhYmxlID0gIWlzRXZlbnRMYXllciAmJiAhaXNOZXR3b3JrTGF5ZXIgJiYgIWlzQ2FsaWJyYXRpb25Qb2ludExheWVyICYmICFpc0NlbnRlcmxpbmVMYXllciAmJiAhaXNJbnRlcnNlY3Rpb25MYXllclxuICAgICAgJiYgIWlzUmVkbGluZUxheWVyICYmIHRoaXMuaXNUYWJsZShsYXllcklkKTtcbiAgICBjb25zdCBpc05vbkxSU0xheWVyID0gIWlzRXZlbnRMYXllciAmJiAhaXNOZXR3b3JrTGF5ZXIgJiYgIWlzQ2FsaWJyYXRpb25Qb2ludExheWVyICYmICFpc0NlbnRlcmxpbmVMYXllciAmJiAhaXNJbnRlcnNlY3Rpb25MYXllclxuICAgICAgJiYgIWlzUmVkbGluZUxheWVyICYmICFpc1RhYmxlICYmIHRoaXMuaXNOb25MUlNMYXllcihsYXllcklkKTtcbiAgICBjb25zdCBsYXllcjogTWFwTGF5ZXIgPSB0aGlzLmdldExheWVyKGxheWVySWQpO1xuICAgIGNvbnN0IHNoYXBlRmllbGQgPSBsYXllciA/IGdldEdlb21ldHJ5RmllbGQobGF5ZXIuZmllbGRzKSA6IG51bGw7XG4gICAgY29uc3QgaWRGaWVsZCA9IGxheWVyID8gZ2V0SWRGaWVsZChsYXllci5maWVsZHMpIDogbnVsbDtcblxuICAgIHJldHVybiB7XG4gICAgICBsYXllcixcbiAgICAgIGxheWVySWQsXG4gICAgICBpc0V2ZW50TGF5ZXIsXG4gICAgICBpc05ldHdvcmtMYXllcixcbiAgICAgIGlzQ2FsaWJyYXRpb25Qb2ludExheWVyLFxuICAgICAgaXNDZW50ZXJsaW5lTGF5ZXIsXG4gICAgICBpc0ludGVyc2VjdGlvbkxheWVyLFxuICAgICAgaXNSZWRsaW5lTGF5ZXIsXG4gICAgICBpc1RhYmxlLFxuICAgICAgaXNOb25MUlNMYXllcixcbiAgICAgIGlzTHJzTGF5ZXIsXG4gICAgICBzaGFwZUZpZWxkLFxuICAgICAgaWRGaWVsZCxcbiAgICB9O1xuICB9XG5cbiAgaXNMcnNMYXllcihsYXllcklkOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihcbiAgICAgIHRoaXMuZ2V0THJzTGF5ZXIobGF5ZXJJZClcbiAgICApO1xuICB9XG5cbiAgaXNOZXR3b3JrTGF5ZXIobGF5ZXJJZDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIEJvb2xlYW4oZmluZChsYXllcklkLCB0aGlzLm5ldHdvcmtMYXllcnMpKTtcbiAgfVxuXG4gIGlzRXZlbnRMYXllcihsYXllcklkOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihmaW5kKGxheWVySWQsIHRoaXMuZXZlbnRMYXllcnMpKTtcbiAgfVxuXG4gIGlzSW50ZXJzZWN0aW9uTGF5ZXIobGF5ZXJJZDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIEJvb2xlYW4oZmluZChsYXllcklkLCB0aGlzLmludGVyc2VjdGlvbkxheWVycykpO1xuICB9XG5cbiAgaXNSZWRsaW5lTGF5ZXIobGF5ZXJJZDogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIEJvb2xlYW4oZmluZChsYXllcklkLCB0aGlzLnJlZGxpbmVMYXllcnMpKTtcbiAgfVxuXG4gIGlzQ2VudGVybGluZUxheWVyKGxheWVySWQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKGZpbmQobGF5ZXJJZCwgdGhpcy5jZW50ZXJsaW5lTGF5ZXJzKSk7XG4gIH1cblxuICBpc0NhbGlicmF0aW9uUG9pbnRMYXllcihsYXllcklkOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihmaW5kKGxheWVySWQsIHRoaXMuY2FsaWJyYXRpb25Qb2ludExheWVycykpO1xuICB9XG5cbiAgaXNOb25MUlNMYXllcihsYXllcklkOiBudW1iZXIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQm9vbGVhbihmaW5kKGxheWVySWQsIHRoaXMubm9uTFJTTGF5ZXJzKSk7XG4gIH1cblxuICBpc1RhYmxlKGxheWVySWQ6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKGZpbmQobGF5ZXJJZCwgdGhpcy50YWJsZXMpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNZXJnZXMgbWFwIHNlcnZlciBnZW5lcmFsIGluZm9ybWF0aW9uIGludG8gdGhpcyBMUlMgbWV0YWRhdGEgaW5zdGFuY2UuXG4gICAqL1xuICBtZXJnZU1hcE1ldGFkYXRhKG1hcE1ldGFkYXRhOiBNYXBTZXJ2ZXJNZXRhZGF0YSk6IExyc01ldGFkYXRhIHtcbiAgICBtZXJnZU1hcE1ldGFkYXRhKHRoaXMsIG1hcE1ldGFkYXRhKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRlZXBNZXJnZU1hcE1ldGFkYXRhKG1hcE1ldGFkYXRhOiBNYXBTZXJ2ZXJNZXRhZGF0YSk6IExyc01ldGFkYXRhIHtcbiAgICBkZWVwTWVyZ2VNYXBNZXRhZGF0YSh0aGlzLCBtYXBNZXRhZGF0YSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogTWVyZ2VzIG90aGVyIExSUyBtZXRhZGF0YSBpbnRvIHRoaXMgTFJTIG1ldGRhdGEgaW5zdGFuY2UuXG4gICAqL1xuICBtZXJnZUxyc01ldGFkYXRhKGxyc01ldGFkYXRhOiBMcnNNZXRhZGF0YSk6IExyc01ldGFkYXRhIHtcbiAgICBtZXJnZUxyc01ldGFkYXRhKHRoaXMsIGxyc01ldGFkYXRhKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGdldE5ldHdvcmtMYXllcihsYXllcklkOiBudW1iZXIpOiBOZXR3b3JrTGF5ZXIge1xuICAgIHJldHVybiBmaW5kKGxheWVySWQsIHRoaXMubmV0d29ya0xheWVycykgYXMgTmV0d29ya0xheWVyO1xuICB9XG5cbiAgZ2V0RXZlbnRMYXllcihsYXllcklkOiBudW1iZXIpOiBFdmVudExheWVyIHtcbiAgICByZXR1cm4gZmluZChsYXllcklkLCB0aGlzLmV2ZW50TGF5ZXJzKSBhcyBFdmVudExheWVyO1xuICB9XG5cbiAgZ2V0SW50ZXJzZWN0aW9uTGF5ZXIobGF5ZXJJZDogbnVtYmVyKTogSW50ZXJzZWN0aW9uTGF5ZXIge1xuICAgIHJldHVybiBmaW5kKGxheWVySWQsIHRoaXMuaW50ZXJzZWN0aW9uTGF5ZXJzKSBhcyBJbnRlcnNlY3Rpb25MYXllcjtcbiAgfVxuXG4gIGdldExyc0xheWVycygpOiBMcnNMYXllcltdIHtcbiAgICByZXR1cm4gKHRoaXMuZXZlbnRMYXllcnMgYXMgTHJzTGF5ZXJbXSlcbiAgICAgIC5jb25jYXQodGhpcy5uZXR3b3JrTGF5ZXJzKVxuICAgICAgLmNvbmNhdCh0aGlzLnJlZGxpbmVMYXllcnMpO1xuICB9XG5cbiAgZ2V0RmVhdHVyZUNsYXNzTGF5ZXJzKCk6IEZlYXR1cmVDbGFzc0xheWVyW10ge1xuICAgIHJldHVybiAodGhpcy5ldmVudExheWVycyBhcyBGZWF0dXJlQ2xhc3NMYXllcltdKVxuICAgICAgLmNvbmNhdCh0aGlzLm5ldHdvcmtMYXllcnMpXG4gICAgICAuY29uY2F0KHRoaXMucmVkbGluZUxheWVycylcbiAgICAgIC5jb25jYXQodGhpcy5jYWxpYnJhdGlvblBvaW50TGF5ZXJzKVxuICAgICAgLmNvbmNhdCh0aGlzLmNlbnRlcmxpbmVMYXllcnMpXG4gICAgICAuY29uY2F0KHRoaXMubm9uTFJTTGF5ZXJzKTtcbiAgfVxuXG4gIGdldEFsbExheWVycygpOiBNYXBMYXllcltdIHtcbiAgICByZXR1cm4gKHRoaXMuZ2V0RmVhdHVyZUNsYXNzTGF5ZXJzKCkgYXMgTWFwTGF5ZXJbXSlcbiAgICAgIC5jb25jYXQodGhpcy50YWJsZXMpXG4gICAgICAuY29uY2F0KHRoaXMubGF5ZXJzKTtcbiAgfVxuXG4gIGdldE5ldHdvcmtJZEZvckxheWVyKGxheWVyOiBMcnNMYXllcik6IG51bWJlciB8IG51bGwge1xuICAgIGxldCBuZXR3b3JrSWQ6IG51bWJlciA9IG51bGw7XG4gICAgaWYgKHRoaXMuaXNFdmVudExheWVyKGxheWVyLmlkKSkge1xuICAgICAgY29uc3QgZXZlbnRMYXllciA9IGxheWVyIGFzIEV2ZW50TGF5ZXI7XG4gICAgICBuZXR3b3JrSWQgPSBldmVudExheWVyLnBhcmVudE5ldHdvcmsgPyBldmVudExheWVyLnBhcmVudE5ldHdvcmsuaWQgOiBudWxsO1xuICAgIH1cblxuICAgIGlmIChpc05vdFZhbHVlKG5ldHdvcmtJZCkpIHtcbiAgICAgIHRoaXMubmV0d29ya0xheWVycy5mb3JFYWNoKG5ldHdvcmsgPT4ge1xuICAgICAgICBpZiAobmV0d29yay5ldmVudExheWVycy5maW5kKGwgPT4gbC5pZCA9PT0gbGF5ZXIuaWQpKSB7XG4gICAgICAgICAgbmV0d29ya0lkID0gbmV0d29yay5pZDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldHdvcmtJZDtcbiAgfVxuXG4gIGdldEV2ZW50TGF5ZXJzQnlOZXR3b3JrKG5ldHdvcmtMYXllcklkOiBudW1iZXIpOiBFdmVudExheWVyW10ge1xuICAgIGNvbnN0IG5ldHdvcmtMYXllciA9IHRoaXMuZ2V0TmV0d29ya0xheWVyKG5ldHdvcmtMYXllcklkKTtcbiAgICByZXR1cm4gdGhpcy5ldmVudExheWVycy5maWx0ZXIobGF5ZXIgPT5cbiAgICAgIGxheWVyLnBhcmVudE5ldHdvcmtcbiAgICAgICYmIGxheWVyLnBhcmVudE5ldHdvcmsuaWQgPT09IG5ldHdvcmtMYXllcklkXG4gICAgICB8fCBuZXR3b3JrTGF5ZXIuZXZlbnRMYXllcnNcbiAgICAgICYmIG5ldHdvcmtMYXllci5ldmVudExheWVycy5maW5kKGwgPT4gbC5pZCA9PT0gbGF5ZXIuaWQpXG4gICAgKTtcbiAgfVxuXG4gIHJlYnVpbGRMYXllcnMoKTogdGhpcyB7XG4gICAgdGhpcy5ldmVudExheWVycyA9IHRoaXMuZXZlbnRMYXllcnMubWFwKGV2ZW50TGF5ZXIgPT4gbmV3IEV2ZW50TGF5ZXIoZmluZChldmVudExheWVyLmlkLCB0aGlzLmxheWVycyksIGV2ZW50TGF5ZXIpKTtcbiAgICB0aGlzLm5ldHdvcmtMYXllcnMgPSB0aGlzLm5ldHdvcmtMYXllcnMubWFwKG5ldHdvcmtMYXllciA9PiBuZXcgTmV0d29ya0xheWVyKGZpbmQobmV0d29ya0xheWVyLmlkLCB0aGlzLmxheWVycyksIG5ldHdvcmtMYXllcikpO1xuICAgIHRoaXMucmVkbGluZUxheWVycyA9IHRoaXMucmVkbGluZUxheWVycy5tYXAocmVkbGluZUxheWVyID0+IG5ldyBSZWRsaW5lTGF5ZXIoZmluZChyZWRsaW5lTGF5ZXIuaWQsIHRoaXMubGF5ZXJzKSwgcmVkbGluZUxheWVyKSk7XG4gICAgdGhpcy5jZW50ZXJsaW5lTGF5ZXJzID0gdGhpcy5jZW50ZXJsaW5lTGF5ZXJzLm1hcChjZW50ZXJsaW5lTGF5ZXIgPT4gbmV3IENlbnRlcmxpbmVMYXllcihjZW50ZXJsaW5lTGF5ZXIpKTtcbiAgICB0aGlzLmNhbGlicmF0aW9uUG9pbnRMYXllcnMgPSB0aGlzLmNhbGlicmF0aW9uUG9pbnRMYXllcnMubWFwKFxuICAgICAgY2FsaWJyYXRpb25Qb2ludExheWVyID0+IG5ldyBDYWxpYnJhdGlvblBvaW50TGF5ZXIoY2FsaWJyYXRpb25Qb2ludExheWVyKVxuICAgICk7XG4gICAgdGhpcy5pbnRlcnNlY3Rpb25MYXllcnMgPSB0aGlzLmludGVyc2VjdGlvbkxheWVycy5tYXAoaW50ZXJzZWN0aW9uTGF5ZXIgPT4gbmV3IEludGVyc2VjdGlvbkxheWVyKGludGVyc2VjdGlvbkxheWVyKSk7XG4gICAgdGhpcy5ub25MUlNMYXllcnMgPSB0aGlzLm5vbkxSU0xheWVycy5tYXAobm9uTHJzTGF5ZXIgPT4gbmV3IE5vbkxyc0xheWVyKGZpbmQobm9uTHJzTGF5ZXIuaWQsIHRoaXMubGF5ZXJzKSwgbm9uTHJzTGF5ZXIpKTtcblxuICAgIHJldHVybiB0aGlzLmFzc2lnbkNvZGVkVmFsdWVEb21haW5zVG9GaWVsZHMoKTtcbiAgfVxuXG4gIGFzc2lnbkNvZGVkVmFsdWVEb21haW5zVG9GaWVsZHMoKTogdGhpcyB7XG4gICAgaWYgKHRoaXMuZG9tYWlucy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZ2V0RmVhdHVyZUNsYXNzTGF5ZXJzKClcbiAgICAgICAgLmZvckVhY2gobGF5ZXIgPT4gbGF5ZXIuYXBwbHlGaWVsZERvbWFpbnModGhpcy5kb21haW5zKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhc3NpZ24oc291cmNlOiBhbnkpOiB0aGlzIHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIHNvdXJjZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBjbG9uZSgpOiBMcnNNZXRhZGF0YSB7XG4gICAgY29uc3QgY29weSA9IGNsb25lKHRoaXMpO1xuICAgIHJldHVybiBuZXcgTHJzTWV0YWRhdGEoKVxuICAgICAgLmFzc2lnbihjb3B5KVxuICAgICAgLnJlYnVpbGRMYXllcnMoKTtcbiAgfVxuXG4gIHZhbGlkYXRlKCk6IFZhbGlkYXRpb25SZXN1bHQge1xuICAgIHJldHVybiBMUlNfTUVUQURBVEFfVkFMSURBVElPTlNcbiAgICAgIC5jaGVjayh0aGlzKTtcbiAgfVxufVxuIl19