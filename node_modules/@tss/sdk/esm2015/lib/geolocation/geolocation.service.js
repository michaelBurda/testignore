/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Injectable } from '@angular/core';
// 3rd Party.
import { ReplaySubject, Subject } from 'rxjs';
import distance from '@turf/distance';
import bearing from '@turf/bearing';
// App.
import { isPositionAcceptable } from './is-position-acceptable.function';
import { Logger } from '../core/logging/logger.service';
import { NotifyService } from '../core/notify/notify.service';
import { GeolocationConfig } from './geolocation.config';
import { GeolocatorAccuracyUnit } from './geolocator/geolocator-accuracy-unit';
import { GeolocatorCapability } from './geolocator/geolocator-capability';
import { isPositionError } from './gps-position/is-position-error.function';
import { toReadableTime } from '../core/date-time/readable/to-readable-time.function';
import { isNumber } from '../core/type-check/is-number.function';
import { isNotNumber } from '../core/type-check/is-not-number.function';
import { formatNumber } from '../core/formatting/format-number.function';
import { errorMsg } from '../core/error/error-msg.function';
import { isNotValue } from '../core/type-check/is-not-value.function';
import { gpsPositionToPoint } from './gps-position/gps-position-to-point';
import { millisecondsToSeconds } from '../core/date-time/conversion/milliseconds-to-seconds.function';
import { convertLengthUnits } from '../core/units/convert-length-units.function';
import { LengthUnit } from '../core/units/length-unit';
import { BaseGeolocator } from './geolocator/base-geolocator.service';
import { isNotValidLocation } from './gps-position/is-not-valid-location.function';
import { gpsPositionsAlmostEqual } from './gps-position/gps-positions-almost-equal';
import * as i0 from "@angular/core";
import * as i1 from "./geolocator/base-geolocator.service";
import * as i2 from "../core/logging/logger.service";
import * as i3 from "../core/notify/notify.service";
import * as i4 from "./geolocation.config";
/**
 * Geolocator service. Provides a single point of GPS interaction.
 */
export class GeolocationService {
    /**
     * @param {?} geolocator
     * @param {?} log
     * @param {?} notify
     * @param {?} config
     */
    constructor(geolocator, log, notify, config) {
        this.log = log;
        this.notify = notify;
        this.config = config;
        this.isTrackingPosition = false;
        this.geolocator = geolocator;
        this.positionChangeSubject = new ReplaySubject(1);
        this.positionRecievedSubject = new Subject();
        this.positionChange = this.positionChangeSubject.asObservable();
        this.positionRecieved = this.positionRecievedSubject.asObservable();
    }
    /**
     * @return {?}
     */
    get positionText() {
        return this.position
            ? `${this.position.longitude.toFixed(this.config.gpsDisplayDecimalPlaces)}
       , ${this.position.latitude.toFixed(this.config.gpsDisplayDecimalPlaces)}`
            : '';
    }
    /**
     * @return {?}
     */
    get positionReceivedEllapsedTime() {
        if (!this.positionRecievedTime) {
            return '';
        }
        /** @type {?} */
        const differenceMilliseconds = Date.now() - this.positionRecievedTime.getTime();
        return `${toReadableTime(differenceMilliseconds)} ago`;
    }
    /**
     * @return {?}
     */
    get isPositionAcceptable() {
        /** @type {?} */
        const accuracyThreshold = this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Meter
            ? this.config.gpsRequiredAccuracyMeters
            : this.config.gpsRequiredDilutionOfPrecision;
        return isPositionAcceptable(this.position, accuracyThreshold);
    }
    /**
     * @return {?}
     */
    get isPositionUnacceptable() {
        return !this.isPositionAcceptable;
    }
    /**
     * @return {?}
     */
    get isPositionWarnable() {
        /** @type {?} */
        const accuracyThreshold = this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Meter
            ? this.config.gpsWarnableAccuracyMeters
            : this.config.gpsWarnableDilutionOfPrecision;
        return !isPositionAcceptable(this.position, accuracyThreshold);
    }
    /**
     * @return {?}
     */
    get hasAccuracyCapability() {
        return this.geolocator.capabilities.indexOf(GeolocatorCapability.Accuracy) > -1;
    }
    /**
     * @return {?}
     */
    get isPositionAccuracyKnown() {
        return this.position && isNumber(this.position.accuracy);
    }
    /**
     * @return {?}
     */
    get isPositionAccuracyUnknown() {
        return !this.isPositionAccuracyKnown;
    }
    /**
     * @return {?}
     */
    get isPositionAccuracyInMeters() {
        return this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Meter;
    }
    /**
     * @return {?}
     */
    get isPositionAccuracyInDilutionOfPrecision() {
        return this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Pdop
            || this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Hdop
            || this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Vdop
            || this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Tdop;
    }
    /**
     * @return {?}
     */
    get geolocatorService() {
        return this.geolocator;
    }
    /**
     * @return {?}
     */
    get accuracyStatement() {
        /** @type {?} */
        const noPosition = !this.position;
        if (noPosition) {
            return this.config.gpsNoAccuracyReading;
        }
        /** @type {?} */
        const isPositionAccuracyKnown = this.isPositionAccuracyKnown;
        /** @type {?} */
        let accuracy = isPositionAccuracyKnown ? this.position.accuracy : null;
        /** @type {?} */
        let suffix;
        if (isPositionAccuracyKnown && this.geolocator.hasCapability(GeolocatorCapability.Accuracy)) {
            suffix = this.geolocator.accuracyUnit === GeolocatorAccuracyUnit.Meter
                ? 'm'
                : String(this.geolocator.accuracyUnit).toUpperCase();
        }
        else if (this.geolocator.hasCapability(GeolocatorCapability.PDOP)) {
            accuracy = this.position.pdop;
            suffix = String(GeolocatorCapability.PDOP).toUpperCase();
        }
        else if (this.geolocator.hasCapability(GeolocatorCapability.HDOP)) {
            accuracy = this.position.hdop;
            suffix = String(GeolocatorCapability.HDOP).toUpperCase();
        }
        else if (this.geolocator.hasCapability(GeolocatorCapability.VDOP)) {
            accuracy = this.position.vdop;
            suffix = String(GeolocatorCapability.VDOP).toUpperCase();
        }
        else if (this.geolocator.hasCapability(GeolocatorCapability.TDOP)) {
            accuracy = this.position.tdop;
            suffix = String(GeolocatorCapability.TDOP).toUpperCase();
        }
        if (isNotNumber(accuracy)) {
            return this.config.gpsNoAccuracyReading;
        }
        return `${formatNumber(accuracy)} ${suffix}`;
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    enableGpsTracking() {
        /** @type {?} */
        const geoOptions = {
            enableHighAccuracy: (/** @type {?} */ (this)).config.gpsEnableHighAccuracy
        };
        (/** @type {?} */ (this)).position = null;
        (/** @type {?} */ (this)).tryUnsubscribe();
        (/** @type {?} */ (this)).log.debug(`Subscribing to GPS watching for '${(/** @type {?} */ (this)).geolocator.name}' with high accuracy set to '${geoOptions.enableHighAccuracy}'`);
        (/** @type {?} */ (this)).gpsLocatorSubscription = (/** @type {?} */ (this)).geolocator.watchPosition(geoOptions)
            .subscribe((/**
         * @template THIS
         * @this {THIS}
         * @param {?} position
         * @return {THIS}
         */
        position => (/** @type {?} */ (this)).onPositionRecieved(position)), (/**
         * @template THIS
         * @this {THIS}
         * @param {?} error
         * @return {THIS}
         */
        error => (/** @type {?} */ (this)).onLocationError(error)));
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    disableGpsTracking() {
        (/** @type {?} */ (this)).isTrackingPosition = false;
        (/** @type {?} */ (this)).tryUnsubscribe();
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} geolocator
     * @return {THIS}
     */
    setGeoLocator(geolocator) {
        (/** @type {?} */ (this)).tryUnsubscribe();
        (/** @type {?} */ (this)).geolocator = geolocator;
        if ((/** @type {?} */ (this)).isTrackingPosition) {
            (/** @type {?} */ (this)).enableGpsTracking();
        }
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} isTrackingLocation
     * @return {THIS}
     */
    setGpsTracking(isTrackingLocation) {
        if (isTrackingLocation) {
            (/** @type {?} */ (this)).enableGpsTracking();
        }
        else {
            (/** @type {?} */ (this)).disableGpsTracking();
        }
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    toggleGpsTracking() {
        (/** @type {?} */ (this)).setGpsTracking(!(/** @type {?} */ (this)).isTrackingPosition);
        return (/** @type {?} */ (this));
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    mockGpsPosition(position) {
        if (!(/** @type {?} */ (this)).config.allowGpsMocking) {
            throw new Error('Permission denied to mock GPS location');
        }
        return (/** @type {?} */ (this)).onPositionRecieved(position);
    }
    /**
     * @protected
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    onPositionRecieved(position) {
        if (isPositionError(position)) {
            (/** @type {?} */ (this)).onLocationError((/** @type {?} */ (position)));
            return (/** @type {?} */ (this));
        }
        /** @type {?} */
        const gpsPosition = (/** @type {?} */ (position));
        if (isNotValidLocation(gpsPosition)) {
            return (/** @type {?} */ (this));
        }
        /** @type {?} */
        const isPreviousPointSameAsNew = (/** @type {?} */ (this)).position
            && gpsPositionsAlmostEqual((/** @type {?} */ (this)).position, gpsPosition, (/** @type {?} */ (this)).config.gpsPositionDuplicatePrecision);
        if (isPreviousPointSameAsNew && !(/** @type {?} */ (this)).config.emitDuplicateGpsPositions) {
            (/** @type {?} */ (this)).positionRecievedSubject.next(gpsPosition);
            return (/** @type {?} */ (this));
        }
        (/** @type {?} */ (this)).log.trace(`Location recieved from '${(/** @type {?} */ (this)).geolocator.name}': ${gpsPosition.latitude}, ${gpsPosition.longitude}`);
        (/** @type {?} */ (this)).adjustCoordinates(gpsPosition);
        (/** @type {?} */ (this)).position = gpsPosition;
        (/** @type {?} */ (this)).isTrackingPosition = true;
        (/** @type {?} */ (this)).positionRecievedTime = new Date((/** @type {?} */ (this)).position.timestamp || Date.now());
        (/** @type {?} */ (this)).positionRecievedSubject.next((/** @type {?} */ (this)).position);
        (/** @type {?} */ (this)).positionChangeSubject.next((/** @type {?} */ (this)).position);
        return (/** @type {?} */ (this));
    }
    /**
     * @protected
     * @template THIS
     * @this {THIS}
     * @param {?} error
     * @return {THIS}
     */
    onLocationError(error) {
        /** @type {?} */
        const errorMessage = errorMsg('Failed to retrieve location position. {error}', error);
        (/** @type {?} */ (this)).positionChangeSubject.error(error);
        (/** @type {?} */ (this)).log.error(errorMessage);
        (/** @type {?} */ (this)).notify.error(errorMessage);
        return (/** @type {?} */ (this));
    }
    /**
     * @private
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    adjustCoordinates(position) {
        (/** @type {?} */ (this)).tryAdjustMissingPositionValues(position);
        if ((/** @type {?} */ (this)).config.adjustForGpsAntennaHeight && (/** @type {?} */ (this)).config.gpsAntennaHeight) {
            /** @type {?} */
            let adjustedHeight = position.altitude - (/** @type {?} */ (this)).config.gpsAntennaHeight;
            adjustedHeight = adjustedHeight < 0 ? 0 : adjustedHeight;
            (/** @type {?} */ (this)).log.trace(`Adjusting coordinate altitude from ${position.altitude} to ${adjustedHeight}`);
            Object.assign(position, {
                altitude: adjustedHeight
            });
        }
        return (/** @type {?} */ (this));
    }
    /**
     * @private
     * @param {?} newPosition
     * @return {?}
     */
    tryAdjustMissingPositionValues(newPosition) {
        /** @type {?} */
        const missingSpeed = isNotValue(newPosition.speed);
        /** @type {?} */
        const missingHeading = isNotValue(newPosition.heading);
        /** @type {?} */
        const positionValuesMissing = missingSpeed || missingHeading;
        /** @type {?} */
        const shouldAdjustPositionValues = this.position && positionValuesMissing && this.config.calculateMissingPositionValues;
        if (shouldAdjustPositionValues) {
            /** @type {?} */
            const fromPoint = gpsPositionToPoint(this.position);
            /** @type {?} */
            const toPoint = gpsPositionToPoint(newPosition);
            if (missingSpeed) {
                // meters per second
                /** @type {?} */
                const kilometersTraveled = distance(fromPoint, toPoint, { units: 'kilometers' });
                if (kilometersTraveled) {
                    /** @type {?} */
                    const metersTraveled = convertLengthUnits(kilometersTraveled, LengthUnit.Kilometer, LengthUnit.Meter);
                    /** @type {?} */
                    const secondsDelta = millisecondsToSeconds(Math.abs(newPosition.timestamp - this.position.timestamp));
                    /** @type {?} */
                    const speed = metersTraveled / secondsDelta;
                    Object.assign(newPosition, { speed });
                }
            }
            if (missingHeading) {
                /** @type {?} */
                const heading = bearing(fromPoint, toPoint);
                Object.assign(newPosition, { heading });
            }
        }
    }
    /**
     * @private
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    tryUnsubscribe() {
        if ((/** @type {?} */ (this)).gpsLocatorSubscription) {
            (/** @type {?} */ (this)).log.debug(`Unsubscribing from watching GPS stream from '${(/** @type {?} */ (this)).geolocator.name}'`);
            (/** @type {?} */ (this)).gpsLocatorSubscription.unsubscribe();
        }
        return (/** @type {?} */ (this));
    }
}
GeolocationService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
GeolocationService.ctorParameters = () => [
    { type: BaseGeolocator },
    { type: Logger },
    { type: NotifyService },
    { type: GeolocationConfig }
];
/** @nocollapse */ GeolocationService.ngInjectableDef = i0.defineInjectable({ factory: function GeolocationService_Factory() { return new GeolocationService(i0.inject(i1.BaseGeolocator), i0.inject(i2.Logger), i0.inject(i3.NotifyService), i0.inject(i4.GeolocationConfig)); }, token: GeolocationService, providedIn: "root" });
if (false) {
    /** @type {?} */
    GeolocationService.prototype.position;
    /** @type {?} */
    GeolocationService.prototype.positionRecievedTime;
    /** @type {?} */
    GeolocationService.prototype.isTrackingPosition;
    /**
     * Fired when ever a new position is received and the value is different than the previous (unless the Geolocation config
     * value "emitDuplicateGpsPositions" is set to true - in which case duplicates will be published).
     * This value will alway emit the last recieved position (if you subscribe after it was emitted you will still receive it).
     * @type {?}
     */
    GeolocationService.prototype.positionChange;
    /**
     * Fired when ever a new position is received regardless of whether the position has changed since the last position was recieved.
     * @type {?}
     */
    GeolocationService.prototype.positionRecieved;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.positionChangeSubject;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.positionRecievedSubject;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.gpsLocatorSubscription;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.geolocator;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.log;
    /**
     * @type {?}
     * @private
     */
    GeolocationService.prototype.notify;
    /**
     * @type {?}
     * @protected
     */
    GeolocationService.prototype.config;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VvbG9jYXRpb24uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0c3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL2dlb2xvY2F0aW9uL2dlb2xvY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOztBQUczQyxPQUFPLEVBQWMsYUFBYSxFQUFnQixPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEUsT0FBTyxRQUFRLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxPQUFPLE1BQU0sZUFBZSxDQUFDOztBQUdwQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzlELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBRS9FLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUM1RSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sc0RBQXNELENBQUM7QUFDdEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUN4RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDekUsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsa0JB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SUFDdEMsb0NBQTRDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQW5ndWxhci5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuLy8gM3JkIFBhcnR5LlxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgU3Vic2NyaXB0aW9uLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgZGlzdGFuY2UgZnJvbSAnQHR1cmYvZGlzdGFuY2UnO1xuaW1wb3J0IGJlYXJpbmcgZnJvbSAnQHR1cmYvYmVhcmluZyc7XG5cbi8vIEFwcC5cbmltcG9ydCB7IGlzUG9zaXRpb25BY2NlcHRhYmxlIH0gZnJvbSAnLi9pcy1wb3NpdGlvbi1hY2NlcHRhYmxlLmZ1bmN0aW9uJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBOb3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vY29yZS9ub3RpZnkvbm90aWZ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgR2VvbG9jYXRpb25Db25maWcgfSBmcm9tICcuL2dlb2xvY2F0aW9uLmNvbmZpZyc7XG5pbXBvcnQgeyBHZW9sb2NhdG9yQWNjdXJhY3lVbml0IH0gZnJvbSAnLi9nZW9sb2NhdG9yL2dlb2xvY2F0b3ItYWNjdXJhY3ktdW5pdCc7XG5pbXBvcnQgeyBHcHNQb3NpdGlvbiB9IGZyb20gJy4vZ3BzLXBvc2l0aW9uL2dwcy1wb3NpdGlvbic7XG5pbXBvcnQgeyBHZW9sb2NhdG9yQ2FwYWJpbGl0eSB9IGZyb20gJy4vZ2VvbG9jYXRvci9nZW9sb2NhdG9yLWNhcGFiaWxpdHknO1xuaW1wb3J0IHsgaXNQb3NpdGlvbkVycm9yIH0gZnJvbSAnLi9ncHMtcG9zaXRpb24vaXMtcG9zaXRpb24tZXJyb3IuZnVuY3Rpb24nO1xuaW1wb3J0IHsgdG9SZWFkYWJsZVRpbWUgfSBmcm9tICcuLi9jb3JlL2RhdGUtdGltZS9yZWFkYWJsZS90by1yZWFkYWJsZS10aW1lLmZ1bmN0aW9uJztcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLW51bWJlci5mdW5jdGlvbic7XG5pbXBvcnQgeyBpc05vdE51bWJlciB9IGZyb20gJy4uL2NvcmUvdHlwZS1jaGVjay9pcy1ub3QtbnVtYmVyLmZ1bmN0aW9uJztcbmltcG9ydCB7IGZvcm1hdE51bWJlciB9IGZyb20gJy4uL2NvcmUvZm9ybWF0dGluZy9mb3JtYXQtbnVtYmVyLmZ1bmN0aW9uJztcbmltcG9ydCB7IGVycm9yTXNnIH0gZnJvbSAnLi4vY29yZS9lcnJvci9lcnJvci1tc2cuZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNOb3RWYWx1ZSB9IGZyb20gJy4uL2NvcmUvdHlwZS1jaGVjay9pcy1ub3QtdmFsdWUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgZ3BzUG9zaXRpb25Ub1BvaW50IH0gZnJvbSAnLi9ncHMtcG9zaXRpb24vZ3BzLXBvc2l0aW9uLXRvLXBvaW50JztcbmltcG9ydCB7IG1pbGxpc2Vjb25kc1RvU2Vjb25kcyB9IGZyb20gJy4uL2NvcmUvZGF0ZS10aW1lL2NvbnZlcnNpb24vbWlsbGlzZWNvbmRzLXRvLXNlY29uZHMuZnVuY3Rpb24nO1xuaW1wb3J0IHsgY29udmVydExlbmd0aFVuaXRzIH0gZnJvbSAnLi4vY29yZS91bml0cy9jb252ZXJ0LWxlbmd0aC11bml0cy5mdW5jdGlvbic7XG5pbXBvcnQgeyBMZW5ndGhVbml0IH0gZnJvbSAnLi4vY29yZS91bml0cy9sZW5ndGgtdW5pdCc7XG5pbXBvcnQgeyBHZW9sb2NhdG9yIH0gZnJvbSAnLi9nZW9sb2NhdG9yL2dlb2xvY2F0b3InO1xuaW1wb3J0IHsgQmFzZUdlb2xvY2F0b3IgfSBmcm9tICcuL2dlb2xvY2F0b3IvYmFzZS1nZW9sb2NhdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgaXNOb3RWYWxpZExvY2F0aW9uIH0gZnJvbSAnLi9ncHMtcG9zaXRpb24vaXMtbm90LXZhbGlkLWxvY2F0aW9uLmZ1bmN0aW9uJztcbmltcG9ydCB7IGdwc1Bvc2l0aW9uc0FsbW9zdEVxdWFsIH0gZnJvbSAnLi9ncHMtcG9zaXRpb24vZ3BzLXBvc2l0aW9ucy1hbG1vc3QtZXF1YWwnO1xuXG5cbi8qKlxuICogR2VvbG9jYXRvciBzZXJ2aWNlLiBQcm92aWRlcyBhIHNpbmdsZSBwb2ludCBvZiBHUFMgaW50ZXJhY3Rpb24uXG4gKi9cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEdlb2xvY2F0aW9uU2VydmljZSB7XG4gIHBvc2l0aW9uOiBHcHNQb3NpdGlvbjtcbiAgcG9zaXRpb25SZWNpZXZlZFRpbWU6IERhdGU7XG4gIGlzVHJhY2tpbmdQb3NpdGlvbiA9IGZhbHNlO1xuICAvKipcbiAgICogRmlyZWQgd2hlbiBldmVyIGEgbmV3IHBvc2l0aW9uIGlzIHJlY2VpdmVkIGFuZCB0aGUgdmFsdWUgaXMgZGlmZmVyZW50IHRoYW4gdGhlIHByZXZpb3VzICh1bmxlc3MgdGhlIEdlb2xvY2F0aW9uIGNvbmZpZ1xuICAgKiB2YWx1ZSBcImVtaXREdXBsaWNhdGVHcHNQb3NpdGlvbnNcIiBpcyBzZXQgdG8gdHJ1ZSAtIGluIHdoaWNoIGNhc2UgZHVwbGljYXRlcyB3aWxsIGJlIHB1Ymxpc2hlZCkuXG4gICAqIFRoaXMgdmFsdWUgd2lsbCBhbHdheSBlbWl0IHRoZSBsYXN0IHJlY2lldmVkIHBvc2l0aW9uIChpZiB5b3Ugc3Vic2NyaWJlIGFmdGVyIGl0IHdhcyBlbWl0dGVkIHlvdSB3aWxsIHN0aWxsIHJlY2VpdmUgaXQpLlxuICAgKi9cbiAgcmVhZG9ubHkgcG9zaXRpb25DaGFuZ2U6IE9ic2VydmFibGU8R3BzUG9zaXRpb24+O1xuXG4gIC8qKlxuICAgKiBGaXJlZCB3aGVuIGV2ZXIgYSBuZXcgcG9zaXRpb24gaXMgcmVjZWl2ZWQgcmVnYXJkbGVzcyBvZiB3aGV0aGVyIHRoZSBwb3NpdGlvbiBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBwb3NpdGlvbiB3YXMgcmVjaWV2ZWQuXG4gICAqL1xuICByZWFkb25seSBwb3NpdGlvblJlY2lldmVkOiBPYnNlcnZhYmxlPEdwc1Bvc2l0aW9uPjtcblxuICBwcml2YXRlIHBvc2l0aW9uQ2hhbmdlU3ViamVjdDogUmVwbGF5U3ViamVjdDxHcHNQb3NpdGlvbj47XG4gIHByaXZhdGUgcG9zaXRpb25SZWNpZXZlZFN1YmplY3Q6IFN1YmplY3Q8R3BzUG9zaXRpb24+O1xuICBwcml2YXRlIGdwc0xvY2F0b3JTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBnZW9sb2NhdG9yOiBHZW9sb2NhdG9yO1xuXG4gIGdldCBwb3NpdGlvblRleHQoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wb3NpdGlvblxuICAgICAgPyBgJHt0aGlzLnBvc2l0aW9uLmxvbmdpdHVkZS50b0ZpeGVkKHRoaXMuY29uZmlnLmdwc0Rpc3BsYXlEZWNpbWFsUGxhY2VzKX1cbiAgICAgICAsICR7dGhpcy5wb3NpdGlvbi5sYXRpdHVkZS50b0ZpeGVkKHRoaXMuY29uZmlnLmdwc0Rpc3BsYXlEZWNpbWFsUGxhY2VzKX1gXG4gICAgICA6ICcnO1xuICB9XG5cbiAgZ2V0IHBvc2l0aW9uUmVjZWl2ZWRFbGxhcHNlZFRpbWUoKTogc3RyaW5nIHtcbiAgICBpZiAoIXRoaXMucG9zaXRpb25SZWNpZXZlZFRpbWUpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG5cbiAgICBjb25zdCBkaWZmZXJlbmNlTWlsbGlzZWNvbmRzID0gRGF0ZS5ub3coKSAtIHRoaXMucG9zaXRpb25SZWNpZXZlZFRpbWUuZ2V0VGltZSgpO1xuICAgIHJldHVybiBgJHt0b1JlYWRhYmxlVGltZShkaWZmZXJlbmNlTWlsbGlzZWNvbmRzKX0gYWdvYDtcbiAgfVxuXG4gIGdldCBpc1Bvc2l0aW9uQWNjZXB0YWJsZSgpOiBib29sZWFuIHtcbiAgICBjb25zdCBhY2N1cmFjeVRocmVzaG9sZCA9IHRoaXMuZ2VvbG9jYXRvci5hY2N1cmFjeVVuaXQgPT09IEdlb2xvY2F0b3JBY2N1cmFjeVVuaXQuTWV0ZXJcbiAgICAgID8gdGhpcy5jb25maWcuZ3BzUmVxdWlyZWRBY2N1cmFjeU1ldGVyc1xuICAgICAgOiB0aGlzLmNvbmZpZy5ncHNSZXF1aXJlZERpbHV0aW9uT2ZQcmVjaXNpb247XG5cbiAgICByZXR1cm4gaXNQb3NpdGlvbkFjY2VwdGFibGUodGhpcy5wb3NpdGlvbiwgYWNjdXJhY3lUaHJlc2hvbGQpO1xuICB9XG5cbiAgZ2V0IGlzUG9zaXRpb25VbmFjY2VwdGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICF0aGlzLmlzUG9zaXRpb25BY2NlcHRhYmxlO1xuICB9XG5cbiAgZ2V0IGlzUG9zaXRpb25XYXJuYWJsZSgpOiBib29sZWFuIHtcbiAgICBjb25zdCBhY2N1cmFjeVRocmVzaG9sZCA9IHRoaXMuZ2VvbG9jYXRvci5hY2N1cmFjeVVuaXQgPT09IEdlb2xvY2F0b3JBY2N1cmFjeVVuaXQuTWV0ZXJcbiAgICAgID8gdGhpcy5jb25maWcuZ3BzV2FybmFibGVBY2N1cmFjeU1ldGVyc1xuICAgICAgOiB0aGlzLmNvbmZpZy5ncHNXYXJuYWJsZURpbHV0aW9uT2ZQcmVjaXNpb247XG5cbiAgICByZXR1cm4gIWlzUG9zaXRpb25BY2NlcHRhYmxlKHRoaXMucG9zaXRpb24sIGFjY3VyYWN5VGhyZXNob2xkKTtcbiAgfVxuXG4gIGdldCBoYXNBY2N1cmFjeUNhcGFiaWxpdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2VvbG9jYXRvci5jYXBhYmlsaXRpZXMuaW5kZXhPZihHZW9sb2NhdG9yQ2FwYWJpbGl0eS5BY2N1cmFjeSkgPiAtMTtcbiAgfVxuXG4gIGdldCBpc1Bvc2l0aW9uQWNjdXJhY3lLbm93bigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5wb3NpdGlvbiAmJiBpc051bWJlcih0aGlzLnBvc2l0aW9uLmFjY3VyYWN5KTtcbiAgfVxuXG4gIGdldCBpc1Bvc2l0aW9uQWNjdXJhY3lVbmtub3duKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5pc1Bvc2l0aW9uQWNjdXJhY3lLbm93bjtcbiAgfVxuXG4gIGdldCBpc1Bvc2l0aW9uQWNjdXJhY3lJbk1ldGVycygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5nZW9sb2NhdG9yLmFjY3VyYWN5VW5pdCA9PT0gR2VvbG9jYXRvckFjY3VyYWN5VW5pdC5NZXRlcjtcbiAgfVxuXG4gIGdldCBpc1Bvc2l0aW9uQWNjdXJhY3lJbkRpbHV0aW9uT2ZQcmVjaXNpb24oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZ2VvbG9jYXRvci5hY2N1cmFjeVVuaXQgPT09IEdlb2xvY2F0b3JBY2N1cmFjeVVuaXQuUGRvcFxuICAgICAgfHwgdGhpcy5nZW9sb2NhdG9yLmFjY3VyYWN5VW5pdCA9PT0gR2VvbG9jYXRvckFjY3VyYWN5VW5pdC5IZG9wXG4gICAgICB8fCB0aGlzLmdlb2xvY2F0b3IuYWNjdXJhY3lVbml0ID09PSBHZW9sb2NhdG9yQWNjdXJhY3lVbml0LlZkb3BcbiAgICAgIHx8IHRoaXMuZ2VvbG9jYXRvci5hY2N1cmFjeVVuaXQgPT09IEdlb2xvY2F0b3JBY2N1cmFjeVVuaXQuVGRvcDtcbiAgfVxuXG4gIGdldCBnZW9sb2NhdG9yU2VydmljZSgpOiBHZW9sb2NhdG9yIHtcbiAgICByZXR1cm4gdGhpcy5nZW9sb2NhdG9yO1xuICB9XG5cbiAgZ2V0IGFjY3VyYWN5U3RhdGVtZW50KCk6IHN0cmluZyB7XG4gICAgY29uc3Qgbm9Qb3NpdGlvbiA9ICF0aGlzLnBvc2l0aW9uO1xuXG4gICAgaWYgKG5vUG9zaXRpb24pIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5ncHNOb0FjY3VyYWN5UmVhZGluZztcbiAgICB9XG5cbiAgICBjb25zdCBpc1Bvc2l0aW9uQWNjdXJhY3lLbm93biA9IHRoaXMuaXNQb3NpdGlvbkFjY3VyYWN5S25vd247XG4gICAgbGV0IGFjY3VyYWN5OiBudW1iZXIgPSBpc1Bvc2l0aW9uQWNjdXJhY3lLbm93biA/IHRoaXMucG9zaXRpb24uYWNjdXJhY3kgOiBudWxsO1xuICAgIGxldCBzdWZmaXg6IHN0cmluZztcblxuICAgIGlmIChpc1Bvc2l0aW9uQWNjdXJhY3lLbm93biAmJiB0aGlzLmdlb2xvY2F0b3IuaGFzQ2FwYWJpbGl0eShHZW9sb2NhdG9yQ2FwYWJpbGl0eS5BY2N1cmFjeSkpIHtcbiAgICAgIHN1ZmZpeCA9IHRoaXMuZ2VvbG9jYXRvci5hY2N1cmFjeVVuaXQgPT09IEdlb2xvY2F0b3JBY2N1cmFjeVVuaXQuTWV0ZXJcbiAgICAgICAgPyAnbSdcbiAgICAgICAgOiBTdHJpbmcodGhpcy5nZW9sb2NhdG9yLmFjY3VyYWN5VW5pdCkudG9VcHBlckNhc2UoKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZ2VvbG9jYXRvci5oYXNDYXBhYmlsaXR5KEdlb2xvY2F0b3JDYXBhYmlsaXR5LlBET1ApKSB7XG4gICAgICBhY2N1cmFjeSA9IHRoaXMucG9zaXRpb24ucGRvcDtcbiAgICAgIHN1ZmZpeCA9IFN0cmluZyhHZW9sb2NhdG9yQ2FwYWJpbGl0eS5QRE9QKS50b1VwcGVyQ2FzZSgpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5nZW9sb2NhdG9yLmhhc0NhcGFiaWxpdHkoR2VvbG9jYXRvckNhcGFiaWxpdHkuSERPUCkpIHtcbiAgICAgIGFjY3VyYWN5ID0gdGhpcy5wb3NpdGlvbi5oZG9wO1xuICAgICAgc3VmZml4ID0gU3RyaW5nKEdlb2xvY2F0b3JDYXBhYmlsaXR5LkhET1ApLnRvVXBwZXJDYXNlKCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmdlb2xvY2F0b3IuaGFzQ2FwYWJpbGl0eShHZW9sb2NhdG9yQ2FwYWJpbGl0eS5WRE9QKSkge1xuICAgICAgYWNjdXJhY3kgPSB0aGlzLnBvc2l0aW9uLnZkb3A7XG4gICAgICBzdWZmaXggPSBTdHJpbmcoR2VvbG9jYXRvckNhcGFiaWxpdHkuVkRPUCkudG9VcHBlckNhc2UoKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZ2VvbG9jYXRvci5oYXNDYXBhYmlsaXR5KEdlb2xvY2F0b3JDYXBhYmlsaXR5LlRET1ApKSB7XG4gICAgICBhY2N1cmFjeSA9IHRoaXMucG9zaXRpb24udGRvcDtcbiAgICAgIHN1ZmZpeCA9IFN0cmluZyhHZW9sb2NhdG9yQ2FwYWJpbGl0eS5URE9QKS50b1VwcGVyQ2FzZSgpO1xuICAgIH1cblxuICAgIGlmIChpc05vdE51bWJlcihhY2N1cmFjeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmNvbmZpZy5ncHNOb0FjY3VyYWN5UmVhZGluZztcbiAgICB9XG5cbiAgICByZXR1cm4gYCR7Zm9ybWF0TnVtYmVyKGFjY3VyYWN5KX0gJHtzdWZmaXh9YDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGdlb2xvY2F0b3I6IEJhc2VHZW9sb2NhdG9yLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbG9nOiBMb2dnZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBub3RpZnk6IE5vdGlmeVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGNvbmZpZzogR2VvbG9jYXRpb25Db25maWcsXG4gICkge1xuICAgIHRoaXMuZ2VvbG9jYXRvciA9IGdlb2xvY2F0b3I7XG4gICAgdGhpcy5wb3NpdGlvbkNoYW5nZVN1YmplY3QgPSBuZXcgUmVwbGF5U3ViamVjdCgxKTtcbiAgICB0aGlzLnBvc2l0aW9uUmVjaWV2ZWRTdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcblxuICAgIHRoaXMucG9zaXRpb25DaGFuZ2UgPSB0aGlzLnBvc2l0aW9uQ2hhbmdlU3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgICB0aGlzLnBvc2l0aW9uUmVjaWV2ZWQgPSB0aGlzLnBvc2l0aW9uUmVjaWV2ZWRTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZW5hYmxlR3BzVHJhY2tpbmcoKTogdGhpcyB7XG4gICAgY29uc3QgZ2VvT3B0aW9ucyA9IHtcbiAgICAgIGVuYWJsZUhpZ2hBY2N1cmFjeTogdGhpcy5jb25maWcuZ3BzRW5hYmxlSGlnaEFjY3VyYWN5XG4gICAgfTtcblxuICAgIHRoaXMucG9zaXRpb24gPSBudWxsO1xuICAgIHRoaXMudHJ5VW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhcbiAgICAgIGBTdWJzY3JpYmluZyB0byBHUFMgd2F0Y2hpbmcgZm9yICcke3RoaXMuZ2VvbG9jYXRvci5uYW1lfScgd2l0aCBoaWdoIGFjY3VyYWN5IHNldCB0byAnJHtnZW9PcHRpb25zLmVuYWJsZUhpZ2hBY2N1cmFjeX0nYFxuICAgICk7XG5cbiAgICB0aGlzLmdwc0xvY2F0b3JTdWJzY3JpcHRpb24gPSB0aGlzLmdlb2xvY2F0b3Iud2F0Y2hQb3NpdGlvbihnZW9PcHRpb25zKVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgcG9zaXRpb24gPT4gdGhpcy5vblBvc2l0aW9uUmVjaWV2ZWQocG9zaXRpb24pLFxuICAgICAgICBlcnJvciA9PiB0aGlzLm9uTG9jYXRpb25FcnJvcihlcnJvcilcbiAgICAgICk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGRpc2FibGVHcHNUcmFja2luZygpOiB0aGlzIHtcbiAgICB0aGlzLmlzVHJhY2tpbmdQb3NpdGlvbiA9IGZhbHNlO1xuICAgIHRoaXMudHJ5VW5zdWJzY3JpYmUoKTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0R2VvTG9jYXRvcihnZW9sb2NhdG9yOiBHZW9sb2NhdG9yKTogdGhpcyB7XG4gICAgdGhpcy50cnlVbnN1YnNjcmliZSgpO1xuICAgIHRoaXMuZ2VvbG9jYXRvciA9IGdlb2xvY2F0b3I7XG4gICAgaWYgKHRoaXMuaXNUcmFja2luZ1Bvc2l0aW9uKSB7XG4gICAgICB0aGlzLmVuYWJsZUdwc1RyYWNraW5nKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRHcHNUcmFja2luZyhpc1RyYWNraW5nTG9jYXRpb246IGJvb2xlYW4pOiB0aGlzIHtcbiAgICBpZiAoaXNUcmFja2luZ0xvY2F0aW9uKSB7XG4gICAgICB0aGlzLmVuYWJsZUdwc1RyYWNraW5nKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlzYWJsZUdwc1RyYWNraW5nKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB0b2dnbGVHcHNUcmFja2luZygpOiB0aGlzIHtcbiAgICB0aGlzLnNldEdwc1RyYWNraW5nKCF0aGlzLmlzVHJhY2tpbmdQb3NpdGlvbik7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBtb2NrR3BzUG9zaXRpb24ocG9zaXRpb246IEdwc1Bvc2l0aW9uIHwgUG9zaXRpb25FcnJvcik6IHRoaXMge1xuICAgIGlmICghdGhpcy5jb25maWcuYWxsb3dHcHNNb2NraW5nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Blcm1pc3Npb24gZGVuaWVkIHRvIG1vY2sgR1BTIGxvY2F0aW9uJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMub25Qb3NpdGlvblJlY2lldmVkKHBvc2l0aW9uKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBvblBvc2l0aW9uUmVjaWV2ZWQocG9zaXRpb246IEdwc1Bvc2l0aW9uIHwgUG9zaXRpb25FcnJvcik6IHRoaXMge1xuICAgIGlmIChpc1Bvc2l0aW9uRXJyb3IocG9zaXRpb24pKSB7XG4gICAgICB0aGlzLm9uTG9jYXRpb25FcnJvcihwb3NpdGlvbiBhcyBQb3NpdGlvbkVycm9yKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbnN0IGdwc1Bvc2l0aW9uID0gcG9zaXRpb24gYXMgR3BzUG9zaXRpb247XG4gICAgaWYgKGlzTm90VmFsaWRMb2NhdGlvbihncHNQb3NpdGlvbikpIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGNvbnN0IGlzUHJldmlvdXNQb2ludFNhbWVBc05ldyA9IHRoaXMucG9zaXRpb25cbiAgICAgICYmIGdwc1Bvc2l0aW9uc0FsbW9zdEVxdWFsKHRoaXMucG9zaXRpb24sIGdwc1Bvc2l0aW9uLCB0aGlzLmNvbmZpZy5ncHNQb3NpdGlvbkR1cGxpY2F0ZVByZWNpc2lvbik7XG5cbiAgICBpZiAoaXNQcmV2aW91c1BvaW50U2FtZUFzTmV3ICYmICF0aGlzLmNvbmZpZy5lbWl0RHVwbGljYXRlR3BzUG9zaXRpb25zKSB7XG4gICAgICB0aGlzLnBvc2l0aW9uUmVjaWV2ZWRTdWJqZWN0Lm5leHQoZ3BzUG9zaXRpb24pO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdGhpcy5sb2cudHJhY2UoYExvY2F0aW9uIHJlY2lldmVkIGZyb20gJyR7dGhpcy5nZW9sb2NhdG9yLm5hbWV9JzogJHtncHNQb3NpdGlvbi5sYXRpdHVkZX0sICR7Z3BzUG9zaXRpb24ubG9uZ2l0dWRlfWApO1xuICAgIHRoaXMuYWRqdXN0Q29vcmRpbmF0ZXMoZ3BzUG9zaXRpb24pO1xuICAgIHRoaXMucG9zaXRpb24gPSBncHNQb3NpdGlvbjtcbiAgICB0aGlzLmlzVHJhY2tpbmdQb3NpdGlvbiA9IHRydWU7XG4gICAgdGhpcy5wb3NpdGlvblJlY2lldmVkVGltZSA9IG5ldyBEYXRlKHRoaXMucG9zaXRpb24udGltZXN0YW1wIHx8IERhdGUubm93KCkpO1xuICAgIHRoaXMucG9zaXRpb25SZWNpZXZlZFN1YmplY3QubmV4dCh0aGlzLnBvc2l0aW9uKTtcbiAgICB0aGlzLnBvc2l0aW9uQ2hhbmdlU3ViamVjdC5uZXh0KHRoaXMucG9zaXRpb24pO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwcm90ZWN0ZWQgb25Mb2NhdGlvbkVycm9yKGVycm9yOiBQb3NpdGlvbkVycm9yKTogdGhpcyB7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3JNc2coJ0ZhaWxlZCB0byByZXRyaWV2ZSBsb2NhdGlvbiBwb3NpdGlvbi4ge2Vycm9yfScsIGVycm9yKTtcbiAgICB0aGlzLnBvc2l0aW9uQ2hhbmdlU3ViamVjdC5lcnJvcihlcnJvcik7XG4gICAgdGhpcy5sb2cuZXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICB0aGlzLm5vdGlmeS5lcnJvcihlcnJvck1lc3NhZ2UpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGp1c3RDb29yZGluYXRlcyhwb3NpdGlvbjogR3BzUG9zaXRpb24pOiB0aGlzIHtcbiAgICB0aGlzLnRyeUFkanVzdE1pc3NpbmdQb3NpdGlvblZhbHVlcyhwb3NpdGlvbik7XG5cbiAgICBpZiAodGhpcy5jb25maWcuYWRqdXN0Rm9yR3BzQW50ZW5uYUhlaWdodCAmJiB0aGlzLmNvbmZpZy5ncHNBbnRlbm5hSGVpZ2h0KSB7XG4gICAgICBsZXQgYWRqdXN0ZWRIZWlnaHQgPSBwb3NpdGlvbi5hbHRpdHVkZSAtIHRoaXMuY29uZmlnLmdwc0FudGVubmFIZWlnaHQ7XG4gICAgICBhZGp1c3RlZEhlaWdodCA9IGFkanVzdGVkSGVpZ2h0IDwgMCA/IDAgOiBhZGp1c3RlZEhlaWdodDtcblxuICAgICAgdGhpcy5sb2cudHJhY2UoYEFkanVzdGluZyBjb29yZGluYXRlIGFsdGl0dWRlIGZyb20gJHtwb3NpdGlvbi5hbHRpdHVkZX0gdG8gJHthZGp1c3RlZEhlaWdodH1gKTtcbiAgICAgIE9iamVjdC5hc3NpZ24ocG9zaXRpb24sIHtcbiAgICAgICAgYWx0aXR1ZGU6IGFkanVzdGVkSGVpZ2h0XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHByaXZhdGUgdHJ5QWRqdXN0TWlzc2luZ1Bvc2l0aW9uVmFsdWVzKG5ld1Bvc2l0aW9uOiBHcHNQb3NpdGlvbik6IHZvaWQge1xuICAgIGNvbnN0IG1pc3NpbmdTcGVlZCA9IGlzTm90VmFsdWUobmV3UG9zaXRpb24uc3BlZWQpO1xuICAgIGNvbnN0IG1pc3NpbmdIZWFkaW5nID0gaXNOb3RWYWx1ZShuZXdQb3NpdGlvbi5oZWFkaW5nKTtcbiAgICBjb25zdCBwb3NpdGlvblZhbHVlc01pc3NpbmcgPSBtaXNzaW5nU3BlZWQgfHwgbWlzc2luZ0hlYWRpbmc7XG4gICAgY29uc3Qgc2hvdWxkQWRqdXN0UG9zaXRpb25WYWx1ZXMgPSB0aGlzLnBvc2l0aW9uICYmIHBvc2l0aW9uVmFsdWVzTWlzc2luZyAmJiB0aGlzLmNvbmZpZy5jYWxjdWxhdGVNaXNzaW5nUG9zaXRpb25WYWx1ZXM7XG5cbiAgICBpZiAoc2hvdWxkQWRqdXN0UG9zaXRpb25WYWx1ZXMpIHtcbiAgICAgIGNvbnN0IGZyb21Qb2ludCA9IGdwc1Bvc2l0aW9uVG9Qb2ludCh0aGlzLnBvc2l0aW9uKTtcbiAgICAgIGNvbnN0IHRvUG9pbnQgPSBncHNQb3NpdGlvblRvUG9pbnQobmV3UG9zaXRpb24pO1xuXG4gICAgICBpZiAobWlzc2luZ1NwZWVkKSB7XG4gICAgICAgIC8vIG1ldGVycyBwZXIgc2Vjb25kXG4gICAgICAgIGNvbnN0IGtpbG9tZXRlcnNUcmF2ZWxlZCA9IGRpc3RhbmNlKGZyb21Qb2ludCwgdG9Qb2ludCwgeyB1bml0czogJ2tpbG9tZXRlcnMnIH0pO1xuICAgICAgICBpZiAoa2lsb21ldGVyc1RyYXZlbGVkKSB7XG4gICAgICAgICAgY29uc3QgbWV0ZXJzVHJhdmVsZWQgPSBjb252ZXJ0TGVuZ3RoVW5pdHMoa2lsb21ldGVyc1RyYXZlbGVkLCBMZW5ndGhVbml0LktpbG9tZXRlciwgTGVuZ3RoVW5pdC5NZXRlcik7XG4gICAgICAgICAgY29uc3Qgc2Vjb25kc0RlbHRhID0gbWlsbGlzZWNvbmRzVG9TZWNvbmRzKFxuICAgICAgICAgICAgTWF0aC5hYnMobmV3UG9zaXRpb24udGltZXN0YW1wIC0gdGhpcy5wb3NpdGlvbi50aW1lc3RhbXApXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBzcGVlZCA9IG1ldGVyc1RyYXZlbGVkIC8gc2Vjb25kc0RlbHRhO1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24obmV3UG9zaXRpb24sIHsgc3BlZWQgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKG1pc3NpbmdIZWFkaW5nKSB7XG4gICAgICAgIGNvbnN0IGhlYWRpbmcgPSBiZWFyaW5nKGZyb21Qb2ludCwgdG9Qb2ludCk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24obmV3UG9zaXRpb24sIHsgaGVhZGluZyB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHRyeVVuc3Vic2NyaWJlKCk6IHRoaXMge1xuICAgIGlmICh0aGlzLmdwc0xvY2F0b3JTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMubG9nLmRlYnVnKGBVbnN1YnNjcmliaW5nIGZyb20gd2F0Y2hpbmcgR1BTIHN0cmVhbSBmcm9tICcke3RoaXMuZ2VvbG9jYXRvci5uYW1lfSdgKTtcbiAgICAgIHRoaXMuZ3BzTG9jYXRvclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG59XG4iXX0=