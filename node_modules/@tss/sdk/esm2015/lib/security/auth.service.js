/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
// 3rd party.
import { Subject } from 'rxjs';
import { publishReplay } from 'rxjs/operators';
import { RoleManagerService } from './role-manager.service';
import { SecurityConfig } from './security-config';
import { Logger } from '../core/logging/logger.service';
import { PersistentStorage } from '../core/storage/persistent-storage.service';
import { isString } from '../core/type-check/is-string.function';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./role-manager.service";
import * as i3 from "./security-config";
import * as i4 from "../core/storage/persistent-storage.service";
import * as i5 from "../core/logging/logger.service";
/** @enum {number} */
const SignInState = {
    SignedIn: 0,
    SignedOut: 1,
    SignInFailed: 2,
    SignOutFailed: 3,
};
export { SignInState };
SignInState[SignInState.SignedIn] = 'SignedIn';
SignInState[SignInState.SignedOut] = 'SignedOut';
SignInState[SignInState.SignInFailed] = 'SignInFailed';
SignInState[SignInState.SignOutFailed] = 'SignOutFailed';
export class AuthService {
    /**
     * @param {?} http
     * @param {?} roleMgr
     * @param {?} config
     * @param {?} storage
     * @param {?} log
     */
    constructor(http, roleMgr, config, storage, log) {
        this.http = http;
        this.roleMgr = roleMgr;
        this.config = config;
        this.storage = storage;
        this.log = log;
        this.stateChangeSubject = new Subject();
        this.rememberMe = config.storeToken;
        this.stateChange = this.stateChangeSubject.asObservable();
        if (config.autoSignIn && !this.isAuthenticated) {
            this.loadStoredToken();
        }
    }
    /**
     * @param {?} userName
     * @param {?} password
     * @param {?=} rememberMe
     * @return {?}
     */
    signIn(userName, password, rememberMe = this.rememberMe) {
        /** @type {?} */
        const observable = this.http.post(`${this.config.serviceUrl}/${this.config.tokenEndpoint}`, this.config.tokenBody(userName, password))
            .pipe(publishReplay(1));
        this.rememberMe = rememberMe;
        observable.subscribe(this.onSignedIn.bind(this), this.onSignInFailed.bind(this));
        return observable;
    }
    /**
     * @return {?}
     */
    signOut() {
        /** @type {?} */
        const signOutUrl = `${this.config.serviceUrl}/${this.config.signOutEndpoint}`;
        if (this.isFederatedAccount) {
            this.log.info(`Signing out. Authentication Type: STS. Forwarded to: ${signOutUrl}`);
            this.onSignedOut();
            if (typeof location !== 'undefined') {
                location.href = signOutUrl;
            }
        }
        else {
            // The only reason this "Account" method is abstracted here is because there is additional stuff that
            // has to happen when you sign out - like removing the user information cache, etc.
            /** @type {?} */
            const obserable = this.http.get(signOutUrl)
                .pipe(publishReplay(1));
            obserable
                .subscribe(this.onSignedOut.bind(this), this.onSignedOutFailed.bind(this));
            return obserable;
        }
    }
    /**
     * @return {?}
     */
    getUserInfo() {
        return this.http.get(`${this.config.serviceUrl}/${this.config.userInfoEndpoint}`);
    }
    /**
     * @return {?}
     */
    getToken() {
        return this.isAuthenticated
            ? this.account.access_token || null
            : null;
    }
    /**
     * @return {?}
     */
    loadStoredToken() {
        /** @type {?} */
        const token = this.getLocalToken();
        /** @type {?} */
        let loaded = false;
        if (token && token['.expires']) {
            /** @type {?} */
            const expiresDate = token['.expires'];
            if (expiresDate > new Date()) {
                this.onSignedIn(token, true);
                loaded = true;
            }
        }
        return loaded;
    }
    /**
     * @param {?} account
     * @param {?=} skipLocalStorage
     * @return {?}
     */
    onSignedIn(account, skipLocalStorage = false) {
        this.account = account;
        this.isAuthenticated = true;
        this.isDomainAccount = (account.foundContextType || '').toLowerCase() === 'domain';
        this.isFederatedAccount = (account.authenticationType || '').toLowerCase() === 'federation';
        // Note, we are exposing the access token through the security config because the token intercepter
        // can not use this auth service - it will result in a cyclic dpendency injection error.
        // See Angular issue: https://github.com/angular/angular/issues/18224
        // TODO: Deprecate "accessToken" property on "SecurityConfig" once this is resolved - RG.
        this.config.accessToken = account.access_token;
        this.roleMgr.setRoles(account.privileges || account.roles);
        if (!skipLocalStorage && this.rememberMe) {
            account.lastSignIn = new Date();
            this.setLocalToken(account);
        }
        this.log.debug('User signed in succesfully');
        this.stateChangeSubject.next(SignInState.SignedIn);
    }
    /**
     * @return {?}
     */
    onSignedOut() {
        // We set the "authenticated" flag state to false so that anyone watching this can see the new state and
        // get rid of the account information that was cached, because it is no longer applicable.
        this.isAuthenticated = false;
        this.isDomainAccount = false;
        this.isFederatedAccount = false;
        this.account = null;
        this.roleMgr.clearRoles();
        this.setLocalToken(null);
        this.log.debug('User signed out succesfully');
        this.stateChangeSubject.next(SignInState.SignedOut);
    }
    /**
     * @private
     * @param {?} err
     * @return {?}
     */
    onSignInFailed(err) {
        this.log.error('Failed to sign in', err);
        this.stateChangeSubject.next(SignInState.SignInFailed);
    }
    /**
     * @private
     * @param {?} err
     * @return {?}
     */
    onSignedOutFailed(err) {
        this.log.error('Failed to sign out', err);
        this.stateChangeSubject.next(SignInState.SignOutFailed);
    }
    /**
     * @private
     * @return {?}
     */
    getLocalToken() {
        try {
            /** @type {?} */
            const token = this.storage.getObject(this.config.tokenStorageKey);
            if (token && token.lastSignIn && isString(token.lastSignIn)) {
                token.lastSignIn = new Date(token.lastSignIn);
            }
            if (token && token['.expires'] && isString(token['.expires'])) {
                token['.expires'] = new Date(Date.parse(token['.expires']));
            }
            return token;
        }
        finally {
            // We don't need to do anything bbecause this is not critical path.
        }
    }
    /**
     * @private
     * @param {?} token
     * @return {?}
     */
    setLocalToken(token) {
        try {
            if (token) {
                this.storage.setObject(this.config.tokenStorageKey, token);
            }
            else {
                this.storage.remove(this.config.tokenStorageKey);
            }
        }
        finally {
            // We don't need to do anything as this is not a core workflow.
        }
    }
}
AuthService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
AuthService.ctorParameters = () => [
    { type: HttpClient },
    { type: RoleManagerService },
    { type: SecurityConfig },
    { type: PersistentStorage },
    { type: Logger }
];
/** @nocollapse */ AuthService.ngInjectableDef = i0.defineInjectable({ factory: function AuthService_Factory() { return new AuthService(i0.inject(i1.HttpClient), i0.inject(i2.RoleManagerService), i0.inject(i3.SecurityConfig), i0.inject(i4.PersistentStorage), i0.inject(i5.Logger)); }, token: AuthService, providedIn: "root" });
if (false) {
    /** @type {?} */
    AuthService.prototype.rememberMe;
    /** @type {?} */
    AuthService.prototype.account;
    /** @type {?} */
    AuthService.prototype.isAuthenticated;
    /** @type {?} */
    AuthService.prototype.isDomainAccount;
    /** @type {?} */
    AuthService.prototype.isFederatedAccount;
    /** @type {?} */
    AuthService.prototype.stateChange;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.stateChangeSubject;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.roleMgr;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.log;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvc2VjdXJpdHkvYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7O0FBR2xELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSS9DLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDL0UsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVDQUF1QyxDQUFDOzs7Ozs7Ozs7SUFJL0QsV0FBUTtJQUNSLFlBQVM7SUFDVCxlQUFZO0lBQ1osZ0JBQWE7Ozs7Ozs7QUFPZixNQUFNLE9BQU8sV0FBVzs7Ozs7Ozs7SUFVdEIsWUFDVSxJQUFnQixFQUNoQixPQUEyQixFQUMzQixNQUFzQixFQUN0QixPQUEwQixFQUMxQixHQUFXO1FBSlgsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixZQUFPLEdBQVAsT0FBTyxDQUFvQjtRQUMzQixXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUMxQixRQUFHLEdBQUgsR0FBRyxDQUFRO1FBUEosdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQWUsQ0FBQztRQVMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7UUFDcEMsSUFBSSxD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QUssQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDN0Q7WUFFRCxPQUFPLEtBQUssQ0FBQztTQUNkO2dCQUFTO1lBQ1IsbUVBQW1FO1NBQ3BFO0lBQ0gsQ0FBQzs7Ozs7O0lBRU8sYUFBYSxDQUFDLEtBQUs7UUFDekIsSUFBSTtZQUNGLElBQUksS0FBSyxFQUFFO2dCQUNULElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQzVEO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7YUFDbEQ7U0FDRjtnQkFBUztZQUNSLCtEQUErRDtTQUNoRTtJQUNILENBQUM7OztZQXJLRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7Ozs7WUF6QlEsVUFBVTtZQVFWLGtCQUFrQjtZQUNsQixjQUFjO1lBRWQsaUJBQWlCO1lBRGpCLE1BQU07Ozs7O0lBaUJiLGlDQUFvQjs7SUFDcEIsOEJBQXFCOztJQUNyQixzQ0FBeUI7O0lBQ3pCLHNDQUF5Qjs7SUFDekIseUNBQTRCOztJQUU1QixrQ0FBOEM7Ozs7O0lBQzlDLHlDQUFpRTs7Ozs7SUFHL0QsMkJBQXdCOzs7OztJQUN4Qiw4QkFBbUM7Ozs7O0lBQ25DLDZCQUE4Qjs7Ozs7SUFDOUIsOEJBQWtDOzs7OztJQUNsQywwQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBbmd1bGFyLlxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuLy8gM3JkIHBhcnR5LlxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgcHVibGlzaFJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLy8gVFNTLlxuaW1wb3J0IHsgVXNlckFjY291bnQgfSBmcm9tICcuL3VzZXItYWNjb3VudCc7XG5pbXBvcnQgeyBSb2xlTWFuYWdlclNlcnZpY2UgfSBmcm9tICcuL3JvbGUtbWFuYWdlci5zZXJ2aWNlJztcbmltcG9ydCB7IFNlY3VyaXR5Q29uZmlnIH0gZnJvbSAnLi9zZWN1cml0eS1jb25maWcnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vY29yZS9sb2dnaW5nL2xvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcnNpc3RlbnRTdG9yYWdlIH0gZnJvbSAnLi4vY29yZS9zdG9yYWdlL3BlcnNpc3RlbnQtc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7IGlzU3RyaW5nIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLXN0cmluZy5mdW5jdGlvbic7XG5cblxuZXhwb3J0IGVudW0gU2lnbkluU3RhdGUge1xuICBTaWduZWRJbixcbiAgU2lnbmVkT3V0LFxuICBTaWduSW5GYWlsZWQsXG4gIFNpZ25PdXRGYWlsZWQsXG59XG5cblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgQXV0aFNlcnZpY2Uge1xuICByZW1lbWJlck1lOiBib29sZWFuO1xuICBhY2NvdW50OiBVc2VyQWNjb3VudDtcbiAgaXNBdXRoZW50aWNhdGVkOiBib29sZWFuO1xuICBpc0RvbWFpbkFjY291bnQ6IGJvb2xlYW47XG4gIGlzRmVkZXJhdGVkQWNjb3VudDogYm9vbGVhbjtcblxuICByZWFkb25seSBzdGF0ZUNoYW5nZTogT2JzZXJ2YWJsZTxTaWduSW5TdGF0ZT47XG4gIHByaXZhdGUgcmVhZG9ubHkgc3RhdGVDaGFuZ2VTdWJqZWN0ID0gbmV3IFN1YmplY3Q8U2lnbkluU3RhdGU+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByaXZhdGUgcm9sZU1ncjogUm9sZU1hbmFnZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgY29uZmlnOiBTZWN1cml0eUNvbmZpZyxcbiAgICBwcml2YXRlIHN0b3JhZ2U6IFBlcnNpc3RlbnRTdG9yYWdlLFxuICAgIHByaXZhdGUgbG9nOiBMb2dnZXJcbiAgKSB7XG4gICAgdGhpcy5yZW1lbWJlck1lID0gY29uZmlnLnN0b3JlVG9rZW47XG4gICAgdGhpcy5zdGF0ZUNoYW5nZSA9IHRoaXMuc3RhdGVDaGFuZ2VTdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuXG4gICAgaWYgKGNvbmZpZy5hdXRvU2lnbkluICYmICF0aGlzLmlzQXV0aGVudGljYXRlZCkge1xuICAgICAgdGhpcy5sb2FkU3RvcmVkVG9rZW4oKTtcbiAgICB9XG4gIH1cblxuICBzaWduSW4odXNlck5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZywgcmVtZW1iZXJNZTogYm9vbGVhbiA9IHRoaXMucmVtZW1iZXJNZSk6IE9ic2VydmFibGU8VXNlckFjY291bnQ+IHtcbiAgICBjb25zdCBvYnNlcnZhYmxlID0gdGhpcy5odHRwLnBvc3Q8VXNlckFjY291bnQ+KFxuICAgICAgYCR7dGhpcy5jb25maWcuc2VydmljZVVybH0vJHt0aGlzLmNvbmZpZy50b2tlbkVuZHBvaW50fWAsXG4gICAgICB0aGlzLmNvbmZpZy50b2tlbkJvZHkodXNlck5hbWUsIHBhc3N3b3JkKVxuICAgIClcbiAgICAgIC5waXBlKFxuICAgICAgICBwdWJsaXNoUmVwbGF5KDEpXG4gICAgICApO1xuXG4gICAgdGhpcy5yZW1lbWJlck1lID0gcmVtZW1iZXJNZTtcbiAgICBvYnNlcnZhYmxlLnN1YnNjcmliZSh0aGlzLm9uU2lnbmVkSW4uYmluZCh0aGlzKSwgdGhpcy5vblNpZ25JbkZhaWxlZC5iaW5kKHRoaXMpKTtcblxuICAgIHJldHVybiBvYnNlcnZhYmxlO1xuICB9XG5cbiAgc2lnbk91dCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHNpZ25PdXRVcmwgPSBgJHt0aGlzLmNvbmZpZy5zZXJ2aWNlVXJsfS8ke3RoaXMuY29uZmlnLnNpZ25PdXRFbmRwb2ludH1gO1xuICAgIGlmICh0aGlzLmlzRmVkZXJhdGVkQWNjb3VudCkge1xuICAgICAgdGhpcy5sb2cuaW5mbyhgU2lnbmluZyBvdXQuIEF1dGhlbnRpY2F0aW9uIFR5cGU6IFNUUy4gRm9yd2FyZGVkIHRvOiAke3NpZ25PdXRVcmx9YCk7XG4gICAgICB0aGlzLm9uU2lnbmVkT3V0KCk7XG5cbiAgICAgIGlmICh0eXBlb2YgbG9jYXRpb24gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgIGxvY2F0aW9uLmhyZWYgPSBzaWduT3V0VXJsO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUaGUgb25seSByZWFzb24gdGhpcyBcIkFjY291bnRcIiBtZXRob2QgaXMgYWJzdHJhY3RlZCBoZXJlIGlzIGJlY2F1c2UgdGhlcmUgaXMgYWRkaXRpb25hbCBzdHVmZiB0aGF0XG4gICAgICAvLyBoYXMgdG8gaGFwcGVuIHdoZW4geW91IHNpZ24gb3V0IC0gbGlrZSByZW1vdmluZyB0aGUgdXNlciBpbmZvcm1hdGlvbiBjYWNoZSwgZXRjLlxuICAgICAgY29uc3Qgb2JzZXJhYmxlID0gdGhpcy5odHRwLmdldChzaWduT3V0VXJsKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBwdWJsaXNoUmVwbGF5KDEpXG4gICAgICAgICk7XG5cbiAgICAgIG9ic2VyYWJsZVxuICAgICAgICAuc3Vic2NyaWJlKHRoaXMub25TaWduZWRPdXQuYmluZCh0aGlzKSwgdGhpcy5vblNpZ25lZE91dEZhaWxlZC5iaW5kKHRoaXMpKTtcblxuICAgICAgcmV0dXJuIG9ic2VyYWJsZTtcbiAgICB9XG4gIH1cblxuICBnZXRVc2VySW5mbygpOiBPYnNlcnZhYmxlPFVzZXJBY2NvdW50PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8VXNlckFjY291bnQ+KGAke3RoaXMuY29uZmlnLnNlcnZpY2VVcmx9LyR7dGhpcy5jb25maWcudXNlckluZm9FbmRwb2ludH1gKTtcbiAgfVxuXG4gIGdldFRva2VuKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuaXNBdXRoZW50aWNhdGVkXG4gICAgICA/IHRoaXMuYWNjb3VudC5hY2Nlc3NfdG9rZW4gfHwgbnVsbFxuICAgICAgOiBudWxsO1xuICB9XG5cbiAgbG9hZFN0b3JlZFRva2VuKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHRva2VuID0gdGhpcy5nZXRMb2NhbFRva2VuKCk7XG4gICAgbGV0IGxvYWRlZCA9IGZhbHNlO1xuXG4gICAgaWYgKHRva2VuICYmIHRva2VuWycuZXhwaXJlcyddKSB7XG4gICAgICBjb25zdCBleHBpcmVzRGF0ZSA9IHRva2VuWycuZXhwaXJlcyddO1xuICAgICAgaWYgKGV4cGlyZXNEYXRlID4gbmV3IERhdGUoKSkge1xuICAgICAgICB0aGlzLm9uU2lnbmVkSW4odG9rZW4sIHRydWUpO1xuICAgICAgICBsb2FkZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBsb2FkZWQ7XG4gIH1cblxuICBvblNpZ25lZEluKGFjY291bnQ6IFVzZXJBY2NvdW50LCBza2lwTG9jYWxTdG9yYWdlOiBib29sZWFuID0gZmFsc2UpIHtcbiAgICB0aGlzLmFjY291bnQgPSBhY2NvdW50O1xuICAgIHRoaXMuaXNBdXRoZW50aWNhdGVkID0gdHJ1ZTtcbiAgICB0aGlzLmlzRG9tYWluQWNjb3VudCA9IChhY2NvdW50LmZvdW5kQ29udGV4dFR5cGUgfHwgJycpLnRvTG93ZXJDYXNlKCkgPT09ICdkb21haW4nO1xuICAgIHRoaXMuaXNGZWRlcmF0ZWRBY2NvdW50ID0gKGFjY291bnQuYXV0aGVudGljYXRpb25UeXBlIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnZmVkZXJhdGlvbic7XG5cbiAgICAvLyBOb3RlLCB3ZSBhcmUgZXhwb3NpbmcgdGhlIGFjY2VzcyB0b2tlbiB0aHJvdWdoIHRoZSBzZWN1cml0eSBjb25maWcgYmVjYXVzZSB0aGUgdG9rZW4gaW50ZXJjZXB0ZXJcbiAgICAvLyBjYW4gbm90IHVzZSB0aGlzIGF1dGggc2VydmljZSAtIGl0IHdpbGwgcmVzdWx0IGluIGEgY3ljbGljIGRwZW5kZW5jeSBpbmplY3Rpb24gZXJyb3IuXG4gICAgLy8gU2VlIEFuZ3VsYXIgaXNzdWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hbmd1bGFyL2FuZ3VsYXIvaXNzdWVzLzE4MjI0XG4gICAgLy8gVE9ETzogRGVwcmVjYXRlIFwiYWNjZXNzVG9rZW5cIiBwcm9wZXJ0eSBvbiBcIlNlY3VyaXR5Q29uZmlnXCIgb25jZSB0aGlzIGlzIHJlc29sdmVkIC0gUkcuXG4gICAgdGhpcy5jb25maWcuYWNjZXNzVG9rZW4gPSBhY2NvdW50LmFjY2Vzc190b2tlbjtcbiAgICB0aGlzLnJvbGVNZ3Iuc2V0Um9sZXMoYWNjb3VudC5wcml2aWxlZ2VzIHx8IGFjY291bnQucm9sZXMpO1xuXG4gICAgaWYgKCFza2lwTG9jYWxTdG9yYWdlICYmIHRoaXMucmVtZW1iZXJNZSkge1xuICAgICAgYWNjb3VudC5sYXN0U2lnbkluID0gbmV3IERhdGUoKTtcbiAgICAgIHRoaXMuc2V0TG9jYWxUb2tlbihhY2NvdW50KTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZy5kZWJ1ZygnVXNlciBzaWduZWQgaW4gc3VjY2VzZnVsbHknKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlU3ViamVjdC5uZXh0KFNpZ25JblN0YXRlLlNpZ25lZEluKTtcbiAgfVxuXG4gIG9uU2lnbmVkT3V0KCkge1xuICAgIC8vIFdlIHNldCB0aGUgXCJhdXRoZW50aWNhdGVkXCIgZmxhZyBzdGF0ZSB0byBmYWxzZSBzbyB0aGF0IGFueW9uZSB3YXRjaGluZyB0aGlzIGNhbiBzZWUgdGhlIG5ldyBzdGF0ZSBhbmRcbiAgICAvLyBnZXQgcmlkIG9mIHRoZSBhY2NvdW50IGluZm9ybWF0aW9uIHRoYXQgd2FzIGNhY2hlZCwgYmVjYXVzZSBpdCBpcyBubyBsb25nZXIgYXBwbGljYWJsZS5cbiAgICB0aGlzLmlzQXV0aGVudGljYXRlZCA9IGZhbHNlO1xuICAgIHRoaXMuaXNEb21haW5BY2NvdW50ID0gZmFsc2U7XG4gICAgdGhpcy5pc0ZlZGVyYXRlZEFjY291bnQgPSBmYWxzZTtcbiAgICB0aGlzLmFjY291bnQgPSBudWxsO1xuICAgIHRoaXMucm9sZU1nci5jbGVhclJvbGVzKCk7XG4gICAgdGhpcy5zZXRMb2NhbFRva2VuKG51bGwpO1xuICAgIHRoaXMubG9nLmRlYnVnKCdVc2VyIHNpZ25lZCBvdXQgc3VjY2VzZnVsbHknKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlU3ViamVjdC5uZXh0KFNpZ25JblN0YXRlLlNpZ25lZE91dCk7XG4gIH1cblxuICBwcml2YXRlIG9uU2lnbkluRmFpbGVkKGVycjogYW55KSB7XG4gICAgdGhpcy5sb2cuZXJyb3IoJ0ZhaWxlZCB0byBzaWduIGluJywgZXJyKTtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlU3ViamVjdC5uZXh0KFNpZ25JblN0YXRlLlNpZ25JbkZhaWxlZCk7XG4gIH1cblxuICBwcml2YXRlIG9uU2lnbmVkT3V0RmFpbGVkKGVycjogYW55KSB7XG4gICAgdGhpcy5sb2cuZXJyb3IoJ0ZhaWxlZCB0byBzaWduIG91dCcsIGVycik7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZVN1YmplY3QubmV4dChTaWduSW5TdGF0ZS5TaWduT3V0RmFpbGVkKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9jYWxUb2tlbigpOiBVc2VyQWNjb3VudCB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRva2VuOiBVc2VyQWNjb3VudCA9IHRoaXMuc3RvcmFnZS5nZXRPYmplY3QodGhpcy5jb25maWcudG9rZW5TdG9yYWdlS2V5KTtcblxuICAgICAgaWYgKHRva2VuICYmIHRva2VuLmxhc3RTaWduSW4gJiYgaXNTdHJpbmcodG9rZW4ubGFzdFNpZ25JbikpIHtcbiAgICAgICAgdG9rZW4ubGFzdFNpZ25JbiA9IG5ldyBEYXRlKHRva2VuLmxhc3RTaWduSW4pO1xuICAgICAgfVxuXG4gICAgICBpZiAodG9rZW4gJiYgdG9rZW5bJy5leHBpcmVzJ10gJiYgaXNTdHJpbmcodG9rZW5bJy5leHBpcmVzJ10pKSB7XG4gICAgICAgIHRva2VuWycuZXhwaXJlcyddID0gbmV3IERhdGUoRGF0ZS5wYXJzZSh0b2tlblsnLmV4cGlyZXMnXSkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdG9rZW47XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcgYmJlY2F1c2UgdGhpcyBpcyBub3QgY3JpdGljYWwgcGF0aC5cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldExvY2FsVG9rZW4odG9rZW4pOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgaWYgKHRva2VuKSB7XG4gICAgICAgIHRoaXMuc3RvcmFnZS5zZXRPYmplY3QodGhpcy5jb25maWcudG9rZW5TdG9yYWdlS2V5LCB0b2tlbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlKHRoaXMuY29uZmlnLnRva2VuU3RvcmFnZUtleSk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIC8vIFdlIGRvbid0IG5lZWQgdG8gZG8gYW55dGhpbmcgYXMgdGhpcyBpcyBub3QgYSBjb3JlIHdvcmtmbG93LlxuICAgIH1cbiAgfVxufVxuIl19