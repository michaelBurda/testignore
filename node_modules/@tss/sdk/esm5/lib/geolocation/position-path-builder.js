/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import destination from '@turf/destination';
import bearing from '@turf/bearing';
import { isPositionAcceptable } from './is-position-acceptable.function';
import { setMeasuresByGeometricLength } from '../geometry/geometry/set-measures-by-geometric-length.function';
import { isMultiPartLine } from '../geometry/line/is-multi-part.function';
import { getMeasureFromPoint } from '../geometry/point/get-measure-from-point.function';
import { PATH_BUILDER_EMPTY_CALIBRATION_MEASURE_VALUE, PATH_BUILDER_CALCULATED_M_DEVICE_SOURCE } from './geolocation.constants';
import { getDistanceBetweenLatLng } from '../geometry/point/get-distance-between-points.function';
import { convertLengthUnits } from '../core/units/convert-length-units.function';
import { LengthUnit } from '../core/units/length-unit';
import { sumValues } from '../core/stats/sum-values.function';
import { getLastItem } from '../core/array/get-last-item.function';
import { isNumber } from '../core/type-check/is-number.function';
import { pointsAlmostEqual } from '../core/equality/points-almost-equal.function';
/** @type {?} */
var UNPLACED_CALIBRATION_MEASURE_KEY = 'pending';
/** @type {?} */
var DEFAULT_OPTIONS = {
    gpsRequiredAccuracyMeters: 10,
    requireAccuracy: true,
    pointEquivalencyPrecision: 8,
    returnZValues: true,
    returnMValues: true,
    mValueUnit: 'miles',
    storeUnfilteredPath: false,
    calibrationMeasureSnappingDistanceDelta: 2,
    calibrationMeasureSnappingDistanceDeltaUnit: LengthUnit.Foot
};
var PositionPathBuilder = /** @class */ (function () {
    function PositionPathBuilder(options) {
        this.parts = [[]];
        this.unfilteredPath = [];
        this.calibratedMeasures = new Map();
        this.options = Object.assign({}, DEFAULT_OPTIONS, options);
    }
    Object.defineProperty(PositionPathBuilder.prototype, "positionCount", {
        get: /**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var counts = this.parts.map((/**
             * @param {?} part
             * @return {?}
             */
            function (part) { return part.length; }));
            return sumValues(counts);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "currentPartIndex", {
        get: /**
         * @return {?}
         */
        function () {
            return this.parts.length - 1;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "currentPart", {
        get: /**
         * @return {?}
         */
        function () {
            return this.parts[this.currentPartIndex];
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "lastPosition", {
        get: /**
         * @return {?}
         */
        function () {
            return getLastItem(this.currentPart);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "hasPosition", {
        get: /**
         * @return {?}
         */
        function () {
            return Boolean(this.lastPosition);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "isEmpty", {
        get: /**
         * @return {?}
         */
        function () {
            return this.currentPart.length === 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "isValidPath", {
        get: /**
         * @return {?}
         */
        function () {
            return this.currentPart.length > 1;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PositionPathBuilder.prototype, "isSinglePoint", {
        get: /**
         * @return {?}
         */
        function () {
            return this.parts.length === 1 && this.currentPart.length === 1;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} positionStream
     * @return {THIS}
     */
    PositionPathBuilder.prototype.trackPosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} positionStream
     * @return {THIS}
     */
    function (positionStream) {
        var _this = this;
        (/** @type {?} */ (this)).trackSubscription = positionStream.subscribe((/**
         * @template THIS
         * @this {THIS}
         * @param {?} position
         * @return {THIS}
         */
        function (position) { return (/** @type {?} */ (_this)).addPosition(position); }));
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @param {?=} calibrationMeasure
     * @return {THIS}
     */
    PositionPathBuilder.prototype.addPosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @param {?=} calibrationMeasure
     * @return {THIS}
     */
    function (position, calibrationMeasure) {
        /** @type {?} */
        var accuracyCriteriaMet = !(/** @type {?} */ (this)).options.requireAccuracy
            || isPositionAcceptable(position, (/** @type {?} */ (this)).options.gpsRequiredAccuracyMeters);
        /** @type {?} */
        var positionNotAcceptable = !position || !accuracyCriteriaMet;
        if (positionNotAcceptable) {
            return (/** @type {?} */ (this)).tryStoreUnfilteredPath(position);
        }
        if ((/** @type {?} */ (this)).isEmpty) {
            return (/** @type {?} */ (this)).forceAddPosition(position);
        }
        /** @type {?} */
        var pointsAtSameLocation = (/** @type {?} */ (this)).arePositionsEquivalent((/** @type {?} */ (this)).lastPosition, position);
        /** @type {?} */
        var bothPointsAtStandStill = (/** @type {?} */ (this)).lastPosition.speed === 0 && position.speed === 0 || pointsAtSameLocation;
        if (bothPointsAtStandStill) {
            (/** @type {?} */ (this)).tryStoreUnfilteredPath(position)
                .replaceLastPositionIfBetter(position);
            return (/** @type {?} */ (this));
        }
        (/** @type {?} */ (this)).forceAddPosition(position);
        if (isNumber(calibrationMeasure)) {
            (/** @type {?} */ (this)).addCalibrationMeasureToLastPosition(calibrationMeasure);
        }
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    PositionPathBuilder.prototype.startNewPart = /**
     * @template THIS
     * @this {THIS}
     * @return {THIS}
     */
    function () {
        (/** @type {?} */ (this)).parts.push([]);
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    PositionPathBuilder.prototype.removePositionByIndex = /**
     * @template THIS
     * @this {THIS}
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    function (vertexIndex, partIndex) {
        if (partIndex === void 0) { partIndex = 0; }
        /** @type {?} */
        var part = (/** @type {?} */ (this)).parts[partIndex];
        if (!part) {
            throw new Error("Invalid part index\" " + partIndex);
        }
        part.splice(vertexIndex, 1);
        /** @type {?} */
        var key = (/** @type {?} */ (this)).getCalibrationMeasureLookupKey(partIndex, vertexIndex);
        if ((/** @type {?} */ (this)).calibratedMeasures.has(key)) {
            (/** @type {?} */ (this)).calibratedMeasures.delete(key);
        }
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    PositionPathBuilder.prototype.removePosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    function (position) {
        /** @type {?} */
        var partIndex = -1;
        /** @type {?} */
        var vertexIndex = -1;
        (/** @type {?} */ (this)).parts.forEach((/**
         * @param {?} part
         * @param {?} index
         * @return {?}
         */
        function (part, index) {
            /** @type {?} */
            var foundPositionIndex = part.indexOf(position);
            if (foundPositionIndex > -1) {
                partIndex = index;
                vertexIndex = foundPositionIndex;
            }
        }));
        if (partIndex > -1 && vertexIndex > -1) {
            return (/** @type {?} */ (this)).removePositionByIndex(vertexIndex, partIndex);
        }
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    PositionPathBuilder.prototype.removeCalibrationMeasure = /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    function (measure) {
        var _this = this;
        Array.from((/** @type {?} */ (this)).calibratedMeasures.values())
            .filter((/**
         * @param {?} calibration
         * @return {?}
         */
        function (calibration) { return calibration.measure === measure; }))
            .forEach((/**
         * @template THIS
         * @this {THIS}
         * @param {?} calibration
         * @return {THIS}
         */
        function (calibration) {
            return (/** @type {?} */ (_this)).removeCalibrationMeasureByIndex(calibration.vertexIndex, calibration.partIndex);
        }));
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    PositionPathBuilder.prototype.removeCalibrationMeasureByIndex = /**
     * @template THIS
     * @this {THIS}
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    function (vertexIndex, partIndex) {
        if (partIndex === void 0) { partIndex = 0; }
        /** @type {?} */
        var key = (/** @type {?} */ (this)).getCalibrationMeasureLookupKey(partIndex, vertexIndex);
        if ((/** @type {?} */ (this)).calibratedMeasures.has(key)) {
            (/** @type {?} */ (this)).calibratedMeasures.delete(key);
        }
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    PositionPathBuilder.prototype.addCalibrationMeasure = /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    function (measure) {
        /** @type {?} */
        var timestamp = new Date().getTime();
        var _a = tslib_1.__read((/** @type {?} */ (this)).currentPart.slice(-1), 1), lastVertex = _a[0];
        if (lastVertex && lastVertex.timestamp && lastVertex.timestamp === timestamp) {
            return (/** @type {?} */ (this)).addCalibrationMeasureToLastPosition(measure);
        }
        /** @type {?} */
        var partIndex = (/** @type {?} */ (this)).currentPartIndex;
        /** @type {?} */
        var key = UNPLACED_CALIBRATION_MEASURE_KEY;
        (/** @type {?} */ (this)).calibratedMeasures.set(key, {
            measure: measure,
            partIndex: partIndex,
            vertexIndex: null,
            timestamp: timestamp
        });
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    PositionPathBuilder.prototype.addCalibrationMeasureToLastPosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @return {THIS}
     */
    function (measure) {
        /** @type {?} */
        var partIndex = (/** @type {?} */ (this)).currentPartIndex;
        /** @type {?} */
        var lastVertexIndex = (/** @type {?} */ (this)).currentPart.length - 1;
        return (/** @type {?} */ (this)).addCalibrationMeasureAtIndex(measure, lastVertexIndex, partIndex);
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    PositionPathBuilder.prototype.addCalibrationMeasureAtIndex = /**
     * @template THIS
     * @this {THIS}
     * @param {?} measure
     * @param {?} vertexIndex
     * @param {?=} partIndex
     * @return {THIS}
     */
    function (measure, vertexIndex, partIndex) {
        if (partIndex === void 0) { partIndex = 0; }
        /** @type {?} */
        var key = (/** @type {?} */ (this)).getCalibrationMeasureLookupKey(partIndex, vertexIndex);
        (/** @type {?} */ (this)).calibratedMeasures.set(key, {
            measure: measure,
            partIndex: partIndex,
            vertexIndex: vertexIndex,
            timestamp: new Date().getTime()
        });
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    PositionPathBuilder.prototype.forceAddPosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    function (position) {
        (/** @type {?} */ (this)).tryStoreUnfilteredPath(position);
        (/** @type {?} */ (this)).addPositionToPath(position);
        return (/** @type {?} */ (this));
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toPointFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toPointGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toLineFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toLineGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toSingleLineFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toSingleLineGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toMultiLineFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toMultiLineGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toPolygonFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toPolygonGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toMultiPolygonFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toMultiPolygonGeometry(),
            properties: properties
        };
    };
    /**
     * @param {?=} properties
     * @return {?}
     */
    PositionPathBuilder.prototype.toSinglePolygonFeature = /**
     * @param {?=} properties
     * @return {?}
     */
    function (properties) {
        if (properties === void 0) { properties = {}; }
        return {
            type: 'Feature',
            geometry: this.toSinglePolygonGeometry(),
            properties: properties
        };
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toFeature = /**
     * @return {?}
     */
    function () {
        return this.isSinglePoint
            ? (/** @type {?} */ (this.toPointFeature()))
            : this.toLineFeature();
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toGeometry = /**
     * @return {?}
     */
    function () {
        return this.isSinglePoint
            ? (/** @type {?} */ (this.toPointGeometry()))
            : this.toLineGeometry();
    };
    /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    PositionPathBuilder.prototype.toSingleLineGeometry = /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    function (calibrateMeasures) {
        if (calibrateMeasures === void 0) { calibrateMeasures = true; }
        /** @type {?} */
        var line = this.toLineGeometry(calibrateMeasures);
        if (isMultiPartLine(line.coordinates)) {
            throw new Error('Cannot convert MultiLineString to LineString. Data would be lost');
        }
        return (/** @type {?} */ (line));
    };
    /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    PositionPathBuilder.prototype.toMultiLineGeometry = /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    function (calibrateMeasures) {
        if (calibrateMeasures === void 0) { calibrateMeasures = true; }
        /** @type {?} */
        var line = this.toLineGeometry(calibrateMeasures);
        /** @type {?} */
        var isSinglePartLine = !isMultiPartLine(line.coordinates);
        if (isSinglePartLine) {
            line = {
                type: 'MultiLineString',
                bbox: line.bbox,
                coordinates: [(/** @type {?} */ (line.coordinates))]
            };
        }
        return (/** @type {?} */ (line));
    };
    /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    PositionPathBuilder.prototype.toLineGeometry = /**
     * @param {?=} calibrateMeasures
     * @return {?}
     */
    function (calibrateMeasures) {
        if (calibrateMeasures === void 0) { calibrateMeasures = true; }
        /** @type {?} */
        var parts = this.toMultiPartArray();
        /** @type {?} */
        var line = parts.length > 1
            ? {
                type: 'MultiLineString',
                coordinates: parts
            }
            : {
                type: 'LineString',
                coordinates: parts[0]
            };
        if (this.options.returnMValues) {
            /** @type {?} */
            var calibrationPositions = calibrateMeasures
                ? Array.from(this.calibratedMeasures.values())
                : [];
            setMeasuresByGeometricLength(line, {
                units: this.options.mValueUnit,
                hasZValues: this.options.returnZValues,
                calibrationPositions: calibrationPositions
            });
        }
        return line;
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toMultiPolygonGeometry = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var poly = this.toPolygonGeometry();
        /** @type {?} */
        var isSinglePolygon = poly.type === 'Polygon';
        if (isSinglePolygon) {
            poly = {
                type: 'MultiPolygon',
                bbox: poly.bbox,
                coordinates: [(/** @type {?} */ (poly.coordinates))]
            };
        }
        return (/** @type {?} */ (poly));
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toSinglePolygonGeometry = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var poly = this.toPolygonGeometry();
        /** @type {?} */
        var isMultiPart = poly.type === 'MultiPolygon';
        if (isMultiPart) {
            throw new Error('Cannot convert MultiPolygon to Polygon. Data would be lost');
        }
        return (/** @type {?} */ (poly));
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toPolygonGeometry = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var parts = this.toMultiPartArray();
        parts.forEach((/**
         * @param {?} part
         * @return {?}
         */
        function (part) { return _this.ensurePolygonIsClosed(part); }));
        return parts.length > 1
            ? {
                type: 'MultiPolygon',
                coordinates: [parts]
            }
            : {
                type: 'Polygon',
                coordinates: parts
            };
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.toPointGeometry = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var parts = this.toMultiPartArray();
        return parts.length > 1
            ? { type: 'MultiPoint', coordinates: parts.map((/**
                 * @param {?} part
                 * @return {?}
                 */
                function (part) { return part[0]; })) }
            : { type: 'Point', coordinates: parts[0][0] };
    };
    /**
     * @param {?} position
     * @return {?}
     */
    PositionPathBuilder.prototype.replaceLastPositionIfBetter = /**
     * @param {?} position
     * @return {?}
     */
    function (position) {
        /** @type {?} */
        var wasPositionAdded = true;
        if (this.isEmpty) {
            this.addPositionToPath(position);
            return wasPositionAdded;
        }
        /** @type {?} */
        var newPositionHasBetterAccuracy = this.lastPosition.accuracy > position.accuracy;
        if (newPositionHasBetterAccuracy) {
            this.replaceLastPosition(position);
        }
        else {
            wasPositionAdded = false;
        }
        return wasPositionAdded;
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    PositionPathBuilder.prototype.replaceLastPosition = /**
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    function (position) {
        (/** @type {?} */ (this)).currentPart[(/** @type {?} */ (this)).currentPart.length - 1] = position;
        return (/** @type {?} */ (this));
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.getBestPosition = /**
     * @return {?}
     */
    function () {
        throw new Error('Not implemented yet');
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.getUnfilteredPath = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return this.unfilteredPath.map((/**
         * @param {?} position
         * @return {?}
         */
        function (position) {
            /** @type {?} */
            var unfilteredGpsPosition = Object.assign({
                included: _this.pathContains(position)
            }, position);
            return unfilteredGpsPosition;
        }));
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.getGeometryPathSummary = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var line = this.toMultiLineGeometry(false);
        return line.coordinates.map((/**
         * @param {?} part
         * @param {?} partIndex
         * @return {?}
         */
        function (part, partIndex) { return _this.getGeometryLinePartSummary(part, partIndex); }));
    };
    /**
     * @param {?} position
     * @return {?}
     */
    PositionPathBuilder.prototype.pathContains = /**
     * @param {?} position
     * @return {?}
     */
    function (position) {
        /** @type {?} */
        var found = this.parts.find((/**
         * @param {?} part
         * @return {?}
         */
        function (part) {
            return part.indexOf(position) > -1;
        }));
        return Boolean(found);
    };
    /**
     * @param {?} partIndex
     * @param {?} vertexIndex
     * @return {?}
     */
    PositionPathBuilder.prototype.getPositionByIndex = /**
     * @param {?} partIndex
     * @param {?} vertexIndex
     * @return {?}
     */
    function (partIndex, vertexIndex) {
        return this.parts[partIndex][vertexIndex];
    };
    /**
     * @return {?}
     */
    PositionPathBuilder.prototype.dispose = /**
     * @return {?}
     */
    function () {
        if (this.trackSubscription) {
            this.trackSubscription.unsubscribe();
        }
        this.parts.length = 0;
    };
    /**
     * @private
     * @param {?} linePart
     * @param {?} partIndex
     * @return {?}
     */
    PositionPathBuilder.prototype.getGeometryLinePartSummary = /**
     * @private
     * @param {?} linePart
     * @param {?} partIndex
     * @return {?}
     */
    function (linePart, partIndex) {
        var _this = this;
        return linePart.map((/**
         * @param {?} vertex
         * @param {?} vertexIndex
         * @return {?}
         */
        function (vertex, vertexIndex) {
            /** @type {?} */
            var position = _this.getPositionByIndex(partIndex, vertexIndex);
            /** @type {?} */
            var calibrationKey = _this.getCalibrationMeasureLookupKey(partIndex, vertexIndex);
            /** @type {?} */
            var calibrationPointMeasureValue = _this.calibratedMeasures.has(calibrationKey)
                ? _this.calibratedMeasures.get(calibrationKey).measure
                : PATH_BUILDER_EMPTY_CALIBRATION_MEASURE_VALUE;
            return Object.assign({
                geometricMeasure: getMeasureFromPoint(vertex),
                partIndex: partIndex,
                vertexIndex: vertexIndex,
                calibrationPointMeasureValue: calibrationPointMeasureValue
            }, position);
        }));
    };
    /**
     * @private
     * @param {?} partIndex
     * @param {?} vertexIndex
     * @return {?}
     */
    PositionPathBuilder.prototype.getCalibrationMeasureLookupKey = /**
     * @private
     * @param {?} partIndex
     * @param {?} vertexIndex
     * @return {?}
     */
    function (partIndex, vertexIndex) {
        return partIndex + "_" + vertexIndex;
    };
    /**
     * @private
     * @return {?}
     */
    PositionPathBuilder.prototype.toMultiPartArray = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var parts = [];
        this.parts.forEach((/**
         * @param {?} part
         * @return {?}
         */
        function (part) {
            /** @type {?} */
            var coordinates = part.map((/**
             * @param {?} position
             * @return {?}
             */
            function (position) { return _this.options.returnZValues
                ? [position.longitude, position.latitude, position.altitude || 0]
                : [position.longitude, position.latitude]; }));
            parts.push(coordinates);
        }));
        return parts;
    };
    /**
     * @private
     * @param {?} polygonPoints
     * @return {?}
     */
    PositionPathBuilder.prototype.ensurePolygonIsClosed = /**
     * @private
     * @param {?} polygonPoints
     * @return {?}
     */
    function (polygonPoints) {
        if (polygonPoints.length > 1) {
            var _a = tslib_1.__read(polygonPoints, 1), first = _a[0];
            /** @type {?} */
            var last = getLastItem(polygonPoints);
            var _b = tslib_1.__read(first, 3), firstLng = _b[0], firstLat = _b[1], firstZ = _b[2];
            var _c = tslib_1.__read(last, 2), lastLng = _c[0], lastLat = _c[1];
            /** @type {?} */
            var doesPolygonNotClose = !this.arePointsEquivalent(firstLng, firstLat, lastLng, lastLat);
            if (doesPolygonNotClose) {
                /** @type {?} */
                var closingPoint = [firstLng, firstLat, firstZ || 0];
                polygonPoints.push(closingPoint);
            }
        }
    };
    /**
     * @private
     * @param {?} position
     * @return {?}
     */
    PositionPathBuilder.prototype.addPositionToPath = /**
     * @private
     * @param {?} position
     * @return {?}
     */
    function (position) {
        this.currentPart.push(position);
        if (this.calibratedMeasures.has(UNPLACED_CALIBRATION_MEASURE_KEY)) {
            this.addPendingCalibrationPoint();
        }
    };
    /**
     * @private
     * @return {?}
     */
    PositionPathBuilder.prototype.addPendingCalibrationPoint = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var calibratonPosition = this.calibratedMeasures.get(UNPLACED_CALIBRATION_MEASURE_KEY);
        /** @type {?} */
        var calibrationTimestamp = calibratonPosition.timestamp;
        var _a = tslib_1.__read(this.currentPart.slice(-2), 2), secondToLastPosition = _a[0], lastPosition = _a[1];
        /** @type {?} */
        var isTimestampBetweenVertices = calibrationTimestamp > secondToLastPosition.timestamp
            && calibrationTimestamp < lastPosition.timestamp;
        if (isTimestampBetweenVertices) {
            /** @type {?} */
            var totalTimeDelta = Math.abs(lastPosition.timestamp - secondToLastPosition.timestamp);
            /** @type {?} */
            var offsetTimeDelta = Math.abs(calibrationTimestamp - secondToLastPosition.timestamp);
            /** @type {?} */
            var percentOfDistance = offsetTimeDelta / totalTimeDelta;
            /** @type {?} */
            var distanceBetweenVerticesKilometers = getDistanceBetweenLatLng(secondToLastPosition.latitude, secondToLastPosition.longitude, lastPosition.latitude, lastPosition.longitude, LengthUnit.Mile);
            /** @type {?} */
            var distanceToPreviousVertexKilometers = percentOfDistance * distanceBetweenVerticesKilometers;
            /** @type {?} */
            var didSnapCalibrationMeasureToVertes = this.trySnapCalibrationMeasureToVertex(calibratonPosition.measure, distanceBetweenVerticesKilometers, distanceToPreviousVertexKilometers);
            if (didSnapCalibrationMeasureToVertes) {
                return;
            }
            /** @type {?} */
            var heading = bearing([secondToLastPosition.longitude, secondToLastPosition.latitude], [lastPosition.longitude, lastPosition.latitude]);
            /** @type {?} */
            var newPoint = destination([secondToLastPosition.longitude, secondToLastPosition.latitude], distanceToPreviousVertexKilometers, heading, { units: 'kilometers' });
            /** @type {?} */
            var spliceIndexForSecondToLastPosition = this.currentPart.length - 1;
            /** @type {?} */
            var newPosition = Object.assign({}, lastPosition, {
                longitude: newPoint.geometry.coordinates[0],
                latitude: newPoint.geometry.coordinates[1],
                deviceSource: PATH_BUILDER_CALCULATED_M_DEVICE_SOURCE
            });
            this.calibratedMeasures.delete(UNPLACED_CALIBRATION_MEASURE_KEY);
            this.addCalibrationMeasureAtIndex(calibratonPosition.measure, spliceIndexForSecondToLastPosition, this.currentPartIndex);
            this.currentPart.splice(spliceIndexForSecondToLastPosition, 0, newPosition);
        }
        else if (calibrationTimestamp >= lastPosition.timestamp) {
            this.addCalibrationMeasureToLastPosition(calibratonPosition.measure);
        }
        else {
            throw new Error("Calibration measure timestamp '" + calibratonPosition.timestamp + "' can not be located between"
                + (" '" + secondToLastPosition.timestamp + "' and '" + lastPosition.timestamp + "'"));
        }
    };
    /**
     * @private
     * @param {?} calibrationMeasure
     * @param {?} totalVerticeDistanceKilometers
     * @param {?} distanceToPreviousVertexKilometers
     * @return {?}
     */
    PositionPathBuilder.prototype.trySnapCalibrationMeasureToVertex = /**
     * @private
     * @param {?} calibrationMeasure
     * @param {?} totalVerticeDistanceKilometers
     * @param {?} distanceToPreviousVertexKilometers
     * @return {?}
     */
    function (calibrationMeasure, totalVerticeDistanceKilometers, distanceToPreviousVertexKilometers) {
        /** @type {?} */
        var distanceToNextVertexKilometers = totalVerticeDistanceKilometers - distanceToPreviousVertexKilometers;
        /** @type {?} */
        var distanceThresholdKilometers = convertLengthUnits(this.options.calibrationMeasureSnappingDistanceDelta, this.options.calibrationMeasureSnappingDistanceDeltaUnit, LengthUnit.Kilometer);
        /** @type {?} */
        var isPointCloseEnoughToPrevious = distanceToPreviousVertexKilometers < distanceThresholdKilometers;
        /** @type {?} */
        var isPointCloseEnoughToNext = distanceToNextVertexKilometers < distanceThresholdKilometers;
        if (isPointCloseEnoughToPrevious || isPointCloseEnoughToNext) {
            /** @type {?} */
            var previousVertexIndex = this.currentPart.length - 2;
            /** @type {?} */
            var nextVertexIndex = this.currentPart.length - 1;
            /** @type {?} */
            var vertexIndex = distanceToPreviousVertexKilometers < distanceToNextVertexKilometers
                ? previousVertexIndex
                : nextVertexIndex;
            this.addCalibrationMeasureAtIndex(calibrationMeasure, vertexIndex, this.currentPartIndex);
            this.calibratedMeasures.delete(UNPLACED_CALIBRATION_MEASURE_KEY);
            return true;
        }
        return false;
    };
    /**
     * @private
     * @param {?} position1
     * @param {?} position2
     * @return {?}
     */
    PositionPathBuilder.prototype.arePositionsEquivalent = /**
     * @private
     * @param {?} position1
     * @param {?} position2
     * @return {?}
     */
    function (position1, position2) {
        return this.arePointsEquivalent(position1.longitude, position1.latitude, position2.longitude, position2.latitude);
    };
    /**
     * @private
     * @param {?} longitude1
     * @param {?} latitude1
     * @param {?} longitude2
     * @param {?} latitude2
     * @return {?}
     */
    PositionPathBuilder.prototype.arePointsEquivalent = /**
     * @private
     * @param {?} longitude1
     * @param {?} latitude1
     * @param {?} longitude2
     * @param {?} latitude2
     * @return {?}
     */
    function (longitude1, latitude1, longitude2, latitude2) {
        return pointsAlmostEqual(longitude1, latitude1, longitude2, latitude2, this.options.pointEquivalencyPrecision);
    };
    /**
     * @private
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    PositionPathBuilder.prototype.tryStoreUnfilteredPath = /**
     * @private
     * @template THIS
     * @this {THIS}
     * @param {?} position
     * @return {THIS}
     */
    function (position) {
        if ((/** @type {?} */ (this)).options.storeUnfilteredPath) {
            (/** @type {?} */ (this)).unfilteredPath.push(position);
        }
        return (/** @type {?} */ (this));
    };
    return PositionPathBuilder;
}());
export { PositionPathBuilder };
if (false) {
    /** @type {?} */
    PositionPathBuilder.prototype.parts;
    /** @type {?} */
    PositionPathBuilder.prototype.unfilteredPath;
    /** @type {?} */
    PositionPathBuilder.prototype.pathBreaks;
    /** @type {?} */
    PositionPathBuilder.prototype.calibratedMeasures;
    /**
     * @type {?}
     * @private
     */
    PositionPathBuilder.prototype.options;
    /**
     * @type {?}
     * @private
     */
    PositionPathBuilder.prototype.trackSubscription;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zaXRpb24tcGF0aC1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvZ2VvbG9jYXRpb24vcG9zaXRpb24tcGF0aC1idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBR0EsT0FBTyxXQUFXLE1BQU0sbUJBQW1CLENBQUM7QUFDNUMsT0FBTyxPQUFPLE1BQU0sZUFBZSxDQUFDO0FBS3BDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBR3pFLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLGdFQUFnRSxDQUFDO0FBQzlHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUkxRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtREFBbUQsQ0FBQztBQUN4RixPQUFPLEVBQUUsNENBQTRDLEVBQUUsdUNBQXVDLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoSSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUNsRyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUNqRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUNuRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDakUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sK0NBQStDLENBQUM7O0lBRzVFLGdDQUFnQyxHQUFHLFNBQVM7O0lBRTVDLGVBQWUsR0FBK0I7SUFDbEQseUJBQXlCLEVBQUUsRUFBRTtJQUM3QixlQUFlLEVBQUUsSUFBSTtJQUNyQix5QkFBeUIsRUFBRSxDQUFDO0lBQzVCLGFBQWEsRUFBRSxJQUFJO0lBQ25C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QWdDLENBQUMsQ0FBQztZQUNqRSxPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7Ozs7O0lBRU8sb0RBQXNCOzs7Ozs7SUFBOUIsVUFBK0IsU0FBc0IsRUFBRSxTQUFzQjtRQUMzRSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FDN0IsU0FBUyxDQUFDLFNBQVMsRUFDbkIsU0FBUyxDQUFDLFFBQVEsRUFDbEIsU0FBUyxDQUFDLFNBQVMsRUFDbkIsU0FBUyxDQUFDLFFBQVEsQ0FDbkIsQ0FBQztJQUNKLENBQUM7Ozs7Ozs7OztJQUVPLGlEQUFtQjs7Ozs7Ozs7SUFBM0IsVUFBNEIsVUFBa0IsRUFBRSxTQUFpQixFQUFFLFVBQWtCLEVBQUUsU0FBaUI7UUFDdEcsT0FBTyxpQkFBaUIsQ0FDdEIsVUFBVSxFQUNWLFNBQVMsRUFDVCxVQUFVLEVBQ1YsU0FBUyxFQUNULElBQUksQ0FBQyxPQUFPLENBQUMseUJBQXlCLENBQ3ZDLENBQUM7SUFDSixDQUFDOzs7Ozs7OztJQUVPLG9EQUFzQjs7Ozs7OztJQUE5QixVQUErQixRQUFxQjtRQUNsRCxJQUFJLG1CQUFBLElBQUksRUFBQSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRTtZQUNwQyxtQkFBQSxJQUFJLEVBQUEsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3BDO1FBRUQsT0FBTyxtQkFBQSxJQUFJLEVBQUEsQ0FBQztJQUNkLENBQUM7SUFDSCwwQkFBQztBQUFELENBQUMsQUFqbEJELElBaWxCQzs7OztJQWhsQkMsb0NBQWdDOztJQUNoQyw2Q0FBdUM7O0lBQ3ZDLHlDQUEwQjs7SUFDMUIsaURBQTBFOzs7OztJQUMxRSxzQ0FBcUQ7Ozs7O0lBQ3JELGdEQUF3QyIsInNvdXJjZXNDb250ZW50IjpbIi8vIDNyZCBQYXJ0eS5cbmltcG9ydCB7IExpbmVTdHJpbmcsIEZlYXR1cmUsIE11bHRpUG9pbnQsIFBvaW50LCBQb2x5Z29uLCBNdWx0aUxpbmVTdHJpbmcsIE11bHRpUG9seWdvbiB9IGZyb20gJ2dlb2pzb24nO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgZGVzdGluYXRpb24gZnJvbSAnQHR1cmYvZGVzdGluYXRpb24nO1xuaW1wb3J0IGJlYXJpbmcgZnJvbSAnQHR1cmYvYmVhcmluZyc7XG5cbi8vIFRTUy5cbmltcG9ydCB7IFBvc2l0aW9uUGF0aEJ1aWxkZXJPcHRpb25zIH0gZnJvbSAnLi9wb3NpdGlvbi1wYXRoLWJ1aWxkZXItb3B0aW9ucyc7XG5pbXBvcnQgeyBEaXNwb3NhYmxlIH0gZnJvbSAnLi4vY29yZS9kaXNwb3NhYmxlJztcbmltcG9ydCB7IGlzUG9zaXRpb25BY2NlcHRhYmxlIH0gZnJvbSAnLi9pcy1wb3NpdGlvbi1hY2NlcHRhYmxlLmZ1bmN0aW9uJztcbmltcG9ydCB7IEdwc1Bvc2l0aW9uIH0gZnJvbSAnLi9ncHMtcG9zaXRpb24vZ3BzLXBvc2l0aW9uJztcbmltcG9ydCB7IFBvc2l0aW9uUGF0aFVuZmlsdGVyZWRHcHNQb3NpdGlvbiB9IGZyb20gJy4vcG9zaXRpb24tcGF0aC11bmZpbHRlcmVkLWdwcy1wb3NpdGlvbic7XG5pbXBvcnQgeyBzZXRNZWFzdXJlc0J5R2VvbWV0cmljTGVuZ3RoIH0gZnJvbSAnLi4vZ2VvbWV0cnkvZ2VvbWV0cnkvc2V0LW1lYXN1cmVzLWJ5LWdlb21ldHJpYy1sZW5ndGguZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNNdWx0aVBhcnRMaW5lIH0gZnJvbSAnLi4vZ2VvbWV0cnkvbGluZS9pcy1tdWx0aS1wYXJ0LmZ1bmN0aW9uJztcbmltcG9ydCB7IFBvc2l0aW9uUGF0aENhbGlicmF0aW9uUG9zaXRpb24gfSBmcm9tICcuL3Bvc2l0aW9uLXBhdGgtY2FsaWJyYXRpb24tcG9zaXRpb24nO1xuaW1wb3J0IHsgQ2FsaWJyYXRpb25Qb3NpdGlvbiB9IGZyb20gJy4uL2dlb21ldHJ5L2xpbmUvY2FsaWJyYXRpb24vY2FsaWJyYXRpb24tcG9pbnQnO1xuaW1wb3J0IHsgUG9zaXRpb25QYXRoQnVpbGRlclN1bW1hcnlQb3NpdGlvbiB9IGZyb20gJy4vcG9zaXRvbi1wYXRoLWJ1aWxkZXItcG9zaXRpb24tc3VtbWFyeSc7XG5pbXBvcnQgeyBnZXRNZWFzdXJlRnJvbVBvaW50IH0gZnJvbSAnLi4vZ2VvbWV0cnkvcG9pbnQvZ2V0LW1lYXN1cmUtZnJvbS1wb2ludC5mdW5jdGlvbic7XG5pbXBvcnQgeyBQQVRIX0JVSUxERVJfRU1QVFlfQ0FMSUJSQVRJT05fTUVBU1VSRV9WQUxVRSwgUEFUSF9CVUlMREVSX0NBTENVTEFURURfTV9ERVZJQ0VfU09VUkNFIH0gZnJvbSAnLi9nZW9sb2NhdGlvbi5jb25zdGFudHMnO1xuaW1wb3J0IHsgZ2V0RGlzdGFuY2VCZXR3ZWVuTGF0TG5nIH0gZnJvbSAnLi4vZ2VvbWV0cnkvcG9pbnQvZ2V0LWRpc3RhbmNlLWJldHdlZW4tcG9pbnRzLmZ1bmN0aW9uJztcbmltcG9ydCB7IGNvbnZlcnRMZW5ndGhVbml0cyB9IGZyb20gJy4uL2NvcmUvdW5pdHMvY29udmVydC1sZW5ndGgtdW5pdHMuZnVuY3Rpb24nO1xuaW1wb3J0IHsgTGVuZ3RoVW5pdCB9IGZyb20gJy4uL2NvcmUvdW5pdHMvbGVuZ3RoLXVuaXQnO1xuaW1wb3J0IHsgc3VtVmFsdWVzIH0gZnJvbSAnLi4vY29yZS9zdGF0cy9zdW0tdmFsdWVzLmZ1bmN0aW9uJztcbmltcG9ydCB7IGdldExhc3RJdGVtIH0gZnJvbSAnLi4vY29yZS9hcnJheS9nZXQtbGFzdC1pdGVtLmZ1bmN0aW9uJztcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnLi4vY29yZS90eXBlLWNoZWNrL2lzLW51bWJlci5mdW5jdGlvbic7XG5pbXBvcnQgeyBwb2ludHNBbG1vc3RFcXVhbCB9IGZyb20gJy4uL2NvcmUvZXF1YWxpdHkvcG9pbnRzLWFsbW9zdC1lcXVhbC5mdW5jdGlvbic7XG5cblxuY29uc3QgVU5QTEFDRURfQ0FMSUJSQVRJT05fTUVBU1VSRV9LRVkgPSAncGVuZGluZyc7XG5cbmNvbnN0IERFRkFVTFRfT1BUSU9OUzogUG9zaXRpb25QYXRoQnVpbGRlck9wdGlvbnMgPSB7XG4gIGdwc1JlcXVpcmVkQWNjdXJhY3lNZXRlcnM6IDEwLFxuICByZXF1aXJlQWNjdXJhY3k6IHRydWUsXG4gIHBvaW50RXF1aXZhbGVuY3lQcmVjaXNpb246IDgsXG4gIHJldHVyblpWYWx1ZXM6IHRydWUsXG4gIHJldHVybk1WYWx1ZXM6IHRydWUsXG4gIG1WYWx1ZVVuaXQ6ICdtaWxlcycsXG4gIHN0b3JlVW5maWx0ZXJlZFBhdGg6IGZhbHNlLFxuICBjYWxpYnJhdGlvbk1lYXN1cmVTbmFwcGluZ0Rpc3RhbmNlRGVsdGE6IDIsXG4gIGNhbGlicmF0aW9uTWVhc3VyZVNuYXBwaW5nRGlzdGFuY2VEZWx0YVVuaXQ6IExlbmd0aFVuaXQuRm9vdFxufTtcblxuXG5leHBvcnQgY2xhc3MgUG9zaXRpb25QYXRoQnVpbGRlciBpbXBsZW1lbnRzIERpc3Bvc2FibGUge1xuICByZWFkb25seSBwYXJ0czogR3BzUG9zaXRpb25bXVtdO1xuICByZWFkb25seSB1bmZpbHRlcmVkUGF0aDogR3BzUG9zaXRpb25bXTtcbiAgcmVhZG9ubHkgcGF0aEJyZWFrczoge31bXTtcbiAgcmVhZG9ubHkgY2FsaWJyYXRlZE1lYXN1cmVzOiBNYXA8c3RyaW5nLCBQb3NpdGlvblBhdGhDYWxpYnJhdGlvblBvc2l0aW9uPjtcbiAgcHJpdmF0ZSByZWFkb25seSBvcHRpb25zOiBQb3NpdGlvblBhdGhCdWlsZGVyT3B0aW9ucztcbiAgcHJpdmF0ZSB0cmFja1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGdldCBwb3NpdGlvbkNvdW50KCk6IG51bWJlciB7XG4gICAgY29uc3QgY291bnRzID0gdGhpcy5wYXJ0cy5tYXAocGFydCA9PiBwYXJ0Lmxlbmd0aCk7XG4gICAgcmV0dXJuIHN1bVZhbHVlcyhjb3VudHMpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRQYXJ0SW5kZXgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5wYXJ0cy5sZW5ndGggLSAxO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRQYXJ0KCk6IEdwc1Bvc2l0aW9uW10ge1xuICAgIHJldHVybiB0aGlzLnBhcnRzW3RoaXMuY3VycmVudFBhcnRJbmRleF07XG4gIH1cblxuICBnZXQgbGFzdFBvc2l0aW9uKCk6IEdwc1Bvc2l0aW9uIHtcbiAgICByZXR1cm4gZ2V0TGFzdEl0ZW0odGhpcy5jdXJyZW50UGFydCk7XG4gIH1cblxuICBnZXQgaGFzUG9zaXRpb24oKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIEJvb2xlYW4odGhpcy5sYXN0UG9zaXRpb24pO1xuICB9XG5cbiAgZ2V0IGlzRW1wdHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFBhcnQubGVuZ3RoID09PSAwO1xuICB9XG5cbiAgZ2V0IGlzVmFsaWRQYXRoKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRQYXJ0Lmxlbmd0aCA+IDE7XG4gIH1cblxuICBnZXQgaXNTaW5nbGVQb2ludCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5wYXJ0cy5sZW5ndGggPT09IDEgJiYgdGhpcy5jdXJyZW50UGFydC5sZW5ndGggPT09IDE7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihvcHRpb25zPzogUG9zaXRpb25QYXRoQnVpbGRlck9wdGlvbnMpIHtcbiAgICB0aGlzLnBhcnRzID0gW1tdXTtcbiAgICB0aGlzLnVuZmlsdGVyZWRQYXRoID0gW107XG4gICAgdGhpcy5jYWxpYnJhdGVkTWVhc3VyZXMgPSBuZXcgTWFwPHN0cmluZywgUG9zaXRpb25QYXRoQ2FsaWJyYXRpb25Qb3NpdGlvbj4oKTtcbiAgICB0aGlzLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpO1xuICB9XG5cbiAgdHJhY2tQb3NpdGlvbihwb3NpdGlvblN0cmVhbTogT2JzZXJ2YWJsZTxHcHNQb3NpdGlvbj4pOiB0aGlzIHtcbiAgICB0aGlzLnRyYWNrU3Vic2NyaXB0aW9uID0gcG9zaXRpb25TdHJlYW0uc3Vic2NyaWJlKHBvc2l0aW9uID0+IHRoaXMuYWRkUG9zaXRpb24ocG9zaXRpb24pKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFkZFBvc2l0aW9uKHBvc2l0aW9uOiBHcHNQb3NpdGlvbiwgY2FsaWJyYXRpb25NZWFzdXJlPzogbnVtYmVyKTogdGhpcyB7XG4gICAgY29uc3QgYWNjdXJhY3lDcml0ZXJpYU1ldCA9ICF0aGlzLm9wdGlvbnMucmVxdWlyZUFjY3VyYWN5XG4gICAgICB8fCBpc1Bvc2l0aW9uQWNjZXB0YWJsZShwb3NpdGlvbiwgdGhpcy5vcHRpb25zLmdwc1JlcXVpcmVkQWNjdXJhY3lNZXRlcnMpO1xuICAgIGNvbnN0IHBvc2l0aW9uTm90QWNjZXB0YWJsZSA9ICFwb3NpdGlvbiB8fCAhYWNjdXJhY3lDcml0ZXJpYU1ldDtcblxuICAgIGlmIChwb3NpdGlvbk5vdEFjY2VwdGFibGUpIHtcbiAgICAgIHJldHVybiB0aGlzLnRyeVN0b3JlVW5maWx0ZXJlZFBhdGgocG9zaXRpb24pO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzRW1wdHkpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcmNlQWRkUG9zaXRpb24ocG9zaXRpb24pO1xuICAgIH1cblxuICAgIGNvbnN0IHBvaW50c0F0U2FtZUxvY2F0aW9uID0gdGhpcy5hcmVQb3NpdGlvbnNFcXVpdmFsZW50KHRoaXMubGFzdFBvc2l0aW9uLCBwb3NpdGlvbik7XG4gICAgY29uc3QgYm90aFBvaW50c0F0U3RhbmRTdGlsbCA9IHRoaXMubGFzdFBvc2l0aW9uLnNwZWVkID09PSAwICYmIHBvc2l0aW9uLnNwZWVkID09PSAwIHx8IHBvaW50c0F0U2FtZUxvY2F0aW9uO1xuICAgIGlmIChib3RoUG9pbnRzQXRTdGFuZFN0aWxsKSB7XG4gICAgICB0aGlzXG4gICAgICAgIC50cnlTdG9yZVVuZmlsdGVyZWRQYXRoKHBvc2l0aW9uKVxuICAgICAgICAucmVwbGFjZUxhc3RQb3NpdGlvbklmQmV0dGVyKHBvc2l0aW9uKTtcblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgdGhpcy5mb3JjZUFkZFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICBpZiAoaXNOdW1iZXIoY2FsaWJyYXRpb25NZWFzdXJlKSkge1xuICAgICAgdGhpcy5hZGRDYWxpYnJhdGlvbk1lYXN1cmVUb0xhc3RQb3NpdGlvbihjYWxpYnJhdGlvbk1lYXN1cmUpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc3RhcnROZXdQYXJ0KCk6IHRoaXMge1xuICAgIHRoaXMucGFydHMucHVzaChbXSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICByZW1vdmVQb3NpdGlvbkJ5SW5kZXgodmVydGV4SW5kZXg6IG51bWJlciwgcGFydEluZGV4OiBudW1iZXIgPSAwKTogdGhpcyB7XG4gICAgY29uc3QgcGFydCA9IHRoaXMucGFydHNbcGFydEluZGV4XTtcbiAgICBpZiAoIXBhcnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwYXJ0IGluZGV4XCIgJHtwYXJ0SW5kZXh9YCk7XG4gICAgfVxuXG4gICAgcGFydC5zcGxpY2UodmVydGV4SW5kZXgsIDEpO1xuXG4gICAgY29uc3Qga2V5ID0gdGhpcy5nZXRDYWxpYnJhdGlvbk1lYXN1cmVMb29rdXBLZXkocGFydEluZGV4LCB2ZXJ0ZXhJbmRleCk7XG4gICAgaWYgKHRoaXMuY2FsaWJyYXRlZE1lYXN1cmVzLmhhcyhrZXkpKSB7XG4gICAgICB0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5kZWxldGUoa2V5KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHJlbW92ZVBvc2l0aW9uKHBvc2l0aW9uOiBHcHNQb3NpdGlvbik6IHRoaXMge1xuICAgIGxldCBwYXJ0SW5kZXggPSAtMTtcbiAgICBsZXQgdmVydGV4SW5kZXggPSAtMTtcblxuICAgIHRoaXMucGFydHMuZm9yRWFjaCgocGFydCwgaW5kZXgpID0+IHtcbiAgICAgIGNvbnN0IGZvdW5kUG9zaXRpb25JbmRleCA9IHBhcnQuaW5kZXhPZihwb3NpdGlvbik7XG4gICAgICBpZiAoZm91bmRQb3NpdGlvbkluZGV4ID4gLTEpIHtcbiAgICAgICAgcGFydEluZGV4ID0gaW5kZXg7XG4gICAgICAgIHZlcnRleEluZGV4ID0gZm91bmRQb3NpdGlvbkluZGV4O1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKHBhcnRJbmRleCA+IC0xICYmIHZlcnRleEluZGV4ID4gLTEpIHtcbiAgICAgIHJldHVybiB0aGlzLnJlbW92ZVBvc2l0aW9uQnlJbmRleCh2ZXJ0ZXhJbmRleCwgcGFydEluZGV4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHJlbW92ZUNhbGlicmF0aW9uTWVhc3VyZShtZWFzdXJlOiBudW1iZXIpOiB0aGlzIHtcbiAgICBBcnJheS5mcm9tKHRoaXMuY2FsaWJyYXRlZE1lYXN1cmVzLnZhbHVlcygpKVxuICAgICAgLmZpbHRlcihjYWxpYnJhdGlvbiA9PiBjYWxpYnJhdGlvbi5tZWFzdXJlID09PSBtZWFzdXJlKVxuICAgICAgLmZvckVhY2goY2FsaWJyYXRpb24gPT5cbiAgICAgICAgdGhpcy5yZW1vdmVDYWxpYnJhdGlvbk1lYXN1cmVCeUluZGV4KGNhbGlicmF0aW9uLnZlcnRleEluZGV4LCBjYWxpYnJhdGlvbi5wYXJ0SW5kZXgpXG4gICAgICApO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICByZW1vdmVDYWxpYnJhdGlvbk1lYXN1cmVCeUluZGV4KHZlcnRleEluZGV4OiBudW1iZXIsIHBhcnRJbmRleDogbnVtYmVyID0gMCk6IHRoaXMge1xuICAgIGNvbnN0IGtleSA9IHRoaXMuZ2V0Q2FsaWJyYXRpb25NZWFzdXJlTG9va3VwS2V5KHBhcnRJbmRleCwgdmVydGV4SW5kZXgpO1xuICAgIGlmICh0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5oYXMoa2V5KSkge1xuICAgICAgdGhpcy5jYWxpYnJhdGVkTWVhc3VyZXMuZGVsZXRlKGtleSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhZGRDYWxpYnJhdGlvbk1lYXN1cmUobWVhc3VyZTogbnVtYmVyKTogdGhpcyB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgW2xhc3RWZXJ0ZXhdID0gdGhpcy5jdXJyZW50UGFydC5zbGljZSgtMSk7XG4gICAgaWYgKGxhc3RWZXJ0ZXggJiYgbGFzdFZlcnRleC50aW1lc3RhbXAgJiYgbGFzdFZlcnRleC50aW1lc3RhbXAgPT09IHRpbWVzdGFtcCkge1xuICAgICAgcmV0dXJuIHRoaXMuYWRkQ2FsaWJyYXRpb25NZWFzdXJlVG9MYXN0UG9zaXRpb24obWVhc3VyZSk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFydEluZGV4ID0gdGhpcy5jdXJyZW50UGFydEluZGV4O1xuICAgIGNvbnN0IGtleSA9IFVOUExBQ0VEX0NBTElCUkFUSU9OX01FQVNVUkVfS0VZO1xuICAgIHRoaXMuY2FsaWJyYXRlZE1lYXN1cmVzLnNldChrZXksIHtcbiAgICAgIG1lYXN1cmUsXG4gICAgICBwYXJ0SW5kZXgsXG4gICAgICB2ZXJ0ZXhJbmRleDogbnVsbCxcbiAgICAgIHRpbWVzdGFtcFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhZGRDYWxpYnJhdGlvbk1lYXN1cmVUb0xhc3RQb3NpdGlvbihtZWFzdXJlOiBudW1iZXIpOiB0aGlzIHtcbiAgICBjb25zdCBwYXJ0SW5kZXggPSB0aGlzLmN1cnJlbnRQYXJ0SW5kZXg7XG4gICAgY29uc3QgbGFzdFZlcnRleEluZGV4ID0gdGhpcy5jdXJyZW50UGFydC5sZW5ndGggLSAxO1xuICAgIHJldHVybiB0aGlzLmFkZENhbGlicmF0aW9uTWVhc3VyZUF0SW5kZXgobWVhc3VyZSwgbGFzdFZlcnRleEluZGV4LCBwYXJ0SW5kZXgpO1xuICB9XG5cbiAgYWRkQ2FsaWJyYXRpb25NZWFzdXJlQXRJbmRleChtZWFzdXJlOiBudW1iZXIsIHZlcnRleEluZGV4OiBudW1iZXIsIHBhcnRJbmRleCA9IDApOiB0aGlzIHtcbiAgICBjb25zdCBrZXkgPSB0aGlzLmdldENhbGlicmF0aW9uTWVhc3VyZUxvb2t1cEtleShwYXJ0SW5kZXgsIHZlcnRleEluZGV4KTtcbiAgICB0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5zZXQoa2V5LCB7XG4gICAgICBtZWFzdXJlLFxuICAgICAgcGFydEluZGV4LFxuICAgICAgdmVydGV4SW5kZXgsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGZvcmNlQWRkUG9zaXRpb24ocG9zaXRpb246IEdwc1Bvc2l0aW9uKTogdGhpcyB7XG4gICAgdGhpcy50cnlTdG9yZVVuZmlsdGVyZWRQYXRoKHBvc2l0aW9uKTtcbiAgICB0aGlzLmFkZFBvc2l0aW9uVG9QYXRoKHBvc2l0aW9uKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHRvUG9pbnRGZWF0dXJlKHByb3BlcnRpZXMgPSB7fSk6IEZlYXR1cmU8UG9pbnQgfCBNdWx0aVBvaW50PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6ICdGZWF0dXJlJyxcbiAgICAgIGdlb21ldHJ5OiB0aGlzLnRvUG9pbnRHZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b0xpbmVGZWF0dXJlKHByb3BlcnRpZXMgPSB7fSk6IEZlYXR1cmU8TGluZVN0cmluZyB8IE11bHRpTGluZVN0cmluZz4ge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnRmVhdHVyZScsXG4gICAgICBnZW9tZXRyeTogdGhpcy50b0xpbmVHZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b1NpbmdsZUxpbmVGZWF0dXJlKHByb3BlcnRpZXMgPSB7fSk6IEZlYXR1cmU8TGluZVN0cmluZz4ge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnRmVhdHVyZScsXG4gICAgICBnZW9tZXRyeTogdGhpcy50b1NpbmdsZUxpbmVHZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b011bHRpTGluZUZlYXR1cmUocHJvcGVydGllcyA9IHt9KTogRmVhdHVyZTxNdWx0aUxpbmVTdHJpbmc+IHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgZ2VvbWV0cnk6IHRoaXMudG9NdWx0aUxpbmVHZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b1BvbHlnb25GZWF0dXJlKHByb3BlcnRpZXMgPSB7fSk6IEZlYXR1cmU8UG9seWdvbiB8IE11bHRpUG9seWdvbj4ge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnRmVhdHVyZScsXG4gICAgICBnZW9tZXRyeTogdGhpcy50b1BvbHlnb25HZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b011bHRpUG9seWdvbkZlYXR1cmUocHJvcGVydGllcyA9IHt9KTogRmVhdHVyZTxNdWx0aVBvbHlnb24+IHtcbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgZ2VvbWV0cnk6IHRoaXMudG9NdWx0aVBvbHlnb25HZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b1NpbmdsZVBvbHlnb25GZWF0dXJlKHByb3BlcnRpZXMgPSB7fSk6IEZlYXR1cmU8UG9seWdvbj4ge1xuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiAnRmVhdHVyZScsXG4gICAgICBnZW9tZXRyeTogdGhpcy50b1NpbmdsZVBvbHlnb25HZW9tZXRyeSgpLFxuICAgICAgcHJvcGVydGllc1xuICAgIH07XG4gIH1cblxuICB0b0ZlYXR1cmUoKTogRmVhdHVyZTxMaW5lU3RyaW5nIHwgTXVsdGlMaW5lU3RyaW5nIHwgUG9pbnQgfCBNdWx0aVBvaW50PiB7XG4gICAgcmV0dXJuIHRoaXMuaXNTaW5nbGVQb2ludFxuICAgICAgPyB0aGlzLnRvUG9pbnRGZWF0dXJlKCkgYXMgRmVhdHVyZTxQb2ludD5cbiAgICAgIDogdGhpcy50b0xpbmVGZWF0dXJlKCk7XG4gIH1cblxuICB0b0dlb21ldHJ5KCk6IExpbmVTdHJpbmcgfCBNdWx0aUxpbmVTdHJpbmcgfCBQb2ludCB7XG4gICAgcmV0dXJuIHRoaXMuaXNTaW5nbGVQb2ludFxuICAgICAgPyB0aGlzLnRvUG9pbnRHZW9tZXRyeSgpIGFzIFBvaW50XG4gICAgICA6IHRoaXMudG9MaW5lR2VvbWV0cnkoKTtcbiAgfVxuXG4gIHRvU2luZ2xlTGluZUdlb21ldHJ5KGNhbGlicmF0ZU1lYXN1cmVzID0gdHJ1ZSk6IExpbmVTdHJpbmcge1xuICAgIGNvbnN0IGxpbmUgPSB0aGlzLnRvTGluZUdlb21ldHJ5KGNhbGlicmF0ZU1lYXN1cmVzKTtcbiAgICBpZiAoaXNNdWx0aVBhcnRMaW5lKGxpbmUuY29vcmRpbmF0ZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjb252ZXJ0IE11bHRpTGluZVN0cmluZyB0byBMaW5lU3RyaW5nLiBEYXRhIHdvdWxkIGJlIGxvc3QnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGluZSBhcyBMaW5lU3RyaW5nO1xuICB9XG5cbiAgdG9NdWx0aUxpbmVHZW9tZXRyeShjYWxpYnJhdGVNZWFzdXJlcyA9IHRydWUpOiBNdWx0aUxpbmVTdHJpbmcge1xuICAgIGxldCBsaW5lID0gdGhpcy50b0xpbmVHZW9tZXRyeShjYWxpYnJhdGVNZWFzdXJlcyk7XG4gICAgY29uc3QgaXNTaW5nbGVQYXJ0TGluZSA9ICFpc011bHRpUGFydExpbmUobGluZS5jb29yZGluYXRlcyk7XG4gICAgaWYgKGlzU2luZ2xlUGFydExpbmUpIHtcbiAgICAgIGxpbmUgPSB7XG4gICAgICAgIHR5cGU6ICdNdWx0aUxpbmVTdHJpbmcnLFxuICAgICAgICBiYm94OiBsaW5lLmJib3gsXG4gICAgICAgIGNvb3JkaW5hdGVzOiBbbGluZS5jb29yZGluYXRlcyBhcyBudW1iZXJbXVtdXVxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGluZSBhcyBNdWx0aUxpbmVTdHJpbmc7XG4gIH1cblxuICB0b0xpbmVHZW9tZXRyeShjYWxpYnJhdGVNZWFzdXJlcyA9IHRydWUpOiBMaW5lU3RyaW5nIHwgTXVsdGlMaW5lU3RyaW5nIHtcbiAgICBjb25zdCBwYXJ0czogbnVtYmVyW11bXVtdID0gdGhpcy50b011bHRpUGFydEFycmF5KCk7XG4gICAgY29uc3QgbGluZTogTGluZVN0cmluZyB8IE11bHRpTGluZVN0cmluZyA9IHBhcnRzLmxlbmd0aCA+IDFcbiAgICAgID8ge1xuICAgICAgICB0eXBlOiAnTXVsdGlMaW5lU3RyaW5nJyxcbiAgICAgICAgY29vcmRpbmF0ZXM6IHBhcnRzXG4gICAgICB9XG4gICAgICA6IHtcbiAgICAgICAgdHlwZTogJ0xpbmVTdHJpbmcnLFxuICAgICAgICBjb29yZGluYXRlczogcGFydHNbMF1cbiAgICAgIH07XG5cbiAgICBpZiAodGhpcy5vcHRpb25zLnJldHVybk1WYWx1ZXMpIHtcbiAgICAgIGNvbnN0IGNhbGlicmF0aW9uUG9zaXRpb25zOiBDYWxpYnJhdGlvblBvc2l0aW9uW10gPSBjYWxpYnJhdGVNZWFzdXJlc1xuICAgICAgICA/IEFycmF5LmZyb20oXG4gICAgICAgICAgdGhpcy5jYWxpYnJhdGVkTWVhc3VyZXMudmFsdWVzKClcbiAgICAgICAgKVxuICAgICAgICA6IFtdO1xuXG4gICAgICBzZXRNZWFzdXJlc0J5R2VvbWV0cmljTGVuZ3RoKGxpbmUsIHtcbiAgICAgICAgdW5pdHM6IHRoaXMub3B0aW9ucy5tVmFsdWVVbml0LFxuICAgICAgICBoYXNaVmFsdWVzOiB0aGlzLm9wdGlvbnMucmV0dXJuWlZhbHVlcyxcbiAgICAgICAgY2FsaWJyYXRpb25Qb3NpdGlvbnNcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBsaW5lO1xuICB9XG5cbiAgdG9NdWx0aVBvbHlnb25HZW9tZXRyeSgpOiBNdWx0aVBvbHlnb24ge1xuICAgIGxldCBwb2x5ID0gdGhpcy50b1BvbHlnb25HZW9tZXRyeSgpO1xuICAgIGNvbnN0IGlzU2luZ2xlUG9seWdvbiA9IHBvbHkudHlwZSA9PT0gJ1BvbHlnb24nO1xuXG4gICAgaWYgKGlzU2luZ2xlUG9seWdvbikge1xuICAgICAgcG9seSA9IHtcbiAgICAgICAgdHlwZTogJ011bHRpUG9seWdvbicsXG4gICAgICAgIGJib3g6IHBvbHkuYmJveCxcbiAgICAgICAgY29vcmRpbmF0ZXM6IFtwb2x5LmNvb3JkaW5hdGVzIGFzIG51bWJlcltdW11bXV1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHBvbHkgYXMgTXVsdGlQb2x5Z29uO1xuICB9XG5cbiAgdG9TaW5nbGVQb2x5Z29uR2VvbWV0cnkoKTogUG9seWdvbiB7XG4gICAgY29uc3QgcG9seSA9IHRoaXMudG9Qb2x5Z29uR2VvbWV0cnkoKTtcbiAgICBjb25zdCBpc011bHRpUGFydCA9IHBvbHkudHlwZSA9PT0gJ011bHRpUG9seWdvbic7XG5cbiAgICBpZiAoaXNNdWx0aVBhcnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNvbnZlcnQgTXVsdGlQb2x5Z29uIHRvIFBvbHlnb24uIERhdGEgd291bGQgYmUgbG9zdCcpO1xuICAgIH1cblxuICAgIHJldHVybiBwb2x5IGFzIFBvbHlnb247XG4gIH1cblxuICB0b1BvbHlnb25HZW9tZXRyeSgpOiBQb2x5Z29uIHwgTXVsdGlQb2x5Z29uIHtcbiAgICBjb25zdCBwYXJ0czogbnVtYmVyW11bXVtdID0gdGhpcy50b011bHRpUGFydEFycmF5KCk7XG4gICAgcGFydHMuZm9yRWFjaChwYXJ0ID0+IHRoaXMuZW5zdXJlUG9seWdvbklzQ2xvc2VkKHBhcnQpKTtcblxuICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPiAxXG4gICAgICA/IHtcbiAgICAgICAgdHlwZTogJ011bHRpUG9seWdvbicsXG4gICAgICAgIGNvb3JkaW5hdGVzOiBbcGFydHNdXG4gICAgICB9XG4gICAgICA6IHtcbiAgICAgICAgdHlwZTogJ1BvbHlnb24nLFxuICAgICAgICBjb29yZGluYXRlczogcGFydHNcbiAgICAgIH07XG4gIH1cblxuICB0b1BvaW50R2VvbWV0cnkoKTogUG9pbnQgfCBNdWx0aVBvaW50IHtcbiAgICBjb25zdCBwYXJ0czogbnVtYmVyW11bXVtdID0gdGhpcy50b011bHRpUGFydEFycmF5KCk7XG5cbiAgICByZXR1cm4gcGFydHMubGVuZ3RoID4gMVxuICAgICAgPyB7IHR5cGU6ICdNdWx0aVBvaW50JywgY29vcmRpbmF0ZXM6IHBhcnRzLm1hcChwYXJ0ID0+IHBhcnRbMF0pIH1cbiAgICAgIDogeyB0eXBlOiAnUG9pbnQnLCBjb29yZGluYXRlczogcGFydHNbMF1bMF0gfTtcbiAgfVxuXG4gIHJlcGxhY2VMYXN0UG9zaXRpb25JZkJldHRlcihwb3NpdGlvbjogR3BzUG9zaXRpb24pOiBib29sZWFuIHtcbiAgICBsZXQgd2FzUG9zaXRpb25BZGRlZCA9IHRydWU7XG4gICAgaWYgKHRoaXMuaXNFbXB0eSkge1xuICAgICAgdGhpcy5hZGRQb3NpdGlvblRvUGF0aChwb3NpdGlvbik7XG4gICAgICByZXR1cm4gd2FzUG9zaXRpb25BZGRlZDtcbiAgICB9XG5cbiAgICBjb25zdCBuZXdQb3NpdGlvbkhhc0JldHRlckFjY3VyYWN5ID0gdGhpcy5sYXN0UG9zaXRpb24uYWNjdXJhY3kgPiBwb3NpdGlvbi5hY2N1cmFjeTtcbiAgICBpZiAobmV3UG9zaXRpb25IYXNCZXR0ZXJBY2N1cmFjeSkge1xuICAgICAgdGhpcy5yZXBsYWNlTGFzdFBvc2l0aW9uKHBvc2l0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgd2FzUG9zaXRpb25BZGRlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB3YXNQb3NpdGlvbkFkZGVkO1xuICB9XG5cbiAgcmVwbGFjZUxhc3RQb3NpdGlvbihwb3NpdGlvbjogR3BzUG9zaXRpb24pOiB0aGlzIHtcbiAgICB0aGlzLmN1cnJlbnRQYXJ0W3RoaXMuY3VycmVudFBhcnQubGVuZ3RoIC0gMV0gPSBwb3NpdGlvbjtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0QmVzdFBvc2l0aW9uKCk6IEdwc1Bvc2l0aW9uIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCB5ZXQnKTtcbiAgfVxuXG4gIGdldFVuZmlsdGVyZWRQYXRoKCk6IFBvc2l0aW9uUGF0aFVuZmlsdGVyZWRHcHNQb3NpdGlvbltdIHtcbiAgICByZXR1cm4gdGhpcy51bmZpbHRlcmVkUGF0aC5tYXAocG9zaXRpb24gPT4ge1xuICAgICAgY29uc3QgdW5maWx0ZXJlZEdwc1Bvc2l0aW9uOiBQb3NpdGlvblBhdGhVbmZpbHRlcmVkR3BzUG9zaXRpb24gPSBPYmplY3QuYXNzaWduKHtcbiAgICAgICAgaW5jbHVkZWQ6IHRoaXMucGF0aENvbnRhaW5zKHBvc2l0aW9uKVxuICAgICAgfSwgcG9zaXRpb24pO1xuXG4gICAgICByZXR1cm4gdW5maWx0ZXJlZEdwc1Bvc2l0aW9uO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0R2VvbWV0cnlQYXRoU3VtbWFyeSgpOiBQb3NpdGlvblBhdGhCdWlsZGVyU3VtbWFyeVBvc2l0aW9uW11bXSB7XG4gICAgY29uc3QgbGluZSA9IHRoaXMudG9NdWx0aUxpbmVHZW9tZXRyeShmYWxzZSk7XG5cbiAgICByZXR1cm4gbGluZS5jb29yZGluYXRlcy5tYXAoXG4gICAgICAocGFydDogbnVtYmVyW11bXSwgcGFydEluZGV4OiBudW1iZXIpID0+IHRoaXMuZ2V0R2VvbWV0cnlMaW5lUGFydFN1bW1hcnkocGFydCwgcGFydEluZGV4KVxuICAgICk7XG4gIH1cblxuICBwYXRoQ29udGFpbnMocG9zaXRpb246IEdwc1Bvc2l0aW9uKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZm91bmQgPSB0aGlzLnBhcnRzLmZpbmQocGFydCA9PlxuICAgICAgcGFydC5pbmRleE9mKHBvc2l0aW9uKSA+IC0xXG4gICAgKTtcblxuICAgIHJldHVybiBCb29sZWFuKGZvdW5kKTtcbiAgfVxuXG4gIGdldFBvc2l0aW9uQnlJbmRleChwYXJ0SW5kZXg6IG51bWJlciwgdmVydGV4SW5kZXg6IG51bWJlcik6IEdwc1Bvc2l0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5wYXJ0c1twYXJ0SW5kZXhdW3ZlcnRleEluZGV4XTtcbiAgfVxuXG4gIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMudHJhY2tTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMudHJhY2tTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLnBhcnRzLmxlbmd0aCA9IDA7XG4gIH1cblxuICBwcml2YXRlIGdldEdlb21ldHJ5TGluZVBhcnRTdW1tYXJ5KGxpbmVQYXJ0OiBudW1iZXJbXVtdLCBwYXJ0SW5kZXg6IG51bWJlcik6IFBvc2l0aW9uUGF0aEJ1aWxkZXJTdW1tYXJ5UG9zaXRpb25bXSB7XG4gICAgcmV0dXJuIGxpbmVQYXJ0Lm1hcCgodmVydGV4LCB2ZXJ0ZXhJbmRleCkgPT4ge1xuICAgICAgY29uc3QgcG9zaXRpb24gPSB0aGlzLmdldFBvc2l0aW9uQnlJbmRleChwYXJ0SW5kZXgsIHZlcnRleEluZGV4KTtcbiAgICAgIGNvbnN0IGNhbGlicmF0aW9uS2V5ID0gdGhpcy5nZXRDYWxpYnJhdGlvbk1lYXN1cmVMb29rdXBLZXkocGFydEluZGV4LCB2ZXJ0ZXhJbmRleCk7XG4gICAgICBjb25zdCBjYWxpYnJhdGlvblBvaW50TWVhc3VyZVZhbHVlID0gdGhpcy5jYWxpYnJhdGVkTWVhc3VyZXMuaGFzKGNhbGlicmF0aW9uS2V5KVxuICAgICAgICA/IHRoaXMuY2FsaWJyYXRlZE1lYXN1cmVzLmdldChjYWxpYnJhdGlvbktleSkubWVhc3VyZVxuICAgICAgICA6IFBBVEhfQlVJTERFUl9FTVBUWV9DQUxJQlJBVElPTl9NRUFTVVJFX1ZBTFVFO1xuXG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7XG4gICAgICAgIGdlb21ldHJpY01lYXN1cmU6IGdldE1lYXN1cmVGcm9tUG9pbnQodmVydGV4KSxcbiAgICAgICAgcGFydEluZGV4LFxuICAgICAgICB2ZXJ0ZXhJbmRleCxcbiAgICAgICAgY2FsaWJyYXRpb25Qb2ludE1lYXN1cmVWYWx1ZVxuICAgICAgfSwgcG9zaXRpb24pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYWxpYnJhdGlvbk1lYXN1cmVMb29rdXBLZXkocGFydEluZGV4OiBudW1iZXIsIHZlcnRleEluZGV4OiBudW1iZXIpOiBzdHJpbmcge1xuICAgIHJldHVybiBgJHtwYXJ0SW5kZXh9XyR7dmVydGV4SW5kZXh9YDtcbiAgfVxuXG4gIHByaXZhdGUgdG9NdWx0aVBhcnRBcnJheSgpOiBudW1iZXJbXVtdW10ge1xuICAgIGNvbnN0IHBhcnRzOiBudW1iZXJbXVtdW10gPSBbXTtcbiAgICB0aGlzLnBhcnRzLmZvckVhY2gocGFydCA9PiB7XG4gICAgICBjb25zdCBjb29yZGluYXRlczogbnVtYmVyW11bXSA9IHBhcnQubWFwKFxuICAgICAgICBwb3NpdGlvbiA9PiB0aGlzLm9wdGlvbnMucmV0dXJuWlZhbHVlc1xuICAgICAgICAgID8gW3Bvc2l0aW9uLmxvbmdpdHVkZSwgcG9zaXRpb24ubGF0aXR1ZGUsIHBvc2l0aW9uLmFsdGl0dWRlIHx8IDBdXG4gICAgICAgICAgOiBbcG9zaXRpb24ubG9uZ2l0dWRlLCBwb3NpdGlvbi5sYXRpdHVkZV1cbiAgICAgICk7XG5cbiAgICAgIHBhcnRzLnB1c2goY29vcmRpbmF0ZXMpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHBhcnRzO1xuICB9XG5cbiAgcHJpdmF0ZSBlbnN1cmVQb2x5Z29uSXNDbG9zZWQocG9seWdvblBvaW50czogbnVtYmVyW11bXSk6IHZvaWQge1xuICAgIGlmIChwb2x5Z29uUG9pbnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgIGNvbnN0IFtmaXJzdF0gPSBwb2x5Z29uUG9pbnRzO1xuICAgICAgY29uc3QgbGFzdDogbnVtYmVyW10gPSBnZXRMYXN0SXRlbShwb2x5Z29uUG9pbnRzKTtcbiAgICAgIGNvbnN0IFtmaXJzdExuZywgZmlyc3RMYXQsIGZpcnN0Wl0gPSBmaXJzdDtcbiAgICAgIGNvbnN0IFtsYXN0TG5nLCBsYXN0TGF0XSA9IGxhc3Q7XG4gICAgICBjb25zdCBkb2VzUG9seWdvbk5vdENsb3NlID0gIXRoaXMuYXJlUG9pbnRzRXF1aXZhbGVudChmaXJzdExuZywgZmlyc3RMYXQsIGxhc3RMbmcsIGxhc3RMYXQpO1xuXG4gICAgICBpZiAoZG9lc1BvbHlnb25Ob3RDbG9zZSkge1xuICAgICAgICBjb25zdCBjbG9zaW5nUG9pbnQgPSBbZmlyc3RMbmcsIGZpcnN0TGF0LCBmaXJzdFogfHwgMF07XG4gICAgICAgIHBvbHlnb25Qb2ludHMucHVzaChjbG9zaW5nUG9pbnQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWRkUG9zaXRpb25Ub1BhdGgocG9zaXRpb246IEdwc1Bvc2l0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5jdXJyZW50UGFydC5wdXNoKHBvc2l0aW9uKTtcblxuICAgIGlmICh0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5oYXMoVU5QTEFDRURfQ0FMSUJSQVRJT05fTUVBU1VSRV9LRVkpKSB7XG4gICAgICB0aGlzLmFkZFBlbmRpbmdDYWxpYnJhdGlvblBvaW50KCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZGRQZW5kaW5nQ2FsaWJyYXRpb25Qb2ludCgpOiB2b2lkIHtcbiAgICBjb25zdCBjYWxpYnJhdG9uUG9zaXRpb24gPSB0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5nZXQoVU5QTEFDRURfQ0FMSUJSQVRJT05fTUVBU1VSRV9LRVkpO1xuICAgIGNvbnN0IGNhbGlicmF0aW9uVGltZXN0YW1wID0gY2FsaWJyYXRvblBvc2l0aW9uLnRpbWVzdGFtcDtcbiAgICBjb25zdCBbc2Vjb25kVG9MYXN0UG9zaXRpb24sIGxhc3RQb3NpdGlvbl0gPSB0aGlzLmN1cnJlbnRQYXJ0LnNsaWNlKC0yKTtcbiAgICBjb25zdCBpc1RpbWVzdGFtcEJldHdlZW5WZXJ0aWNlcyA9IGNhbGlicmF0aW9uVGltZXN0YW1wID4gc2Vjb25kVG9MYXN0UG9zaXRpb24udGltZXN0YW1wXG4gICAgICAmJiBjYWxpYnJhdGlvblRpbWVzdGFtcCA8IGxhc3RQb3NpdGlvbi50aW1lc3RhbXA7XG5cbiAgICBpZiAoaXNUaW1lc3RhbXBCZXR3ZWVuVmVydGljZXMpIHtcbiAgICAgIGNvbnN0IHRvdGFsVGltZURlbHRhID0gTWF0aC5hYnMobGFzdFBvc2l0aW9uLnRpbWVzdGFtcCAtIHNlY29uZFRvTGFzdFBvc2l0aW9uLnRpbWVzdGFtcCk7XG4gICAgICBjb25zdCBvZmZzZXRUaW1lRGVsdGEgPSBNYXRoLmFicyhjYWxpYnJhdGlvblRpbWVzdGFtcCAtIHNlY29uZFRvTGFzdFBvc2l0aW9uLnRpbWVzdGFtcCk7XG4gICAgICBjb25zdCBwZXJjZW50T2ZEaXN0YW5jZSA9IG9mZnNldFRpbWVEZWx0YSAvIHRvdGFsVGltZURlbHRhO1xuICAgICAgY29uc3QgZGlzdGFuY2VCZXR3ZWVuVmVydGljZXNLaWxvbWV0ZXJzID0gZ2V0RGlzdGFuY2VCZXR3ZWVuTGF0TG5nKFxuICAgICAgICBzZWNvbmRUb0xhc3RQb3NpdGlvbi5sYXRpdHVkZSxcbiAgICAgICAgc2Vjb25kVG9MYXN0UG9zaXRpb24ubG9uZ2l0dWRlLFxuICAgICAgICBsYXN0UG9zaXRpb24ubGF0aXR1ZGUsXG4gICAgICAgIGxhc3RQb3NpdGlvbi5sb25naXR1ZGUsXG4gICAgICAgIExlbmd0aFVuaXQuTWlsZVxuICAgICAgKTtcblxuICAgICAgY29uc3QgZGlzdGFuY2VUb1ByZXZpb3VzVmVydGV4S2lsb21ldGVycyA9IHBlcmNlbnRPZkRpc3RhbmNlICogZGlzdGFuY2VCZXR3ZWVuVmVydGljZXNLaWxvbWV0ZXJzO1xuICAgICAgY29uc3QgZGlkU25hcENhbGlicmF0aW9uTWVhc3VyZVRvVmVydGVzID0gdGhpcy50cnlTbmFwQ2FsaWJyYXRpb25NZWFzdXJlVG9WZXJ0ZXgoXG4gICAgICAgIGNhbGlicmF0b25Qb3NpdGlvbi5tZWFzdXJlLFxuICAgICAgICBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlc0tpbG9tZXRlcnMsXG4gICAgICAgIGRpc3RhbmNlVG9QcmV2aW91c1ZlcnRleEtpbG9tZXRlcnMpO1xuXG4gICAgICBpZiAoZGlkU25hcENhbGlicmF0aW9uTWVhc3VyZVRvVmVydGVzKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaGVhZGluZyA9IGJlYXJpbmcoXG4gICAgICAgIFtzZWNvbmRUb0xhc3RQb3NpdGlvbi5sb25naXR1ZGUsIHNlY29uZFRvTGFzdFBvc2l0aW9uLmxhdGl0dWRlXSxcbiAgICAgICAgW2xhc3RQb3NpdGlvbi5sb25naXR1ZGUsIGxhc3RQb3NpdGlvbi5sYXRpdHVkZV1cbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IG5ld1BvaW50OiBGZWF0dXJlPFBvaW50PiA9IGRlc3RpbmF0aW9uKFxuICAgICAgICBbc2Vjb25kVG9MYXN0UG9zaXRpb24ubG9uZ2l0dWRlLCBzZWNvbmRUb0xhc3RQb3NpdGlvbi5sYXRpdHVkZV0sXG4gICAgICAgIGRpc3RhbmNlVG9QcmV2aW91c1ZlcnRleEtpbG9tZXRlcnMsXG4gICAgICAgIGhlYWRpbmcsIHsgdW5pdHM6ICdraWxvbWV0ZXJzJyB9XG4gICAgICApO1xuXG4gICAgICBjb25zdCBzcGxpY2VJbmRleEZvclNlY29uZFRvTGFzdFBvc2l0aW9uID0gdGhpcy5jdXJyZW50UGFydC5sZW5ndGggLSAxO1xuICAgICAgY29uc3QgbmV3UG9zaXRpb246IEdwc1Bvc2l0aW9uID0gT2JqZWN0LmFzc2lnbih7fSwgbGFzdFBvc2l0aW9uLCB7XG4gICAgICAgIGxvbmdpdHVkZTogbmV3UG9pbnQuZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF0sXG4gICAgICAgIGxhdGl0dWRlOiBuZXdQb2ludC5nZW9tZXRyeS5jb29yZGluYXRlc1sxXSxcbiAgICAgICAgZGV2aWNlU291cmNlOiBQQVRIX0JVSUxERVJfQ0FMQ1VMQVRFRF9NX0RFVklDRV9TT1VSQ0VcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmNhbGlicmF0ZWRNZWFzdXJlcy5kZWxldGUoVU5QTEFDRURfQ0FMSUJSQVRJT05fTUVBU1VSRV9LRVkpO1xuICAgICAgdGhpcy5hZGRDYWxpYnJhdGlvbk1lYXN1cmVBdEluZGV4KGNhbGlicmF0b25Qb3NpdGlvbi5tZWFzdXJlLCBzcGxpY2VJbmRleEZvclNlY29uZFRvTGFzdFBvc2l0aW9uLCB0aGlzLmN1cnJlbnRQYXJ0SW5kZXgpO1xuICAgICAgdGhpcy5jdXJyZW50UGFydC5zcGxpY2Uoc3BsaWNlSW5kZXhGb3JTZWNvbmRUb0xhc3RQb3NpdGlvbiwgMCwgbmV3UG9zaXRpb24pO1xuICAgIH0gZWxzZSBpZiAoY2FsaWJyYXRpb25UaW1lc3RhbXAgPj0gbGFzdFBvc2l0aW9uLnRpbWVzdGFtcCkge1xuICAgICAgdGhpcy5hZGRDYWxpYnJhdGlvbk1lYXN1cmVUb0xhc3RQb3NpdGlvbihjYWxpYnJhdG9uUG9zaXRpb24ubWVhc3VyZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FsaWJyYXRpb24gbWVhc3VyZSB0aW1lc3RhbXAgJyR7Y2FsaWJyYXRvblBvc2l0aW9uLnRpbWVzdGFtcH0nIGNhbiBub3QgYmUgbG9jYXRlZCBiZXR3ZWVuYFxuICAgICAgICArIGAgJyR7c2Vjb25kVG9MYXN0UG9zaXRpb24udGltZXN0YW1wfScgYW5kICcke2xhc3RQb3NpdGlvbi50aW1lc3RhbXB9J2ApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdHJ5U25hcENhbGlicmF0aW9uTWVhc3VyZVRvVmVydGV4KFxuICAgIGNhbGlicmF0aW9uTWVhc3VyZTogbnVtYmVyLFxuICAgIHRvdGFsVmVydGljZURpc3RhbmNlS2lsb21ldGVyczogbnVtYmVyLFxuICAgIGRpc3RhbmNlVG9QcmV2aW91c1ZlcnRleEtpbG9tZXRlcnM6IG51bWJlclxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBkaXN0YW5jZVRvTmV4dFZlcnRleEtpbG9tZXRlcnMgPSB0b3RhbFZlcnRpY2VEaXN0YW5jZUtpbG9tZXRlcnMgLSBkaXN0YW5jZVRvUHJldmlvdXNWZXJ0ZXhLaWxvbWV0ZXJzO1xuICAgIGNvbnN0IGRpc3RhbmNlVGhyZXNob2xkS2lsb21ldGVycyA9IGNvbnZlcnRMZW5ndGhVbml0cyhcbiAgICAgIHRoaXMub3B0aW9ucy5jYWxpYnJhdGlvbk1lYXN1cmVTbmFwcGluZ0Rpc3RhbmNlRGVsdGEsXG4gICAgICB0aGlzLm9wdGlvbnMuY2FsaWJyYXRpb25NZWFzdXJlU25hcHBpbmdEaXN0YW5jZURlbHRhVW5pdCxcbiAgICAgIExlbmd0aFVuaXQuS2lsb21ldGVyXG4gICAgKTtcblxuICAgIGNvbnN0IGlzUG9pbnRDbG9zZUVub3VnaFRvUHJldmlvdXMgPSBkaXN0YW5jZVRvUHJldmlvdXNWZXJ0ZXhLaWxvbWV0ZXJzIDwgZGlzdGFuY2VUaHJlc2hvbGRLaWxvbWV0ZXJzO1xuICAgIGNvbnN0IGlzUG9pbnRDbG9zZUVub3VnaFRvTmV4dCA9IGRpc3RhbmNlVG9OZXh0VmVydGV4S2lsb21ldGVycyA8IGRpc3RhbmNlVGhyZXNob2xkS2lsb21ldGVycztcblxuICAgIGlmIChpc1BvaW50Q2xvc2VFbm91Z2hUb1ByZXZpb3VzIHx8IGlzUG9pbnRDbG9zZUVub3VnaFRvTmV4dCkge1xuICAgICAgY29uc3QgcHJldmlvdXNWZXJ0ZXhJbmRleCA9IHRoaXMuY3VycmVudFBhcnQubGVuZ3RoIC0gMjtcbiAgICAgIGNvbnN0IG5leHRWZXJ0ZXhJbmRleCA9IHRoaXMuY3VycmVudFBhcnQubGVuZ3RoIC0gMTtcbiAgICAgIGNvbnN0IHZlcnRleEluZGV4ID0gZGlzdGFuY2VUb1ByZXZpb3VzVmVydGV4S2lsb21ldGVycyA8IGRpc3RhbmNlVG9OZXh0VmVydGV4S2lsb21ldGVyc1xuICAgICAgICA/IHByZXZpb3VzVmVydGV4SW5kZXhcbiAgICAgICAgOiBuZXh0VmVydGV4SW5kZXg7XG5cbiAgICAgIHRoaXMuYWRkQ2FsaWJyYXRpb25NZWFzdXJlQXRJbmRleChjYWxpYnJhdGlvbk1lYXN1cmUsIHZlcnRleEluZGV4LCB0aGlzLmN1cnJlbnRQYXJ0SW5kZXgpO1xuICAgICAgdGhpcy5jYWxpYnJhdGVkTWVhc3VyZXMuZGVsZXRlKFVOUExBQ0VEX0NBTElCUkFUSU9OX01FQVNVUkVfS0VZKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgYXJlUG9zaXRpb25zRXF1aXZhbGVudChwb3NpdGlvbjE6IEdwc1Bvc2l0aW9uLCBwb3NpdGlvbjI6IEdwc1Bvc2l0aW9uKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuYXJlUG9pbnRzRXF1aXZhbGVudChcbiAgICAgIHBvc2l0aW9uMS5sb25naXR1ZGUsXG4gICAgICBwb3NpdGlvbjEubGF0aXR1ZGUsXG4gICAgICBwb3NpdGlvbjIubG9uZ2l0dWRlLFxuICAgICAgcG9zaXRpb24yLmxhdGl0dWRlXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXJlUG9pbnRzRXF1aXZhbGVudChsb25naXR1ZGUxOiBudW1iZXIsIGxhdGl0dWRlMTogbnVtYmVyLCBsb25naXR1ZGUyOiBudW1iZXIsIGxhdGl0dWRlMjogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHBvaW50c0FsbW9zdEVxdWFsKFxuICAgICAgbG9uZ2l0dWRlMSxcbiAgICAgIGxhdGl0dWRlMSxcbiAgICAgIGxvbmdpdHVkZTIsXG4gICAgICBsYXRpdHVkZTIsXG4gICAgICB0aGlzLm9wdGlvbnMucG9pbnRFcXVpdmFsZW5jeVByZWNpc2lvblxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHRyeVN0b3JlVW5maWx0ZXJlZFBhdGgocG9zaXRpb246IEdwc1Bvc2l0aW9uKTogdGhpcyB7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5zdG9yZVVuZmlsdGVyZWRQYXRoKSB7XG4gICAgICB0aGlzLnVuZmlsdGVyZWRQYXRoLnB1c2gocG9zaXRpb24pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG59XG4iXX0=