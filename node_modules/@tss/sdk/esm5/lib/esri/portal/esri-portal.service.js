/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { tap, map } from 'rxjs/operators';
// TSS.
import { getPortalUrl } from './get-portal-url.function';
import { getEsriMapServiceHttOptions, addParamsToHttpOptions } from '../esri-map-service-request';
import { EsriConfig } from '../esri-config';
import { DataSourceConfig } from '../../data-source/data-source-config';
import { BaseEsriService } from '../base-esri.service';
import { Logger } from '../../core/logging/logger.service';
import { toFormData } from '../../http/to-form-data.function';
import { toEsriPortalAccessToken } from './to-esri-portal-access-token.function';
import { toEsriServerToken } from '../to-esri-server-token.function';
import { PORTAL_GENERATE_TOKEN_ENDPOINT, PORTAL_OAUTH_TOKEN_ENDPOINT } from '../esri.constants';
import { removePortalAccessTokenFromHash } from './remove-portal-access-token-from-hash.function';
import { join } from '../../core/url/join.function';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "../esri-config";
import * as i3 from "../../data-source/data-source-config";
import * as i4 from "../../core/logging/logger.service";
var EsriPortalService = /** @class */ (function (_super) {
    tslib_1.__extends(EsriPortalService, _super);
    function EsriPortalService(http, config, dataConfig, log) {
        return _super.call(this, http, config, dataConfig, log) || this;
    }
    /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} code
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    EsriPortalService.prototype.getTokenByCode = /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} code
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    function (portalUrl, clientId, code, bodyData, params) {
        /** @type {?} */
        var data = Object.assign({
            client_id: clientId,
            code: code,
            redirect_uri: removePortalAccessTokenFromHash(window.location.href),
            grant_type: 'authorization_code'
        }, bodyData);
        /** @type {?} */
        var formData = toFormData(data);
        return this.doPost(portalUrl, PORTAL_OAUTH_TOKEN_ENDPOINT, formData, params)
            .pipe(map((/**
         * @param {?} rawToken
         * @return {?}
         */
        function (rawToken) { return toEsriPortalAccessToken(rawToken, portalUrl); })));
    };
    /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} refreshToken
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    EsriPortalService.prototype.refreshToken = /**
     * @param {?} portalUrl
     * @param {?} clientId
     * @param {?} refreshToken
     * @param {?=} bodyData
     * @param {?=} params
     * @return {?}
     */
    function (portalUrl, clientId, refreshToken, bodyData, params) {
        /** @type {?} */
        var data = Object.assign({
            client_id: clientId,
            refresh_token: refreshToken,
            grant_type: 'refresh_token'
        }, bodyData);
        /** @type {?} */
        var formData = toFormData(data);
        return this.doPost(portalUrl, PORTAL_OAUTH_TOKEN_ENDPOINT, formData, params)
            .pipe(map((/**
         * @param {?} rawToken
         * @return {?}
         */
        function (rawToken) { return toEsriPortalAccessToken(rawToken, portalUrl); })));
    };
    /**
     * @param {?} portalUrl
     * @param {?} portalAccessToken
     * @param {?} serverUrl
     * @param {?=} params
     * @return {?}
     */
    EsriPortalService.prototype.getServerToken = /**
     * @param {?} portalUrl
     * @param {?} portalAccessToken
     * @param {?} serverUrl
     * @param {?=} params
     * @return {?}
     */
    function (portalUrl, portalAccessToken, serverUrl, params) {
        /** @type {?} */
        var additionalParams = {
            request: 'getToken',
            serverUrl: serverUrl,
            token: portalAccessToken,
            referer: window.location.host
        };
        return this.doGet(portalUrl, PORTAL_GENERATE_TOKEN_ENDPOINT, additionalParams, params)
            .pipe(map((/**
         * @param {?} token
         * @return {?}
         */
        function (token) { return toEsriServerToken(token); })));
    };
    /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} queryParams
     * @param {?=} params
     * @return {?}
     */
    EsriPortalService.prototype.doGet = /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} queryParams
     * @param {?=} params
     * @return {?}
     */
    function (portalUrl, endpoint, queryParams, params) {
        var _this = this;
        /** @type {?} */
        var basePortalUrl = getPortalUrl(portalUrl);
        /** @type {?} */
        var url = join(basePortalUrl, endpoint);
        /** @type {?} */
        var httpOption = getEsriMapServiceHttOptions(params);
        addParamsToHttpOptions(httpOption, queryParams);
        return this.http
            .get(url, httpOption)
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        function (response) { return _this.handleEsriResponseError(response, url); })));
    };
    /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} formData
     * @param {?=} params
     * @return {?}
     */
    EsriPortalService.prototype.doPost = /**
     * @protected
     * @template T
     * @param {?} portalUrl
     * @param {?} endpoint
     * @param {?} formData
     * @param {?=} params
     * @return {?}
     */
    function (portalUrl, endpoint, formData, params) {
        var _this = this;
        /** @type {?} */
        var basePortalUrl = getPortalUrl(portalUrl);
        /** @type {?} */
        var url = join(basePortalUrl, endpoint);
        /** @type {?} */
        var httpOption = getEsriMapServiceHttOptions(params);
        return this.http
            .post(url, formData, httpOption)
            .pipe(tap((/**
         * @param {?} response
         * @return {?}
         */
        function (response) { return _this.handleEsriResponseError(response, url); })));
    };
    EsriPortalService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    EsriPortalService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: EsriConfig },
        { type: DataSourceConfig },
        { type: Logger }
    ]; };
    /** @nocollapse */ EsriPortalService.ngInjectableDef = i0.defineInjectable({ factory: function EsriPortalService_Factory() { return new EsriPortalService(i0.inject(i1.HttpClient), i0.inject(i2.EsriConfig), i0.inject(i3.DataSourceConfig), i0.inject(i4.Logger)); }, token: EsriPortalService, providedIn: "root" });
    return EsriPortalService;
}(BaseEsriService));
export { EsriPortalService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXNyaS1wb3J0YWwuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0B0c3Mvc2RrLyIsInNvdXJjZXMiOlsibGliL2VzcmkvcG9ydGFsL2VzcmktcG9ydGFsLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFjLE1BQU0sc0JBQXNCLENBQUM7QUFJOUQsT0FBTyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHMUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3pELE9BQU8sRUFBRSwyQkFBMkIsRUFBcUIsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUVySCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDeEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUUzRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDOUQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFDakYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDckUsT0FBTyxFQUNMLDhCQUE4QixFQUM5QiwyQkFBMkIsRUFDNUIsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQixPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUNsRyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sOEJBQThCLENBQUM7Ozs7OztBQUdwRDtJQUd1Qyw2Q0FBZTtJQUNwRCwyQkFBWSxJQUFnQixFQUFFLE1BQWtC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M0MsQ0FBMkMsRUFBQyxDQUNsRSxDQUFDO0lBQ04sQ0FBQzs7Ozs7Ozs7OztJQUVTLGtDQUFNOzs7Ozs7Ozs7SUFBaEIsVUFBb0IsU0FBaUIsRUFBRSxRQUFnQixFQUFFLFFBQWtCLEVBQUUsTUFBbUI7UUFBaEcsaUJBVUM7O1lBVE8sYUFBYSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUM7O1lBQ3ZDLEdBQUcsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQzs7WUFDbkMsVUFBVSxHQUFzQiwyQkFBMkIsQ0FBQyxNQUFNLENBQUM7UUFFekUsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLElBQUksQ0FBSSxHQUFHLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQzthQUNsQyxJQUFJLENBQ0gsR0FBRzs7OztRQUFDLFVBQUMsUUFBVyxJQUFLLE9BQUEsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsRUFBM0MsQ0FBMkMsRUFBQyxDQUNsRSxDQUFDO0lBQ04sQ0FBQzs7Z0JBaEZGLFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7Ozs7Z0JBNUJRLFVBQVU7Z0JBVVYsVUFBVTtnQkFDVixnQkFBZ0I7Z0JBRWhCLE1BQU07Ozs0QkFmZjtDQTZHQyxBQWpGRCxDQUd1QyxlQUFlLEdBOEVyRDtTQTlFWSxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBbmd1bGFyLlxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuLy8gM3JkIFBhcnR5LlxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8vIFRTUy5cbmltcG9ydCB7IGdldFBvcnRhbFVybCB9IGZyb20gJy4vZ2V0LXBvcnRhbC11cmwuZnVuY3Rpb24nO1xuaW1wb3J0IHsgZ2V0RXNyaU1hcFNlcnZpY2VIdHRPcHRpb25zLCBBbmd1bGFySHR0cE9wdGlvbiwgYWRkUGFyYW1zVG9IdHRwT3B0aW9ucyB9IGZyb20gJy4uL2VzcmktbWFwLXNlcnZpY2UtcmVxdWVzdCc7XG5pbXBvcnQgeyBFc3JpU2VydmVyVG9rZW4gfSBmcm9tICcuLi9lc3JpLXNlcnZlci10b2tlbic7XG5pbXBvcnQgeyBFc3JpQ29uZmlnIH0gZnJvbSAnLi4vZXNyaS1jb25maWcnO1xuaW1wb3J0IHsgRGF0YVNvdXJjZUNvbmZpZyB9IGZyb20gJy4uLy4uL2RhdGEtc291cmNlL2RhdGEtc291cmNlLWNvbmZpZyc7XG5pbXBvcnQgeyBCYXNlRXNyaVNlcnZpY2UgfSBmcm9tICcuLi9iYXNlLWVzcmkuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi8uLi9jb3JlL2xvZ2dpbmcvbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgRXNyaVBvcnRhbEFjY2Vzc1Rva2VuIH0gZnJvbSAnLi9lc3JpLXBvcnRhbC1hY2Nlc3MtdG9rZW4nO1xuaW1wb3J0IHsgdG9Gb3JtRGF0YSB9IGZyb20gJy4uLy4uL2h0dHAvdG8tZm9ybS1kYXRhLmZ1bmN0aW9uJztcbmltcG9ydCB7IHRvRXNyaVBvcnRhbEFjY2Vzc1Rva2VuIH0gZnJvbSAnLi90by1lc3JpLXBvcnRhbC1hY2Nlc3MtdG9rZW4uZnVuY3Rpb24nO1xuaW1wb3J0IHsgdG9Fc3JpU2VydmVyVG9rZW4gfSBmcm9tICcuLi90by1lc3JpLXNlcnZlci10b2tlbi5mdW5jdGlvbic7XG5pbXBvcnQge1xuICBQT1JUQUxfR0VORVJBVEVfVE9LRU5fRU5EUE9JTlQsXG4gIFBPUlRBTF9PQVVUSF9UT0tFTl9FTkRQT0lOVFxufSBmcm9tICcuLi9lc3JpLmNvbnN0YW50cyc7XG5pbXBvcnQgeyByZW1vdmVQb3J0YWxBY2Nlc3NUb2tlbkZyb21IYXNoIH0gZnJvbSAnLi9yZW1vdmUtcG9ydGFsLWFjY2Vzcy10b2tlbi1mcm9tLWhhc2guZnVuY3Rpb24nO1xuaW1wb3J0IHsgam9pbiB9IGZyb20gJy4uLy4uL2NvcmUvdXJsL2pvaW4uZnVuY3Rpb24nO1xuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEVzcmlQb3J0YWxTZXJ2aWNlIGV4dGVuZHMgQmFzZUVzcmlTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoaHR0cDogSHR0cENsaWVudCwgY29uZmlnOiBFc3JpQ29uZmlnLCBkYXRhQ29uZmlnOiBEYXRhU291cmNlQ29uZmlnLCBsb2c6IExvZ2dlcikge1xuICAgIHN1cGVyKGh0dHAsIGNvbmZpZywgZGF0YUNvbmZpZywgbG9nKTtcbiAgfVxuXG4gIGdldFRva2VuQnlDb2RlKHBvcnRhbFVybDogc3RyaW5nLCBjbGllbnRJZDogc3RyaW5nLCBjb2RlOiBzdHJpbmcsIGJvZHlEYXRhPzoge30sIHBhcmFtcz86IEh0dHBQYXJhbXMpOiBPYnNlcnZhYmxlPEVzcmlQb3J0YWxBY2Nlc3NUb2tlbj4ge1xuICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHtcbiAgICAgIGNsaWVudF9pZDogY2xpZW50SWQsXG4gICAgICBjb2RlLFxuICAgICAgcmVkaXJlY3RfdXJpOiByZW1vdmVQb3J0YWxBY2Nlc3NUb2tlbkZyb21IYXNoKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSxcbiAgICAgIGdyYW50X3R5cGU6ICdhdXRob3JpemF0aW9uX2NvZGUnXG4gICAgfSwgYm9keURhdGEpO1xuICAgIGNvbnN0IGZvcm1EYXRhID0gdG9Gb3JtRGF0YShkYXRhKTtcblxuICAgIHJldHVybiB0aGlzLmRvUG9zdChwb3J0YWxVcmwsIFBPUlRBTF9PQVVUSF9UT0tFTl9FTkRQT0lOVCwgZm9ybURhdGEsIHBhcmFtcylcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAocmF3VG9rZW4gPT4gdG9Fc3JpUG9ydGFsQWNjZXNzVG9rZW4ocmF3VG9rZW4sIHBvcnRhbFVybCkpXG4gICAgICApO1xuICB9XG5cbiAgcmVmcmVzaFRva2VuKFxuICAgIHBvcnRhbFVybDogc3RyaW5nLFxuICAgIGNsaWVudElkOiBzdHJpbmcsXG4gICAgcmVmcmVzaFRva2VuOiBzdHJpbmcsXG4gICAgYm9keURhdGE/OiB7fSxcbiAgICBwYXJhbXM/OiBIdHRwUGFyYW1zXG4gICk6IE9ic2VydmFibGU8RXNyaVBvcnRhbEFjY2Vzc1Rva2VuPiB7XG4gICAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgY2xpZW50X2lkOiBjbGllbnRJZCxcbiAgICAgIHJlZnJlc2hfdG9rZW46IHJlZnJlc2hUb2tlbixcbiAgICAgIGdyYW50X3R5cGU6ICdyZWZyZXNoX3Rva2VuJ1xuICAgIH0sIGJvZHlEYXRhKTtcbiAgICBjb25zdCBmb3JtRGF0YSA9IHRvRm9ybURhdGEoZGF0YSk7XG5cbiAgICByZXR1cm4gdGhpcy5kb1Bvc3QocG9ydGFsVXJsLCBQT1JUQUxfT0FVVEhfVE9LRU5fRU5EUE9JTlQsIGZvcm1EYXRhLCBwYXJhbXMpXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKHJhd1Rva2VuID0+IHRvRXNyaVBvcnRhbEFjY2Vzc1Rva2VuKHJhd1Rva2VuLCBwb3J0YWxVcmwpKVxuICAgICAgKTtcbiAgfVxuXG4gIGdldFNlcnZlclRva2VuKHBvcnRhbFVybDogc3RyaW5nLCBwb3J0YWxBY2Nlc3NUb2tlbjogc3RyaW5nLCBzZXJ2ZXJVcmw6IHN0cmluZywgcGFyYW1zPzogSHR0cFBhcmFtcyk6IE9ic2VydmFibGU8RXNyaVNlcnZlclRva2VuPiB7XG4gICAgY29uc3QgYWRkaXRpb25hbFBhcmFtcyA9IHtcbiAgICAgIHJlcXVlc3Q6ICdnZXRUb2tlbicsXG4gICAgICBzZXJ2ZXJVcmwsXG4gICAgICB0b2tlbjogcG9ydGFsQWNjZXNzVG9rZW4sXG4gICAgICByZWZlcmVyOiB3aW5kb3cubG9jYXRpb24uaG9zdFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5kb0dldChwb3J0YWxVcmwsIFBPUlRBTF9HRU5FUkFURV9UT0tFTl9FTkRQT0lOVCwgYWRkaXRpb25hbFBhcmFtcywgcGFyYW1zKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCh0b2tlbiA9PiB0b0VzcmlTZXJ2ZXJUb2tlbih0b2tlbikpXG4gICAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRvR2V0PFQ+KHBvcnRhbFVybDogc3RyaW5nLCBlbmRwb2ludDogc3RyaW5nLCBxdWVyeVBhcmFtczoge30sIHBhcmFtcz86IEh0dHBQYXJhbXMpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICBjb25zdCBiYXNlUG9ydGFsVXJsID0gZ2V0UG9ydGFsVXJsKHBvcnRhbFVybCk7XG4gICAgY29uc3QgdXJsID0gam9pbihiYXNlUG9ydGFsVXJsLCBlbmRwb2ludCk7XG4gICAgY29uc3QgaHR0cE9wdGlvbjogQW5ndWxhckh0dHBPcHRpb24gPSBnZXRFc3JpTWFwU2VydmljZUh0dE9wdGlvbnMocGFyYW1zKTtcblxuICAgIGFkZFBhcmFtc1RvSHR0cE9wdGlvbnMoaHR0cE9wdGlvbiwgcXVlcnlQYXJhbXMpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8VD4odXJsLCBodHRwT3B0aW9uKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgocmVzcG9uc2U6IFQpID0+IHRoaXMuaGFuZGxlRXNyaVJlc3BvbnNlRXJyb3IocmVzcG9uc2UsIHVybCkpXG4gICAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGRvUG9zdDxUPihwb3J0YWxVcmw6IHN0cmluZywgZW5kcG9pbnQ6IHN0cmluZywgZm9ybURhdGE6IEZvcm1EYXRhLCBwYXJhbXM/OiBIdHRwUGFyYW1zKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgY29uc3QgYmFzZVBvcnRhbFVybCA9IGdldFBvcnRhbFVybChwb3J0YWxVcmwpO1xuICAgIGNvbnN0IHVybCA9IGpvaW4oYmFzZVBvcnRhbFVybCwgZW5kcG9pbnQpO1xuICAgIGNvbnN0IGh0dHBPcHRpb246IEFuZ3VsYXJIdHRwT3B0aW9uID0gZ2V0RXNyaU1hcFNlcnZpY2VIdHRPcHRpb25zKHBhcmFtcyk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucG9zdDxUPih1cmwsIGZvcm1EYXRhLCBodHRwT3B0aW9uKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRhcCgocmVzcG9uc2U6IFQpID0+IHRoaXMuaGFuZGxlRXNyaVJlc3BvbnNlRXJyb3IocmVzcG9uc2UsIHVybCkpXG4gICAgICApO1xuICB9XG59XG4iXX0=