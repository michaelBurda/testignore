/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { LrsMetadata } from './lrs-metadata';
import { findLayer } from './layer-search';
import { LayerDrawingInfo } from '../maps/drawing/layer-drawing-info';
import { mergeDeep } from '../core/merge/merge-deep.function';
import { mergeDeepArray } from '../core/merge/merge-deep-array.function';
import { isNumber } from '../core/type-check/is-number.function';
/**
 * @param {?} layerId
 * @param {...?} layerList
 * @return {?}
 */
function find(layerId) {
    var layerList = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        layerList[_i - 1] = arguments[_i];
    }
    return findLayer.apply(void 0, tslib_1.__spread([layerId], layerList));
}
/**
 * @param {?} layer
 * @return {?}
 */
function setLayerDefaults(layer) {
    layer.fields = layer.fields || [];
}
/**
 * @param {?} layer
 * @return {?}
 */
function setNetworkLayerDefaults(layer) {
    if (layer) {
        layer.hierarchyFilter = layer.hierarchyFilter || [];
    }
}
/**
 * @param {?} target
 * @param {?} source
 * @return {?}
 */
export function mergeFieldDomains(target, source) {
    mergeDeep(target, source, { ignoreArrays: true });
    if (target && target.codedValues && source && source.codedValues) {
        mergeDeepArray(target.codedValues, source.codedValues, { identifier: 'code' });
    }
}
/**
 * @param {?} target
 * @param {?} source
 * @return {?}
 */
export function mergeFields(target, source) {
    target = target || [];
    source = source || [];
    mergeDeepArray(target, source, {
        identifier: 'name',
        beforeMerge: (/**
         * @param {?} targetField
         * @param {?} sourceField
         * @return {?}
         */
        function (targetField, sourceField) {
            if (targetField.domain && sourceField.domain && sourceField.domain.codedValues) {
                /** @type {?} */
                var doValuesNeedMerged = sourceField.domain.codedValues.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return isNumber(c.order); }));
                if (doValuesNeedMerged && doValuesNeedMerged.length) {
                    mergeFieldDomains(targetField.domain, sourceField.domain);
                    return false;
                }
            }
        })
    });
}
/**
 * @param {?} target
 * @param {?} source
 * @return {?}
 */
export function mergeLayer(target, source) {
    if (!target || !source) {
        return;
    }
    /** @type {?} */
    var lrsTarget = (/** @type {?} */ (target));
    /** @type {?} */
    var lrsSource = (/** @type {?} */ (source));
    /** @type {?} */
    var targetCapturePositions = lrsTarget.capturePositions || [];
    /** @type {?} */
    var sourceCapturePositions = lrsSource.capturePositions || [];
    /** @type {?} */
    var targetDrawingInfo = (/** @type {?} */ (lrsTarget.drawingInfo));
    /** @type {?} */
    var sourceDrawingInfo = (/** @type {?} */ (lrsSource.drawingInfo));
    /** @type {?} */
    var hasDrawingInfo = Boolean(targetDrawingInfo || sourceDrawingInfo);
    /** @type {?} */
    var drawingInfo = new LayerDrawingInfo((/** @type {?} */ (lrsTarget.drawingInfo)), (/** @type {?} */ (lrsSource.drawingInfo)));
    mergeDeep(target, source, { ignoreArrays: true });
    mergeFields(target.fields, source.fields);
    if (hasDrawingInfo) {
        ((/** @type {?} */ (target))).drawingInfo = drawingInfo;
    }
    if (!targetCapturePositions.length && sourceCapturePositions.length) {
        lrsTarget.capturePositions = sourceCapturePositions;
    }
}
/**
 * @param {?} target
 * @param {?} source
 * @param {?=} sourceMetadata
 * @param {?=} sort
 * @param {?=} onMergeComplete
 * @return {?}
 */
export function mergeLayers(target, source, sourceMetadata, sort, onMergeComplete) {
    if (sort === void 0) { sort = true; }
    if (onMergeComplete === void 0) { onMergeComplete = null; }
    target = target || [];
    source = source || [];
    target.forEach((/**
     * @param {?} targetLayer
     * @return {?}
     */
    function (targetLayer) {
        setLayerDefaults(targetLayer);
        mergeLayer(targetLayer, source.find((/**
         * @param {?} sourceLayer
         * @return {?}
         */
        function (sourceLayer) { return sourceLayer.id === targetLayer.id; })));
    }));
    // There will be occurences where the source has layers that the target doesn't, which
    // means that the merge will not happen above, because the target is the one being looped.
    source
        .filter((/**
     * @param {?} src
     * @return {?}
     */
    function (src) { return !target.find((/**
     * @param {?} x
     * @return {?}
     */
    function (x) { return src.id === x.id; })); }))
        .forEach((/**
     * @param {?} missing
     * @return {?}
     */
    function (missing) {
        /** @type {?} */
        var newLayer = missing;
        if (sourceMetadata) {
            /** @type {?} */
            var merger = find(missing.id, sourceMetadata.tables, sourceMetadata.layers, sourceMetadata.nonLRSLayers);
            // We want to preseve the original table or layer, so we don't overwrite it here.
            newLayer = Object.assign({}, merger);
            mergeLayer(newLayer, missing);
        }
        setLayerDefaults(newLayer);
        target.push(newLayer);
    }));
    if (sort) {
        target.sort((/**
         * @param {?} layer1
         * @param {?} layer2
         * @return {?}
         */
        function (layer1, layer2) { return layer1.order - layer2.order; }));
    }
    if (onMergeComplete) {
        target.forEach((/**
         * @param {?} targetLayer
         * @return {?}
         */
        function (targetLayer) {
            onMergeComplete(targetLayer, source.find((/**
             * @param {?} sourceLayer
             * @return {?}
             */
            function (sourceLayer) { return sourceLayer.id === targetLayer.id; })));
        }));
    }
}
/**
 * @param {?} target
 * @param {?} source
 * @param {?=} sourceMetadata
 * @return {?}
 */
export function mergeNetworkLayers(target, source, sourceMetadata) {
    /** @type {?} */
    var isSorted = true;
    mergeLayers(target, source, sourceMetadata, isSorted, onMergeNetworkLayerComplete);
}
/**
 * @param {?} targetLayer
 * @param {?} sourceLayer
 * @return {?}
 */
export function onMergeNetworkLayerComplete(targetLayer, sourceLayer) {
    setNetworkLayerDefaults(targetLayer);
    setNetworkLayerDefaults(sourceLayer);
    if (targetLayer && sourceLayer) {
        mergeDeepArray(targetLayer.hierarchyFilter, sourceLayer.hierarchyFilter, { identifier: 'name' });
    }
}
/**
 * @param {?} target
 * @param {...?} source
 * @return {?}
 */
export function mergeLrsMetadata(target) {
    var source = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        source[_i - 1] = arguments[_i];
    }
    source.forEach((/**
     * @param {?} srcMeta
     * @return {?}
     */
    function (srcMeta) {
        /** @type {?} */
        var dataSource = srcMeta.dataSource || target.dataSource;
        mergeDeep(target, srcMeta, { ignoreArrays: true });
        if (dataSource) {
            target.dataSource = dataSource;
        }
        mergeNetworkLayers(target.networkLayers, srcMeta.networkLayers, target);
        mergeLayers(target.eventLayers, srcMeta.eventLayers, target);
        mergeLayers(target.calibrationPointLayers, srcMeta.calibrationPointLayers, target);
        mergeLayers(target.intersectionLayers, srcMeta.intersectionLayers, target);
        mergeLayers(target.centerlineLayers, srcMeta.centerlineLayers, target);
        mergeLayers(target.redlineLayers, srcMeta.redlineLayers, target);
        mergeLayers(target.nonLRSLayers, srcMeta.nonLRSLayers, target);
        mergeLayers(target.layers, srcMeta.layers);
        mergeLayers(target.tables, srcMeta.tables);
    }));
}
/**
 * @param {?} target
 * @param {...?} source
 * @return {?}
 */
export function mergeMapMetadata(target) {
    var source = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        source[_i - 1] = arguments[_i];
    }
    source.forEach((/**
     * @param {?} meta
     * @return {?}
     */
    function (meta) {
        Object.assign(target, meta);
    }));
}
/**
 * @param {?} target
 * @param {...?} source
 * @return {?}
 */
export function deepMergeMapMetadata(target) {
    var source = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        source[_i - 1] = arguments[_i];
    }
    source.forEach((/**
     * @param {?} meta
     * @return {?}
     */
    function (meta) {
        meta.layers.forEach((/**
         * @param {?} nonLrsLayerInfo
         * @return {?}
         */
        function (nonLrsLayerInfo) {
            /** @type {?} */
            var targetLayer = target.getLrsLayer(nonLrsLayerInfo.id);
            if (targetLayer) {
                /** @type {?} */
                var baseFields = tslib_1.__spread(nonLrsLayerInfo.fields);
                mergeFields(baseFields, targetLayer.fields);
                targetLayer.fields = baseFields;
                if (nonLrsLayerInfo.geometryType) {
                    targetLayer.geometryType = nonLrsLayerInfo.geometryType;
                }
                targetLayer.drawingInfo = new LayerDrawingInfo(nonLrsLayerInfo.drawingInfo, targetLayer.drawingInfo);
            }
        }));
    }));
}
/**
 * @param {?} dataSource
 * @param {?} dataSourceLrsMetadata
 * @param {?} mapServerLrsMetadata
 * @param {?} mapServerMetadata
 * @return {?}
 */
export function mergeLrsMetadataSources(dataSource, dataSourceLrsMetadata, mapServerLrsMetadata, mapServerMetadata) {
    /** @type {?} */
    var hasMapServerLrsMetadata = Boolean(mapServerLrsMetadata);
    /** @type {?} */
    var fullLrsMeta = mapServerLrsMetadata
        || dataSourceLrsMetadata
        || new LrsMetadata(dataSource);
    fullLrsMeta.mergeMapMetadata(mapServerMetadata);
    fullLrsMeta.dataSource = fullLrsMeta.dataSource || dataSource;
    fullLrsMeta.dataSourceId = fullLrsMeta.dataSourceId || dataSource.id;
    if (hasMapServerLrsMetadata) {
        // If the map service has LRS metadata then we need to merge the
        // data source LRS metadata into the map service lrs metadata
        // because we want the data source metadata to be priority.
        fullLrsMeta.mergeLrsMetadata(dataSourceLrsMetadata);
    }
    else {
        // We only need to do a dep merge when there is no LRS metadata available in the map service because
        // the map service LRS metadata provides all of the same information as the map server metadata (like fields).
        fullLrsMeta.deepMergeMapMetadata(mapServerMetadata);
    }
    fullLrsMeta.rebuildLayers();
    return fullLrsMeta;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHJzLW1ldGFkYXRhLW1lcmdlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvbHJzL2xycy1tZXRhZGF0YS1tZXJnZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJM0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFFdEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQzlELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7Ozs7OztBQUlqRSxTQUFTLElBQUksQ0FBQyxPQUFlO0lBQUUsbUJBQTBCO1NBQTFCLFVBQTBCLEVBQTFCLHFCQUEwQixFQUExQixJQUEwQjtRQUExQixrQ0FBMEI7O0lBQ3ZELE9BQU8sU0FBUyxpQ0FBQyxPQUFPLEdBQUssU0FBUyxHQUFFO0FBQzFDLENBQUM7Ozs7O0FBRUQsU0FBUyxnQkFBZ0IsQ0FBQyxLQUFlO0lBQ3ZDLEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUM7QUFDcEMsQ0FBQzs7Ozs7QUFFRCxTQUFTLHVCQUF1QixDQUFDLEtBQW1CO0lBQ2xELElBQUksS0FBSyxFQUFFO1FBQ1QsS0FBSyxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQztLQUNyRDtBQUNILENBQUM7Ozs7OztBQUVELE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxNQUF3QixFQUFFLE1BQXdCO0lBQ2xGLFNBQVMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFFbEQs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bkMscUJBQXFCO1dBQ3JCLElBQUksV0FBVyxDQUFDLFVBQVUsQ0FBQztJQUVoQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUNoRCxXQUFXLENBQUMsVUFBVSxHQUFHLFdBQVcsQ0FBQyxVQUFVLElBQUksVUFBVSxDQUFDO0lBQzlELFdBQVcsQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLFlBQVksSUFBSSxVQUFVLENBQUMsRUFBRSxDQUFDO0lBRXJFLElBQUksdUJBQXVCLEVBQUU7UUFDM0IsZ0VBQWdFO1FBQ2hFLDZEQUE2RDtRQUM3RCwyREFBMkQ7UUFDM0QsV0FBVyxDQUFDLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLENBQUM7S0FDckQ7U0FBTTtRQUNMLG9HQUFvRztRQUNwRyw4R0FBOEc7UUFDOUcsV0FBVyxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDLENBQUM7S0FDckQ7SUFFRCxXQUFXLENBQUMsYUFBYSxFQUFFLENBQUM7SUFFNUIsT0FBTyxXQUFXLENBQUM7QUFDckIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExheWVyRmllbGQsIExheWVyRmllbGREb21haW4gfSBmcm9tICcuLi9tYXBzL2ZpZWxkcy9sYXllci1maWVsZCc7XG5pbXBvcnQgeyBMcnNNZXRhZGF0YSB9IGZyb20gJy4vbHJzLW1ldGFkYXRhJztcbmltcG9ydCB7IE1hcFNlcnZlck1ldGFkYXRhIH0gZnJvbSAnLi4vbWFwcy9tYXAtc2VydmVyLW1ldGFkYXRhJztcbmltcG9ydCB7IGZpbmRMYXllciB9IGZyb20gJy4vbGF5ZXItc2VhcmNoJztcbmltcG9ydCB7IE1hcExheWVyIH0gZnJvbSAnLi4vbWFwcy9tYXAtbGF5ZXInO1xuaW1wb3J0IHsgTmV0d29ya0xheWVyIH0gZnJvbSAnLi9uZXR3b3Jrcy9uZXR3b3JrLWxheWVyJztcbmltcG9ydCB7IERhdGFTb3VyY2UgfSBmcm9tICcuLi9kYXRhLXNvdXJjZS9kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBMYXllckRyYXdpbmdJbmZvIH0gZnJvbSAnLi4vbWFwcy9kcmF3aW5nL2xheWVyLWRyYXdpbmctaW5mbyc7XG5pbXBvcnQgeyBGZWF0dXJlQ2xhc3NMYXllciB9IGZyb20gJy4uL21hcHMvZmVhdHVyZS1jbGFzcy1sYXllcic7XG5pbXBvcnQgeyBtZXJnZURlZXAgfSBmcm9tICcuLi9jb3JlL21lcmdlL21lcmdlLWRlZXAuZnVuY3Rpb24nO1xuaW1wb3J0IHsgbWVyZ2VEZWVwQXJyYXkgfSBmcm9tICcuLi9jb3JlL21lcmdlL21lcmdlLWRlZXAtYXJyYXkuZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNOdW1iZXIgfSBmcm9tICcuLi9jb3JlL3R5cGUtY2hlY2svaXMtbnVtYmVyLmZ1bmN0aW9uJztcbmltcG9ydCB7IExyc0xheWVyIH0gZnJvbSAnLi9scnMtbGF5ZXInO1xuXG5cbmZ1bmN0aW9uIGZpbmQobGF5ZXJJZDogbnVtYmVyLCAuLi5sYXllckxpc3Q6IE1hcExheWVyW11bXSk6IE1hcExheWVyIHtcbiAgcmV0dXJuIGZpbmRMYXllcihsYXllcklkLCAuLi5sYXllckxpc3QpO1xufVxuXG5mdW5jdGlvbiBzZXRMYXllckRlZmF1bHRzKGxheWVyOiBNYXBMYXllcik6IHZvaWQge1xuICBsYXllci5maWVsZHMgPSBsYXllci5maWVsZHMgfHwgW107XG59XG5cbmZ1bmN0aW9uIHNldE5ldHdvcmtMYXllckRlZmF1bHRzKGxheWVyOiBOZXR3b3JrTGF5ZXIpOiB2b2lkIHtcbiAgaWYgKGxheWVyKSB7XG4gICAgbGF5ZXIuaGllcmFyY2h5RmlsdGVyID0gbGF5ZXIuaGllcmFyY2h5RmlsdGVyIHx8IFtdO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZUZpZWxkRG9tYWlucyh0YXJnZXQ6IExheWVyRmllbGREb21haW4sIHNvdXJjZTogTGF5ZXJGaWVsZERvbWFpbikge1xuICBtZXJnZURlZXAodGFyZ2V0LCBzb3VyY2UsIHsgaWdub3JlQXJyYXlzOiB0cnVlIH0pO1xuXG4gIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmNvZGVkVmFsdWVzICYmIHNvdXJjZSAmJiBzb3VyY2UuY29kZWRWYWx1ZXMpIHtcbiAgICBtZXJnZURlZXBBcnJheSh0YXJnZXQuY29kZWRWYWx1ZXMsIHNvdXJjZS5jb2RlZFZhbHVlcywgeyBpZGVudGlmaWVyOiAnY29kZScgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlRmllbGRzKHRhcmdldDogTGF5ZXJGaWVsZFtdLCBzb3VyY2U6IExheWVyRmllbGRbXSkge1xuICB0YXJnZXQgPSB0YXJnZXQgfHwgW107XG4gIHNvdXJjZSA9IHNvdXJjZSB8fCBbXTtcblxuICBtZXJnZURlZXBBcnJheSh0YXJnZXQsIHNvdXJjZSwge1xuICAgIGlkZW50aWZpZXI6ICduYW1lJyxcbiAgICBiZWZvcmVNZXJnZTogKHRhcmdldEZpZWxkOiBMYXllckZpZWxkLCBzb3VyY2VGaWVsZDogTGF5ZXJGaWVsZCkgPT4ge1xuICAgICAgaWYgKHRhcmdldEZpZWxkLmRvbWFpbiAmJiBzb3VyY2VGaWVsZC5kb21haW4gJiYgc291cmNlRmllbGQuZG9tYWluLmNvZGVkVmFsdWVzKSB7XG4gICAgICAgIGNvbnN0IGRvVmFsdWVzTmVlZE1lcmdlZCA9IHNvdXJjZUZpZWxkLmRvbWFpbi5jb2RlZFZhbHVlcy5maWx0ZXIoYyA9PiBpc051bWJlcihjLm9yZGVyKSk7XG5cbiAgICAgICAgaWYgKGRvVmFsdWVzTmVlZE1lcmdlZCAmJiBkb1ZhbHVlc05lZWRNZXJnZWQubGVuZ3RoKSB7XG4gICAgICAgICAgbWVyZ2VGaWVsZERvbWFpbnModGFyZ2V0RmllbGQuZG9tYWluLCBzb3VyY2VGaWVsZC5kb21haW4pO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBtZXJnZUxheWVyKHRhcmdldDogTWFwTGF5ZXIsIHNvdXJjZTogTWFwTGF5ZXIpIHtcbiAgaWYgKCF0YXJnZXQgfHwgIXNvdXJjZSkge1xuICAgIHJldHVybjtcbiAgfVxuXG5cbiAgY29uc3QgbHJzVGFyZ2V0ID0gdGFyZ2V0IGFzIExyc0xheWVyO1xuICBjb25zdCBscnNTb3VyY2UgPSBzb3VyY2UgYXMgTHJzTGF5ZXI7XG4gIGNvbnN0IHRhcmdldENhcHR1cmVQb3NpdGlvbnMgPSBscnNUYXJnZXQuY2FwdHVyZVBvc2l0aW9ucyB8fCBbXTtcbiAgY29uc3Qgc291cmNlQ2FwdHVyZVBvc2l0aW9ucyA9IGxyc1NvdXJjZS5jYXB0dXJlUG9zaXRpb25zIHx8IFtdO1xuICBjb25zdCB0YXJnZXREcmF3aW5nSW5mbyA9IGxyc1RhcmdldC5kcmF3aW5nSW5mbyBhcyBMYXllckRyYXdpbmdJbmZvO1xuICBjb25zdCBzb3VyY2VEcmF3aW5nSW5mbyA9IGxyc1NvdXJjZS5kcmF3aW5nSW5mbyBhcyBMYXllckRyYXdpbmdJbmZvO1xuICBjb25zdCBoYXNEcmF3aW5nSW5mbyA9IEJvb2xlYW4odGFyZ2V0RHJhd2luZ0luZm8gfHwgc291cmNlRHJhd2luZ0luZm8pO1xuICBjb25zdCBkcmF3aW5nSW5mbyA9IG5ldyBMYXllckRyYXdpbmdJbmZvKGxyc1RhcmdldC5kcmF3aW5nSW5mbyBhcyBMYXllckRyYXdpbmdJbmZvLCBscnNTb3VyY2UuZHJhd2luZ0luZm8gYXMgTGF5ZXJEcmF3aW5nSW5mbyk7XG5cbiAgbWVyZ2VEZWVwKHRhcmdldCwgc291cmNlLCB7IGlnbm9yZUFycmF5czogdHJ1ZSB9KTtcbiAgbWVyZ2VGaWVsZHModGFyZ2V0LmZpZWxkcywgc291cmNlLmZpZWxkcyk7XG5cbiAgaWYgKGhhc0RyYXdpbmdJbmZvKSB7XG4gICAgKHRhcmdldCBhcyBGZWF0dXJlQ2xhc3NMYXllcikuZHJhd2luZ0luZm8gPSBkcmF3aW5nSW5mbztcbiAgfVxuXG4gIGlmICghdGFyZ2V0Q2FwdHVyZVBvc2l0aW9ucy5sZW5ndGggJiYgc291cmNlQ2FwdHVyZVBvc2l0aW9ucy5sZW5ndGgpIHtcbiAgICBscnNUYXJnZXQuY2FwdHVyZVBvc2l0aW9ucyA9IHNvdXJjZUNhcHR1cmVQb3NpdGlvbnM7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlTGF5ZXJzKFxuICB0YXJnZXQ6IE1hcExheWVyW10sXG4gIHNvdXJjZTogTWFwTGF5ZXJbXSxcbiAgc291cmNlTWV0YWRhdGE/OiBMcnNNZXRhZGF0YSxcbiAgc29ydCA9IHRydWUsXG4gIG9uTWVyZ2VDb21wbGV0ZTogKHRhcmdldDogTWFwTGF5ZXIsIHNvdXJjZTogTWFwTGF5ZXIpID0+IGFueSA9IG51bGxcbikge1xuICB0YXJnZXQgPSB0YXJnZXQgfHwgW107XG4gIHNvdXJjZSA9IHNvdXJjZSB8fCBbXTtcblxuICB0YXJnZXQuZm9yRWFjaCgodGFyZ2V0TGF5ZXI6IE1hcExheWVyKSA9PiB7XG4gICAgc2V0TGF5ZXJEZWZhdWx0cyh0YXJnZXRMYXllcik7XG4gICAgbWVyZ2VMYXllcih0YXJnZXRMYXllciwgc291cmNlLmZpbmQoc291cmNlTGF5ZXIgPT4gc291cmNlTGF5ZXIuaWQgPT09IHRhcmdldExheWVyLmlkKSk7XG4gIH0pO1xuXG4gIC8vIFRoZXJlIHdpbGwgYmUgb2NjdXJlbmNlcyB3aGVyZSB0aGUgc291cmNlIGhhcyBsYXllcnMgdGhhdCB0aGUgdGFyZ2V0IGRvZXNuJ3QsIHdoaWNoXG4gIC8vIG1lYW5zIHRoYXQgdGhlIG1lcmdlIHdpbGwgbm90IGhhcHBlbiBhYm92ZSwgYmVjYXVzZSB0aGUgdGFyZ2V0IGlzIHRoZSBvbmUgYmVpbmcgbG9vcGVkLlxuICBzb3VyY2VcbiAgICAuZmlsdGVyKHNyYyA9PiAhdGFyZ2V0LmZpbmQoeCA9PiBzcmMuaWQgPT09IHguaWQpKVxuICAgIC5mb3JFYWNoKG1pc3NpbmcgPT4ge1xuICAgICAgbGV0IG5ld0xheWVyOiBNYXBMYXllciA9IG1pc3Npbmc7XG4gICAgICBpZiAoc291cmNlTWV0YWRhdGEpIHtcbiAgICAgICAgY29uc3QgbWVyZ2VyOiBNYXBMYXllciA9IGZpbmQobWlzc2luZy5pZCwgc291cmNlTWV0YWRhdGEudGFibGVzLCBzb3VyY2VNZXRhZGF0YS5sYXllcnMsIHNvdXJjZU1ldGFkYXRhLm5vbkxSU0xheWVycyk7XG5cbiAgICAgICAgLy8gV2Ugd2FudCB0byBwcmVzZXZlIHRoZSBvcmlnaW5hbCB0YWJsZSBvciBsYXllciwgc28gd2UgZG9uJ3Qgb3ZlcndyaXRlIGl0IGhlcmUuXG4gICAgICAgIG5ld0xheWVyID0gT2JqZWN0LmFzc2lnbih7fSwgbWVyZ2VyKTtcbiAgICAgICAgbWVyZ2VMYXllcihuZXdMYXllciwgbWlzc2luZyk7XG4gICAgICB9XG5cbiAgICAgIHNldExheWVyRGVmYXVsdHMobmV3TGF5ZXIpO1xuICAgICAgdGFyZ2V0LnB1c2gobmV3TGF5ZXIpO1xuICAgIH0pO1xuXG4gIGlmIChzb3J0KSB7XG4gICAgdGFyZ2V0LnNvcnQoKGxheWVyMSwgbGF5ZXIyKSA9PiBsYXllcjEub3JkZXIgLSBsYXllcjIub3JkZXIpO1xuICB9XG5cbiAgaWYgKG9uTWVyZ2VDb21wbGV0ZSkge1xuICAgIHRhcmdldC5mb3JFYWNoKCh0YXJnZXRMYXllcjogTWFwTGF5ZXIpID0+IHtcbiAgICAgIG9uTWVyZ2VDb21wbGV0ZSh0YXJnZXRMYXllciwgc291cmNlLmZpbmQoc291cmNlTGF5ZXIgPT4gc291cmNlTGF5ZXIuaWQgPT09IHRhcmdldExheWVyLmlkKSk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1lcmdlTmV0d29ya0xheWVycyh0YXJnZXQ6IE5ldHdvcmtMYXllcltdLCBzb3VyY2U6IE5ldHdvcmtMYXllcltdLCBzb3VyY2VNZXRhZGF0YT86IExyc01ldGFkYXRhKSB7XG4gIGNvbnN0IGlzU29ydGVkID0gdHJ1ZTtcbiAgbWVyZ2VMYXllcnModGFyZ2V0LCBzb3VyY2UsIHNvdXJjZU1ldGFkYXRhLCBpc1NvcnRlZCwgb25NZXJnZU5ldHdvcmtMYXllckNvbXBsZXRlKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG9uTWVyZ2VOZXR3b3JrTGF5ZXJDb21wbGV0ZSh0YXJnZXRMYXllcjogTmV0d29ya0xheWVyLCBzb3VyY2VMYXllcjogTmV0d29ya0xheWVyKTogdm9pZCB7XG4gIHNldE5ldHdvcmtMYXllckRlZmF1bHRzKHRhcmdldExheWVyKTtcbiAgc2V0TmV0d29ya0xheWVyRGVmYXVsdHMoc291cmNlTGF5ZXIpO1xuXG4gIGlmICh0YXJnZXRMYXllciAmJiBzb3VyY2VMYXllcikge1xuICAgIG1lcmdlRGVlcEFycmF5KHRhcmdldExheWVyLmhpZXJhcmNoeUZpbHRlciwgc291cmNlTGF5ZXIuaGllcmFyY2h5RmlsdGVyLCB7IGlkZW50aWZpZXI6ICduYW1lJyB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VMcnNNZXRhZGF0YSh0YXJnZXQ6IExyc01ldGFkYXRhLCAuLi5zb3VyY2U6IExyc01ldGFkYXRhW10pOiB2b2lkIHtcbiAgc291cmNlLmZvckVhY2goc3JjTWV0YSA9PiB7XG4gICAgY29uc3QgZGF0YVNvdXJjZSA9IHNyY01ldGEuZGF0YVNvdXJjZSB8fCB0YXJnZXQuZGF0YVNvdXJjZTtcbiAgICBtZXJnZURlZXAodGFyZ2V0LCBzcmNNZXRhLCB7IGlnbm9yZUFycmF5czogdHJ1ZSB9KTtcblxuICAgIGlmIChkYXRhU291cmNlKSB7XG4gICAgICB0YXJnZXQuZGF0YVNvdXJjZSA9IGRhdGFTb3VyY2U7XG4gICAgfVxuXG4gICAgbWVyZ2VOZXR3b3JrTGF5ZXJzKHRhcmdldC5uZXR3b3JrTGF5ZXJzLCBzcmNNZXRhLm5ldHdvcmtMYXllcnMsIHRhcmdldCk7XG4gICAgbWVyZ2VMYXllcnModGFyZ2V0LmV2ZW50TGF5ZXJzLCBzcmNNZXRhLmV2ZW50TGF5ZXJzLCB0YXJnZXQpO1xuICAgIG1lcmdlTGF5ZXJzKHRhcmdldC5jYWxpYnJhdGlvblBvaW50TGF5ZXJzLCBzcmNNZXRhLmNhbGlicmF0aW9uUG9pbnRMYXllcnMsIHRhcmdldCk7XG4gICAgbWVyZ2VMYXllcnModGFyZ2V0LmludGVyc2VjdGlvbkxheWVycywgc3JjTWV0YS5pbnRlcnNlY3Rpb25MYXllcnMsIHRhcmdldCk7XG4gICAgbWVyZ2VMYXllcnModGFyZ2V0LmNlbnRlcmxpbmVMYXllcnMsIHNyY01ldGEuY2VudGVybGluZUxheWVycywgdGFyZ2V0KTtcbiAgICBtZXJnZUxheWVycyh0YXJnZXQucmVkbGluZUxheWVycywgc3JjTWV0YS5yZWRsaW5lTGF5ZXJzLCB0YXJnZXQpO1xuICAgIG1lcmdlTGF5ZXJzKHRhcmdldC5ub25MUlNMYXllcnMsIHNyY01ldGEubm9uTFJTTGF5ZXJzLCB0YXJnZXQpO1xuICAgIG1lcmdlTGF5ZXJzKHRhcmdldC5sYXllcnMsIHNyY01ldGEubGF5ZXJzKTtcbiAgICBtZXJnZUxheWVycyh0YXJnZXQudGFibGVzLCBzcmNNZXRhLnRhYmxlcyk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VNYXBNZXRhZGF0YSh0YXJnZXQ6IExyc01ldGFkYXRhLCAuLi5zb3VyY2U6IE1hcFNlcnZlck1ldGFkYXRhW10pOiB2b2lkIHtcbiAgc291cmNlLmZvckVhY2gobWV0YSA9PiB7XG4gICAgT2JqZWN0LmFzc2lnbih0YXJnZXQsIG1ldGEpO1xuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlZXBNZXJnZU1hcE1ldGFkYXRhKHRhcmdldDogTHJzTWV0YWRhdGEsIC4uLnNvdXJjZTogTWFwU2VydmVyTWV0YWRhdGFbXSk6IHZvaWQge1xuICBzb3VyY2UuZm9yRWFjaChtZXRhID0+IHtcbiAgICBtZXRhLmxheWVycy5mb3JFYWNoKG5vbkxyc0xheWVySW5mbyA9PiB7XG4gICAgICBjb25zdCB0YXJnZXRMYXllciA9IHRhcmdldC5nZXRMcnNMYXllcihub25McnNMYXllckluZm8uaWQpO1xuICAgICAgaWYgKHRhcmdldExheWVyKSB7XG4gICAgICAgIGNvbnN0IGJhc2VGaWVsZHMgPSBbLi4ubm9uTHJzTGF5ZXJJbmZvLmZpZWxkc107XG4gICAgICAgIG1lcmdlRmllbGRzKGJhc2VGaWVsZHMsIHRhcmdldExheWVyLmZpZWxkcyk7XG4gICAgICAgIHRhcmdldExheWVyLmZpZWxkcyA9IGJhc2VGaWVsZHM7XG4gICAgICAgIGlmIChub25McnNMYXllckluZm8uZ2VvbWV0cnlUeXBlKSB7XG4gICAgICAgICAgdGFyZ2V0TGF5ZXIuZ2VvbWV0cnlUeXBlID0gbm9uTHJzTGF5ZXJJbmZvLmdlb21ldHJ5VHlwZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRhcmdldExheWVyLmRyYXdpbmdJbmZvID0gbmV3IExheWVyRHJhd2luZ0luZm8obm9uTHJzTGF5ZXJJbmZvLmRyYXdpbmdJbmZvLCB0YXJnZXRMYXllci5kcmF3aW5nSW5mbyk7XG4gICAgICB9XG4gICAgfSk7XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbWVyZ2VMcnNNZXRhZGF0YVNvdXJjZXMoXG4gIGRhdGFTb3VyY2U6IERhdGFTb3VyY2UsXG4gIGRhdGFTb3VyY2VMcnNNZXRhZGF0YTogTHJzTWV0YWRhdGEsXG4gIG1hcFNlcnZlckxyc01ldGFkYXRhOiBMcnNNZXRhZGF0YSxcbiAgbWFwU2VydmVyTWV0YWRhdGE6IE1hcFNlcnZlck1ldGFkYXRhXG4pOiBMcnNNZXRhZGF0YSB7XG4gIGNvbnN0IGhhc01hcFNlcnZlckxyc01ldGFkYXRhID0gQm9vbGVhbihtYXBTZXJ2ZXJMcnNNZXRhZGF0YSk7XG4gIGNvbnN0IGZ1bGxMcnNNZXRhID0gbWFwU2VydmVyTHJzTWV0YWRhdGFcbiAgICB8fCBkYXRhU291cmNlTHJzTWV0YWRhdGFcbiAgICB8fCBuZXcgTHJzTWV0YWRhdGEoZGF0YVNvdXJjZSk7XG5cbiAgZnVsbExyc01ldGEubWVyZ2VNYXBNZXRhZGF0YShtYXBTZXJ2ZXJNZXRhZGF0YSk7XG4gIGZ1bGxMcnNNZXRhLmRhdGFTb3VyY2UgPSBmdWxsTHJzTWV0YS5kYXRhU291cmNlIHx8IGRhdGFTb3VyY2U7XG4gIGZ1bGxMcnNNZXRhLmRhdGFTb3VyY2VJZCA9IGZ1bGxMcnNNZXRhLmRhdGFTb3VyY2VJZCB8fCBkYXRhU291cmNlLmlkO1xuXG4gIGlmIChoYXNNYXBTZXJ2ZXJMcnNNZXRhZGF0YSkge1xuICAgIC8vIElmIHRoZSBtYXAgc2VydmljZSBoYXMgTFJTIG1ldGFkYXRhIHRoZW4gd2UgbmVlZCB0byBtZXJnZSB0aGVcbiAgICAvLyBkYXRhIHNvdXJjZSBMUlMgbWV0YWRhdGEgaW50byB0aGUgbWFwIHNlcnZpY2UgbHJzIG1ldGFkYXRhXG4gICAgLy8gYmVjYXVzZSB3ZSB3YW50IHRoZSBkYXRhIHNvdXJjZSBtZXRhZGF0YSB0byBiZSBwcmlvcml0eS5cbiAgICBmdWxsTHJzTWV0YS5tZXJnZUxyc01ldGFkYXRhKGRhdGFTb3VyY2VMcnNNZXRhZGF0YSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gV2Ugb25seSBuZWVkIHRvIGRvIGEgZGVwIG1lcmdlIHdoZW4gdGhlcmUgaXMgbm8gTFJTIG1ldGFkYXRhIGF2YWlsYWJsZSBpbiB0aGUgbWFwIHNlcnZpY2UgYmVjYXVzZVxuICAgIC8vIHRoZSBtYXAgc2VydmljZSBMUlMgbWV0YWRhdGEgcHJvdmlkZXMgYWxsIG9mIHRoZSBzYW1lIGluZm9ybWF0aW9uIGFzIHRoZSBtYXAgc2VydmVyIG1ldGFkYXRhIChsaWtlIGZpZWxkcykuXG4gICAgZnVsbExyc01ldGEuZGVlcE1lcmdlTWFwTWV0YWRhdGEobWFwU2VydmVyTWV0YWRhdGEpO1xuICB9XG5cbiAgZnVsbExyc01ldGEucmVidWlsZExheWVycygpO1xuXG4gIHJldHVybiBmdWxsTHJzTWV0YTtcbn1cbiJdfQ==