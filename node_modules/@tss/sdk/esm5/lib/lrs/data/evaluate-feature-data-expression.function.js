/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { isDynamicDataExpression, DYNAMIC_DATA_REGEX } from './is-dynamic-data-expression.function';
import { extractFeatureDataByLayer } from './extract-feature-data.function';
import { isNumber } from 'util';
import { sumValues } from '../../core/stats/sum-values.function';
import { average } from '../../core/stats/average.function';
import { isObject } from '../../core/type-check/is-object.function';
import { extractTokenExpressions } from '../../core/tokens/extract-token-expressions.function';
import { replaceToken } from '../../core/tokens/replace-token.function';
import { format } from '../../core/formatting/format.function';
/**
 * @param {?} dataValues
 * @return {?}
 */
function dataValuesToNumbers(dataValues) {
    return dataValues
        .filter((/**
     * @param {?} value
     * @return {?}
     */
    function (value) { return isNumber(value); }))
        .map((/**
     * @param {?} value
     * @return {?}
     */
    function (value) { return Number(value); }));
}
/**
 * @param {?} expression
 * @param {...?} features
 * @return {?}
 */
function evaluateSingleDynamicDataExpression(expression) {
    var features = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        features[_i - 1] = arguments[_i];
    }
    /** @type {?} */
    var parsedValue = expression.match(DYNAMIC_DATA_REGEX);
    /** @type {?} */
    var expressionValue;
    if (parsedValue && parsedValue.length > 2) {
        /** @type {?} */
        var layerId = Number(parsedValue[1]);
        /** @type {?} */
        var field = parsedValue[2];
        /** @type {?} */
        var subsetKeyword = (/** @type {?} */ ((parsedValue[3] || 'first').toLocaleLowerCase()));
        /** @type {?} */
        var dataValues = extractFeatureDataByLayer.apply(void 0, tslib_1.__spread([layerId, field], features));
        if (subsetKeyword === 'first') {
            expressionValue = dataValues[0];
        }
        else if (subsetKeyword === 'last') {
            expressionValue = dataValues[dataValues.length - 1];
        }
        else if (subsetKeyword === 'sum' || subsetKeyword === 'add') {
            /** @type {?} */
            var numberValues = dataValuesToNumbers(dataValues);
            expressionValue = sumValues(numberValues);
        }
        else if (subsetKeyword === 'avg' || subsetKeyword === 'average') {
            /** @type {?} */
            var numberValues = dataValuesToNumbers(dataValues);
            expressionValue = average(numberValues);
        }
        else if (subsetKeyword === 'concat') {
            expressionValue = dataValues.join(', ');
        }
        else if (subsetKeyword === 'min') {
            /** @type {?} */
            var numberValues = dataValuesToNumbers(dataValues);
            expressionValue = Math.min.apply(Math, tslib_1.__spread(numberValues));
        }
        else if (subsetKeyword === 'max') {
            /** @type {?} */
            var numberValues = dataValuesToNumbers(dataValues);
            expressionValue = Math.max.apply(Math, tslib_1.__spread(numberValues));
        }
        else {
            throw new Error("Unsupported dynamic data expression subset keyword '" + subsetKeyword + "'");
        }
        return isObject(expressionValue)
            ? JSON.stringify(expressionValue)
            : String(expressionValue);
    }
}
/**
 * @param {?} expression
 * @param {...?} features
 * @return {?}
 */
function evaluateDynamicDataExpression(expression) {
    var features = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        features[_i - 1] = arguments[_i];
    }
    /** @type {?} */
    var tokenExpressions = extractTokenExpressions(expression);
    /** @type {?} */
    var evaluationResult = expression;
    tokenExpressions
        .filter((/**
     * @param {?} tokenExpression
     * @return {?}
     */
    function (tokenExpression) { return isDynamicDataExpression(tokenExpression); }))
        .forEach((/**
     * @param {?} tokenExpression
     * @return {?}
     */
    function (tokenExpression) {
        /** @type {?} */
        var value = evaluateSingleDynamicDataExpression.apply(void 0, tslib_1.__spread([tokenExpression], features));
        evaluationResult = replaceToken(evaluationResult, tokenExpression, value);
    }));
    return evaluationResult;
}
/**
 * @param {?} expression
 * @param {...?} features
 * @return {?}
 */
export function evaluteFeatureDataExpression(expression) {
    var features = [];
    for (var _i = 1; _i < arguments.length; _i++) {
        features[_i - 1] = arguments[_i];
    }
    /** @type {?} */
    var evaluationResult = evaluateDynamicDataExpression.apply(void 0, tslib_1.__spread([expression], features));
    /** @type {?} */
    var firstFeatureProperties = features && features.length
        ? features[0].properties
        : {};
    /** @type {?} */
    var replaceTokens = Object.assign({}, firstFeatureProperties, {
        RecordCount: features.length,
    });
    return format(evaluationResult, replaceTokens);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZhbHVhdGUtZmVhdHVyZS1kYXRhLWV4cHJlc3Npb24uZnVuY3Rpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9scnMvZGF0YS9ldmFsdWF0ZS1mZWF0dXJlLWRhdGEtZXhwcmVzc2lvbi5mdW5jdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQ3BHLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFaEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUM1RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDcEUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0RBQXNELENBQUM7QUFDL0YsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7Ozs7QUFJL0QsU0FBUyxtQkFBbUIsQ0FBQyxVQUFpQjtJQUM1QyxPQUFPLFVBQVU7U0FDZCxNQUFNOzs7O0lBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQWYsQ0FBZSxFQUFDO1NBQ2hDLEdBQUc7Ozs7SUFBQyxVQUFBLEtBQUssSUFBSSxPQUFBLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBYixDQUFhLEVBQUMsQ0FBQztBQUNqQyxDQUFDOzs7Ozs7QUFFRCxTQUFTLG1DQUFtQyxDQUFDLFVBQWtCO0lBQUUsa0JBQXlCO1NBQXpCLFVBQXlCLEVBQXpCLHFCQUF5QixFQUF6QixJQUF5QjtRQUF6Qixp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QztBQUMxQixDQUFDOzs7Ozs7QUFFRCxNQUFNLFVBQVUsNEJBQTRCLENBQUMsVUFBa0I7SUFBRSxrQkFBeUI7U0FBekIsVUFBeUIsRUFBekIscUJBQXlCLEVBQXpCLElBQXlCO1FBQXpCLGlDQUF5Qjs7O1FBQ2xGLGdCQUFnQixHQUFHLDZCQUE2QixpQ0FBQyxVQUFVLEdBQUssUUFBUSxFQUFDOztRQUN6RSxzQkFBc0IsR0FBRyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU07UUFDeEQsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVO1FBQ3hCLENBQUMsQ0FBQyxFQUFFOztRQUVBLGFBQWEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxzQkFBc0IsRUFBRTtRQUM5RCxXQUFXLEVBQUUsUUFBUSxDQUFDLE1BQU07S0FDN0IsQ0FBQztJQUVGLE9BQU8sTUFBTSxDQUFDLGdCQUFnQixFQUFFLGFBQWEsQ0FBQyxDQUFDO0FBQ2pELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0R5bmFtaWNEYXRhRXhwcmVzc2lvbiwgRFlOQU1JQ19EQVRBX1JFR0VYIH0gZnJvbSAnLi9pcy1keW5hbWljLWRhdGEtZXhwcmVzc2lvbi5mdW5jdGlvbic7XG5pbXBvcnQgeyBleHRyYWN0RmVhdHVyZURhdGFCeUxheWVyIH0gZnJvbSAnLi9leHRyYWN0LWZlYXR1cmUtZGF0YS5mdW5jdGlvbic7XG5pbXBvcnQgeyBpc051bWJlciB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IHsgTWFwRmVhdHVyZSB9IGZyb20gJy4uLy4uL21hcHMvbWFwLWZlYXR1cmUnO1xuaW1wb3J0IHsgc3VtVmFsdWVzIH0gZnJvbSAnLi4vLi4vY29yZS9zdGF0cy9zdW0tdmFsdWVzLmZ1bmN0aW9uJztcbmltcG9ydCB7IGF2ZXJhZ2UgfSBmcm9tICcuLi8uLi9jb3JlL3N0YXRzL2F2ZXJhZ2UuZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNPYmplY3QgfSBmcm9tICcuLi8uLi9jb3JlL3R5cGUtY2hlY2svaXMtb2JqZWN0LmZ1bmN0aW9uJztcbmltcG9ydCB7IGV4dHJhY3RUb2tlbkV4cHJlc3Npb25zIH0gZnJvbSAnLi4vLi4vY29yZS90b2tlbnMvZXh0cmFjdC10b2tlbi1leHByZXNzaW9ucy5mdW5jdGlvbic7XG5pbXBvcnQgeyByZXBsYWNlVG9rZW4gfSBmcm9tICcuLi8uLi9jb3JlL3Rva2Vucy9yZXBsYWNlLXRva2VuLmZ1bmN0aW9uJztcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJy4uLy4uL2NvcmUvZm9ybWF0dGluZy9mb3JtYXQuZnVuY3Rpb24nO1xuXG5leHBvcnQgdHlwZSBEeW5hbWljRGF0YVN1YnNldEtleXdvcmQgPSAnZmlyc3QnIHwgJ2xhc3QnIHwgJ3N1bScgfCAnYWRkJyB8ICdhdmcnIHwgJ2F2ZXJhZ2UnIHwgJ2NvbmNhdCc7XG5cbmZ1bmN0aW9uIGRhdGFWYWx1ZXNUb051bWJlcnMoZGF0YVZhbHVlczogYW55W10pOiBudW1iZXJbXSB7XG4gIHJldHVybiBkYXRhVmFsdWVzXG4gICAgLmZpbHRlcih2YWx1ZSA9PiBpc051bWJlcih2YWx1ZSkpXG4gICAgLm1hcCh2YWx1ZSA9PiBOdW1iZXIodmFsdWUpKTtcbn1cblxuZnVuY3Rpb24gZXZhbHVhdGVTaW5nbGVEeW5hbWljRGF0YUV4cHJlc3Npb24oZXhwcmVzc2lvbjogc3RyaW5nLCAuLi5mZWF0dXJlczogTWFwRmVhdHVyZVtdKTogc3RyaW5nIHwgJycge1xuICBjb25zdCBwYXJzZWRWYWx1ZSA9IGV4cHJlc3Npb24ubWF0Y2goRFlOQU1JQ19EQVRBX1JFR0VYKTtcbiAgbGV0IGV4cHJlc3Npb25WYWx1ZToge307XG5cbiAgaWYgKHBhcnNlZFZhbHVlICYmIHBhcnNlZFZhbHVlLmxlbmd0aCA+IDIpIHtcbiAgICBjb25zdCBsYXllcklkID0gTnVtYmVyKHBhcnNlZFZhbHVlWzFdKTtcbiAgICBjb25zdCBmaWVsZCA9IHBhcnNlZFZhbHVlWzJdO1xuICAgIGNvbnN0IHN1YnNldEtleXdvcmQ6IER5bmFtaWNEYXRhU3Vic2V0S2V5d29yZCA9IChwYXJzZWRWYWx1ZVszXSB8fCAnZmlyc3QnKS50b0xvY2FsZUxvd2VyQ2FzZSgpIGFzIER5bmFtaWNEYXRhU3Vic2V0S2V5d29yZDtcbiAgICBjb25zdCBkYXRhVmFsdWVzID0gZXh0cmFjdEZlYXR1cmVEYXRhQnlMYXllcihsYXllcklkLCBmaWVsZCwgLi4uZmVhdHVyZXMpO1xuXG4gICAgaWYgKHN1YnNldEtleXdvcmQgPT09ICdmaXJzdCcpIHtcbiAgICAgIGV4cHJlc3Npb25WYWx1ZSA9IGRhdGFWYWx1ZXNbMF07XG4gICAgfSBlbHNlIGlmIChzdWJzZXRLZXl3b3JkID09PSAnbGFzdCcpIHtcbiAgICAgIGV4cHJlc3Npb25WYWx1ZSA9IGRhdGFWYWx1ZXNbZGF0YVZhbHVlcy5sZW5ndGggLSAxXTtcbiAgICB9IGVsc2UgaWYgKHN1YnNldEtleXdvcmQgPT09ICdzdW0nIHx8IHN1YnNldEtleXdvcmQgPT09ICdhZGQnKSB7XG4gICAgICBjb25zdCBudW1iZXJWYWx1ZXMgPSBkYXRhVmFsdWVzVG9OdW1iZXJzKGRhdGFWYWx1ZXMpO1xuICAgICAgZXhwcmVzc2lvblZhbHVlID0gc3VtVmFsdWVzKG51bWJlclZhbHVlcyk7XG4gICAgfSBlbHNlIGlmIChzdWJzZXRLZXl3b3JkID09PSAnYXZnJyB8fCBzdWJzZXRLZXl3b3JkID09PSAnYXZlcmFnZScpIHtcbiAgICAgIGNvbnN0IG51bWJlclZhbHVlcyA9IGRhdGFWYWx1ZXNUb051bWJlcnMoZGF0YVZhbHVlcyk7XG4gICAgICBleHByZXNzaW9uVmFsdWUgPSBhdmVyYWdlKG51bWJlclZhbHVlcyk7XG4gICAgfSBlbHNlIGlmIChzdWJzZXRLZXl3b3JkID09PSAnY29uY2F0Jykge1xuICAgICAgZXhwcmVzc2lvblZhbHVlID0gZGF0YVZhbHVlcy5qb2luKCcsICcpO1xuICAgIH0gZWxzZSBpZiAoc3Vic2V0S2V5d29yZCA9PT0gJ21pbicpIHtcbiAgICAgIGNvbnN0IG51bWJlclZhbHVlcyA9IGRhdGFWYWx1ZXNUb051bWJlcnMoZGF0YVZhbHVlcyk7XG4gICAgICBleHByZXNzaW9uVmFsdWUgPSBNYXRoLm1pbiguLi5udW1iZXJWYWx1ZXMpO1xuICAgIH0gZWxzZSBpZiAoc3Vic2V0S2V5d29yZCA9PT0gJ21heCcpIHtcbiAgICAgIGNvbnN0IG51bWJlclZhbHVlcyA9IGRhdGFWYWx1ZXNUb051bWJlcnMoZGF0YVZhbHVlcyk7XG4gICAgICBleHByZXNzaW9uVmFsdWUgPSBNYXRoLm1heCguLi5udW1iZXJWYWx1ZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIGR5bmFtaWMgZGF0YSBleHByZXNzaW9uIHN1YnNldCBrZXl3b3JkICcke3N1YnNldEtleXdvcmR9J2ApO1xuICAgIH1cblxuICAgIHJldHVybiBpc09iamVjdChleHByZXNzaW9uVmFsdWUpXG4gICAgICA/IEpTT04uc3RyaW5naWZ5KGV4cHJlc3Npb25WYWx1ZSlcbiAgICAgIDogU3RyaW5nKGV4cHJlc3Npb25WYWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZXZhbHVhdGVEeW5hbWljRGF0YUV4cHJlc3Npb24oZXhwcmVzc2lvbjogc3RyaW5nLCAuLi5mZWF0dXJlczogTWFwRmVhdHVyZVtdKTogc3RyaW5nIHwgJycge1xuICBjb25zdCB0b2tlbkV4cHJlc3Npb25zID0gZXh0cmFjdFRva2VuRXhwcmVzc2lvbnMoZXhwcmVzc2lvbik7XG4gIGxldCBldmFsdWF0aW9uUmVzdWx0ID0gZXhwcmVzc2lvbjtcblxuICB0b2tlbkV4cHJlc3Npb25zXG4gICAgLmZpbHRlcih0b2tlbkV4cHJlc3Npb24gPT4gaXNEeW5hbWljRGF0YUV4cHJlc3Npb24odG9rZW5FeHByZXNzaW9uKSlcbiAgICAuZm9yRWFjaCh0b2tlbkV4cHJlc3Npb24gPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBldmFsdWF0ZVNpbmdsZUR5bmFtaWNEYXRhRXhwcmVzc2lvbih0b2tlbkV4cHJlc3Npb24sIC4uLmZlYXR1cmVzKTtcbiAgICAgIGV2YWx1YXRpb25SZXN1bHQgPSByZXBsYWNlVG9rZW4oZXZhbHVhdGlvblJlc3VsdCwgdG9rZW5FeHByZXNzaW9uLCB2YWx1ZSk7XG4gICAgfSk7XG5cbiAgcmV0dXJuIGV2YWx1YXRpb25SZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBldmFsdXRlRmVhdHVyZURhdGFFeHByZXNzaW9uKGV4cHJlc3Npb246IHN0cmluZywgLi4uZmVhdHVyZXM6IE1hcEZlYXR1cmVbXSk6IHN0cmluZyB7XG4gIGNvbnN0IGV2YWx1YXRpb25SZXN1bHQgPSBldmFsdWF0ZUR5bmFtaWNEYXRhRXhwcmVzc2lvbihleHByZXNzaW9uLCAuLi5mZWF0dXJlcyk7XG4gIGNvbnN0IGZpcnN0RmVhdHVyZVByb3BlcnRpZXMgPSBmZWF0dXJlcyAmJiBmZWF0dXJlcy5sZW5ndGhcbiAgICA/IGZlYXR1cmVzWzBdLnByb3BlcnRpZXNcbiAgICA6IHt9O1xuXG4gIGNvbnN0IHJlcGxhY2VUb2tlbnMgPSBPYmplY3QuYXNzaWduKHt9LCBmaXJzdEZlYXR1cmVQcm9wZXJ0aWVzLCB7XG4gICAgUmVjb3JkQ291bnQ6IGZlYXR1cmVzLmxlbmd0aCxcbiAgfSk7XG5cbiAgcmV0dXJuIGZvcm1hdChldmFsdWF0aW9uUmVzdWx0LCByZXBsYWNlVG9rZW5zKTtcbn1cbiJdfQ==