/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { WhereClauseBuilder, CriteriaOperator } from '../maps/where-clause-builder';
import { toUtcDate } from '../core/date-time/conversion/to-utc-date.function';
import { setDateToBeginningOfDay } from '../core/date-time/set-date-to-beginning-of-date.function';
import { getDateFormatForProvider } from '../data-source/get-date-format-for-provider.function';
import { format } from '../core/formatting/format.function';
import { formatDateForQuery } from '../core/date-time/format/format-date-for-query.function';
/** @type {?} */
export var NO_TEMPORAL_LAYER_SUPPLIED_ERROR_MSG = 'No LRS temporal layers supplied';
/** @type {?} */
export var NO_REFERENCE_LAYER_SUPPLIED_ERROR_MSG = 'No LRS reference layer supplied';
/** @type {?} */
export var LRS_DATE_WHERE_CLAUSE_TEMPLATE = '(({fromDateFieldName} IS NULL OR {fromDateFieldName} <= {dateEndOfDay})'
    + ' AND ({toDateFieldName} IS NULL OR {toDateFieldName} > {date}))';
/** @type {?} */
export var LRS_POINT_EVENT_WHERE_CLAUSE_TEMPLATE = "({fromMeasureFieldName} between {fromMeasure} and {toMeasure})";
/** @type {?} */
export var LRS_LINEAR_EVENT_WHERE_CLAUSE_TEMPLATE = "(({fromMeasureFieldName} between {fromMeasure} AND {toMeasure})"
    + " OR ({toMeasureFieldName} between {fromMeasure} AND {toMeasure}) OR ({fromMeasureFieldName} < {fromMeasure}"
    + " AND {toMeasureFieldName} > {toMeasure})) AND NOT (({fromMeasureFieldName} < {fromMeasure}"
    + " AND {toMeasureFieldName} <= {fromMeasure}) OR ({toMeasureFieldName} > {toMeasure} AND {fromMeasureFieldName} >= {toMeasure}))";
/**
 * @param {?} fromDateFieldName
 * @param {?} toDateFieldName
 * @param {?=} dbType
 * @param {?=} viewDate
 * @return {?}
 */
export function getLrsViewDateWhereStatement(fromDateFieldName, toDateFieldName, dbType, viewDate) {
    viewDate = toUtcDate(viewDate || new Date());
    setDateToBeginningOfDay(viewDate);
    // TODO: Look into whether we need to actually use end of day or not
    // Currently we are just setting it to same as 'date' - RG.
    /** @type {?} */
    var dateFormat = getDateFormatForProvider(dbType);
    return format(LRS_DATE_WHERE_CLAUSE_TEMPLATE, {
        fromDateFieldName: fromDateFieldName,
        toDateFieldName: toDateFieldName,
        date: formatDateForQuery(viewDate, dateFormat),
        dateEndOfDay: formatDateForQuery(viewDate, dateFormat),
    });
}
var LrsWhereClauseBuilder = /** @class */ (function (_super) {
    tslib_1.__extends(LrsWhereClauseBuilder, _super);
    function LrsWhereClauseBuilder(options) {
        return _super.call(this, options) || this;
    }
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceData
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withDataSource = /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceData
     * @return {THIS}
     */
    function (sourceData) {
        return (/** @type {?} */ (this)).withDataProvider(sourceData.providerName);
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceDbType
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withDataProvider = /**
     * @template THIS
     * @this {THIS}
     * @param {?} sourceDbType
     * @return {THIS}
     */
    function (sourceDbType) {
        (/** @type {?} */ (this)).sourceDbType = sourceDbType;
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} eventLayer
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withEventLayer = /**
     * @template THIS
     * @this {THIS}
     * @param {?} eventLayer
     * @return {THIS}
     */
    function (eventLayer) {
        return (/** @type {?} */ (this)).withTemporalLayer(eventLayer)
            .withReferenceLayer(eventLayer);
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} referenceLayer
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withReferenceLayer = /**
     * @template THIS
     * @this {THIS}
     * @param {?} referenceLayer
     * @return {THIS}
     */
    function (referenceLayer) {
        (/** @type {?} */ (this)).referenceLayer = referenceLayer;
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} networkLayer
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withNetworkLayer = /**
     * @template THIS
     * @this {THIS}
     * @param {?} networkLayer
     * @return {THIS}
     */
    function (networkLayer) {
        return (/** @type {?} */ (this)).withTemporalLayer(networkLayer);
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} temporalLayer
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withTemporalLayer = /**
     * @template THIS
     * @this {THIS}
     * @param {?} temporalLayer
     * @return {THIS}
     */
    function (temporalLayer) {
        (/** @type {?} */ (this)).temporalLayer = temporalLayer;
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} routeId
     * @param {?=} routeIdFieldName
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withRouteId = /**
     * @template THIS
     * @this {THIS}
     * @param {?} routeId
     * @param {?=} routeIdFieldName
     * @return {THIS}
     */
    function (routeId, routeIdFieldName) {
        return (/** @type {?} */ (this)).where(routeIdFieldName || (/** @type {?} */ (this)).referenceLayer.routeIdFieldName, CriteriaOperator.Equals, routeId);
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?=} viewDate
     * @param {?=} fromDateFieldName
     * @param {?=} toDateFieldName
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.withViewDate = /**
     * @template THIS
     * @this {THIS}
     * @param {?=} viewDate
     * @param {?=} fromDateFieldName
     * @param {?=} toDateFieldName
     * @return {THIS}
     */
    function (viewDate, fromDateFieldName, toDateFieldName) {
        if ((/** @type {?} */ (this)).temporalLayer) {
            fromDateFieldName = fromDateFieldName || (/** @type {?} */ (this)).temporalLayer.fromDateFieldName;
            toDateFieldName = toDateFieldName || (/** @type {?} */ (this)).temporalLayer.toDateFieldName;
        }
        /** @type {?} */
        var hasDateFieldInfo = Boolean((/** @type {?} */ (this)).temporalLayer || fromDateFieldName && toDateFieldName);
        if (!hasDateFieldInfo) {
            throw new Error(NO_TEMPORAL_LAYER_SUPPLIED_ERROR_MSG);
        }
        if (fromDateFieldName && toDateFieldName) {
            /** @type {?} */
            var dateClause = getLrsViewDateWhereStatement((/** @type {?} */ (this)).formatField(fromDateFieldName), (/** @type {?} */ (this)).formatField(toDateFieldName), (/** @type {?} */ (this)).sourceDbType, viewDate);
            (/** @type {?} */ (this)).add(dateClause);
        }
        return (/** @type {?} */ (this));
    };
    /**
     * @template THIS
     * @this {THIS}
     * @param {?} fromMeasure
     * @param {?} toMeasure
     * @param {?=} fromMeasureFieldName
     * @param {?=} toMeasureFieldName
     * @return {THIS}
     */
    LrsWhereClauseBuilder.prototype.betweenMeasures = /**
     * @template THIS
     * @this {THIS}
     * @param {?} fromMeasure
     * @param {?} toMeasure
     * @param {?=} fromMeasureFieldName
     * @param {?=} toMeasureFieldName
     * @return {THIS}
     */
    function (fromMeasure, toMeasure, fromMeasureFieldName, toMeasureFieldName) {
        if ((/** @type {?} */ (this)).referenceLayer) {
            fromMeasureFieldName = fromMeasureFieldName || (/** @type {?} */ (this)).referenceLayer.fromMeasureFieldName;
            toMeasureFieldName = toMeasureFieldName || (/** @type {?} */ (this)).referenceLayer.toMeasureFieldName;
        }
        /** @type {?} */
        var hasMeasureFieldInfo = Boolean((/** @type {?} */ (this)).referenceLayer || fromMeasureFieldName);
        if (!hasMeasureFieldInfo) {
            throw new Error(NO_REFERENCE_LAYER_SUPPLIED_ERROR_MSG);
        }
        /** @type {?} */
        var whereTemplate = toMeasureFieldName
            ? LRS_LINEAR_EVENT_WHERE_CLAUSE_TEMPLATE
            : LRS_POINT_EVENT_WHERE_CLAUSE_TEMPLATE;
        /** @type {?} */
        var measureClause = format(whereTemplate, {
            fromMeasureFieldName: (/** @type {?} */ (this)).formatField(fromMeasureFieldName),
            toMeasureFieldName: (/** @type {?} */ (this)).formatField(toMeasureFieldName),
            fromMeasure: fromMeasure,
            toMeasure: toMeasure,
        });
        return (/** @type {?} */ (this)).add(measureClause);
    };
    return LrsWhereClauseBuilder;
}(WhereClauseBuilder));
export { LrsWhereClauseBuilder };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.temporalLayer;
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.referenceLayer;
    /**
     * @type {?}
     * @private
     */
    LrsWhereClauseBuilder.prototype.sourceDbType;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHJzLXdoZXJlLWNsYXVzZS1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvbHJzL2xycy13aGVyZS1jbGF1c2UtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxnQkFBZ0IsRUFBNkIsTUFBTSw4QkFBOEIsQ0FBQztBQUsvRyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDOUUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sMERBQTBELENBQUM7QUFFbkcsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sc0RBQXNELENBQUM7QUFDaEcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlEQUF5RCxDQUFDOztBQUc3RixNQUFNLEtBQU8sb0NBQW9DLEdBQUcsaUNBQWlDOztBQUNyRixNQUFNLEtBQU8scUNBQXFDLEdBQUcsaUNBQWlDOztBQUN0RixNQUFNLEtBQU8sOEJBQThCLEdBQUcseUVBQXlFO01BQ25ILGlFQUFpRTs7QUFDckUsTUFBTSxLQUFPLHFDQUFxQyxHQUFHLGdFQUFnRTs7QUFDckgsTUFBTSxLQUFPLHNDQUFzQyxHQUFHLGlFQUFpRTtNQUNuSCw2R0FBNkc7TUFDN0csNEZBQTRGO01BQzVGLGdJQUFnSTs7Ozs7Ozs7QUFHcEksTUFBTSxVQUFVLDRCQUE0QixDQUMxQyxpQkFBeUIsRUFDekIsZUFBdUIsRUFDdkIsTUFBK0IsRUFDL0IsUUFBZTtJQUVmLFFBQVEsR0FBRyxTQUFTLENBQUMsUUFBUSxJQUFJLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQztJQUM3Qyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7OztRQUk1QixVQUFVLEdBQUcsd0JBQXdCLENBQUMsTUFBTSxDQUFDO0lBRW5ELE9BQU8sTUFBTSxDQUFD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NkY1RDs7Ozs7OztJQTFGQyw4Q0FBcUM7Ozs7O0lBQ3JDLCtDQUEwQzs7Ozs7SUFDMUMsNkNBQTZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV2hlcmVDbGF1c2VCdWlsZGVyLCBDcml0ZXJpYU9wZXJhdG9yLCBXaGVyZUNsYXVzZUJ1aWxkZXJPcHRpb25zIH0gZnJvbSAnLi4vbWFwcy93aGVyZS1jbGF1c2UtYnVpbGRlcic7XG5pbXBvcnQgeyBMcnNSZWZlcmVuY2VMYXllciwgVGVtcG9yYWxMYXllciB9IGZyb20gJy4vbHJzLWxheWVyJztcbmltcG9ydCB7IE5ldHdvcmtMYXllciB9IGZyb20gJy4vbmV0d29ya3MvbmV0d29yay1sYXllcic7XG5pbXBvcnQgeyBFdmVudExheWVyIH0gZnJvbSAnLi9ldmVudHMvZXZlbnQtbGF5ZXInO1xuaW1wb3J0IHsgRGF0YVNvdXJjZSB9IGZyb20gJy4uL2RhdGEtc291cmNlL2RhdGEtc291cmNlJztcbmltcG9ydCB7IHRvVXRjRGF0ZSB9IGZyb20gJy4uL2NvcmUvZGF0ZS10aW1lL2NvbnZlcnNpb24vdG8tdXRjLWRhdGUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgc2V0RGF0ZVRvQmVnaW5uaW5nT2ZEYXkgfSBmcm9tICcuLi9jb3JlL2RhdGUtdGltZS9zZXQtZGF0ZS10by1iZWdpbm5pbmctb2YtZGF0ZS5mdW5jdGlvbic7XG5pbXBvcnQgeyBEYXRhU291cmNlUHJvdmlkZXJUeXBlIH0gZnJvbSAnLi4vZGF0YS1zb3VyY2UvZGF0YS1zb3VyY2UtcHJvdmlkZXItdHlwZSc7XG5pbXBvcnQgeyBnZXREYXRlRm9ybWF0Rm9yUHJvdmlkZXIgfSBmcm9tICcuLi9kYXRhLXNvdXJjZS9nZXQtZGF0ZS1mb3JtYXQtZm9yLXByb3ZpZGVyLmZ1bmN0aW9uJztcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gJy4uL2NvcmUvZm9ybWF0dGluZy9mb3JtYXQuZnVuY3Rpb24nO1xuaW1wb3J0IHsgZm9ybWF0RGF0ZUZvclF1ZXJ5IH0gZnJvbSAnLi4vY29yZS9kYXRlLXRpbWUvZm9ybWF0L2Zvcm1hdC1kYXRlLWZvci1xdWVyeS5mdW5jdGlvbic7XG5cblxuZXhwb3J0IGNvbnN0IE5PX1RFTVBPUkFMX0xBWUVSX1NVUFBMSUVEX0VSUk9SX01TRyA9ICdObyBMUlMgdGVtcG9yYWwgbGF5ZXJzIHN1cHBsaWVkJztcbmV4cG9ydCBjb25zdCBOT19SRUZFUkVOQ0VfTEFZRVJfU1VQUExJRURfRVJST1JfTVNHID0gJ05vIExSUyByZWZlcmVuY2UgbGF5ZXIgc3VwcGxpZWQnO1xuZXhwb3J0IGNvbnN0IExSU19EQVRFX1dIRVJFX0NMQVVTRV9URU1QTEFURSA9ICcoKHtmcm9tRGF0ZUZpZWxkTmFtZX0gSVMgTlVMTCBPUiB7ZnJvbURhdGVGaWVsZE5hbWV9IDw9IHtkYXRlRW5kT2ZEYXl9KSdcbiAgKyAnIEFORCAoe3RvRGF0ZUZpZWxkTmFtZX0gSVMgTlVMTCBPUiB7dG9EYXRlRmllbGROYW1lfSA+IHtkYXRlfSkpJztcbmV4cG9ydCBjb25zdCBMUlNfUE9JTlRfRVZFTlRfV0hFUkVfQ0xBVVNFX1RFTVBMQVRFID0gYCh7ZnJvbU1lYXN1cmVGaWVsZE5hbWV9IGJldHdlZW4ge2Zyb21NZWFzdXJlfSBhbmQge3RvTWVhc3VyZX0pYDtcbmV4cG9ydCBjb25zdCBMUlNfTElORUFSX0VWRU5UX1dIRVJFX0NMQVVTRV9URU1QTEFURSA9IGAoKHtmcm9tTWVhc3VyZUZpZWxkTmFtZX0gYmV0d2VlbiB7ZnJvbU1lYXN1cmV9IEFORCB7dG9NZWFzdXJlfSlgXG4gICsgYCBPUiAoe3RvTWVhc3VyZUZpZWxkTmFtZX0gYmV0d2VlbiB7ZnJvbU1lYXN1cmV9IEFORCB7dG9NZWFzdXJlfSkgT1IgKHtmcm9tTWVhc3VyZUZpZWxkTmFtZX0gPCB7ZnJvbU1lYXN1cmV9YFxuICArIGAgQU5EIHt0b01lYXN1cmVGaWVsZE5hbWV9ID4ge3RvTWVhc3VyZX0pKSBBTkQgTk9UICgoe2Zyb21NZWFzdXJlRmllbGROYW1lfSA8IHtmcm9tTWVhc3VyZX1gXG4gICsgYCBBTkQge3RvTWVhc3VyZUZpZWxkTmFtZX0gPD0ge2Zyb21NZWFzdXJlfSkgT1IgKHt0b01lYXN1cmVGaWVsZE5hbWV9ID4ge3RvTWVhc3VyZX0gQU5EIHtmcm9tTWVhc3VyZUZpZWxkTmFtZX0gPj0ge3RvTWVhc3VyZX0pKWA7XG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldExyc1ZpZXdEYXRlV2hlcmVTdGF0ZW1lbnQoXG4gIGZyb21EYXRlRmllbGROYW1lOiBzdHJpbmcsXG4gIHRvRGF0ZUZpZWxkTmFtZTogc3RyaW5nLFxuICBkYlR5cGU/OiBEYXRhU291cmNlUHJvdmlkZXJUeXBlLFxuICB2aWV3RGF0ZT86IERhdGVcbik6IHN0cmluZyB7XG4gIHZpZXdEYXRlID0gdG9VdGNEYXRlKHZpZXdEYXRlIHx8IG5ldyBEYXRlKCkpO1xuICBzZXREYXRlVG9CZWdpbm5pbmdPZkRheSh2aWV3RGF0ZSk7XG5cbiAgLy8gVE9ETzogTG9vayBpbnRvIHdoZXRoZXIgd2UgbmVlZCB0byBhY3R1YWxseSB1c2UgZW5kIG9mIGRheSBvciBub3RcbiAgLy8gQ3VycmVudGx5IHdlIGFyZSBqdXN0IHNldHRpbmcgaXQgdG8gc2FtZSBhcyAnZGF0ZScgLSBSRy5cbiAgY29uc3QgZGF0ZUZvcm1hdCA9IGdldERhdGVGb3JtYXRGb3JQcm92aWRlcihkYlR5cGUpO1xuXG4gIHJldHVybiBmb3JtYXQoTFJTX0RBVEVfV0hFUkVfQ0xBVVNFX1RFTVBMQVRFLCB7XG4gICAgZnJvbURhdGVGaWVsZE5hbWUsXG4gICAgdG9EYXRlRmllbGROYW1lLFxuICAgIGRhdGU6IGZvcm1hdERhdGVGb3JRdWVyeSh2aWV3RGF0ZSwgZGF0ZUZvcm1hdCksXG4gICAgZGF0ZUVuZE9mRGF5OiBmb3JtYXREYXRlRm9yUXVlcnkodmlld0RhdGUsIGRhdGVGb3JtYXQpLFxuICB9KTtcbn1cblxuZXhwb3J0IGNsYXNzIExyc1doZXJlQ2xhdXNlQnVpbGRlciBleHRlbmRzIFdoZXJlQ2xhdXNlQnVpbGRlciB7XG4gIC8vIHByaXZhdGUgbmV0d29ya0xheWVyOiBOZXR3b3JrTGF5ZXI7XG4gIC8vIHByaXZhdGUgZXZlbnRMYXllcjogRXZlbnRMYXllcjtcbiAgcHJpdmF0ZSB0ZW1wb3JhbExheWVyOiBUZW1wb3JhbExheWVyO1xuICBwcml2YXRlIHJlZmVyZW5jZUxheWVyOiBMcnNSZWZlcmVuY2VMYXllcjtcbiAgcHJpdmF0ZSBzb3VyY2VEYlR5cGU6IERhdGFTb3VyY2VQcm92aWRlclR5cGU7XG5cbiAgY29uc3RydWN0b3Iob3B0aW9ucz86IFdoZXJlQ2xhdXNlQnVpbGRlck9wdGlvbnMpIHtcbiAgICBzdXBlcihvcHRpb25zKTtcbiAgfVxuXG4gIHdpdGhEYXRhU291cmNlKHNvdXJjZURhdGE6IERhdGFTb3VyY2UpOiB0aGlzIHtcbiAgICByZXR1cm4gdGhpcy53aXRoRGF0YVByb3ZpZGVyKHNvdXJjZURhdGEucHJvdmlkZXJOYW1lKTtcbiAgfVxuXG4gIHdpdGhEYXRhUHJvdmlkZXIoc291cmNlRGJUeXBlOiBEYXRhU291cmNlUHJvdmlkZXJUeXBlKTogdGhpcyB7XG4gICAgdGhpcy5zb3VyY2VEYlR5cGUgPSBzb3VyY2VEYlR5cGU7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB3aXRoRXZlbnRMYXllcihldmVudExheWVyOiBFdmVudExheWVyKTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXNcbiAgICAgIC53aXRoVGVtcG9yYWxMYXllcihldmVudExheWVyKVxuICAgICAgLndpdGhSZWZlcmVuY2VMYXllcihldmVudExheWVyKTtcbiAgfVxuXG4gIHdpdGhSZWZlcmVuY2VMYXllcihyZWZlcmVuY2VMYXllcjogTHJzUmVmZXJlbmNlTGF5ZXIpOiB0aGlzIHtcbiAgICB0aGlzLnJlZmVyZW5jZUxheWVyID0gcmVmZXJlbmNlTGF5ZXI7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICB3aXRoTmV0d29ya0xheWVyKG5ldHdvcmtMYXllcjogTmV0d29ya0xheWVyKTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXMud2l0aFRlbXBvcmFsTGF5ZXIobmV0d29ya0xheWVyKTtcbiAgfVxuXG4gIHdpdGhUZW1wb3JhbExheWVyKHRlbXBvcmFsTGF5ZXI6IFRlbXBvcmFsTGF5ZXIpOiB0aGlzIHtcbiAgICB0aGlzLnRlbXBvcmFsTGF5ZXIgPSB0ZW1wb3JhbExheWVyO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgd2l0aFJvdXRlSWQocm91dGVJZDogc3RyaW5nIHwgbnVtYmVyLCByb3V0ZUlkRmllbGROYW1lPzogc3RyaW5nKTogdGhpcyB7XG4gICAgcmV0dXJuIHRoaXMud2hlcmUocm91dGVJZEZpZWxkTmFtZSB8fCB0aGlzLnJlZmVyZW5jZUxheWVyLnJvdXRlSWRGaWVsZE5hbWUsIENyaXRlcmlhT3BlcmF0b3IuRXF1YWxzLCByb3V0ZUlkKTtcbiAgfVxuXG4gIHdpdGhWaWV3RGF0ZSh2aWV3RGF0ZT86IERhdGUsIGZyb21EYXRlRmllbGROYW1lPzogc3RyaW5nLCB0b0RhdGVGaWVsZE5hbWU/OiBzdHJpbmcpOiB0aGlzIHtcbiAgICBpZiAodGhpcy50ZW1wb3JhbExheWVyKSB7XG4gICAgICBmcm9tRGF0ZUZpZWxkTmFtZSA9IGZyb21EYXRlRmllbGROYW1lIHx8IHRoaXMudGVtcG9yYWxMYXllci5mcm9tRGF0ZUZpZWxkTmFtZTtcbiAgICAgIHRvRGF0ZUZpZWxkTmFtZSA9IHRvRGF0ZUZpZWxkTmFtZSB8fCB0aGlzLnRlbXBvcmFsTGF5ZXIudG9EYXRlRmllbGROYW1lO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc0RhdGVGaWVsZEluZm8gPSBCb29sZWFuKHRoaXMudGVtcG9yYWxMYXllciB8fCBmcm9tRGF0ZUZpZWxkTmFtZSAmJiB0b0RhdGVGaWVsZE5hbWUpO1xuICAgIGlmICghaGFzRGF0ZUZpZWxkSW5mbykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKE5PX1RFTVBPUkFMX0xBWUVSX1NVUFBMSUVEX0VSUk9SX01TRyk7XG4gICAgfVxuXG4gICAgaWYgKGZyb21EYXRlRmllbGROYW1lICYmIHRvRGF0ZUZpZWxkTmFtZSkge1xuICAgICAgY29uc3QgZGF0ZUNsYXVzZSA9IGdldExyc1ZpZXdEYXRlV2hlcmVTdGF0ZW1lbnQoXG4gICAgICAgIHRoaXMuZm9ybWF0RmllbGQoZnJvbURhdGVGaWVsZE5hbWUpLFxuICAgICAgICB0aGlzLmZvcm1hdEZpZWxkKHRvRGF0ZUZpZWxkTmFtZSksXG4gICAgICAgIHRoaXMuc291cmNlRGJUeXBlLFxuICAgICAgICB2aWV3RGF0ZVxuICAgICAgKTtcblxuICAgICAgdGhpcy5hZGQoZGF0ZUNsYXVzZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBiZXR3ZWVuTWVhc3VyZXMoZnJvbU1lYXN1cmU6IG51bWJlciwgdG9NZWFzdXJlOiBudW1iZXIsIGZyb21NZWFzdXJlRmllbGROYW1lPzogc3RyaW5nLCB0b01lYXN1cmVGaWVsZE5hbWU/OiBzdHJpbmcpOiB0aGlzIHtcbiAgICBpZiAodGhpcy5yZWZlcmVuY2VMYXllcikge1xuICAgICAgZnJvbU1lYXN1cmVGaWVsZE5hbWUgPSBmcm9tTWVhc3VyZUZpZWxkTmFtZSB8fCB0aGlzLnJlZmVyZW5jZUxheWVyLmZyb21NZWFzdXJlRmllbGROYW1lO1xuICAgICAgdG9NZWFzdXJlRmllbGROYW1lID0gdG9NZWFzdXJlRmllbGROYW1lIHx8IHRoaXMucmVmZXJlbmNlTGF5ZXIudG9NZWFzdXJlRmllbGROYW1lO1xuICAgIH1cblxuICAgIGNvbnN0IGhhc01lYXN1cmVGaWVsZEluZm8gPSBCb29sZWFuKHRoaXMucmVmZXJlbmNlTGF5ZXIgfHwgZnJvbU1lYXN1cmVGaWVsZE5hbWUpO1xuICAgIGlmICghaGFzTWVhc3VyZUZpZWxkSW5mbykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKE5PX1JFRkVSRU5DRV9MQVlFUl9TVVBQTElFRF9FUlJPUl9NU0cpO1xuICAgIH1cblxuICAgIGNvbnN0IHdoZXJlVGVtcGxhdGUgPSB0b01lYXN1cmVGaWVsZE5hbWVcbiAgICAgID8gTFJTX0xJTkVBUl9FVkVOVF9XSEVSRV9DTEFVU0VfVEVNUExBVEVcbiAgICAgIDogTFJTX1BPSU5UX0VWRU5UX1dIRVJFX0NMQVVTRV9URU1QTEFURTtcblxuICAgIGNvbnN0IG1lYXN1cmVDbGF1c2UgPSBmb3JtYXQod2hlcmVUZW1wbGF0ZSwge1xuICAgICAgZnJvbU1lYXN1cmVGaWVsZE5hbWU6IHRoaXMuZm9ybWF0RmllbGQoZnJvbU1lYXN1cmVGaWVsZE5hbWUpLFxuICAgICAgdG9NZWFzdXJlRmllbGROYW1lOiB0aGlzLmZvcm1hdEZpZWxkKHRvTWVhc3VyZUZpZWxkTmFtZSksXG4gICAgICBmcm9tTWVhc3VyZSxcbiAgICAgIHRvTWVhc3VyZSxcbiAgICB9KTtcblxuICAgIHJldHVybiB0aGlzLmFkZChtZWFzdXJlQ2xhdXNlKTtcbiAgfVxufVxuIl19