/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
// 3rd Party.
import { Subject, of } from 'rxjs';
import { finalize, map, catchError } from 'rxjs/operators';
// TSS.
import { GeolocatorCapability } from '../geolocation/geolocator/geolocator-capability';
import { BaseGeolocator } from '../geolocation/geolocator/base-geolocator.service';
import { GeolocatorAccuracyUnit } from '../geolocation/geolocator/geolocator-accuracy-unit';
import { Logger } from '../core/logging/logger.service';
import { GpsGateConfig } from './gps-gate.config';
import { format } from '../core/formatting/format.function';
import { Geolocatable } from '../geolocation/geolocator/geolocatable.decorator';
import * as i0 from "@angular/core";
import * as i1 from "../core/logging/logger.service";
import * as i2 from "@angular/common/http";
import * as i3 from "./gps-gate.config";
/**
 * Wrapper for geolocation service. The wrapper primarily exists to abstract the direct interaction with
 * the "navigator" object and to allow for injecting other implementations of geolocation functionality.
 */
var GpsGateGeolocator = /** @class */ (function (_super) {
    tslib_1.__extends(GpsGateGeolocator, _super);
    function GpsGateGeolocator(log, http, config) {
        var _this = _super.call(this, log) || this;
        _this.http = http;
        _this.config = config;
        _this.capabilities = [
            GeolocatorCapability.Altitude,
            GeolocatorCapability.AltitudeAccuracy,
            GeolocatorCapability.Heading,
            GeolocatorCapability.Speed,
            GeolocatorCapability.HDOP,
        ];
        _this.accuracyUnit = GeolocatorAccuracyUnit.Hdop;
        return _this;
    }
    Object.defineProperty(GpsGateGeolocator.prototype, "name", {
        get: /**
         * @return {?}
         */
        function () {
            return this.config.geolocatorName;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(GpsGateGeolocator.prototype, "description", {
        get: /**
         * @return {?}
         */
        function () {
            return this.config.geolocatorDescription;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @param {?=} options
     * @return {?}
     */
    GpsGateGeolocator.prototype.getCurrentPosition = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        /** @type {?} */
        var url = format(this.config.urlTemplate, {
            endpoint: this.config.getInfoEndpoint,
            cacheBuster: new Date().getTime()
        });
        return this.http.jsonp(url, this.config.jsonpParameterName)
            .pipe(map((/**
         * @param {?} info
         * @return {?}
         */
        function (info) {
            /** @type {?} */
            var timestamp = new Date(info.trackPoint.utc).getTime();
            /** @type {?} */
            var position = Object.assign({
                timestamp: timestamp,
                // NOTE: We are setting accuracy to HDOP because since this geolocator does not have
                // accuracy capabilities (see capabilities property), accuracy will not be shown within
                // the UI - rather fallback PDOP, HDOP, VDOP, etc will be used. However, we want to set
                // the accuracy because this value is what will be used to do collection
                // accuracy/precision acceptance (acceptable, warning, unaceptable, etc) - RG.
                accuracy: info.trackPoint.precision.hdop,
                altitudeAccuracy: null,
                speed: info.trackPoint.velocity.groundSpeed,
                heading: info.trackPoint.velocity.heading,
                hdop: info.trackPoint.precision.hdop
            }, info.trackPoint.position);
            _this.log.trace("Received current position for " + _this.name);
            return position;
        })))
            .toPromise();
    };
    /**
     * @param {?=} options
     * @return {?}
     */
    GpsGateGeolocator.prototype.watchPosition = /**
     * @param {?=} options
     * @return {?}
     */
    function (options) {
        var _this = this;
        /** @type {?} */
        var lastPosition;
        /** @type {?} */
        var subject = new Subject();
        /** @type {?} */
        var interval = setInterval((/**
         * @return {?}
         */
        function () {
            _this.getCurrentPosition(options)
                .then((/**
             * @param {?} position
             * @return {?}
             */
            function (position) {
                if (notEqual(position, lastPosition)) {
                    subject.next(position);
                }
                _this.log.trace("Received watch position for " + _this.name);
                lastPosition = position;
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) { return subject.error(error); }));
        }), this.config.refreshInterval);
        return subject.pipe(finalize((/**
         * @return {?}
         */
        function () { return clearInterval(interval); })));
    };
    /**
     * @return {?}
     */
    GpsGateGeolocator.prototype.isAvailable = /**
     * @return {?}
     */
    function () {
        return this.getVersion()
            .pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        function (result) { return Boolean(result); })), catchError((/**
         * @return {?}
         */
        function () { return of(false); })));
    };
    /**
     * @return {?}
     */
    GpsGateGeolocator.prototype.getVersion = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var url = format(this.config.urlTemplate, {
            endpoint: this.config.getVersionEndpoint,
            cacheBuster: new Date().getTime()
        });
        return this.http.jsonp(url, this.config.jsonpParameterName);
    };
    GpsGateGeolocator.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    GpsGateGeolocator.ctorParameters = function () { return [
        { type: Logger },
        { type: HttpClient },
        { type: GpsGateConfig }
    ]; };
    /** @nocollapse */ GpsGateGeolocator.ngInjectableDef = i0.defineInjectable({ factory: function GpsGateGeolocator_Factory() { return new GpsGateGeolocator(i0.inject(i1.Logger), i0.inject(i2.HttpClient), i0.inject(i3.GpsGateConfig)); }, token: GpsGateGeolocator, providedIn: "root" });
    /**
     * Wrapper for geolocation service. The wrapper primarily exists to abstract the direct interaction with
     * the "navigator" object and to allow for injecting other implementations of geolocation functionality.
     */
    GpsGateGeolocator = tslib_1.__decorate([
        Geolocatable('gps-gate'),
        tslib_1.__metadata("design:paramtypes", [Logger, HttpClient, GpsGateConfig])
    ], GpsGateGeolocator);
    return GpsGateGeolocator;
}(BaseGeolocator));
export { GpsGateGeolocator };
if (false) {
    /** @type {?} */
    GpsGateGeolocator.prototype.capabilities;
    /**
     * @type {?}
     * @private
     */
    GpsGateGeolocator.prototype.http;
    /**
     * @type {?}
     * @private
     */
    GpsGateGeolocator.prototype.config;
}
/**
 * @param {?} position1
 * @param {?} position2
 * @return {?}
 */
function notEqual(position1, position2) {
    return !equal(position1, position2);
}
/**
 * @param {?} position1
 * @param {?} position2
 * @return {?}
 */
function equal(position1, position2) {
    return position1
        && position2
        && position1.timestamp === position2.timestamp
        && position1.latitude === position2.latitude
        && position1.longitude === position2.longitude
        && position1.accuracy === position2.accuracy
        && position1.speed === position2.speed
        && position1.heading === position2.heading
        && position1.altitude === position2.altitude
        && position1.altitudeAccuracy === position2.altitudeAccuracy
        && position1.pdop === position2.pdop
        && position1.hdop === position2.hdop
        && position1.vdop === position2.vdop
        && position1.tdop === position2.tdop;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3BzLWdhdGUtZ2VvbG9jYXRvci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvZ3BzLWdhdGUvZ3BzLWdhdGUtZ2VvbG9jYXRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDOztBQUdsRCxPQUFPLEVBQWMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQyxPQUFPLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHM0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0saURBQWlELENBQUM7QUFDdkYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBQ25GLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLG9EQUFvRCxDQUFDO0FBQzVGLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFJbEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxrREFBa0QsQ0FBQzs7Ozs7Ozs7OztJQVN6Qyw2Q0FBYztJQWlCbkQsMkJBQVksR0FBVyxFQUFtQixJQUFnQixFQUFtQixNQUFxQjtRQUFsRyxZQUNFLGtCQUFNLEdBQUcsQ0FBQyxTQUVYO1FBSHlDLFVBQUksR0FBSixJQUFJLENBQVk7UUFBbUIsWUFBTSxHQUFOLE1BQU0sQ0FBZTtRQWhCbEcsa0JBQVksR0FBRztZQUNiLG9CQUFvQixDQUFDLFFBQVE7WUFDN0Isb0JBQW9CLENBQUMsZ0JBQWdCO1lBQ3JDLG9CQUFvQixD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U0FBUyxLQUFLLENBQUMsU0FBc0IsRUFBRSxTQUFzQjtJQUMzRCxPQUFPLFNBQVM7V0FDWCxTQUFTO1dBQ1QsU0FBUyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsU0FBUztXQUMzQyxTQUFTLENBQUMsUUFBUSxLQUFLLFNBQVMsQ0FBQyxRQUFRO1dBQ3pDLFNBQVMsQ0FBQyxTQUFTLEtBQUssU0FBUyxDQUFDLFNBQVM7V0FDM0MsU0FBUyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsUUFBUTtXQUN6QyxTQUFTLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxLQUFLO1dBQ25DLFNBQVMsQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDLE9BQU87V0FDdkMsU0FBUyxDQUFDLFFBQVEsS0FBSyxTQUFTLENBQUMsUUFBUTtXQUN6QyxTQUFTLENBQUMsZ0JBQWdCLEtBQUssU0FBUyxDQUFDLGdCQUFnQjtXQUN6RCxTQUFTLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxJQUFJO1dBQ2pDLFNBQVMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLElBQUk7V0FDakMsU0FBUyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsSUFBSTtXQUNqQyxTQUFTLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUM7QUFDekMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEFuZ3VsYXIuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG4vLyAzcmQgUGFydHkuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmluYWxpemUsIG1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuLy8gVFNTLlxuaW1wb3J0IHsgR2VvbG9jYXRvckNhcGFiaWxpdHkgfSBmcm9tICcuLi9nZW9sb2NhdGlvbi9nZW9sb2NhdG9yL2dlb2xvY2F0b3ItY2FwYWJpbGl0eSc7XG5pbXBvcnQgeyBCYXNlR2VvbG9jYXRvciB9IGZyb20gJy4uL2dlb2xvY2F0aW9uL2dlb2xvY2F0b3IvYmFzZS1nZW9sb2NhdG9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgR2VvbG9jYXRvckFjY3VyYWN5VW5pdCB9IGZyb20gJy4uL2dlb2xvY2F0aW9uL2dlb2xvY2F0b3IvZ2VvbG9jYXRvci1hY2N1cmFjeS11bml0JztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBHcHNHYXRlQ29uZmlnIH0gZnJvbSAnLi9ncHMtZ2F0ZS5jb25maWcnO1xuaW1wb3J0IHsgR3BzR2F0ZVZlcnNpb25JbmZvIH0gZnJvbSAnLi9ncHMtZ2F0ZS12ZXJzaW9uLWluZm8nO1xuaW1wb3J0IHsgR3BzUG9zaXRpb24gfSBmcm9tICcuLi9nZW9sb2NhdGlvbi9ncHMtcG9zaXRpb24vZ3BzLXBvc2l0aW9uJztcbmltcG9ydCB7IEdwc0dhdGVHcHNJbmZvIH0gZnJvbSAnLi9ncHMtZ2F0ZS1ncHMtaW5mbyc7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tICcuLi9jb3JlL2Zvcm1hdHRpbmcvZm9ybWF0LmZ1bmN0aW9uJztcbmltcG9ydCB7IEdlb2xvY2F0YWJsZSB9IGZyb20gJy4uL2dlb2xvY2F0aW9uL2dlb2xvY2F0b3IvZ2VvbG9jYXRhYmxlLmRlY29yYXRvcic7XG5cblxuLyoqXG4gKiBXcmFwcGVyIGZvciBnZW9sb2NhdGlvbiBzZXJ2aWNlLiBUaGUgd3JhcHBlciBwcmltYXJpbHkgZXhpc3RzIHRvIGFic3RyYWN0IHRoZSBkaXJlY3QgaW50ZXJhY3Rpb24gd2l0aFxuICogdGhlIFwibmF2aWdhdG9yXCIgb2JqZWN0IGFuZCB0byBhbGxvdyBmb3IgaW5qZWN0aW5nIG90aGVyIGltcGxlbWVudGF0aW9ucyBvZiBnZW9sb2NhdGlvbiBmdW5jdGlvbmFsaXR5LlxuICovXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuQEdlb2xvY2F0YWJsZSgnZ3BzLWdhdGUnKVxuZXhwb3J0IGNsYXNzIEdwc0dhdGVHZW9sb2NhdG9yIGV4dGVuZHMgQmFzZUdlb2xvY2F0b3Ige1xuICBjYXBhYmlsaXRpZXMgPSBbXG4gICAgR2VvbG9jYXRvckNhcGFiaWxpdHkuQWx0aXR1ZGUsXG4gICAgR2VvbG9jYXRvckNhcGFiaWxpdHkuQWx0aXR1ZGVBY2N1cmFjeSxcbiAgICBHZW9sb2NhdG9yQ2FwYWJpbGl0eS5IZWFkaW5nLFxuICAgIEdlb2xvY2F0b3JDYXBhYmlsaXR5LlNwZWVkLFxuICAgIEdlb2xvY2F0b3JDYXBhYmlsaXR5LkhET1AsXG4gIF07XG5cbiAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcuZ2VvbG9jYXRvck5hbWU7XG4gIH1cblxuICBnZXQgZGVzY3JpcHRpb24oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcuZ2VvbG9jYXRvckRlc2NyaXB0aW9uO1xuICB9XG5cbiAgY29uc3RydWN0b3IobG9nOiBMb2dnZXIsIHByaXZhdGUgcmVhZG9ubHkgaHR0cDogSHR0cENsaWVudCwgcHJpdmF0ZSByZWFkb25seSBjb25maWc6IEdwc0dhdGVDb25maWcpIHtcbiAgICBzdXBlcihsb2cpO1xuICAgIHRoaXMuYWNjdXJhY3lVbml0ID0gR2VvbG9jYXRvckFjY3VyYWN5VW5pdC5IZG9wO1xuICB9XG5cbiAgZ2V0Q3VycmVudFBvc2l0aW9uKG9wdGlvbnM/OiBQb3NpdGlvbk9wdGlvbnMpOiBQcm9taXNlPEdwc1Bvc2l0aW9uPiB7XG4gICAgY29uc3QgdXJsID0gZm9ybWF0KHRoaXMuY29uZmlnLnVybFRlbXBsYXRlLCB7XG4gICAgICBlbmRwb2ludDogdGhpcy5jb25maWcuZ2V0SW5mb0VuZHBvaW50LFxuICAgICAgY2FjaGVCdXN0ZXI6IG5ldyBEYXRlKCkuZ2V0VGltZSgpXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmpzb25wPEdwc0dhdGVHcHNJbmZvPih1cmwsIHRoaXMuY29uZmlnLmpzb25wUGFyYW1ldGVyTmFtZSlcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKGluZm86IEdwc0dhdGVHcHNJbmZvKSA9PiB7XG4gICAgICAgICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoaW5mby50cmFja1BvaW50LnV0YykuZ2V0VGltZSgpO1xuICAgICAgICAgIGNvbnN0IHBvc2l0aW9uOiBHcHNQb3NpdGlvbiA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgICAgLy8gTk9URTogV2UgYXJlIHNldHRpbmcgYWNjdXJhY3kgdG8gSERPUCBiZWNhdXNlIHNpbmNlIHRoaXMgZ2VvbG9jYXRvciBkb2VzIG5vdCBoYXZlXG4gICAgICAgICAgICAvLyBhY2N1cmFjeSBjYXBhYmlsaXRpZXMgKHNlZSBjYXBhYmlsaXRpZXMgcHJvcGVydHkpLCBhY2N1cmFjeSB3aWxsIG5vdCBiZSBzaG93biB3aXRoaW5cbiAgICAgICAgICAgIC8vIHRoZSBVSSAtIHJhdGhlciBmYWxsYmFjayBQRE9QLCBIRE9QLCBWRE9QLCBldGMgd2lsbCBiZSB1c2VkLiBIb3dldmVyLCB3ZSB3YW50IHRvIHNldFxuICAgICAgICAgICAgLy8gdGhlIGFjY3VyYWN5IGJlY2F1c2UgdGhpcyB2YWx1ZSBpcyB3aGF0IHdpbGwgYmUgdXNlZCB0byBkbyBjb2xsZWN0aW9uXG4gICAgICAgICAgICAvLyBhY2N1cmFjeS9wcmVjaXNpb24gYWNjZXB0YW5jZSAoYWNjZXB0YWJsZSwgd2FybmluZywgdW5hY2VwdGFibGUsIGV0YykgLSBSRy5cbiAgICAgICAgICAgIGFjY3VyYWN5OiBpbmZvLnRyYWNrUG9pbnQucHJlY2lzaW9uLmhkb3AsXG4gICAgICAgICAgICBhbHRpdHVkZUFjY3VyYWN5OiBudWxsLFxuICAgICAgICAgICAgc3BlZWQ6IGluZm8udHJhY2tQb2ludC52ZWxvY2l0eS5ncm91bmRTcGVlZCxcbiAgICAgICAgICAgIGhlYWRpbmc6IGluZm8udHJhY2tQb2ludC52ZWxvY2l0eS5oZWFkaW5nLFxuICAgICAgICAgICAgaGRvcDogaW5mby50cmFja1BvaW50LnByZWNpc2lvbi5oZG9wXG4gICAgICAgICAgfSwgaW5mby50cmFja1BvaW50LnBvc2l0aW9uKTtcblxuICAgICAgICAgIHRoaXMubG9nLnRyYWNlKGBSZWNlaXZlZCBjdXJyZW50IHBvc2l0aW9uIGZvciAke3RoaXMubmFtZX1gKTtcbiAgICAgICAgICByZXR1cm4gcG9zaXRpb247XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgICAudG9Qcm9taXNlKCk7XG4gIH1cblxuICB3YXRjaFBvc2l0aW9uKG9wdGlvbnM/OiBQb3NpdGlvbk9wdGlvbnMpOiBPYnNlcnZhYmxlPEdwc1Bvc2l0aW9uPiB7XG4gICAgbGV0IGxhc3RQb3NpdGlvbjogR3BzUG9zaXRpb247XG4gICAgY29uc3Qgc3ViamVjdCA9IG5ldyBTdWJqZWN0PEdwc1Bvc2l0aW9uPigpO1xuICAgIGNvbnN0IGludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgdGhpcy5nZXRDdXJyZW50UG9zaXRpb24ob3B0aW9ucylcbiAgICAgICAgLnRoZW4ocG9zaXRpb24gPT4ge1xuICAgICAgICAgIGlmIChub3RFcXVhbChwb3NpdGlvbiwgbGFzdFBvc2l0aW9uKSkge1xuICAgICAgICAgICAgc3ViamVjdC5uZXh0KHBvc2l0aW9uKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0aGlzLmxvZy50cmFjZShgUmVjZWl2ZWQgd2F0Y2ggcG9zaXRpb24gZm9yICR7dGhpcy5uYW1lfWApO1xuICAgICAgICAgIGxhc3RQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4gc3ViamVjdC5lcnJvcihlcnJvcikpO1xuICAgIH0sIHRoaXMuY29uZmlnLnJlZnJlc2hJbnRlcnZhbCk7XG5cbiAgICByZXR1cm4gc3ViamVjdC5waXBlKFxuICAgICAgZmluYWxpemUoKCkgPT4gY2xlYXJJbnRlcnZhbChpbnRlcnZhbCkpXG4gICAgKTtcbiAgfVxuXG4gIGlzQXZhaWxhYmxlKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLmdldFZlcnNpb24oKVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcChyZXN1bHQgPT4gQm9vbGVhbihyZXN1bHQpKSxcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihmYWxzZSkpXG4gICAgICApO1xuICB9XG5cbiAgZ2V0VmVyc2lvbigpOiBPYnNlcnZhYmxlPEdwc0dhdGVWZXJzaW9uSW5mbz4ge1xuICAgIGNvbnN0IHVybCA9IGZvcm1hdCh0aGlzLmNvbmZpZy51cmxUZW1wbGF0ZSwge1xuICAgICAgZW5kcG9pbnQ6IHRoaXMuY29uZmlnLmdldFZlcnNpb25FbmRwb2ludCxcbiAgICAgIGNhY2hlQnVzdGVyOiBuZXcgRGF0ZSgpLmdldFRpbWUoKVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5qc29ucDxHcHNHYXRlVmVyc2lvbkluZm8+KHVybCwgdGhpcy5jb25maWcuanNvbnBQYXJhbWV0ZXJOYW1lKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBub3RFcXVhbChwb3NpdGlvbjE6IEdwc1Bvc2l0aW9uLCBwb3NpdGlvbjI6IEdwc1Bvc2l0aW9uKTogYm9vbGVhbiB7XG4gIHJldHVybiAhZXF1YWwocG9zaXRpb24xLCBwb3NpdGlvbjIpO1xufVxuXG5mdW5jdGlvbiBlcXVhbChwb3NpdGlvbjE6IEdwc1Bvc2l0aW9uLCBwb3NpdGlvbjI6IEdwc1Bvc2l0aW9uKTogYm9vbGVhbiB7XG4gIHJldHVybiBwb3NpdGlvbjFcbiAgICAmJiBwb3NpdGlvbjJcbiAgICAmJiBwb3NpdGlvbjEudGltZXN0YW1wID09PSBwb3NpdGlvbjIudGltZXN0YW1wXG4gICAgJiYgcG9zaXRpb24xLmxhdGl0dWRlID09PSBwb3NpdGlvbjIubGF0aXR1ZGVcbiAgICAmJiBwb3NpdGlvbjEubG9uZ2l0dWRlID09PSBwb3NpdGlvbjIubG9uZ2l0dWRlXG4gICAgJiYgcG9zaXRpb24xLmFjY3VyYWN5ID09PSBwb3NpdGlvbjIuYWNjdXJhY3lcbiAgICAmJiBwb3NpdGlvbjEuc3BlZWQgPT09IHBvc2l0aW9uMi5zcGVlZFxuICAgICYmIHBvc2l0aW9uMS5oZWFkaW5nID09PSBwb3NpdGlvbjIuaGVhZGluZ1xuICAgICYmIHBvc2l0aW9uMS5hbHRpdHVkZSA9PT0gcG9zaXRpb24yLmFsdGl0dWRlXG4gICAgJiYgcG9zaXRpb24xLmFsdGl0dWRlQWNjdXJhY3kgPT09IHBvc2l0aW9uMi5hbHRpdHVkZUFjY3VyYWN5XG4gICAgJiYgcG9zaXRpb24xLnBkb3AgPT09IHBvc2l0aW9uMi5wZG9wXG4gICAgJiYgcG9zaXRpb24xLmhkb3AgPT09IHBvc2l0aW9uMi5oZG9wXG4gICAgJiYgcG9zaXRpb24xLnZkb3AgPT09IHBvc2l0aW9uMi52ZG9wXG4gICAgJiYgcG9zaXRpb24xLnRkb3AgPT09IHBvc2l0aW9uMi50ZG9wO1xufVxuIl19