/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angular.
import { Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
// 3rd party.
import { Subject } from 'rxjs';
import { publishReplay } from 'rxjs/operators';
import { RoleManagerService } from './role-manager.service';
import { SecurityConfig } from './security-config';
import { Logger } from '../core/logging/logger.service';
import { PersistentStorage } from '../core/storage/persistent-storage.service';
import { isString } from '../core/type-check/is-string.function';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "./role-manager.service";
import * as i3 from "./security-config";
import * as i4 from "../core/storage/persistent-storage.service";
import * as i5 from "../core/logging/logger.service";
/** @enum {number} */
var SignInState = {
    SignedIn: 0,
    SignedOut: 1,
    SignInFailed: 2,
    SignOutFailed: 3,
};
export { SignInState };
SignInState[SignInState.SignedIn] = 'SignedIn';
SignInState[SignInState.SignedOut] = 'SignedOut';
SignInState[SignInState.SignInFailed] = 'SignInFailed';
SignInState[SignInState.SignOutFailed] = 'SignOutFailed';
var AuthService = /** @class */ (function () {
    function AuthService(http, roleMgr, config, storage, log) {
        this.http = http;
        this.roleMgr = roleMgr;
        this.config = config;
        this.storage = storage;
        this.log = log;
        this.stateChangeSubject = new Subject();
        this.rememberMe = config.storeToken;
        this.stateChange = this.stateChangeSubject.asObservable();
        if (config.autoSignIn && !this.isAuthenticated) {
            this.loadStoredToken();
        }
    }
    /**
     * @param {?} userName
     * @param {?} password
     * @param {?=} rememberMe
     * @return {?}
     */
    AuthService.prototype.signIn = /**
     * @param {?} userName
     * @param {?} password
     * @param {?=} rememberMe
     * @return {?}
     */
    function (userName, password, rememberMe) {
        if (rememberMe === void 0) { rememberMe = this.rememberMe; }
        /** @type {?} */
        var observable = this.http.post(this.config.serviceUrl + "/" + this.config.tokenEndpoint, this.config.tokenBody(userName, password))
            .pipe(publishReplay(1));
        this.rememberMe = rememberMe;
        observable.subscribe(this.onSignedIn.bind(this), this.onSignInFailed.bind(this));
        return observable;
    };
    /**
     * @return {?}
     */
    AuthService.prototype.signOut = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var signOutUrl = this.config.serviceUrl + "/" + this.config.signOutEndpoint;
        if (this.isFederatedAccount) {
            this.log.info("Signing out. Authentication Type: STS. Forwarded to: " + signOutUrl);
            this.onSignedOut();
            if (typeof location !== 'undefined') {
                location.href = signOutUrl;
            }
        }
        else {
            // The only reason this "Account" method is abstracted here is because there is additional stuff that
            // has to happen when you sign out - like removing the user information cache, etc.
            /** @type {?} */
            var obserable = this.http.get(signOutUrl)
                .pipe(publishReplay(1));
            obserable
                .subscribe(this.onSignedOut.bind(this), this.onSignedOutFailed.bind(this));
            return obserable;
        }
    };
    /**
     * @return {?}
     */
    AuthService.prototype.getUserInfo = /**
     * @return {?}
     */
    function () {
        return this.http.get(this.config.serviceUrl + "/" + this.config.userInfoEndpoint);
    };
    /**
     * @return {?}
     */
    AuthService.prototype.getToken = /**
     * @return {?}
     */
    function () {
        return this.isAuthenticated
            ? this.account.access_token || null
            : null;
    };
    /**
     * @return {?}
     */
    AuthService.prototype.loadStoredToken = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var token = this.getLocalToken();
        /** @type {?} */
        var loaded = false;
        if (token && token['.expires']) {
            /** @type {?} */
            var expiresDate = token['.expires'];
            if (expiresDate > new Date()) {
                this.onSignedIn(token, true);
                loaded = true;
            }
        }
        return loaded;
    };
    /**
     * @param {?} account
     * @param {?=} skipLocalStorage
     * @return {?}
     */
    AuthService.prototype.onSignedIn = /**
     * @param {?} account
     * @param {?=} skipLocalStorage
     * @return {?}
     */
    function (account, skipLocalStorage) {
        if (skipLocalStorage === void 0) { skipLocalStorage = false; }
        this.account = account;
        this.isAuthenticated = true;
        this.isDomainAccount = (account.foundContextType || '').toLowerCase() === 'domain';
        this.isFederatedAccount = (account.authenticationType || '').toLowerCase() === 'federation';
        // Note, we are exposing the access token through the security config because the token intercepter
        // can not use this auth service - it will result in a cyclic dpendency injection error.
        // See Angular issue: https://github.com/angular/angular/issues/18224
        // TODO: Deprecate "accessToken" property on "SecurityConfig" once this is resolved - RG.
        this.config.accessToken = account.access_token;
        this.roleMgr.setRoles(account.privileges || account.roles);
        if (!skipLocalStorage && this.rememberMe) {
            account.lastSignIn = new Date();
            this.setLocalToken(account);
        }
        this.log.debug('User signed in succesfully');
        this.stateChangeSubject.next(SignInState.SignedIn);
    };
    /**
     * @return {?}
     */
    AuthService.prototype.onSignedOut = /**
     * @return {?}
     */
    function () {
        // We set the "authenticated" flag state to false so that anyone watching this can see the new state and
        // get rid of the account information that was cached, because it is no longer applicable.
        this.isAuthenticated = false;
        this.isDomainAccount = false;
        this.isFederatedAccount = false;
        this.account = null;
        this.roleMgr.clearRoles();
        this.setLocalToken(null);
        this.log.debug('User signed out succesfully');
        this.stateChangeSubject.next(SignInState.SignedOut);
    };
    /**
     * @private
     * @param {?} err
     * @return {?}
     */
    AuthService.prototype.onSignInFailed = /**
     * @private
     * @param {?} err
     * @return {?}
     */
    function (err) {
        this.log.error('Failed to sign in', err);
        this.stateChangeSubject.next(SignInState.SignInFailed);
    };
    /**
     * @private
     * @param {?} err
     * @return {?}
     */
    AuthService.prototype.onSignedOutFailed = /**
     * @private
     * @param {?} err
     * @return {?}
     */
    function (err) {
        this.log.error('Failed to sign out', err);
        this.stateChangeSubject.next(SignInState.SignOutFailed);
    };
    /**
     * @private
     * @return {?}
     */
    AuthService.prototype.getLocalToken = /**
     * @private
     * @return {?}
     */
    function () {
        try {
            /** @type {?} */
            var token = this.storage.getObject(this.config.tokenStorageKey);
            if (token && token.lastSignIn && isString(token.lastSignIn)) {
                token.lastSignIn = new Date(token.lastSignIn);
            }
            if (token && token['.expires'] && isString(token['.expires'])) {
                token['.expires'] = new Date(Date.parse(token['.expires']));
            }
            return token;
        }
        finally {
            // We don't need to do anything bbecause this is not critical path.
        }
    };
    /**
     * @private
     * @param {?} token
     * @return {?}
     */
    AuthService.prototype.setLocalToken = /**
     * @private
     * @param {?} token
     * @return {?}
     */
    function (token) {
        try {
            if (token) {
                this.storage.setObject(this.config.tokenStorageKey, token);
            }
            else {
                this.storage.remove(this.config.tokenStorageKey);
            }
        }
        finally {
            // We don't need to do anything as this is not a core workflow.
        }
    };
    AuthService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    AuthService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: RoleManagerService },
        { type: SecurityConfig },
        { type: PersistentStorage },
        { type: Logger }
    ]; };
    /** @nocollapse */ AuthService.ngInjectableDef = i0.defineInjectable({ factory: function AuthService_Factory() { return new AuthService(i0.inject(i1.HttpClient), i0.inject(i2.RoleManagerService), i0.inject(i3.SecurityConfig), i0.inject(i4.PersistentStorage), i0.inject(i5.Logger)); }, token: AuthService, providedIn: "root" });
    return AuthService;
}());
export { AuthService };
if (false) {
    /** @type {?} */
    AuthService.prototype.rememberMe;
    /** @type {?} */
    AuthService.prototype.account;
    /** @type {?} */
    AuthService.prototype.isAuthenticated;
    /** @type {?} */
    AuthService.prototype.isDomainAccount;
    /** @type {?} */
    AuthService.prototype.isFederatedAccount;
    /** @type {?} */
    AuthService.prototype.stateChange;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.stateChangeSubject;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.http;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.roleMgr;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    AuthService.prototype.log;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHRzcy9zZGsvIiwic291cmNlcyI6WyJsaWIvc2VjdXJpdHkvYXV0aC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7O0FBR2xELE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSS9DLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDL0UsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVDQUF1QyxDQUFDOzs7Ozs7Ozs7SUFJL0QsV0FBUTtJQUNSLFlBQVM7SUFDVCxlQUFZO0lBQ1osZ0JBQWE7Ozs7Ozs7QUFJZjtJQWFFLHFCQUNVLElBQWdCLEVBQ2hCLE9BQTJCLEVBQzNCLE1BQXNCLEVBQ3RCLE9BQTBCLEVBQzFCLEdBQVc7UUFKWCxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLFlBQU8sR0FBUCxPQUFPLENBQW9CO1FBQzNCLFdBQU0sR0FBTixNQUFNLENBQWdCO1FBQ3RCLFlBQU8sR0FBUCxPQUFPLENBQW1CO1FBQzFCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFQSix1QkFBa0IsR0FBRyxJQUFJLE9BQU8sRUFBZSxDQUFDO1FBUy9ELElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUNwQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FB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bGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5cbi8vIDNyZCBwYXJ0eS5cbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHB1Ymxpc2hSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8vIFRTUy5cbmltcG9ydCB7IFVzZXJBY2NvdW50IH0gZnJvbSAnLi91c2VyLWFjY291bnQnO1xuaW1wb3J0IHsgUm9sZU1hbmFnZXJTZXJ2aWNlIH0gZnJvbSAnLi9yb2xlLW1hbmFnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBTZWN1cml0eUNvbmZpZyB9IGZyb20gJy4vc2VjdXJpdHktY29uZmlnJztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2NvcmUvbG9nZ2luZy9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBQZXJzaXN0ZW50U3RvcmFnZSB9IGZyb20gJy4uL2NvcmUvc3RvcmFnZS9wZXJzaXN0ZW50LXN0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBpc1N0cmluZyB9IGZyb20gJy4uL2NvcmUvdHlwZS1jaGVjay9pcy1zdHJpbmcuZnVuY3Rpb24nO1xuXG5cbmV4cG9ydCBlbnVtIFNpZ25JblN0YXRlIHtcbiAgU2lnbmVkSW4sXG4gIFNpZ25lZE91dCxcbiAgU2lnbkluRmFpbGVkLFxuICBTaWduT3V0RmFpbGVkLFxufVxuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEF1dGhTZXJ2aWNlIHtcbiAgcmVtZW1iZXJNZTogYm9vbGVhbjtcbiAgYWNjb3VudDogVXNlckFjY291bnQ7XG4gIGlzQXV0aGVudGljYXRlZDogYm9vbGVhbjtcbiAgaXNEb21haW5BY2NvdW50OiBib29sZWFuO1xuICBpc0ZlZGVyYXRlZEFjY291bnQ6IGJvb2xlYW47XG5cbiAgcmVhZG9ubHkgc3RhdGVDaGFuZ2U6IE9ic2VydmFibGU8U2lnbkluU3RhdGU+O1xuICBwcml2YXRlIHJlYWRvbmx5IHN0YXRlQ2hhbmdlU3ViamVjdCA9IG5ldyBTdWJqZWN0PFNpZ25JblN0YXRlPigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAgICBwcml2YXRlIHJvbGVNZ3I6IFJvbGVNYW5hZ2VyU2VydmljZSxcbiAgICBwcml2YXRlIGNvbmZpZzogU2VjdXJpdHlDb25maWcsXG4gICAgcHJpdmF0ZSBzdG9yYWdlOiBQZXJzaXN0ZW50U3RvcmFnZSxcbiAgICBwcml2YXRlIGxvZzogTG9nZ2VyXG4gICkge1xuICAgIHRoaXMucmVtZW1iZXJNZSA9IGNvbmZpZy5zdG9yZVRva2VuO1xuICAgIHRoaXMuc3RhdGVDaGFuZ2UgPSB0aGlzLnN0YXRlQ2hhbmdlU3ViamVjdC5hc09ic2VydmFibGUoKTtcblxuICAgIGlmIChjb25maWcuYXV0b1NpZ25JbiAmJiAhdGhpcy5pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgIHRoaXMubG9hZFN0b3JlZFRva2VuKCk7XG4gICAgfVxuICB9XG5cbiAgc2lnbkluKHVzZXJOYW1lOiBzdHJpbmcsIHBhc3N3b3JkOiBzdHJpbmcsIHJlbWVtYmVyTWU6IGJvb2xlYW4gPSB0aGlzLnJlbWVtYmVyTWUpOiBPYnNlcnZhYmxlPFVzZXJBY2NvdW50PiB7XG4gICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHRoaXMuaHR0cC5wb3N0PFVzZXJBY2NvdW50PihcbiAgICAgIGAke3RoaXMuY29uZmlnLnNlcnZpY2VVcmx9LyR7dGhpcy5jb25maWcudG9rZW5FbmRwb2ludH1gLFxuICAgICAgdGhpcy5jb25maWcudG9rZW5Cb2R5KHVzZXJOYW1lLCBwYXNzd29yZClcbiAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgcHVibGlzaFJlcGxheSgxKVxuICAgICAgKTtcblxuICAgIHRoaXMucmVtZW1iZXJNZSA9IHJlbWVtYmVyTWU7XG4gICAgb2JzZXJ2YWJsZS5zdWJzY3JpYmUodGhpcy5vblNpZ25lZEluLmJpbmQodGhpcyksIHRoaXMub25TaWduSW5GYWlsZWQuYmluZCh0aGlzKSk7XG5cbiAgICByZXR1cm4gb2JzZXJ2YWJsZTtcbiAgfVxuXG4gIHNpZ25PdXQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBzaWduT3V0VXJsID0gYCR7dGhpcy5jb25maWcuc2VydmljZVVybH0vJHt0aGlzLmNvbmZpZy5zaWduT3V0RW5kcG9pbnR9YDtcbiAgICBpZiAodGhpcy5pc0ZlZGVyYXRlZEFjY291bnQpIHtcbiAgICAgIHRoaXMubG9nLmluZm8oYFNpZ25pbmcgb3V0LiBBdXRoZW50aWNhdGlvbiBUeXBlOiBTVFMuIEZvcndhcmRlZCB0bzogJHtzaWduT3V0VXJsfWApO1xuICAgICAgdGhpcy5vblNpZ25lZE91dCgpO1xuXG4gICAgICBpZiAodHlwZW9mIGxvY2F0aW9uICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBsb2NhdGlvbi5ocmVmID0gc2lnbk91dFVybDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVGhlIG9ubHkgcmVhc29uIHRoaXMgXCJBY2NvdW50XCIgbWV0aG9kIGlzIGFic3RyYWN0ZWQgaGVyZSBpcyBiZWNhdXNlIHRoZXJlIGlzIGFkZGl0aW9uYWwgc3R1ZmYgdGhhdFxuICAgICAgLy8gaGFzIHRvIGhhcHBlbiB3aGVuIHlvdSBzaWduIG91dCAtIGxpa2UgcmVtb3ZpbmcgdGhlIHVzZXIgaW5mb3JtYXRpb24gY2FjaGUsIGV0Yy5cbiAgICAgIGNvbnN0IG9ic2VyYWJsZSA9IHRoaXMuaHR0cC5nZXQoc2lnbk91dFVybClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgcHVibGlzaFJlcGxheSgxKVxuICAgICAgICApO1xuXG4gICAgICBvYnNlcmFibGVcbiAgICAgICAgLnN1YnNjcmliZSh0aGlzLm9uU2lnbmVkT3V0LmJpbmQodGhpcyksIHRoaXMub25TaWduZWRPdXRGYWlsZWQuYmluZCh0aGlzKSk7XG5cbiAgICAgIHJldHVybiBvYnNlcmFibGU7XG4gICAgfVxuICB9XG5cbiAgZ2V0VXNlckluZm8oKTogT2JzZXJ2YWJsZTxVc2VyQWNjb3VudD4ge1xuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PFVzZXJBY2NvdW50PihgJHt0aGlzLmNvbmZpZy5zZXJ2aWNlVXJsfS8ke3RoaXMuY29uZmlnLnVzZXJJbmZvRW5kcG9pbnR9YCk7XG4gIH1cblxuICBnZXRUb2tlbigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmlzQXV0aGVudGljYXRlZFxuICAgICAgPyB0aGlzLmFjY291bnQuYWNjZXNzX3Rva2VuIHx8IG51bGxcbiAgICAgIDogbnVsbDtcbiAgfVxuXG4gIGxvYWRTdG9yZWRUb2tlbigpOiBib29sZWFuIHtcbiAgICBjb25zdCB0b2tlbiA9IHRoaXMuZ2V0TG9jYWxUb2tlbigpO1xuICAgIGxldCBsb2FkZWQgPSBmYWxzZTtcblxuICAgIGlmICh0b2tlbiAmJiB0b2tlblsnLmV4cGlyZXMnXSkge1xuICAgICAgY29uc3QgZXhwaXJlc0RhdGUgPSB0b2tlblsnLmV4cGlyZXMnXTtcbiAgICAgIGlmIChleHBpcmVzRGF0ZSA+IG5ldyBEYXRlKCkpIHtcbiAgICAgICAgdGhpcy5vblNpZ25lZEluKHRva2VuLCB0cnVlKTtcbiAgICAgICAgbG9hZGVkID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbG9hZGVkO1xuICB9XG5cbiAgb25TaWduZWRJbihhY2NvdW50OiBVc2VyQWNjb3VudCwgc2tpcExvY2FsU3RvcmFnZTogYm9vbGVhbiA9IGZhbHNlKSB7XG4gICAgdGhpcy5hY2NvdW50ID0gYWNjb3VudDtcbiAgICB0aGlzLmlzQXV0aGVudGljYXRlZCA9IHRydWU7XG4gICAgdGhpcy5pc0RvbWFpbkFjY291bnQgPSAoYWNjb3VudC5mb3VuZENvbnRleHRUeXBlIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnZG9tYWluJztcbiAgICB0aGlzLmlzRmVkZXJhdGVkQWNjb3VudCA9IChhY2NvdW50LmF1dGhlbnRpY2F0aW9uVHlwZSB8fCAnJykudG9Mb3dlckNhc2UoKSA9PT0gJ2ZlZGVyYXRpb24nO1xuXG4gICAgLy8gTm90ZSwgd2UgYXJlIGV4cG9zaW5nIHRoZSBhY2Nlc3MgdG9rZW4gdGhyb3VnaCB0aGUgc2VjdXJpdHkgY29uZmlnIGJlY2F1c2UgdGhlIHRva2VuIGludGVyY2VwdGVyXG4gICAgLy8gY2FuIG5vdCB1c2UgdGhpcyBhdXRoIHNlcnZpY2UgLSBpdCB3aWxsIHJlc3VsdCBpbiBhIGN5Y2xpYyBkcGVuZGVuY3kgaW5qZWN0aW9uIGVycm9yLlxuICAgIC8vIFNlZSBBbmd1bGFyIGlzc3VlOiBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8xODIyNFxuICAgIC8vIFRPRE86IERlcHJlY2F0ZSBcImFjY2Vzc1Rva2VuXCIgcHJvcGVydHkgb24gXCJTZWN1cml0eUNvbmZpZ1wiIG9uY2UgdGhpcyBpcyByZXNvbHZlZCAtIFJHLlxuICAgIHRoaXMuY29uZmlnLmFjY2Vzc1Rva2VuID0gYWNjb3VudC5hY2Nlc3NfdG9rZW47XG4gICAgdGhpcy5yb2xlTWdyLnNldFJvbGVzKGFjY291bnQucHJpdmlsZWdlcyB8fCBhY2NvdW50LnJvbGVzKTtcblxuICAgIGlmICghc2tpcExvY2FsU3RvcmFnZSAmJiB0aGlzLnJlbWVtYmVyTWUpIHtcbiAgICAgIGFjY291bnQubGFzdFNpZ25JbiA9IG5ldyBEYXRlKCk7XG4gICAgICB0aGlzLnNldExvY2FsVG9rZW4oYWNjb3VudCk7XG4gICAgfVxuXG4gICAgdGhpcy5sb2cuZGVidWcoJ1VzZXIgc2lnbmVkIGluIHN1Y2Nlc2Z1bGx5Jyk7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZVN1YmplY3QubmV4dChTaWduSW5TdGF0ZS5TaWduZWRJbik7XG4gIH1cblxuICBvblNpZ25lZE91dCgpIHtcbiAgICAvLyBXZSBzZXQgdGhlIFwiYXV0aGVudGljYXRlZFwiIGZsYWcgc3RhdGUgdG8gZmFsc2Ugc28gdGhhdCBhbnlvbmUgd2F0Y2hpbmcgdGhpcyBjYW4gc2VlIHRoZSBuZXcgc3RhdGUgYW5kXG4gICAgLy8gZ2V0IHJpZCBvZiB0aGUgYWNjb3VudCBpbmZvcm1hdGlvbiB0aGF0IHdhcyBjYWNoZWQsIGJlY2F1c2UgaXQgaXMgbm8gbG9uZ2VyIGFwcGxpY2FibGUuXG4gICAgdGhpcy5pc0F1dGhlbnRpY2F0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmlzRG9tYWluQWNjb3VudCA9IGZhbHNlO1xuICAgIHRoaXMuaXNGZWRlcmF0ZWRBY2NvdW50ID0gZmFsc2U7XG4gICAgdGhpcy5hY2NvdW50ID0gbnVsbDtcbiAgICB0aGlzLnJvbGVNZ3IuY2xlYXJSb2xlcygpO1xuICAgIHRoaXMuc2V0TG9jYWxUb2tlbihudWxsKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZygnVXNlciBzaWduZWQgb3V0IHN1Y2Nlc2Z1bGx5Jyk7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZVN1YmplY3QubmV4dChTaWduSW5TdGF0ZS5TaWduZWRPdXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblNpZ25JbkZhaWxlZChlcnI6IGFueSkge1xuICAgIHRoaXMubG9nLmVycm9yKCdGYWlsZWQgdG8gc2lnbiBpbicsIGVycik7XG4gICAgdGhpcy5zdGF0ZUNoYW5nZVN1YmplY3QubmV4dChTaWduSW5TdGF0ZS5TaWduSW5GYWlsZWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblNpZ25lZE91dEZhaWxlZChlcnI6IGFueSkge1xuICAgIHRoaXMubG9nLmVycm9yKCdGYWlsZWQgdG8gc2lnbiBvdXQnLCBlcnIpO1xuICAgIHRoaXMuc3RhdGVDaGFuZ2VTdWJqZWN0Lm5leHQoU2lnbkluU3RhdGUuU2lnbk91dEZhaWxlZCk7XG4gIH1cblxuICBwcml2YXRlIGdldExvY2FsVG9rZW4oKTogVXNlckFjY291bnQge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB0b2tlbjogVXNlckFjY291bnQgPSB0aGlzLnN0b3JhZ2UuZ2V0T2JqZWN0KHRoaXMuY29uZmlnLnRva2VuU3RvcmFnZUtleSk7XG5cbiAgICAgIGlmICh0b2tlbiAmJiB0b2tlbi5sYXN0U2lnbkluICYmIGlzU3RyaW5nKHRva2VuLmxhc3RTaWduSW4pKSB7XG4gICAgICAgIHRva2VuLmxhc3RTaWduSW4gPSBuZXcgRGF0ZSh0b2tlbi5sYXN0U2lnbkluKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRva2VuICYmIHRva2VuWycuZXhwaXJlcyddICYmIGlzU3RyaW5nKHRva2VuWycuZXhwaXJlcyddKSkge1xuICAgICAgICB0b2tlblsnLmV4cGlyZXMnXSA9IG5ldyBEYXRlKERhdGUucGFyc2UodG9rZW5bJy5leHBpcmVzJ10pKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRva2VuO1xuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nIGJiZWNhdXNlIHRoaXMgaXMgbm90IGNyaXRpY2FsIHBhdGguXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRMb2NhbFRva2VuKHRva2VuKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0b2tlbikge1xuICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0T2JqZWN0KHRoaXMuY29uZmlnLnRva2VuU3RvcmFnZUtleSwgdG9rZW4pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zdG9yYWdlLnJlbW92ZSh0aGlzLmNvbmZpZy50b2tlblN0b3JhZ2VLZXkpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICAvLyBXZSBkb24ndCBuZWVkIHRvIGRvIGFueXRoaW5nIGFzIHRoaXMgaXMgbm90IGEgY29yZSB3b3JrZmxvdy5cbiAgICB9XG4gIH1cbn1cbiJdfQ==