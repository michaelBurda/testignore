/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// 3rd party.
import distance from '@turf/distance';
import { toMultiPartPaths } from '../line/to-multi-part-paths.function';
import { getMeasureFromPoint } from '../point/get-measure-from-point.function';
import { sortAscending } from '../../core/sort/sort.function';
import { isNotNumber } from '../../core/type-check/is-not-number.function';
/** @type {?} */
var DEFAULT_EMPTY_Z_VALUE = 0;
/** @type {?} */
var DEFAULT_OPTIONS = {
    units: 'miles',
    hasZValues: true,
    calibrationPositions: []
};
/**
 * @param {?} line
 * @param {?=} options
 * @return {?}
 */
export function setMeasuresByGeometricLength(line, options) {
    /** @type {?} */
    var martiPart = toMultiPartPaths(line);
    options = Object.assign({}, DEFAULT_OPTIONS, options);
    /** @type {?} */
    var lastMeasure = 0;
    martiPart.forEach((/**
     * @param {?} linePart
     * @param {?} partIndex
     * @return {?}
     */
    function (linePart, partIndex) {
        setMeasureForLine(linePart, lastMeasure, partIndex, options);
        /** @type {?} */
        var lastCoordinateIndex = linePart.length - 1;
        /** @type {?} */
        var lastCoordinate = linePart[lastCoordinateIndex];
        lastMeasure += getMeasureFromPoint(lastCoordinate);
    }));
}
/**
 * @param {?} line
 * @param {?} startMeasure
 * @param {?} partIndex
 * @param {?} options
 * @return {?}
 */
function setMeasureForLine(line, startMeasure, partIndex, options) {
    /** @type {?} */
    var hasCalibrationPoints = options.calibrationPositions.some((/**
     * @param {?} calibrationPosition
     * @return {?}
     */
    function (calibrationPosition) {
        return calibrationPosition.partIndex === partIndex;
    }));
    if (hasCalibrationPoints) {
        calibrateLinePart(line, startMeasure, partIndex, options);
    }
    else {
        setLinePartMeasuresByGeometricLength(line, startMeasure, options);
    }
}
/**
 * @param {?} line
 * @param {?} startMeasure
 * @param {?} partIndex
 * @param {?} options
 * @return {?}
 */
function calibrateLinePart(line, startMeasure, partIndex, options) {
    /** @type {?} */
    var calibrationPositions = options.calibrationPositions.filter((/**
     * @param {?} position
     * @return {?}
     */
    function (position) { return position.partIndex === partIndex; }));
    /** @type {?} */
    var fromVertexIndex = 0;
    sortAscending(calibrationPositions, (/**
     * @param {?} calibration
     * @return {?}
     */
    function (calibration) { return calibration.measure; }));
    calibrationPositions.forEach((/**
     * @param {?} calibration
     * @return {?}
     */
    function (calibration) {
        /** @type {?} */
        var fromVertex = line[fromVertexIndex];
        /** @type {?} */
        var toVertex = line[calibration.vertexIndex];
        /** @type {?} */
        var numberOfVerticesInBetween = calibration.vertexIndex - fromVertexIndex;
        /** @type {?} */
        var distanceForSection = Math.abs(calibration.measure - startMeasure);
        /** @type {?} */
        var measureDistributionIncrement = distanceForSection / numberOfVerticesInBetween;
        setMeasure(fromVertex, startMeasure, options.hasZValues);
        setMeasure(toVertex, calibration.measure, options.hasZValues);
        /** @type {?} */
        var inBetweenVertices = getVerticesBetween(line, fromVertexIndex, calibration.vertexIndex);
        inBetweenVertices.forEach((/**
         * @param {?} vertice
         * @param {?} index
         * @return {?}
         */
        function (vertice, index) {
            /** @type {?} */
            var partNumber = index + 1;
            /** @type {?} */
            var verticeIncrement = partNumber * measureDistributionIncrement;
            /** @type {?} */
            var measure = startMeasure + verticeIncrement;
            setMeasure(vertice, measure, options.hasZValues);
        }));
        fromVertexIndex = calibration.vertexIndex;
        startMeasure = calibration.measure;
    }));
    /** @type {?} */
    var areMoreVertices = fromVertexIndex < line.length - 1;
    if (areMoreVertices) {
        /** @type {?} */
        var remainingPoints = getVerticesBetween(line, fromVertexIndex - 1, line.length);
        setLinePartMeasuresByGeometricLength(remainingPoints, startMeasure, options);
    }
}
/**
 * @param {?} line
 * @param {?} startRangeIndex
 * @param {?} endRangeIndex
 * @return {?}
 */
function getVerticesBetween(line, startRangeIndex, endRangeIndex) {
    /** @type {?} */
    var index = startRangeIndex + 1;
    /** @type {?} */
    var vertices = [];
    for (; index < endRangeIndex; index++) {
        /** @type {?} */
        var vertice = line[index];
        vertices.push(vertice);
    }
    return vertices;
}
/**
 * @param {?} line
 * @param {?} startMeasure
 * @param {?} options
 * @return {?}
 */
function setLinePartMeasuresByGeometricLength(line, startMeasure, options) {
    /** @type {?} */
    var previousVertex;
    /** @type {?} */
    var vertexMeasure = startMeasure;
    line.forEach((/**
     * @param {?} vertex
     * @param {?} index
     * @return {?}
     */
    function (vertex, index) {
        if (index !== 0) {
            /** @type {?} */
            var distanceBetweenVerticees = distance(previousVertex, vertex, options);
            vertexMeasure += distanceBetweenVerticees;
        }
        setMeasure(vertex, vertexMeasure, options.hasZValues);
        previousVertex = vertex;
    }));
}
/**
 * @param {?} coordinate
 * @param {?} measure
 * @param {?} hasZValues
 * @return {?}
 */
function setMeasure(coordinate, measure, hasZValues) {
    /** @type {?} */
    var accountForZValue = hasZValues || coordinate.length > 3;
    /** @type {?} */
    var measureIndex = accountForZValue ? 3 : 2;
    coordinate[measureIndex] = measure;
    if (accountForZValue) {
        ensureZValue(coordinate);
    }
}
/**
 * @param {?} coordinate
 * @return {?}
 */
function ensureZValue(coordinate) {
    if (isNotNumber(coordinate[2])) {
        coordinate[2] = DEFAULT_EMPTY_Z_VALUE;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0LW1lYXN1cmVzLWJ5LWdlb21ldHJpYy1sZW5ndGguZnVuY3Rpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9nZW9tZXRyeS9nZW9tZXRyeS9zZXQtbWVhc3VyZXMtYnktZ2VvbWV0cmljLWxlbmd0aC5mdW5jdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sUUFBUSxNQUFNLGdCQUFnQixDQUFDO0FBSXRDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBRS9FLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sOENBQThDLENBQUM7O0lBR3JFLHFCQUFxQixHQUFHLENBQUM7O0lBQ3pCLGVBQWUsR0FBd0M7SUFDM0QsS0FBSyxFQUFFLE9BQU87SUFDZCxVQUFVLEVBQUUsSUFBSTtJQUNoQixvQkFBb0IsRUFBRSxFQUFFO0NBQ3pCOzs7Ozs7QUFFRCxNQUFNLFVBQVUsNEJBQTRCLENBQUMsSUFBa0IsRUFBRSxPQUE2Qzs7UUFDdEcsU0FBUyxHQUFpQixnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7SUFDdEQsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQzs7UUFDbEQsV0FBVyxHQUFHLENBQUM7SUFFbkIsU0FBUyxDQUFDLE9BQU87Ozs7O0lBQUMsVUFBQyxRQUFRLEVBQUUsU0FBUztRQUNwQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQzs7WUFDdkQsbUJBQW1CLEdBQUcsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDOztZQUN6QyxjQUFjLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixD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QUFTLFlBQVksQ0FBQyxVQUFvQjtJQUN4QyxJQUFJLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUM5QixVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcscUJBQXFCLENBQUM7S0FDdkM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gM3JkIHBhcnR5LlxuaW1wb3J0IGRpc3RhbmNlIGZyb20gJ0B0dXJmL2Rpc3RhbmNlJztcblxuLy8gVFNTLlxuaW1wb3J0IHsgTGluZUdlb21ldHJ5IH0gZnJvbSAnLi4vbGluZS9saW5lLWdlb21ldHJ5JztcbmltcG9ydCB7IHRvTXVsdGlQYXJ0UGF0aHMgfSBmcm9tICcuLi9saW5lL3RvLW11bHRpLXBhcnQtcGF0aHMuZnVuY3Rpb24nO1xuaW1wb3J0IHsgZ2V0TWVhc3VyZUZyb21Qb2ludCB9IGZyb20gJy4uL3BvaW50L2dldC1tZWFzdXJlLWZyb20tcG9pbnQuZnVuY3Rpb24nO1xuaW1wb3J0IHsgU2V0TWVhc3VyZXNCeUdlb21ldHJpY0xlbmd0aE9wdGlvbnMgfSBmcm9tICcuL3NldC1tZWFzdXJlcy1ieS1nZW9tZXRyaWMtbGVuZ3RoLW9wdGlvbnMnO1xuaW1wb3J0IHsgc29ydEFzY2VuZGluZyB9IGZyb20gJy4uLy4uL2NvcmUvc29ydC9zb3J0LmZ1bmN0aW9uJztcbmltcG9ydCB7IGlzTm90TnVtYmVyIH0gZnJvbSAnLi4vLi4vY29yZS90eXBlLWNoZWNrL2lzLW5vdC1udW1iZXIuZnVuY3Rpb24nO1xuXG5cbmNvbnN0IERFRkFVTFRfRU1QVFlfWl9WQUxVRSA9IDA7XG5jb25zdCBERUZBVUxUX09QVElPTlM6IFNldE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGhPcHRpb25zID0ge1xuICB1bml0czogJ21pbGVzJyxcbiAgaGFzWlZhbHVlczogdHJ1ZSxcbiAgY2FsaWJyYXRpb25Qb3NpdGlvbnM6IFtdXG59O1xuXG5leHBvcnQgZnVuY3Rpb24gc2V0TWVhc3VyZXNCeUdlb21ldHJpY0xlbmd0aChsaW5lOiBMaW5lR2VvbWV0cnksIG9wdGlvbnM/OiBTZXRNZWFzdXJlc0J5R2VvbWV0cmljTGVuZ3RoT3B0aW9ucyk6IHZvaWQge1xuICBjb25zdCBtYXJ0aVBhcnQ6IG51bWJlcltdW11bXSA9IHRvTXVsdGlQYXJ0UGF0aHMobGluZSk7XG4gIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCBERUZBVUxUX09QVElPTlMsIG9wdGlvbnMpO1xuICBsZXQgbGFzdE1lYXN1cmUgPSAwO1xuXG4gIG1hcnRpUGFydC5mb3JFYWNoKChsaW5lUGFydCwgcGFydEluZGV4KSA9PiB7XG4gICAgc2V0TWVhc3VyZUZvckxpbmUobGluZVBhcnQsIGxhc3RNZWFzdXJlLCBwYXJ0SW5kZXgsIG9wdGlvbnMpO1xuICAgIGNvbnN0IGxhc3RDb29yZGluYXRlSW5kZXggPSBsaW5lUGFydC5sZW5ndGggLSAxO1xuICAgIGNvbnN0IGxhc3RDb29yZGluYXRlID0gbGluZVBhcnRbbGFzdENvb3JkaW5hdGVJbmRleF07XG5cbiAgICBsYXN0TWVhc3VyZSArPSBnZXRNZWFzdXJlRnJvbVBvaW50KGxhc3RDb29yZGluYXRlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNldE1lYXN1cmVGb3JMaW5lKGxpbmU6IG51bWJlcltdW10sIHN0YXJ0TWVhc3VyZTogbnVtYmVyLCBwYXJ0SW5kZXg6IG51bWJlciwgb3B0aW9uczogU2V0TWVhc3VyZXNCeUdlb21ldHJpY0xlbmd0aE9wdGlvbnMpOiB2b2lkIHtcbiAgY29uc3QgaGFzQ2FsaWJyYXRpb25Qb2ludHM6IGJvb2xlYW4gPSBvcHRpb25zLmNhbGlicmF0aW9uUG9zaXRpb25zLnNvbWUoXG4gICAgY2FsaWJyYXRpb25Qb3NpdGlvbiA9PlxuICAgICAgY2FsaWJyYXRpb25Qb3NpdGlvbi5wYXJ0SW5kZXggPT09IHBhcnRJbmRleFxuICApO1xuXG4gIGlmIChoYXNDYWxpYnJhdGlvblBvaW50cykge1xuICAgIGNhbGlicmF0ZUxpbmVQYXJ0KGxpbmUsIHN0YXJ0TWVhc3VyZSwgcGFydEluZGV4LCBvcHRpb25zKTtcbiAgfSBlbHNlIHtcbiAgICBzZXRMaW5lUGFydE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGgobGluZSwgc3RhcnRNZWFzdXJlLCBvcHRpb25zKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYWxpYnJhdGVMaW5lUGFydChsaW5lOiBudW1iZXJbXVtdLCBzdGFydE1lYXN1cmU6IG51bWJlciwgcGFydEluZGV4OiBudW1iZXIsIG9wdGlvbnM6IFNldE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGhPcHRpb25zKTogdm9pZCB7XG4gIGNvbnN0IGNhbGlicmF0aW9uUG9zaXRpb25zID0gb3B0aW9ucy5jYWxpYnJhdGlvblBvc2l0aW9ucy5maWx0ZXIoXG4gICAgcG9zaXRpb24gPT4gcG9zaXRpb24ucGFydEluZGV4ID09PSBwYXJ0SW5kZXhcbiAgKTtcblxuICBsZXQgZnJvbVZlcnRleEluZGV4ID0gMDtcbiAgc29ydEFzY2VuZGluZyhjYWxpYnJhdGlvblBvc2l0aW9ucywgY2FsaWJyYXRpb24gPT4gY2FsaWJyYXRpb24ubWVhc3VyZSk7XG5cbiAgY2FsaWJyYXRpb25Qb3NpdGlvbnMuZm9yRWFjaChjYWxpYnJhdGlvbiA9PiB7XG4gICAgY29uc3QgZnJvbVZlcnRleCA9IGxpbmVbZnJvbVZlcnRleEluZGV4XTtcbiAgICBjb25zdCB0b1ZlcnRleCA9IGxpbmVbY2FsaWJyYXRpb24udmVydGV4SW5kZXhdO1xuICAgIGNvbnN0IG51bWJlck9mVmVydGljZXNJbkJldHdlZW4gPSBjYWxpYnJhdGlvbi52ZXJ0ZXhJbmRleCAtIGZyb21WZXJ0ZXhJbmRleDtcbiAgICBjb25zdCBkaXN0YW5jZUZvclNlY3Rpb24gPSBNYXRoLmFicyhjYWxpYnJhdGlvbi5tZWFzdXJlIC0gc3RhcnRNZWFzdXJlKTtcbiAgICBjb25zdCBtZWFzdXJlRGlzdHJpYnV0aW9uSW5jcmVtZW50ID0gZGlzdGFuY2VGb3JTZWN0aW9uIC8gbnVtYmVyT2ZWZXJ0aWNlc0luQmV0d2VlbjtcblxuICAgIHNldE1lYXN1cmUoZnJvbVZlcnRleCwgc3RhcnRNZWFzdXJlLCBvcHRpb25zLmhhc1pWYWx1ZXMpO1xuICAgIHNldE1lYXN1cmUodG9WZXJ0ZXgsIGNhbGlicmF0aW9uLm1lYXN1cmUsIG9wdGlvbnMuaGFzWlZhbHVlcyk7XG4gICAgY29uc3QgaW5CZXR3ZWVuVmVydGljZXMgPSBnZXRWZXJ0aWNlc0JldHdlZW4obGluZSwgZnJvbVZlcnRleEluZGV4LCBjYWxpYnJhdGlvbi52ZXJ0ZXhJbmRleCk7XG5cbiAgICBpbkJldHdlZW5WZXJ0aWNlcy5mb3JFYWNoKCh2ZXJ0aWNlLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgcGFydE51bWJlciA9IGluZGV4ICsgMTtcbiAgICAgIGNvbnN0IHZlcnRpY2VJbmNyZW1lbnQgPSBwYXJ0TnVtYmVyICogbWVhc3VyZURpc3RyaWJ1dGlvbkluY3JlbWVudDtcbiAgICAgIGNvbnN0IG1lYXN1cmUgPSBzdGFydE1lYXN1cmUgKyB2ZXJ0aWNlSW5jcmVtZW50O1xuICAgICAgc2V0TWVhc3VyZSh2ZXJ0aWNlLCBtZWFzdXJlLCBvcHRpb25zLmhhc1pWYWx1ZXMpO1xuICAgIH0pO1xuXG4gICAgZnJvbVZlcnRleEluZGV4ID0gY2FsaWJyYXRpb24udmVydGV4SW5kZXg7XG4gICAgc3RhcnRNZWFzdXJlID0gY2FsaWJyYXRpb24ubWVhc3VyZTtcbiAgfSk7XG5cbiAgY29uc3QgYXJlTW9yZVZlcnRpY2VzID0gZnJvbVZlcnRleEluZGV4IDwgbGluZS5sZW5ndGggLSAxO1xuICBpZiAoYXJlTW9yZVZlcnRpY2VzKSB7XG4gICAgY29uc3QgcmVtYWluaW5nUG9pbnRzOiBudW1iZXJbXVtdID0gZ2V0VmVydGljZXNCZXR3ZWVuKGxpbmUsIGZyb21WZXJ0ZXhJbmRleCAtIDEsIGxpbmUubGVuZ3RoKTtcbiAgICBzZXRMaW5lUGFydE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGgocmVtYWluaW5nUG9pbnRzLCBzdGFydE1lYXN1cmUsIG9wdGlvbnMpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFZlcnRpY2VzQmV0d2VlbihsaW5lOiBudW1iZXJbXVtdLCBzdGFydFJhbmdlSW5kZXg6IG51bWJlciwgZW5kUmFuZ2VJbmRleDogbnVtYmVyKTogbnVtYmVyW11bXSB7XG4gIGxldCBpbmRleCA9IHN0YXJ0UmFuZ2VJbmRleCArIDE7XG4gIGNvbnN0IHZlcnRpY2VzOiBudW1iZXJbXVtdID0gW107XG5cbiAgZm9yICg7IGluZGV4IDwgZW5kUmFuZ2VJbmRleDsgaW5kZXgrKykge1xuICAgIGNvbnN0IHZlcnRpY2UgPSBsaW5lW2luZGV4XTtcbiAgICB2ZXJ0aWNlcy5wdXNoKHZlcnRpY2UpO1xuICB9XG5cbiAgcmV0dXJuIHZlcnRpY2VzO1xufVxuXG5mdW5jdGlvbiBzZXRMaW5lUGFydE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGgobGluZTogbnVtYmVyW11bXSwgc3RhcnRNZWFzdXJlOiBudW1iZXIsIG9wdGlvbnM6IFNldE1lYXN1cmVzQnlHZW9tZXRyaWNMZW5ndGhPcHRpb25zKTogdm9pZCB7XG4gIGxldCBwcmV2aW91c1ZlcnRleDtcbiAgbGV0IHZlcnRleE1lYXN1cmUgPSBzdGFydE1lYXN1cmU7XG5cbiAgbGluZS5mb3JFYWNoKCh2ZXJ0ZXgsIGluZGV4KSA9PiB7XG4gICAgaWYgKGluZGV4ICE9PSAwKSB7XG4gICAgICBjb25zdCBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlZXM6IG51bWJlciA9IGRpc3RhbmNlKHByZXZpb3VzVmVydGV4LCB2ZXJ0ZXgsIG9wdGlvbnMpO1xuICAgICAgdmVydGV4TWVhc3VyZSArPSBkaXN0YW5jZUJldHdlZW5WZXJ0aWNlZXM7XG4gICAgfVxuXG4gICAgc2V0TWVhc3VyZSh2ZXJ0ZXgsIHZlcnRleE1lYXN1cmUsIG9wdGlvbnMuaGFzWlZhbHVlcyk7XG4gICAgcHJldmlvdXNWZXJ0ZXggPSB2ZXJ0ZXg7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBzZXRNZWFzdXJlKGNvb3JkaW5hdGU6IG51bWJlcltdLCBtZWFzdXJlOiBudW1iZXIsIGhhc1pWYWx1ZXM6IGJvb2xlYW4pOiB2b2lkIHtcbiAgY29uc3QgYWNjb3VudEZvclpWYWx1ZSA9IGhhc1pWYWx1ZXMgfHwgY29vcmRpbmF0ZS5sZW5ndGggPiAzO1xuICBjb25zdCBtZWFzdXJlSW5kZXggPSBhY2NvdW50Rm9yWlZhbHVlID8gMyA6IDI7XG4gIGNvb3JkaW5hdGVbbWVhc3VyZUluZGV4XSA9IG1lYXN1cmU7XG5cbiAgaWYgKGFjY291bnRGb3JaVmFsdWUpIHtcbiAgICBlbnN1cmVaVmFsdWUoY29vcmRpbmF0ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZW5zdXJlWlZhbHVlKGNvb3JkaW5hdGU6IG51bWJlcltdKTogdm9pZCB7XG4gIGlmIChpc05vdE51bWJlcihjb29yZGluYXRlWzJdKSkge1xuICAgIGNvb3JkaW5hdGVbMl0gPSBERUZBVUxUX0VNUFRZX1pfVkFMVUU7XG4gIH1cbn1cbiJdfQ==