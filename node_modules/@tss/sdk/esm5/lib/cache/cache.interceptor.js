/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
// Angualr.
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
// 3rd Party.
import { of, throwError } from 'rxjs';
import { tap, catchError } from 'rxjs/operators';
// TSS.
import { CacheService } from './cache.service';
import { CacheConfig } from './cache.config';
import { Logger } from '../core/logging/logger.service';
import { CacheStrategy } from './cache-strategy';
import { hasTokens } from '../core/tokens/has-tokens.function';
import { isString } from '../core/type-check/is-string.function';
import { extractTokenValuesFromTemplate } from '../core/tokens/extract-token-values-from-template.function';
import { format } from '../core/formatting/format.function';
import { CACHE_ONLY_NO_DATA_EXC_MSG } from './cache.constants';
import * as i0 from "@angular/core";
import * as i1 from "./cache.config";
import * as i2 from "./cache.service";
import * as i3 from "../core/logging/logger.service";
/**
 * @param {?} strategy
 * @return {?}
 */
function shouldCheckCacheFirst(strategy) {
    return strategy === CacheStrategy.CacheFirst
        || strategy === CacheStrategy.Fastest
        || strategy === CacheStrategy.CacheOnly;
}
/**
 * @param {?} definition
 * @param {?} requestUrl
 * @return {?}
 */
function getCacheKey(definition, requestUrl) {
    /** @type {?} */
    var cacheKey = definition.cacheId || requestUrl;
    if (hasTokens(cacheKey) && isString(definition.route)) {
        /** @type {?} */
        var tokenValues = extractTokenValuesFromTemplate((/** @type {?} */ (definition.route)), requestUrl);
        cacheKey = format(cacheKey, tokenValues, true);
    }
    return cacheKey;
}
var CacheInterceptor = /** @class */ (function () {
    function CacheInterceptor(config, cache, log) {
        this.config = config;
        this.cache = cache;
        this.log = log;
    }
    /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    CacheInterceptor.prototype.intercept = /**
     * @param {?} request
     * @param {?} next
     * @return {?}
     */
    function (request, next) {
        /** @type {?} */
        var allowCaching = request.method === 'GET' && this.config.cacheEnabled;
        /** @type {?} */
        var matchingCacheDefinition;
        // TODO: Handle request method type.
        // TDOO: Handle global use cache only.
        if (allowCaching) {
            matchingCacheDefinition = this.config.getCacheDefinition(request.urlWithParams);
            /** @type {?} */
            var strategy = matchingCacheDefinition
                ? this.config.forcedGlobalCacheStrategy || matchingCacheDefinition.strategy
                : null;
            if (matchingCacheDefinition && shouldCheckCacheFirst(strategy)) {
                /** @type {?} */
                var cacheKey = getCacheKey(matchingCacheDefinition, request.url);
                /** @type {?} */
                var isCacheOnly = strategy === CacheStrategy.CacheOnly;
                /** @type {?} */
                var cachedResponse = this.cache.get(cacheKey);
                if (cachedResponse) {
                    this.log.debug("Resolving HTTP request from cache: '" + request.url + "'");
                    return of(cachedResponse);
                }
                else if (isCacheOnly) {
                    return throwError(new Error(CACHE_ONLY_NO_DATA_EXC_MSG));
                }
            }
        }
        this.log.trace("Making HTTP request: '" + request.url + "'");
        /** @type {?} */
        var continuedResponse = next.handle(request);
        // If a matched cache definition is found, then we need to handle caching when the request when it is complete.
        if (allowCaching && matchingCacheDefinition) {
            continuedResponse = this.cacheResponse(continuedResponse, request, matchingCacheDefinition);
        }
        return continuedResponse;
    };
    /**
     * @private
     * @param {?} source
     * @param {?} request
     * @param {?} cacheDefinition
     * @return {?}
     */
    CacheInterceptor.prototype.cacheResponse = /**
     * @private
     * @param {?} source
     * @param {?} request
     * @param {?} cacheDefinition
     * @return {?}
     */
    function (source, request, cacheDefinition) {
        var _this = this;
        /** @type {?} */
        var cacheKey = getCacheKey(cacheDefinition, request.url);
        return source.pipe(tap((/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (cacheDefinition && event instanceof HttpResponse) {
                _this.log.debug("Caching HTTP request: '" + request.url + "'");
                _this.cache.set(cacheKey, event, cacheDefinition.expires);
            }
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var cachedData = _this.cache.get(cacheKey);
            if (cachedData) {
                _this.log.debug("Failed to resolve cacheable HTTP request from URL '" + request.url + "', fallingback to cache");
                return of(cachedData);
            }
            else {
                _this.log.debug("Failed to resolve cacheable HTTP request from URL '" + request.url + "' and no cached data available");
                throw error;
            }
        })));
    };
    CacheInterceptor.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    CacheInterceptor.ctorParameters = function () { return [
        { type: CacheConfig },
        { type: CacheService },
        { type: Logger }
    ]; };
    /** @nocollapse */ CacheInterceptor.ngInjectableDef = i0.defineInjectable({ factory: function CacheInterceptor_Factory() { return new CacheInterceptor(i0.inject(i1.CacheConfig), i0.inject(i2.CacheService), i0.inject(i3.Logger)); }, token: CacheInterceptor, providedIn: "root" });
    return CacheInterceptor;
}());
export { CacheInterceptor };
if (false) {
    /**
     * @type {?}
     * @private
     */
    CacheInterceptor.prototype.config;
    /**
     * @type {?}
     * @private
     */
    CacheInterceptor.prototype.cache;
    /**
     * @type {?}
     * @private
     */
    CacheInterceptor.prototype.log;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUuaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AdHNzL3Nkay8iLCJzb3VyY2VzIjpbImxpYi9jYWNoZS9jYWNoZS5pbnRlcmNlcHRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUF3RCxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQzs7QUFHMUcsT0FBTyxFQUFjLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDakUsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sNERBQTRELENBQUM7QUFDNUcsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLG1CQUFtQixDQUFDOzs7Ozs7Ozs7QUFHL0QsU0FBUyxxQkFBcUIsQ0FBQyxRQUF1QjtJQUNwRCxPQUFPLFFBQVEsS0FBSyxhQUFhLENBQUMsVUFBVTtXQUN2QyxRQUFRLEtBQUssYUFBYSxDQUFDLE9BQU87V0FDbEMsUUFBUSxLQUFLLGFBQWEsQ0FBQyxTQUFTLENBQUM7QUFDNUMsQ0FBQzs7Ozs7O0FBRUQsU0FBUyxXQUFXLENB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NEJBQTBCLE9BQU8sQ0FBQyxHQUFHLE1BQUcsQ0FBQyxDQUFDO2dCQUN6RCxLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUMxRDtRQUNILENBQUMsRUFBQyxFQUNGLFVBQVU7Ozs7UUFBQyxVQUFDLEtBQVU7O2dCQUNkLFVBQVUsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7WUFDM0MsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsS0FBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsd0RBQXNELE9BQU8sQ0FBQyxHQUFHLDRCQUF5QixDQUFDLENBQUM7Z0JBQzNHLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNMLEtBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLHdEQUFzRCxPQUFPLENBQUMsR0FBRyxtQ0FBZ0MsQ0FBQyxDQUFDO2dCQUNsSCxNQUFNLEtBQUssQ0FBQzthQUNiO1FBQ0gsQ0FBQyxFQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7O2dCQXJFRixVQUFVLFNBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzs7O2dCQTlCUSxXQUFXO2dCQURYLFlBQVk7Z0JBRVosTUFBTTs7OzJCQVhmO0NBNEdDLEFBdEVELElBc0VDO1NBbkVZLGdCQUFnQjs7Ozs7O0lBQ2Ysa0NBQTJCOzs7OztJQUFFLGlDQUEyQjs7Ozs7SUFBRSwrQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBbmd1YWxyLlxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cFJlcXVlc3QsIEh0dHBIYW5kbGVyLCBIdHRwRXZlbnQsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG4vLyAzcmQgUGFydHkuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vLyBUU1MuXG5pbXBvcnQgeyBDYWNoZVNlcnZpY2UgfSBmcm9tICcuL2NhY2hlLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2FjaGVDb25maWcgfSBmcm9tICcuL2NhY2hlLmNvbmZpZyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9jb3JlL2xvZ2dpbmcvbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2FjaGVTdHJhdGVneSB9IGZyb20gJy4vY2FjaGUtc3RyYXRlZ3knO1xuaW1wb3J0IHsgQ2FjaGVEZWZpbml0aW9uIH0gZnJvbSAnLi9jYWNoZS1kZWZpbml0aW9uJztcbmltcG9ydCB7IGhhc1Rva2VucyB9IGZyb20gJy4uL2NvcmUvdG9rZW5zL2hhcy10b2tlbnMuZnVuY3Rpb24nO1xuaW1wb3J0IHsgaXNTdHJpbmcgfSBmcm9tICcuLi9jb3JlL3R5cGUtY2hlY2svaXMtc3RyaW5nLmZ1bmN0aW9uJztcbmltcG9ydCB7IGV4dHJhY3RUb2tlblZhbHVlc0Zyb21UZW1wbGF0ZSB9IGZyb20gJy4uL2NvcmUvdG9rZW5zL2V4dHJhY3QtdG9rZW4tdmFsdWVzLWZyb20tdGVtcGxhdGUuZnVuY3Rpb24nO1xuaW1wb3J0IHsgZm9ybWF0IH0gZnJvbSAnLi4vY29yZS9mb3JtYXR0aW5nL2Zvcm1hdC5mdW5jdGlvbic7XG5pbXBvcnQgeyBDQUNIRV9PTkxZX05PX0RBVEFfRVhDX01TRyB9IGZyb20gJy4vY2FjaGUuY29uc3RhbnRzJztcblxuXG5mdW5jdGlvbiBzaG91bGRDaGVja0NhY2hlRmlyc3Qoc3RyYXRlZ3k6IENhY2hlU3RyYXRlZ3kpIHtcbiAgcmV0dXJuIHN0cmF0ZWd5ID09PSBDYWNoZVN0cmF0ZWd5LkNhY2hlRmlyc3RcbiAgICB8fCBzdHJhdGVneSA9PT0gQ2FjaGVTdHJhdGVneS5GYXN0ZXN0XG4gICAgfHwgc3RyYXRlZ3kgPT09IENhY2hlU3RyYXRlZ3kuQ2FjaGVPbmx5O1xufVxuXG5mdW5jdGlvbiBnZXRDYWNoZUtleShkZWZpbml0aW9uOiBDYWNoZURlZmluaXRpb24sIHJlcXVlc3RVcmw6IHN0cmluZyk6IHN0cmluZyB7XG4gIGxldCBjYWNoZUtleSA9IGRlZmluaXRpb24uY2FjaGVJZCB8fCByZXF1ZXN0VXJsO1xuICBpZiAoaGFzVG9rZW5zKGNhY2hlS2V5KSAmJiBpc1N0cmluZyhkZWZpbml0aW9uLnJvdXRlKSkge1xuICAgIGNvbnN0IHRva2VuVmFsdWVzID0gZXh0cmFjdFRva2VuVmFsdWVzRnJvbVRlbXBsYXRlKGRlZmluaXRpb24ucm91dGUgYXMgc3RyaW5nLCByZXF1ZXN0VXJsKTtcbiAgICBjYWNoZUtleSA9IGZvcm1hdChjYWNoZUtleSwgdG9rZW5WYWx1ZXMsIHRydWUpO1xuICB9XG5cbiAgcmV0dXJuIGNhY2hlS2V5O1xufVxuXG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENhY2hlSW50ZXJjZXB0b3IgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogQ2FjaGVDb25maWcsIHByaXZhdGUgY2FjaGU6IENhY2hlU2VydmljZSwgcHJpdmF0ZSBsb2c6IExvZ2dlcikge1xuICB9XG5cbiAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xuICAgIGNvbnN0IGFsbG93Q2FjaGluZyA9IHJlcXVlc3QubWV0aG9kID09PSAnR0VUJyAmJiB0aGlzLmNvbmZpZy5jYWNoZUVuYWJsZWQ7XG4gICAgbGV0IG1hdGNoaW5nQ2FjaGVEZWZpbml0aW9uOiBDYWNoZURlZmluaXRpb247XG5cbiAgICAvLyBUT0RPOiBIYW5kbGUgcmVxdWVzdCBtZXRob2QgdHlwZS5cbiAgICAvLyBURE9POiBIYW5kbGUgZ2xvYmFsIHVzZSBjYWNoZSBvbmx5LlxuXG4gICAgaWYgKGFsbG93Q2FjaGluZykge1xuICAgICAgbWF0Y2hpbmdDYWNoZURlZmluaXRpb24gPSB0aGlzLmNvbmZpZy5nZXRDYWNoZURlZmluaXRpb24ocmVxdWVzdC51cmxXaXRoUGFyYW1zKTtcbiAgICAgIGNvbnN0IHN0cmF0ZWd5OiBDYWNoZVN0cmF0ZWd5ID0gbWF0Y2hpbmdDYWNoZURlZmluaXRpb25cbiAgICAgICAgPyB0aGlzLmNvbmZpZy5mb3JjZWRHbG9iYWxDYWNoZVN0cmF0ZWd5IHx8IG1hdGNoaW5nQ2FjaGVEZWZpbml0aW9uLnN0cmF0ZWd5XG4gICAgICAgIDogbnVsbDtcblxuICAgICAgaWYgKG1hdGNoaW5nQ2FjaGVEZWZpbml0aW9uICYmIHNob3VsZENoZWNrQ2FjaGVGaXJzdChzdHJhdGVneSkpIHtcbiAgICAgICAgY29uc3QgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShtYXRjaGluZ0NhY2hlRGVmaW5pdGlvbiwgcmVxdWVzdC51cmwpO1xuICAgICAgICBjb25zdCBpc0NhY2hlT25seSA9IHN0cmF0ZWd5ID09PSBDYWNoZVN0cmF0ZWd5LkNhY2hlT25seTtcbiAgICAgICAgY29uc3QgY2FjaGVkUmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+ID0gdGhpcy5jYWNoZS5nZXQoY2FjaGVLZXkpO1xuXG4gICAgICAgIGlmIChjYWNoZWRSZXNwb25zZSkge1xuICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBSZXNvbHZpbmcgSFRUUCByZXF1ZXN0IGZyb20gY2FjaGU6ICcke3JlcXVlc3QudXJsfSdgKTtcbiAgICAgICAgICByZXR1cm4gb2YoY2FjaGVkUmVzcG9uc2UpO1xuICAgICAgICB9IGVsc2UgaWYgKGlzQ2FjaGVPbmx5KSB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IobmV3IEVycm9yKENBQ0hFX09OTFlfTk9fREFUQV9FWENfTVNHKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmxvZy50cmFjZShgTWFraW5nIEhUVFAgcmVxdWVzdDogJyR7cmVxdWVzdC51cmx9J2ApO1xuICAgIGxldCBjb250aW51ZWRSZXNwb25zZTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4gPSBuZXh0LmhhbmRsZShyZXF1ZXN0KTtcblxuICAgIC8vIElmIGEgbWF0Y2hlZCBjYWNoZSBkZWZpbml0aW9uIGlzIGZvdW5kLCB0aGVuIHdlIG5lZWQgdG8gaGFuZGxlIGNhY2hpbmcgd2hlbiB0aGUgcmVxdWVzdCB3aGVuIGl0IGlzIGNvbXBsZXRlLlxuICAgIGlmIChhbGxvd0NhY2hpbmcgJiYgbWF0Y2hpbmdDYWNoZURlZmluaXRpb24pIHtcbiAgICAgIGNvbnRpbnVlZFJlc3BvbnNlID0gdGhpcy5jYWNoZVJlc3BvbnNlKGNvbnRpbnVlZFJlc3BvbnNlLCByZXF1ZXN0LCBtYXRjaGluZ0NhY2hlRGVmaW5pdGlvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbnRpbnVlZFJlc3BvbnNlO1xuICB9XG5cbiAgcHJpdmF0ZSBjYWNoZVJlc3BvbnNlKFxuICAgIHNvdXJjZTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4sXG4gICAgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PixcbiAgICBjYWNoZURlZmluaXRpb246IENhY2hlRGVmaW5pdGlvblxuICApOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBnZXRDYWNoZUtleShjYWNoZURlZmluaXRpb24sIHJlcXVlc3QudXJsKTtcbiAgICByZXR1cm4gc291cmNlLnBpcGUoXG4gICAgICB0YXAoZXZlbnQgPT4ge1xuICAgICAgICBpZiAoY2FjaGVEZWZpbml0aW9uICYmIGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgdGhpcy5sb2cuZGVidWcoYENhY2hpbmcgSFRUUCByZXF1ZXN0OiAnJHtyZXF1ZXN0LnVybH0nYCk7XG4gICAgICAgICAgdGhpcy5jYWNoZS5zZXQoY2FjaGVLZXksIGV2ZW50LCBjYWNoZURlZmluaXRpb24uZXhwaXJlcyk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBjYWNoZWREYXRhID0gdGhpcy5jYWNoZS5nZXQoY2FjaGVLZXkpO1xuICAgICAgICBpZiAoY2FjaGVkRGF0YSkge1xuICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBGYWlsZWQgdG8gcmVzb2x2ZSBjYWNoZWFibGUgSFRUUCByZXF1ZXN0IGZyb20gVVJMICcke3JlcXVlc3QudXJsfScsIGZhbGxpbmdiYWNrIHRvIGNhY2hlYCk7XG4gICAgICAgICAgcmV0dXJuIG9mKGNhY2hlZERhdGEpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9nLmRlYnVnKGBGYWlsZWQgdG8gcmVzb2x2ZSBjYWNoZWFibGUgSFRUUCByZXF1ZXN0IGZyb20gVVJMICcke3JlcXVlc3QudXJsfScgYW5kIG5vIGNhY2hlZCBkYXRhIGF2YWlsYWJsZWApO1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cbiJdfQ==